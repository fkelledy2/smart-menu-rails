<%= render 'shared/currency' %>

<% 
  # Determine view type: allow explicit override via params[:view]
  # - ?view=customer forces customer view
  # - ?view=staff forces staff view
  if params[:view] == 'customer'
    show_customer_view = true
  elsif params[:view] == 'staff'
    show_customer_view = false
  else
    show_customer_view = @force_customer_view || !current_user
  end
%>

<%# Test-only: disable modal backdrops and transitions to make UI automation reliable %>
<% if Rails.env.test? %>
  <style>
    .modal-backdrop { display: none !important; }
    .modal { transition: none !important; }
  </style>
<% end %>

<%# Cache the menu header - disable cache in test for reliability %>
<% if Rails.env.test? %>
  <% if show_customer_view %>
  <div id="menuc" class="menu-sticky-header menu-sticky-header-mobile" data-testid="smartmenu-customer-view">
  <% else %>
  <div id="menuu" class="menu-sticky-header menu-sticky-header-mobile" data-testid="smartmenu-staff-view">
  <% end %>
      <%= render partial: "smartmenus/showMenuBanner" %>
  </div>
<% else %>
  <% cache [@smartmenu, @menu, @restaurant, show_customer_view ? 'customer' : 'staff'], expires_in: 1.hour do %>
  <% if show_customer_view %>
  <div id="menuc" class="menu-sticky-header menu-sticky-header-mobile" data-testid="smartmenu-customer-view">
  <% else %>
  <div id="menuu" class="menu-sticky-header menu-sticky-header-mobile" data-testid="smartmenu-staff-view">
  <% end %>
      <%= render partial: "smartmenus/showMenuBanner" %>
  </div>
  <% end %>
<% end %>

<div id="menuContentContainer" data-testid="menu-content-container">
    <%# Cache menu content separately - disable cache in test for reliability %>
    <% if Rails.env.test? %>
        <% if show_customer_view %>
            <%= render partial: "smartmenus/showMenuContentCustomer", locals: { order: @openOrder, menu: @menu, allergyns: @allergyns, restaurantCurrency: @restaurantCurrency, ordrparticipant: @ordrparticipant, menuparticipant: @menuparticipant, tablesetting: @tablesetting } %>
        <% else %>
            <%= render partial: "smartmenus/showMenuContentStaff", locals: { order: @openOrder, menu: @menu, allergyns: @allergyns, restaurantCurrency: @restaurantCurrency, ordrparticipant: @ordrparticipant, menuparticipant: @menuparticipant, tablesetting: @tablesetting } %>
        <% end %>
    <% else %>
        <% cache_key = [@smartmenu, @menu, @allergyns.maximum(:updated_at), @openOrder&.updated_at, show_customer_view ? 'customer' : 'staff'] %>
        <% cache cache_key, expires_in: 30.minutes do %>
        <% if show_customer_view %>
            <%= render partial: "smartmenus/showMenuContentCustomer", locals: { order: @openOrder, menu: @menu, allergyns: @allergyns, restaurantCurrency: @restaurantCurrency, ordrparticipant: @ordrparticipant, menuparticipant: @menuparticipant, tablesetting: @tablesetting } %>
        <% else %>
            <%= render partial: "smartmenus/showMenuContentStaff", locals: { order: @openOrder, menu: @menu, allergyns: @allergyns, restaurantCurrency: @restaurantCurrency, ordrparticipant: @ordrparticipant, menuparticipant: @menuparticipant, tablesetting: @tablesetting } %>
        <% end %>
        <% end %>
    <% end %>
</div>

<%# Allergen Legend Modal - outside cache to always be available %>
<%= render partial: "smartmenus/allergen_legend_modal", locals: { allergyns: @allergyns } %>
