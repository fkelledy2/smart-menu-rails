<div id="modalsContainer">

    <div class="modal fade" id="openOrderModal" tabindex="-1" aria-labelledby="openOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="openOrderModalLabel"><%= t(".startOrder") %></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"></button>
                </div>
                <div class="modal-body">
                    <% if tablesetting %>
                        <div class="d-flex flex-column gap-3">
                            <div class="text-center">
                                <div class="fs-4 fw-bold"><%= t(".partySize") %></div>
                            </div>

                            <div class="d-flex align-items-center justify-content-center gap-3">
                                <button type="button" class="btn btn-outline-secondary btn-lg" id="orderCapacityDecrement">-</button>
                                <div class="text-center" style="min-width: 120px;">
                                    <div id="orderCapacityValue" class="display-4 mb-0">1</div>
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-lg" id="orderCapacityIncrement">+</button>
                            </div>

                            <input type="hidden" id="orderCapacity" value="1" data-min="1" data-max="<%= tablesetting.capacity %>">

                            <div class="d-flex flex-wrap justify-content-center gap-2">
                                <button type="button" class="btn btn-outline-primary orderCapacityPreset" data-capacity="1">1</button>
                                <% if tablesetting.capacity.to_i >= 2 %>
                                    <button type="button" class="btn btn-outline-primary orderCapacityPreset" data-capacity="2">2</button>
                                <% end %>
                                <% if tablesetting.capacity.to_i >= 4 %>
                                    <button type="button" class="btn btn-outline-primary orderCapacityPreset" data-capacity="4">4</button>
                                <% end %>
                                <% if tablesetting.capacity.to_i >= 6 %>
                                    <button type="button" class="btn btn-outline-primary orderCapacityPreset" data-capacity="6">6</button>
                                <% end %>
                                <button type="button" class="btn btn-outline-primary orderCapacityPreset" data-capacity="<%= tablesetting.capacity %>">Full (<%= tablesetting.capacity %>)</button>
                            </div>
                        </div>
                    <% end %>
                </div>
                <div class="modal-footer gap-2">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"><%= t(".cancel") %></button>
                    <button id="start-order" type="button" data-bs-dismiss="modal" class="btn btn-primary"><%= t(".start") %></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addItemToOrderModal" tabindex="-1" aria-labelledby="addItemToOrderModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content">
          <%= render partial: "smartmenus/modal_header_add_item" %>
          <div class="modal-body modal-body-no-padding">
                <% if (menu.displayImages == true && menu.restaurant.displayImages == true) || (menu.displayImagesInPopup == true && menu.restaurant.displayImagesInPopup == true) %>
                    <div class="row">
                        <div class="col-12">
                            <div class="image-container position-relative">
                                <!-- Placeholder image (same size as final image) -->
                                <img id="placeholder" src="https://placehold.co/600x400/white/white" class="w-100" style="visibility: visible;">
                                <!-- Spinner overlay -->
                                <div id="spinner" class="position-absolute top-50 start-50 translate-middle">
                                    <div class="spinner-border text-primary"></div>
                                </div>
                                <%= image_tag "",
                                    :id => "a2o_menuitem_image",
                                    :title => "",
                                    :class => "addItemToOrderImage card-img-top",
                                    :onload => "fadeIn(this)",
                                    :style => "display:none;"
                                %>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:20px;"></div>
            <% end %>
            <span style="display:none" id="a2o_ordr_id"></span>
            <span style="display:none" id="a2o_menuitem_id"></span>
            <span style="display:none" id="a2o_size_name"></span>
            <div style="padding-left:15px;padding-right:15px;" class="row">
                <div class="col-12">
                    <span class="h4" id="a2o_menuitem_name"></span>
                </div>
            </div>
            <div style="padding-left:15px;padding-right:15px;" class="row">
                <div class="col-12">
                    <span id="a2o_menuitem_description"></span>
                </div>
            </div>
            <div style="padding-left:15px;padding-right:15px;" class="row mt-2" id="a2o_tasting_controls" hidden>
              <div class="col-12 d-flex align-items-center gap-2 flex-wrap">
                <div class="input-group input-group-sm" style="width: 140px;">
                  <button class="btn btn-outline-secondary" type="button" id="a2o_tasting_qty_decr" aria-label="Decrease">-</button>
                  <input type="number" class="form-control text-center" id="a2o_tasting_qty" value="1" min="1">
                  <button class="btn btn-outline-secondary" type="button" id="a2o_tasting_qty_incr" aria-label="Increase">+</button>
                </div>
                <div class="form-check form-check-inline" id="a2o_tasting_pairing_wrap" hidden>
                  <input class="form-check-input" type="checkbox" id="a2o_tasting_pairing">
                  <label class="form-check-label" for="a2o_tasting_pairing">Pairing</label>
                </div>
              </div>
            </div>
          </div>
          <%= render partial: "smartmenus/modal_footer_add_item", locals: { restaurantCurrency: restaurantCurrency } %>
        </div>
      </div>
    </div>

    <% if ordrparticipant %>
    <div class="modal fade" id="filterOrderModal" tabindex="-1" aria-labelledby="filterOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="filterOrderModalLabel"><%= t(".filterAllergyns") %></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"></button>
                </div>
                <%= form_with(model: [restaurant, ordrparticipant]) do |form| %>
                    <div class="modal-body">
                        <div class="form-group row">
                            <div class="col-8">
                                <div style="max-height: 60vh; overflow-y: auto; padding-right: 8px;">
                                    <%= form.collection_check_boxes :allergyn_ids, allergyns, :id, :name, { hide_label: true } do |b| %>
                                        <div class="form-check">
                                            <%= b.check_box %>
                                            <label class="form-check-label">
                                                <%= b.label %>
                                            </label>
                                        </div>
                                    <% end %>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="float-end form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="toggleFilters">
                                    <label class="form-check-label" for="toggleFilters"><%= t(".noneAll") %></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"><%= t(".cancel") %></button>
                        <%= form.submit value: t(".filterBy"), class: 'btn btn-primary' %>
                    </div>
                <% end %>
            </div>
        </div>
    </div>
    <% end %>
    <div class="modal fade" id="viewOrderModal" tabindex="-1" aria-labelledby="viewOrderModalLabel" aria-hidden="true" data-testid="view-order-modal" data-controller="order-totals">
      <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewOrderModalLabel"><%= t(".yourOrder")%></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"></button>
          </div>
          <div class="modal-body" data-testid="order-modal-body">
            <% if order %>
                <div class="row">
                    <div class="col-8">
                    </div>
                    <div class="col-2">
                    </div>
                    <div class="col-2">
                      <span class="float-end">
                        <b><%= t(".price")%></b>
                      </span>
                    </div>
                </div>
                <% if order && order.addedCount > 0 %>
                    <div class="row" data-testid="order-items-selected-section">
                        <div class="col-2">
                            <p><%= t('.selected') %></p>
                        </div>
                        <div class="col-10">
                            <hr>
                        </div>
                    </div>
                    <% order.ordractions.each do |ordraction| %>
                        <% if ordraction.ordritem && ordraction.ordritem.status == 'opened' && ordraction.ordritem.in?(order.ordritems) %>
                            <div id="ordritem_<%= ordraction.ordritem.id %>" style="margin-top:5px" class="row" data-testid="order-item-<%= ordraction.ordritem.id %>">
                                <div class="col-8">
                                    <div class="d-flex w-100 overflow-hidden">
                                        <p class="text-truncate">
                                            <button type="button" class="removeItemFromOrderButton btn-touch-danger btn-touch-icon btn-touch-sm"
                                                data-bs-ordritem_id="<%= ordraction.ordritem.id %>"
                                                aria-label="<%= t('.remove_item', default: 'Remove item') %>"
                                                data-testid="remove-order-item-<%= ordraction.ordritem.id %>-btn">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            <% if ordrparticipant && ordrparticipant.preferredlocale %>
                                                <%= ordraction.ordritem.menuitem.localised_name(ordrparticipant.preferredlocale) %>
                                            <% else %>
                                                <% if menuparticipant && menuparticipant.preferredlocale %>
                                                    <%= ordraction.ordritem.menuitem.localised_name(menuparticipant.preferredlocale) %>
                                                <% else %>
                                                    <%= ordraction.ordritem.menuitem.name %>
                                                <% end %>
                                            <% end %>
                                            <% if ordraction.ordritem.size_name.present? %>
                                              <span class="text-muted" style="font-size: 0.8em;">(<%= ordraction.ordritem.size_name.sub(/\s*\(.*\)/, '') %>)</span>
                                            <% end %>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="d-flex w-100 overflow-hidden">
                                        <p class="text-truncate">
                                            <%= ordraction.ordrparticipant.name %>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <span class="float-end">
                                        <%= number_to_currency(ordraction.ordritem.ordritemprice, unit: restaurantCurrency.symbol ? restaurantCurrency.symbol : "") %>
                                    </span>
                                </div>
                            </div>
                        <% end %>
                    <% end %>
                <% end %>
                <% if order && order.orderedCount > 0 %>
                    <div class="row">
                        <div class="col-2">
                            <p><%= t('.submitted') %></p>
                        </div>
                        <div class="col-10">
                            <hr>
                        </div>
                    </div>
                    <% order.ordractions.each do |ordraction| %>
                        <% if ordraction.ordritem && (ordraction.ordritem.status == 'ordered' || ordraction.ordritem.status == 'preparing' || ordraction.ordritem.status == 'ready'  || ordraction.ordritem.status == 'delivered') && ordraction.ordritem.in?(order.ordritems) %>
                            <div id="ordritem_<%= ordraction.ordritem.id %>" style="margin-top:5px" class="row">
                                <div class="col-8">
                                    <div class="d-flex w-100 overflow-hidden">
                                        <p class="text-muted text-truncate">
                                            <button type="button" class="btn-touch-dark btn-touch-icon btn-touch-sm" disabled>
                                                <i class="bi bi-arrow-right-circle-fill"></i>
                                            </button>
                                            <% if ordrparticipant && ordrparticipant.preferredlocale %>
                                                <%= ordraction.ordritem.menuitem.localised_name(ordrparticipant.preferredlocale) %>
                                            <% else %>
                                                <% if menuparticipant && menuparticipant.preferredlocale %>
                                                    <%= ordraction.ordritem.menuitem.localised_name(menuparticipant.preferredlocale) %>
                                                <% else %>
                                                    <%= ordraction.ordritem.menuitem.name %>
                                                <% end %>
                                            <% end %>
                                            <% if ordraction.ordritem.size_name.present? %>
                                              <span class="text-muted" style="font-size: 0.8em;">(<%= ordraction.ordritem.size_name.sub(/\s*\(.*\)/, '') %>)</span>
                                            <% end %>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="d-flex w-100 overflow-hidden">
                                        <p class="text-muted text-truncate">
                                            <%= ordraction.ordrparticipant.name %>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <span class="text-muted float-end">
                                        <%= number_to_currency(ordraction.ordritem.menuitem.price, unit: restaurantCurrency.symbol ? restaurantCurrency.symbol : "") %>
                                    </span>
                                </div>
                            </div>
                        <% end %>
                    <% end %>
                <% end %>

                <div class="row" data-testid="order-total-row">
                    <div class="col-8">
                    </div>
                    <div class="col-2">
                        <b><%= t(".total")%>:</b>
                    </div>
                    <div class="col-2">
                        <% order_total = begin
                          order.ordritems.sum { |it| it.ordritemprice.to_f }
                        rescue StandardError
                          order.nett
                        end %>
                        <span class="float-end" data-testid="order-total-amount"><b><%= number_to_currency(order_total, unit: restaurantCurrency.symbol ? restaurantCurrency.symbol : "") %></b></span>
                    </div>
                </div>
            <% end %>
          </div>
          <div class="modal-footer gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"><%= t('.cancel') %></button>
            <% if order && order.addedCount > 0 %>
              <button id="confirm-order" type="button" data-bs-dismiss="modal" class="btn btn-primary" data-testid="submit-order-btn"><%= t('.submit') %></button>
            <% else %>
              <button id="confirm-order" type="button" data-bs-dismiss="modal" class="btn btn-primary" disabled data-testid="submit-order-btn"><%= t('.submit') %></button>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="requestBillModal" tabindex="-1" aria-labelledby="requestBillModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="requestBillModalLabel"><%= t(".requestBill") %></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"></button>
          </div>
          <div class="modal-body text-center py-4">
            <i class="bi bi-exclamation-triangle-fill text-warning fs-1 mb-3 d-block"></i>
            <p class="fw-bold mb-2"><%= t('smartmenus.showModals.request_bill_confirm_title', default: 'Are you sure?') %></p>
            <p class="text-muted"><%= t('smartmenus.showModals.request_bill_confirm_body', default: 'Once you request the bill, you will no longer be able to add items to your order.') %></p>
          </div>
          <%= render partial: "smartmenus/modal_footer_primary", locals: { primary_id: 'request-bill-confirm', primary_text: t('.requestBill'), disabled: !(order && order.gross.to_f > 0) } %>
        </div>
      </div>
    </div>

    <%# Pay Bill modal â€” staff/admin only (customers use the inline bottom sheet pay section) %>
    <% if current_user || current_employee %>
    <div class="modal fade" id="payOrderModal" tabindex="-1" aria-labelledby="payOrderModalLabel" aria-hidden="true" data-controller="order-totals" data-tip-presets="<%= restaurant.tips.sort_by(&:percentage).map(&:percentage).to_json %>" data-currency-symbol="<%= restaurantCurrency.symbol || '' %>">
        <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="payOrderModalLabel"><%= t(".payBill") %></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"></button>
                </div>
                <div class="modal-body">
                  <% if order %>
                    <% cur = restaurantCurrency.symbol.presence || "" %>
                    <div class="bill-line bill-line-header"><span><b><%= t('.item') %></b></span><span><b><%= t('.price') %></b></span></div>
                    <% if order.covercharge.to_f > 0 %>
                      <div class="bill-line"><span><%= t('.cover_charge') %></span><span class="bill-amount" id="orderCoverCharge"><%= number_to_currency(order.covercharge, unit: cur) %></span></div>
                    <% end %>
                    <div class="bill-line"><span><%= t('.nett') %></span><span class="bill-amount" id="orderNett"><%= number_to_currency(order.nett, unit: cur) %></span></div>
                    <% if order.service.to_f > 0 %>
                      <div class="bill-line"><span><%= t('.service') %></span><span class="bill-amount" id="orderService"><%= number_to_currency(order.service, unit: cur) %></span></div>
                    <% end %>
                    <% if order.tax.to_f > 0 %>
                      <div class="bill-line"><span><%= t('.tax') %></span><span class="bill-amount" id="orderTax"><%= number_to_currency(order.tax, unit: cur) %></span></div>
                    <% end %>
                    <hr>
                    <div class="bill-line bill-line-total"><span><b><%= t('.total') %></b> <i>(<%= t('.excluding_tip') %>)</i></span><span class="bill-amount"><b><%= cur %><span id="orderGross"><%= number_to_currency(order.gross, unit: "") %></span></b></span></div>
                    <div class="bill-tip-row">
                      <div class="d-flex flex-wrap align-items-center justify-content-end gap-2 mt-3 mb-3">
                        <% restaurant.tips.sort_by(&:percentage).each do |tip| %>
                          <button type="button" class="btn-touch-secondary btn-touch-sm"><span class="tipPreset"><%= tip.percentage %></span>%</button>
                        <% end %>
                        <input id="tipNumberField" type="number" min="0.00" max="<%= number_to_currency(order.gross, unit: cur) %>" class="form-control form-control-sm text-end" style="width: 80px;" value="0.00">
                      </div>
                    </div>
                    <hr>
                    <div class="bill-line bill-line-total"><span><b><%= t('.total') %></b> <i>(<%= t('.including_tip') %>)</i></span><span class="bill-amount"><b><span id="orderGrandTotal"><%= number_to_currency(order.gross, unit: cur) %></span></b></span></div>
                    <div class="d-flex flex-column align-items-center gap-3 mt-4">
                      <div id="wallet-button-container" data-controller="stripe-wallet" data-stripe-wallet-open-order-id-value="<%= order&.id %>" data-stripe-wallet-amount-cents-value="<%= order&.grossInCents %>" data-stripe-wallet-currency-value="<%= restaurantCurrency.code %>"></div>
                      <input type="hidden" id="openOrderId" value="<%= order.id %>">
                      <input type="hidden" id="paymentAmount" value="<%= order.grossInCents %>">
                      <input type="hidden" id="paymentCurrency" value="<%= restaurantCurrency.code %>">
                      <input type="hidden" id="paymentRestaurantName" value="<%= t('.bill_prefix') %> <%= order.restaurant.name %>">
                      <input type="hidden" id="paymentRestaurantId" value="<%= order.restaurant.id %>">
                    </div>
                  <% end %>
                </div>
                <%= render partial: "smartmenus/modal_footer_primary", locals: { primary_id: 'pay-order-confirm', primary_text: t('.confirmPayment'), disabled: !(order && order.gross.to_f > 0) } %>
            </div>
        </div>
    </div>
    <% end %>

    <div class="modal fade" id="addNameToParticipantModal" tabindex="-1" aria-labelledby="addNameToParticipantModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addNameToParticipantModalLabel"><%= t(".customiseOrderWithName") %></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <input type="hidden" class="form-control" id="ordr_id">
                          <div class="form-group row">
                            <div class="col-3">
                            <label for="name" class="form-label"><%= t('.name_label') %></label>
                            </div>
                            <div class="col-9">
                            <input type="text" class="form-control" id="name">
                            </div>
                          </div>
                    </form>
                </div>
                <div class="modal-footer gap-2">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"><%= t(".cancel") %></button>
                    <button id="addNameToParticipantButton" type="button" class="btn btn-primary" data-bs-dismiss="modal"><i class="bi bi-plus"></i> <%= t(".add") %></button>
                </div>
            </div>
        </div>
    </div>
</div>