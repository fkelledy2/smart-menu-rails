<%# Bottom Sheet Cart — replaces the full-screen viewOrderModal for customers
    Uses the existing bottom-sheet Stimulus controller with peek/half/full snap points.
    The peek state shows a summary bar; half shows the item list; full adds totals + checkout.
%>
<% order = local_assigns[:order] %>
<% restaurant = local_assigns[:restaurant] %>
<% restaurantCurrency = local_assigns[:restaurantCurrency] %>
<% ordrparticipant = local_assigns[:ordrparticipant] %>
<% menuparticipant = local_assigns[:menuparticipant] %>
<% tablesetting = local_assigns[:tablesetting] %>
<% cur = restaurantCurrency&.symbol.presence || '' %>
<% has_table = tablesetting.present? %>

<%# Backdrop %>
<div class="bottom-sheet-backdrop"
     data-bottom-sheet-target="backdrop"
     data-action="click->bottom-sheet#close"></div>

<%# Bottom Sheet %>
<div class="bottom-sheet cart-bottom-sheet"
     data-controller="bottom-sheet"
     data-bottom-sheet-peek-value="72"
     data-bottom-sheet-initial-value="<%= order ? 'peek' : (has_table ? 'peek' : 'closed') %>"
     data-tip-presets="<%= restaurant&.tips&.sort_by(&:percentage)&.map(&:percentage)&.to_json || '[]' %>"
     data-currency-symbol="<%= cur %>"
     data-currency-code="<%= restaurantCurrency&.code || '' %>"
     data-testid="cart-bottom-sheet"
     id="cartBottomSheet">

  <%# Drag Handle + Summary Bar (always visible in peek) %>
  <div class="bottom-sheet__handle cart-sheet__peek-bar"
       data-bottom-sheet-target="handle"
       data-action="click->bottom-sheet#toggle">
    <div class="bottom-sheet__handle-bar"></div>
    <div class="cart-sheet__summary">
      <% if order %>
        <div class="cart-sheet__summary-left">
          <i class="bi bi-cart3"></i>
          <span class="cart-sheet__count" id="cartItemCount" data-testid="cart-item-count">
            <%= order.addedCount.to_i %>
          </span>
          <span class="cart-sheet__label"><%= t('smartmenus.showModals.yourOrder', default: 'Your order') %></span>
        </div>
        <div class="cart-sheet__summary-right">
          <span class="cart-sheet__total" id="cartTotalAmount" data-testid="cart-total-amount">
            <%= number_to_currency(order.runningTotal.to_f, unit: restaurantCurrency&.symbol || '') %>
          </span>
          <i class="bi bi-chevron-up cart-sheet__chevron"></i>
        </div>
      <% end %>
    </div>
  </div>

  <%# Scrollable Content (visible in half/full) %>
  <div class="bottom-sheet__content cart-sheet__content" data-bottom-sheet-target="content" data-testid="cart-sheet-content">
    <div id="cartItemsContainer">
    <% if order %>
      <%# Selected (not yet submitted) items %>
      <% selected_items = order.ordractions.select { |a| a.ordritem&.status == 'opened' && order.ordritems.include?(a.ordritem) } %>
      <% if selected_items.any? %>
        <div class="cart-sheet__section-label"><%= t('smartmenus.showModals.selected', default: 'Selected') %></div>
        <% selected_items.each do |ordraction| %>
          <div class="cart-sheet__item" data-testid="cart-item-<%= ordraction.ordritem.id %>">
            <button type="button" class="cart-sheet__remove removeItemFromOrderButton"
                    data-bs-ordritem_id="<%= ordraction.ordritem.id %>"
                    aria-label="<%= t('smartmenus.showModals.remove_item', default: 'Remove') %>"
                    data-testid="remove-cart-item-<%= ordraction.ordritem.id %>">
              <i class="bi bi-x-circle"></i>
            </button>
            <div class="cart-sheet__item-name">
              <% if ordrparticipant&.preferredlocale %>
                <%= ordraction.ordritem.menuitem.localised_name(ordrparticipant.preferredlocale) %>
              <% elsif menuparticipant&.preferredlocale %>
                <%= ordraction.ordritem.menuitem.localised_name(menuparticipant.preferredlocale) %>
              <% else %>
                <%= ordraction.ordritem.menuitem.name %>
              <% end %>
              <% if ordraction.ordritem.size_name.present? %>
                <span class="text-muted" style="font-size: 0.8em;">(<%= ordraction.ordritem.size_name.sub(/\s*\(.*\)/, '') %>)</span>
              <% end %>
            </div>
            <div class="cart-sheet__item-price">
              <%= number_to_currency(ordraction.ordritem.ordritemprice, unit: restaurantCurrency&.symbol || '') %>
            </div>
          </div>
        <% end %>
      <% end %>

      <%# Submitted items %>
      <% submitted_items = order.ordractions.select { |a| a.ordritem && %w[ordered preparing ready delivered].include?(a.ordritem.status) && order.ordritems.include?(a.ordritem) } %>
      <% if submitted_items.any? %>
        <div class="cart-sheet__section-label cart-sheet__section-label--muted"><%= t('smartmenus.showModals.submitted', default: 'Submitted') %></div>
        <% submitted_items.each do |ordraction| %>
          <div class="cart-sheet__item cart-sheet__item--submitted">
            <div class="cart-sheet__status-icon">
              <i class="bi bi-check-circle-fill text-success"></i>
            </div>
            <div class="cart-sheet__item-name">
              <% if ordrparticipant&.preferredlocale %>
                <%= ordraction.ordritem.menuitem.localised_name(ordrparticipant.preferredlocale) %>
              <% elsif menuparticipant&.preferredlocale %>
                <%= ordraction.ordritem.menuitem.localised_name(menuparticipant.preferredlocale) %>
              <% else %>
                <%= ordraction.ordritem.menuitem.name %>
              <% end %>
              <% if ordraction.ordritem.size_name.present? %>
                <span class="text-muted" style="font-size: 0.8em;">(<%= ordraction.ordritem.size_name.sub(/\s*\(.*\)/, '') %>)</span>
              <% end %>
            </div>
            <div class="cart-sheet__item-price text-muted">
              <%= number_to_currency(ordraction.ordritem.menuitem.price, unit: restaurantCurrency&.symbol || '') %>
            </div>
          </div>
        <% end %>
      <% end %>

      <%# Action buttons %>
      <div class="cart-sheet__actions" data-testid="cart-actions">
        <% if order.addedCount.to_i > 0 %>
          <button type="button" class="btn-touch-primary w-100 submitOrderButton" id="cartSubmitOrder" data-testid="cart-submit-order-btn">
            <i class="bi bi-send"></i>
            <%= t('smartmenus.showModals.submit', default: 'Submit order') %>
          </button>
        <% end %>
        <button type="button" class="btn-touch-primary w-100 mt-2" id="cartRequestBill"
                data-bs-toggle="modal" data-bs-target="#requestBillModal"
                style="display:none;">
          <i class="bi bi-receipt"></i>
          <%= t('smartmenus.showModals.request_bill', default: 'Request Bill') %>
        </button>
        <button type="button" class="btn-touch-dark w-100 mt-2" id="cartPayOrder"
                style="display:none;">
          <i class="bi bi-currency-euro"></i>
          <%= t('smartmenus.showModals.pay', default: 'Pay') %>
        </button>
      </div>

      <%# Inline Pay Section (shown when Pay button is clicked) %>
      <div id="cartPaySection" style="display:none;" class="cart-sheet__pay-section mt-3">
        <hr>
        <h6 class="fw-bold mb-3"><%= t('smartmenus.showModals.payBill', default: 'Pay Bill') %></h6>
        <% if order %>
          <div class="bill-line bill-line-header"><span><b><%= t('smartmenus.showModals.item', default: 'Item') %></b></span><span class="bill-amount"><b><%= t('smartmenus.showModals.price', default: 'Price') %></b></span></div>
          <% if order.covercharge.to_f > 0 %>
            <div class="bill-line"><span><%= t('smartmenus.showModals.cover_charge', default: 'Cover charge') %></span><span class="bill-amount" id="orderCoverCharge"><%= number_to_currency(order.covercharge, unit: cur) %></span></div>
          <% end %>
          <div class="bill-line"><span><%= t('smartmenus.showModals.nett', default: 'Nett') %></span><span class="bill-amount" id="orderNett"><%= number_to_currency(order.nett, unit: cur) %></span></div>
          <% if order.service.to_f > 0 %>
            <div class="bill-line"><span><%= t('smartmenus.showModals.service', default: 'Service') %></span><span class="bill-amount" id="orderService"><%= number_to_currency(order.service, unit: cur) %></span></div>
          <% end %>
          <% if order.tax.to_f > 0 %>
            <div class="bill-line"><span><%= t('smartmenus.showModals.tax', default: 'Tax') %></span><span class="bill-amount" id="orderTax"><%= number_to_currency(order.tax, unit: cur) %></span></div>
          <% end %>
          <hr>
          <div class="bill-line bill-line-total"><span><b><%= t('smartmenus.showModals.total', default: 'Total') %></b> <i>(<%= t('smartmenus.showModals.excluding_tip', default: 'excluding tip') %>)</i></span><span class="bill-amount"><b><%= cur %><span id="orderGross"><%= number_to_currency(order.gross, unit: '') %></span></b></span></div>

          <div class="bill-tip-row">
            <div class="d-flex flex-wrap align-items-center justify-content-end gap-2 mt-3 mb-3">
              <% restaurant&.tips&.sort_by(&:percentage)&.each do |tip| %>
                <button type="button" class="btn-touch-secondary btn-touch-sm tip-preset-btn"><span class="tipPreset"><%= tip.percentage %>%</span></button>
              <% end %>
              <input id="tipNumberField" type="number" min="0.00" max="<%= number_to_currency(order.gross, unit: cur) %>" class="form-control form-control-sm text-end" style="width: 80px;" value="0.00">
            </div>
          </div>
          <hr>
          <div class="bill-line bill-line-total"><span><b><%= t('smartmenus.showModals.total', default: 'Total') %></b> <i>(<%= t('smartmenus.showModals.including_tip', default: 'including tip') %>)</i></span><span class="bill-amount"><b><span id="orderGrandTotal"><%= number_to_currency(order.gross, unit: cur) %></span></b></span></div>

          <div class="d-flex flex-column align-items-center gap-3 mt-4">
            <div id="wallet-button-container"
                 data-controller="stripe-wallet"
                 data-stripe-wallet-open-order-id-value="<%= order&.id %>"
                 data-stripe-wallet-amount-cents-value="<%= order&.grossInCents %>"
                 data-stripe-wallet-currency-value="<%= restaurantCurrency&.code %>"></div>
            <input type="hidden" id="openOrderId" value="<%= order.id %>">
            <input type="hidden" id="paymentAmount" value="<%= order.grossInCents %>">
            <input type="hidden" id="paymentCurrency" value="<%= restaurantCurrency&.code %>">
            <input type="hidden" id="paymentRestaurantName" value="<%= t('smartmenus.showModals.bill_prefix', default: 'Bill:') %> <%= order.restaurant.name %>">
            <input type="hidden" id="paymentRestaurantId" value="<%= order.restaurant.id %>">
          </div>

          <div class="d-flex gap-2 mt-3">
            <button id="cartPayCancel" type="button" class="btn-touch-secondary w-50">
              <%= t('common.cancel', default: 'Cancel') %>
            </button>
            <button id="pay-order-confirm" type="button" class="btn-touch-dark w-50" <%= 'disabled' unless order.gross.to_f > 0 %>>
              <i class="bi bi-credit-card"></i>
              <%= t('smartmenus.showModals.confirmPayment', default: 'Pay') %>
            </button>
          </div>
        <% end %>
      </div>
    <% elsif has_table %>
      <%# Start Order — party size selector (replaces the modal for customers) %>
      <div id="cartStartOrderSection" class="cart-sheet__start-order">
        <div class="d-flex flex-column gap-3 py-3">
          <div class="text-center">
            <div class="fs-4 fw-bold"><%= t('smartmenus.showModals.partySize', default: 'Party Size') %></div>
          </div>

          <div class="d-flex align-items-center justify-content-center gap-3">
            <button type="button" class="btn-touch-secondary btn-touch-icon" id="orderCapacityDecrement" disabled>
              <i class="bi bi-dash"></i>
            </button>
            <div class="text-center" style="min-width: 100px;">
              <div id="orderCapacityValue" class="display-4 mb-0">1</div>
            </div>
            <button type="button" class="btn-touch-secondary btn-touch-icon" id="orderCapacityIncrement">
              <i class="bi bi-plus"></i>
            </button>
          </div>

          <input type="hidden" id="orderCapacity" value="1" data-min="1" data-max="<%= tablesetting.capacity %>">

          <div class="d-flex flex-wrap justify-content-center gap-2">
            <button type="button" class="btn-touch-secondary btn-touch-sm orderCapacityPreset" data-capacity="1">1</button>
            <% if tablesetting.capacity.to_i >= 2 %>
              <button type="button" class="btn-touch-secondary btn-touch-sm orderCapacityPreset" data-capacity="2">2</button>
            <% end %>
            <% if tablesetting.capacity.to_i >= 4 %>
              <button type="button" class="btn-touch-secondary btn-touch-sm orderCapacityPreset" data-capacity="4">4</button>
            <% end %>
            <% if tablesetting.capacity.to_i >= 6 %>
              <button type="button" class="btn-touch-secondary btn-touch-sm orderCapacityPreset" data-capacity="6">6</button>
            <% end %>
            <button type="button" class="btn-touch-secondary btn-touch-sm orderCapacityPreset" data-capacity="<%= tablesetting.capacity %>">
              <%= t('smartmenus.showModals.full_capacity', default: 'Full') %> (<%= tablesetting.capacity %>)
            </button>
          </div>

          <div class="mt-3">
            <button id="start-order" type="button" class="btn-touch-primary w-100">
              <i class="bi bi-play-circle"></i>
              <%= t('smartmenus.showModals.start', default: 'Start') %>
            </button>
          </div>
        </div>
      </div>
    <% else %>
      <div class="text-center text-muted py-4">
        <i class="bi bi-cart3 fs-1 mb-2 d-block"></i>
        <p><%= t('smartmenus.showModals.empty_cart', default: 'Your cart is empty') %></p>
        <p class="small"><%= t('smartmenus.showModals.add_items_hint', default: 'Tap + on any item to add it') %></p>
      </div>
    <% end %>
    </div>
  </div>
</div>
