<%# Combined Allergen Modal — selectable allergen list that filters menu items %>
<% allergyns = local_assigns[:allergyns] || [] %>
<%
  # Build a unified list: standard allergens first, then restaurant-specific extras
  standard = Allergyn::STANDARD_ALLERGENS # { "G" => "Gluten …", … }
  custom   = allergyns.reject { |a| standard.keys.include?(a.symbol) }
%>

<div class="modal fade" id="allergenModal" tabindex="-1" aria-labelledby="allergenModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-height: 60vh;">
    <div class="modal-content" style="max-height: 60vh; display: flex; flex-direction: column;">

      <div class="modal-header" style="flex-shrink: 0;">
        <h5 class="modal-title" id="allergenModalLabel">
          <i class="bi bi-shield-exclamation me-2"></i>
          <%= t('smartmenus.allergen_combined_modal.title', default: 'Allergens') %>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('common.close', default: 'Close') %>"></button>
      </div>

      <div class="modal-body" style="flex: 1 1 auto; overflow-y: auto; padding: 0;">
        <p class="text-muted small px-3 pt-3 mb-2">
          <%= t('smartmenus.allergen_combined_modal.filter_description',
                default: 'Tap an allergen to hide menu items that contain it.') %>
        </p>

        <div class="list-group list-group-flush" id="allergenSelectList">
          <%# ── Standard EU 14 allergens ── %>
          <% standard.each do |code, name| %>
            <label class="list-group-item list-group-item-action d-flex align-items-center gap-3 allergen-row"
                   data-allergen-code="<%= code %>" style="cursor: pointer;">
              <span class="badge bg-warning text-dark" style="min-width: 32px; font-weight: 700; font-size: 0.85rem;">
                <%= code %>
              </span>
              <span class="flex-grow-1"><%= name %></span>
              <i class="bi bi-check-circle-fill text-primary allergen-check-icon" style="font-size: 1.25rem; display: none;"></i>
            </label>
          <% end %>

          <%# ── Restaurant-specific (custom) allergens ── %>
          <% if custom.any? %>
            <div class="list-group-item bg-light py-1 px-3">
              <small class="text-muted fw-semibold"><%= t('smartmenus.allergen_legend_modal.custom_allergens', default: 'Additional Allergens') %></small>
            </div>
            <% custom.each do |allergyn| %>
              <label class="list-group-item list-group-item-action d-flex align-items-center gap-3 allergen-row"
                     data-allergen-code="<%= allergyn.symbol %>" style="cursor: pointer;">
                <span class="badge bg-warning text-dark" style="min-width: 32px; font-weight: 700; font-size: 0.85rem;">
                  <%= allergyn.symbol %>
                </span>
                <span class="flex-grow-1"><%= allergyn.name %></span>
                <i class="bi bi-check-circle-fill text-primary allergen-check-icon" style="font-size: 1.25rem; display: none;"></i>
              </label>
            <% end %>
          <% end %>
        </div>
      </div>

      <div class="modal-footer" style="flex-shrink: 0;">
        <span class="me-auto text-muted small" id="allergenFilterCount"></span>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="allergenClearAll" style="display: none;">
          <%= t('smartmenus.allergen_combined_modal.clear_all', default: 'Clear all') %>
        </button>
        <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">
          <%= t('smartmenus.allergen_combined_modal.done', default: 'Done') %>
        </button>
      </div>

    </div>
  </div>
</div>

<script>
(function () {
  document.addEventListener('DOMContentLoaded', function () {
    var modal = document.getElementById('allergenModal');
    if (!modal) return;

    var STORAGE_KEY = 'sm_allergen_filters';
    var rows = modal.querySelectorAll('.allergen-row');
    var countEl = document.getElementById('allergenFilterCount');
    var clearBtn = document.getElementById('allergenClearAll');
    var selected = new Set();

    // ── Restore from localStorage ──
    try {
      var saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
      if (Array.isArray(saved)) saved.forEach(function (c) { selected.add(c); });
    } catch (_) {}

    function save() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(selected))); } catch (_) {}
    }

    // ── Update visual state of rows ──
    function renderRows() {
      rows.forEach(function (row) {
        var code = row.getAttribute('data-allergen-code');
        var icon = row.querySelector('.allergen-check-icon');
        var isOn = selected.has(code);
        if (icon) icon.style.display = isOn ? '' : 'none';
        row.classList.toggle('active', isOn);
      });
      // Footer count + clear button
      var n = selected.size;
      if (countEl) countEl.textContent = n > 0 ? (n + ' selected') : '';
      if (clearBtn) clearBtn.style.display = n > 0 ? '' : 'none';
    }

    // ── Apply filter to menu item cards ──
    function applyFilter() {
      var cards = document.querySelectorAll('.menu-item-card-mobile');
      cards.forEach(function (card) {
        if (selected.size === 0) {
          card.style.display = '';
          return;
        }
        // Read allergen codes from badges inside this card
        var badges = card.querySelectorAll('.allergen-badges .badge.bg-warning');
        var cardAllergens = [];
        badges.forEach(function (b) { cardAllergens.push(b.textContent.trim()); });
        // Hide if any of the card's allergens are in the selected set
        var shouldHide = cardAllergens.some(function (c) { return selected.has(c); });
        card.style.display = shouldHide ? 'none' : '';
      });
      // Update the trigger button badge
      var triggerBadge = document.querySelector('[data-bs-target="#allergenModal"] .filter-badge');
      if (triggerBadge) {
        triggerBadge.textContent = selected.size;
        triggerBadge.style.display = selected.size > 0 ? '' : 'none';
      }
    }

    // ── Row click toggles selection ──
    rows.forEach(function (row) {
      row.addEventListener('click', function (e) {
        e.preventDefault();
        var code = row.getAttribute('data-allergen-code');
        if (selected.has(code)) { selected.delete(code); } else { selected.add(code); }
        save();
        renderRows();
        applyFilter();
      });
    });

    // ── Clear all ──
    if (clearBtn) {
      clearBtn.addEventListener('click', function () {
        selected.clear();
        save();
        renderRows();
        applyFilter();
      });
    }

    // ── Initial render ──
    renderRows();
    applyFilter();
  });
})();
</script>
