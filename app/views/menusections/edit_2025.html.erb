<%#
  2025 Menu Section Edit Page
  Modern design aligned with menu edit page
%>

<% content_for :title, @menusection.name %>

<!-- Page Header -->
<div class="container-fluid px-0 py-4 bg-white border-bottom sticky-header">
  <div class="container-2025">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <!-- Breadcrumb -->
        <div class="text-sm text-gray-500 mb-2">
          <%= link_to @menusection.menu.restaurant.name,
              edit_restaurant_path(@menusection.menu.restaurant),
              class: 'text-primary' %>
          <i class="bi bi-chevron-right"></i>
          <%= link_to @menusection.menu.name,
              edit_restaurant_menu_path(@menusection.menu.restaurant, @menusection.menu, section: 'sections'),
              class: 'text-primary' %>
          <i class="bi bi-chevron-right"></i>
          <%= t('.menu_section', default: 'Menu Section') %>
        </div>

        <h1 class="text-2xl font-semibold text-gray-900 mb-1">
          <%= @menusection.name %>
        </h1>

        <div class="d-flex align-items-center gap-3 mt-2">
          <!-- Items Badge -->
          <span class="badge bg-secondary">
            <i class="bi bi-list-ul"></i> <%= @menusection.menuitems.count %> <%= t('.items', default: 'items') %>
          </span>
        </div>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <!-- Back Button -->
        <%= link_to edit_restaurant_menu_path(@menusection.menu.restaurant, @menusection.menu, section: 'sections'),
            class: 'btn-2025 btn-2025-secondary btn-2025-md' do %>
          <i class="bi bi-arrow-left"></i> <%= t('.back_to_sections', default: 'Back to Sections') %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container-2025 py-4">
  <%= render 'form', menusection: @menusection %>
</div>

<!-- Preload noUiSlider CSS -->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css" /></noscript>

<!-- Load noUiSlider -->
<script data-turbo-track="reload">
  if (typeof noUiSlider === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js';
    script.onload = function() {
      window.noUiSliderLoaded = true;
    };
    document.head.appendChild(script);
  } else {
    window.noUiSliderLoaded = true;
  }
</script>

<% content_for :head do %>
  <style>
    /* Page-specific styles */
    body {
      background: var(--color-gray-50);
    }

    .container-2025 {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--space-4);
    }

    .text-2xl {
      font-size: 1.5rem;
      line-height: 2rem;
    }

    .text-gray-900 {
      color: var(--color-gray-900);
    }

    .text-gray-500 {
      color: var(--color-gray-500);
    }

    .text-sm {
      font-size: var(--text-sm);
    }

    /* Time Slider Styles */
    .time-slider-container {
      position: relative;
      padding: 0.5rem 0.25rem;
    }

    .time-display {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--color-gray-900);
    }

    .time-display i {
      font-size: 1.125rem;
    }

    .time-value {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      color: var(--color-gray-700);
    }

    .time-range-slider {
      margin: 0.75rem 0;
      height: 12px;
    }

    /* noUiSlider customization */
    .noUi-target {
      background: var(--color-gray-200);
      border: none;
      box-shadow: none;
      border-radius: 8px;
      height: 12px;
    }

    .noUi-connect {
      background: var(--color-gray-600);
      box-shadow: none;
    }

    .noUi-handle {
      background: #fff;
      border: 3px solid var(--color-gray-400);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      width: 20px !important;
      height: 20px !important;
      right: -10px !important;
      top: -4px !important;
      cursor: grab;
    }

    .noUi-handle:active {
      cursor: grabbing;
      border-color: var(--color-gray-700);
    }

    .noUi-handle:hover {
      border-color: var(--color-gray-500);
    }

    .noUi-handle:before,
    .noUi-handle:after {
      display: none;
    }
  </style>
<% end %>

<script>
  // Keep state on window to avoid redeclaration across Turbo navigations
  window.__sectionSliderState = window.__sectionSliderState || { retries: 0, max: 50, bound: false };

  function initializeSectionTimeSlider() {
    const state = window.__sectionSliderState;
    if (typeof noUiSlider === 'undefined') {
      if (state.retries < state.max) {
        state.retries++;
        setTimeout(initializeSectionTimeSlider, 100);
        return;
      } else {
        console.error('Failed to load noUiSlider');
        return;
      }
    }

    const sliderElement = document.getElementById('section_time_slider');
    if (!sliderElement) return;

    // Destroy existing slider if present
    if (sliderElement.noUiSlider) {
      sliderElement.noUiSlider.destroy();
    }

    const openMinutes = parseInt(sliderElement.dataset.open) || 540; // 9:00
    const closeMinutes = parseInt(sliderElement.dataset.close) || 1320; // 22:00

    // Create the slider
    const slider = noUiSlider.create(sliderElement, {
      start: [openMinutes, closeMinutes],
      connect: true,
      range: {
        'min': 0,    // 00:00
        'max': 1439  // 23:59
      },
      step: 15
    });

    // Update time displays and hidden fields
    slider.on('update', function(values, handle) {
      const minutes = Math.round(values[handle]);
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      const timeString = sprintf('%02d:%02d', hours, mins);

      const container = sliderElement.closest('.time-slider-container');

      if (handle === 0) {
        container.querySelector('.opening-time .time-value').textContent = timeString;
        document.querySelector('.from-hour-field').value = hours;
        document.querySelector('.from-min-field').value = mins;
      } else {
        container.querySelector('.closing-time .time-value').textContent = timeString;
        document.querySelector('.to-hour-field').value = hours;
        document.querySelector('.to-min-field').value = mins;
      }
    });
  }

  // Helper function for formatting
  function sprintf(format, ...args) {
    let i = 0;
    return format.replace(/%(\d*)d/g, (match, width) => {
      const num = args[i++].toString();
      return width ? num.padStart(parseInt(width), '0') : num;
    });
  }

  // Bind listeners once across Turbo visits
  (function bindOnce(){
    if (window.__sectionSliderState.bound) return;
    window.__sectionSliderState.bound = true;

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeSectionTimeSlider);
    } else {
      initializeSectionTimeSlider();
    }

    document.addEventListener('turbo:load', initializeSectionTimeSlider);
    document.addEventListener('turbo:render', initializeSectionTimeSlider);
  })();
</script>
