<%
  # Determine the menu and menusection for nested routing
  menu = if menuitem.menusection&.menu
           menuitem.menusection.menu
         elsif @futureParentMenuSection&.menu
           @futureParentMenuSection.menu
         elsif @menu
           @menu
         else
           # This shouldn't happen in normal flow - all menuitem routes should have menu context
           raise "No menu context available for menuitem form"
         end

  # Determine the menusection for nested routing
  menusection = if menuitem.menusection
                  menuitem.menusection
                elsif @futureParentMenuSection
                  @futureParentMenuSection
                elsif @menusection
                  @menusection
                else
                  # This shouldn't happen in normal flow - all menuitem routes should have menusection context
                  raise "No menusection context available for menuitem form. Please create menuitems from within a menu section."
                end
%>
<%= form_with(model: [menu.restaurant, menu, menusection, menuitem], html: { data: { turbo_frame: '_top' } }) do |form| %>

  <div style="display:none">
      <% if @futureParentMenuSection %>
          <%= form.hidden_field :menusection_id, value: @futureParentMenuSection.id %>
      <% else %>
          <%= form.hidden_field :menusection_id %>
      <% end %>
  </div>
  <div class="form-with-sticky-actions-2025 form-stack-2025" data-menuitem-form-root>
    <% if menuitem.errors.any? %>
      <div class="alert alert-danger mb-3">
        <div class="fw-semibold mb-2"><%= t('common.errors') %></div>
        <ul class="mb-0">
            <% menuitem.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
        </ul>
      </div>
    <% end %>

    <div class="mb-3 p-3">
      <h2 class="h5 mb-3"><%= t(".details") %></h2>
      <div class="form-group row mb-3">
          <div class="col-12">
            <%= form.label :name, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <%= form.text_field :name, class: 'form-control' %>
          </div>
        </div>
        <div class="form-group row mb-0">
          <div class="col-12">
            <%= form.label :description, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <%= form.text_area :description, class: 'form-control', rows: 2 %>
          </div>
        </div>
    </div>
    <% if menuitem.itemtype != 'wine' %>
      <div class="mb-3 p-3">
        <h2 class="h5 mb-3"><%= t(".imageSettings") %></h2>
        <div class="row g-3">
            <div class="col-12">
              <% if menuitem.image %>
                <%
                  image_src = (menuitem.webp_url(:medium) || menuitem.medium_url || menuitem.image_url)
                  if image_src.present?
                    begin
                      uri = URI.parse(image_src)
                      has_s3_sig = (uri.query.to_s.include?('X-Amz-') || uri.query.to_s.include?('X-Amz-Signature'))
                      image_src = has_s3_sig ? image_src : "#{image_src}#{image_src.include?('?') ? '&' : '?'}v=#{menuitem.updated_at.to_i}"
                    rescue
                      image_src = "#{image_src}#{image_src.include?('?') ? '&' : '?'}v=#{menuitem.updated_at.to_i}"
                    end
                  end
                %>
                <%= image_tag image_src, class: 'img-thumbnail menuitem-image-preview-2025', alt: menuitem.name %>
              <% else %>
                <div class="text-muted">
                  <%= t('.no_image') %>
                </div>
              <% end %>
            </div>

            <div class="col-12">
              <div class="form-group row">
                <div class="col-12">
                  <%= form.label :image, class: 'col-form-label' %>
                </div>
                <div class="col-12">
                  <%= form.hidden_field :image, value: form.object.cached_image_data, id: nil %>
                  <%= form.file_field :image, multiple: false, accept:'image/*;capture=camera', class: 'form-control' %>
                </div>
              </div>

              <div class="mb-2"></div>

              <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                <div class="form-check">
                  <%= form.check_box :remove_image, class: 'form-check-input' %>
                  <%= form.label :remove_image, class: 'form-check-label' do %>
                    <i class="bi bi-trash"></i>
                    <%= t('common.remove') %>
                  <% end %>
                </div>

                <% if menuitem.genimage %>
                  <%
                    initial_image_url = (menuitem.webp_url(:medium) || menuitem.medium_url || menuitem.image_url)
                  %>
                  <%= link_to generate_ai_image_restaurant_menu_menusection_menuitem_path(
                        menuitem.menusection.menu.restaurant,
                        menuitem.menusection.menu,
                        menuitem.menusection,
                        menuitem,
                      ),
                      class: 'btn-2025 btn-2025-secondary btn-2025-md',
                      data: {
                        turbo: false,
                        menuitem_ai_generate: true,
                        generate_url: generate_ai_image_restaurant_menu_menusection_menuitem_path(
                          menuitem.menusection.menu.restaurant,
                          menuitem.menusection.menu,
                          menuitem.menusection,
                          menuitem,
                        ),
                        status_url: image_status_restaurant_menu_menusection_menuitem_path(
                          menuitem.menusection.menu.restaurant,
                          menuitem.menusection.menu,
                          menuitem.menusection,
                          menuitem,
                        ),
                        initial_updated_at: menuitem.updated_at.to_i,
                        initial_image_url: initial_image_url,
                      } do %>
                    <i class="bi bi-stars"></i>
                    <%= t('.generateImage') %>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
      </div>
    <% end %>

    <div class="mb-3 p-3">
      <h2 class="h5 mb-3"><%= t(".settings") %></h2>
      <div class="form-group row mb-3">
          <div class="col-12">
            <%= form.label :status, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <%= form.select :status, options_for_select(Menuitem.statuses.keys.to_a, form.object.status), {}, class: 'form-control' %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <div class="col-12">
            <%= form.label :itemtype, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <%= form.select :itemtype, options_for_select(Menuitem.itemtypes.keys.to_a, form.object.itemtype), {}, class: 'form-control' %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <div class="col-12">
            <%= form.label :calories, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <%= form.text_field :calories, class: 'form-control' %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <div class="col-12">
            <%= form.label :unitcost, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <%= form.text_field :unitcost, class: 'form-control' %>
          </div>
        </div>
        <div class="form-group row mb-0">
          <div class="col-12">
            <%= form.label :price, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <%= form.text_field :price, class: 'form-control' %>
            <% if menusection.tasting_menu? %>
              <small class="text-muted"><%= t('.tasting_price_ignored') %></small>
            <% end %>
          </div>
        </div>
    </div>

    <div class="mb-3 p-3">
      <h2 class="h5 mb-3"><%= t('.alcohol_settings') %></h2>
      <div class="form-group row mb-3">
          <div class="col-12">
            <%= form.label :preptime, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <%= form.text_field :preptime, class: 'form-control' %>
          </div>
        </div>
        <div class="form-group row align-items-center mb-3">
          <div class="col-12">
            <%= form.label :alcoholic, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <div class="form-check form-switch">
              <%= form.check_box :alcoholic, class: 'form-check-input', role: 'switch' %>
              <small class="text-muted d-block"><%= t('.alcoholic_help') %></small>
            </div>
          </div>
        </div>
        <div class="form-group row mb-3">
          <div class="col-12">
            <%= form.label :abv, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <div class="input-group">
              <%= form.number_field :abv, class: 'form-control', step: 0.1, min: 0, max: 100, placeholder: t('.abv_placeholder') %>
              <span class="input-group-text">%</span>
            </div>
            <small class="text-muted"><%= t('.abv_help') %></small>
          </div>
        </div>
        <div class="form-group row mb-3">
          <div class="col-12">
            <%= form.label :alcohol_classification, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <%= form.select :alcohol_classification,
                  options_for_select([
                    [t('.classification_wine'), 'wine'],
                    [t('.classification_beer'), 'beer'],
                    [t('.classification_spirit'), 'spirit'],
                    [t('.classification_cocktail'), 'cocktail'],
                    [t('.classification_liqueur'), 'liqueur'],
                    [t('.classification_other'), 'other'],
                    [t('.classification_non_alcoholic'), 'non_alcoholic']
                  ], form.object.alcohol_classification),
                  { include_blank: true },
                  { class: 'form-control' } %>
            <small class="text-muted"><%= t('.classification_help') %></small>
          </div>
        </div>
        <div class="form-group row mb-0">
          <div class="col-12">
            <%= form.label :alcohol_notes, class: 'col-form-label' %>
          </div>
          <div class="col-12">
            <%= form.text_area :alcohol_notes, class: 'form-control', placeholder: t('.alcohol_notes_ph'), rows: 2 %>
          </div>
        </div>
    </div>
  <% if menusection.tasting_menu? %>
    <div class="mb-3 p-3">
      <h2 class="h5 mb-3"><%= t('.tasting_item_settings') %></h2>

      <div class="form-group row mb-3">
        <div class="col-12">
          <span><%= t('.tasting_optional') %></span>
        </div>
        <div class="col-12">
          <div class="form-check form-switch">
            <%= form.check_box :tasting_optional, class: 'form-check-input', role: 'switch' %>
            <small class="text-muted"><%= t('.tasting_optional_help') %></small>
          </div>
        </div>
      </div>

      <div class="form-group row mb-3">
        <div class="col-12">
          <span><%= t('.tasting_supplement') %></span>
        </div>
        <div class="col-12">
          <div class="row g-2">
            <div class="col-6">
              <%= form.number_field :tasting_supplement_cents, class: 'form-control', min: 0, step: 1 %>
            </div>
            <div class="col-6">
              <%= form.hidden_field :tasting_supplement_currency, value: menu.restaurant.currency %>
              <input class="form-control" value="<%= menu.restaurant.currency %>" disabled>
            </div>
          </div>
          <small class="text-muted"><%= t('.tasting_supplement_help') %></small>
        </div>
      </div>

      <div class="form-group row mb-3">
        <div class="col-12">
          <span><%= t('.course_order') %></span>
        </div>
        <div class="col-12">
          <%= form.number_field :course_order, class: 'form-control', min: 1, step: 1 %>
          <small class="text-muted"><%= t('.course_order_help') %></small>
        </div>
      </div>

      <div class="form-group row mb-0">
        <div class="col-12">
          <span><%= t('.visibility') %></span>
        </div>
        <div class="col-12">
          <div class="form-check">
            <%= form.check_box :hidden, class: 'form-check-input', id: 'menuitem_hidden' %>
            <label class="form-check-label" for="menuitem_hidden"><%= t('.hidden') %></label>
          </div>
          <div class="form-check mt-2">
            <%= form.check_box :tasting_carrier, class: 'form-check-input', id: 'menuitem_tasting_carrier' %>
            <label class="form-check-label" for="menuitem_tasting_carrier"><%= t('.tasting_carrier') %></label>
            <div><small class="text-muted"><%= t('.tasting_carrier_help') %></small></div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  <% if Allergyn.where( restaurant: menu.restaurant ).count > 0 %>
    <div class="mb-3 p-3">
      <h2 class="h5 mb-3"><%= form.label :allergyns, class: 'col-form-label' %></h2>

      <div class="form-group row mb-0">
        <div class="col-12">
          <div class="form-control">
            <span class="position-relative-right-25">
              <%= form.collection_check_boxes :allergyn_ids, Allergyn.where( restaurant_id: menu.restaurant.id ), :id, :name, { hide_label: true } do |b| %>
                <div class="form-check">
                  <%= b.check_box %>
                  <label class="form-check-label">
                    <%= b.label %>
                  </label>
                </div>
              <% end %>
            </span>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  <div class="form-group row mb-3">
    <div class="col-12">
      <%= form.label :sizesupport, class: 'col-form-label' %>
    </div>
    <div class="col-12">
      <%= form.select :sizesupport, [[t('.true'), true], [t('.false'), false]], {}, class: 'form-control' %>
    </div>
  </div>
  <% if menuitem.sizesupport && Size.where( restaurant_id: menu.restaurant.id ).count > 0 %>
    <div class="mb-3 p-3">
      <h2 class="h5 mb-3"><%= form.label :sizes, class: 'col-form-label' %></h2>

      <div class="form-group row mb-0">
        <div class="col-12">
          <div class="form-control">
            <span class="position-relative-right-25">
              <%= form.collection_check_boxes :size_ids, Size.where( restaurant_id: menu.restaurant.id ), :id, :name, { hide_label: true } do |size| %>
                <div class="form-check">
                  <%= size.check_box %>
                  <label class="form-check-label">
                    <%= size.label %>
                  </label>
                </div>
              <% end %>
            </span>
          </div>
        </div>
      </div>
    </div>
  <% end %>
    <div class="form-actions-2025 form-actions-2025-end d-none d-md-flex">
      <% if menuitem.persisted? %>
        <%= link_to t('common.archive', default: 'Archive'),
            restaurant_menu_menusection_menuitem_path(menuitem.menusection.menu.restaurant, menuitem.menusection.menu, menuitem.menusection, menuitem),
            class: 'btn-2025 btn-2025-outline-danger btn-2025-md',
            data: { turbo_method: :delete, turbo_confirm: t('common.confirm') } %>
      <% end %>
      <%= form.submit value: t('common.save'), class: 'btn-2025 btn-2025-primary btn-2025-md' %>
    </div>

    <%= render 'shared/sticky_edit_actions_2025',
        back_url: edit_restaurant_menu_path(menu.restaurant, menu, section: 'items'),
        delete_url: (menuitem.persisted? ? restaurant_menu_menusection_menuitem_path(menuitem.menusection.menu.restaurant, menuitem.menusection.menu, menuitem.menusection, menuitem) : nil),
        delete_label: t('common.archive', default: 'Archive'),
        delete_confirm: t('common.confirm') %>
  </div>
<% end %>

<% if menuitem.menuitem_size_mappings.count > 0 %>
  <div class="mb-3 p-3">
    <h2 class="h5 mb-3"><%= t(".variantPricing") %></h2>

    <% menuitem.menuitem_size_mappings.each do |menuitemSizeMapping| %>
      <%= form_with(model: [menu.restaurant, menu, menuitemSizeMapping]) do |menuitemSizeMappingForm| %>
        <div class="form-group row mb-2">
          <div class="col-4">
            <span class="float-md-end"><%= menuitemSizeMapping.sizeName %></span>
          </div>
          <div class="col-4">
            <%= menuitemSizeMappingForm.text_field :price, class: 'form-control' %>
          </div>
          <div class="col-4">
            <span class="float-end">
              <%= menuitemSizeMappingForm.submit value: t('common.update'), class: 'btn btn-sm btn-dark' %>
            </span>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
