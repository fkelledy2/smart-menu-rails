<% content_for :title, "Cache Administration" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Cache Administration</h1>
        <div class="btn-group" role="group">
          <%= link_to "Refresh", admin_cache_index_path, class: "btn btn-outline-primary" %>
          <%= link_to "Health Check", admin_cache_health_path, class: "btn btn-outline-info", 
                      data: { remote: true } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Cache Health Status -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Cache Health Status</h5>
          <span class="badge <%= @health_check[:healthy] ? 'bg-success' : 'bg-danger' %>">
            <%= @health_check[:healthy] ? 'Healthy' : 'Unhealthy' %>
          </span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <strong>Response Time:</strong><br>
              <span class="text-muted"><%= @health_check[:response_time_ms] %>ms</span>
            </div>
            <div class="col-md-3">
              <strong>Write Operation:</strong><br>
              <span class="<%= @health_check[:operations][:write] ? 'text-success' : 'text-danger' %>">
                <%= @health_check[:operations][:write] ? 'OK' : 'Failed' %>
              </span>
            </div>
            <div class="col-md-3">
              <strong>Read Operation:</strong><br>
              <span class="<%= @health_check[:operations][:read] ? 'text-success' : 'text-danger' %>">
                <%= @health_check[:operations][:read] ? 'OK' : 'Failed' %>
              </span>
            </div>
            <div class="col-md-3">
              <strong>Delete Operation:</strong><br>
              <span class="<%= @health_check[:operations][:delete] ? 'text-success' : 'text-danger' %>">
                <%= @health_check[:operations][:delete] ? 'OK' : 'Failed' %>
              </span>
            </div>
          </div>
          <% if @health_check[:error] %>
            <div class="alert alert-danger mt-3">
              <strong>Error:</strong> <%= @health_check[:error] %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Cache Statistics -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Performance Statistics</h5>
          <%= link_to "Reset Stats", admin_cache_reset_stats_path, method: :post, 
                      class: "btn btn-sm btn-outline-warning",
                      data: { confirm: "Are you sure you want to reset cache statistics?" } %>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-2">
              <div class="text-center">
                <h4 class="text-success"><%= @cache_stats[:hits] %></h4>
                <small class="text-muted">Cache Hits</small>
              </div>
            </div>
            <div class="col-md-2">
              <div class="text-center">
                <h4 class="text-warning"><%= @cache_stats[:misses] %></h4>
                <small class="text-muted">Cache Misses</small>
              </div>
            </div>
            <div class="col-md-2">
              <div class="text-center">
                <h4 class="text-info"><%= @cache_stats[:writes] %></h4>
                <small class="text-muted">Cache Writes</small>
              </div>
            </div>
            <div class="col-md-2">
              <div class="text-center">
                <h4 class="text-primary"><%= @cache_stats[:deletes] %></h4>
                <small class="text-muted">Cache Deletes</small>
              </div>
            </div>
            <div class="col-md-2">
              <div class="text-center">
                <h4 class="text-danger"><%= @cache_stats[:errors] %></h4>
                <small class="text-muted">Errors</small>
              </div>
            </div>
            <div class="col-md-2">
              <div class="text-center">
                <h4 class="text-success"><%= @cache_stats[:hit_rate] %>%</h4>
                <small class="text-muted">Hit Rate</small>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <small class="text-muted">
              Total Operations: <%= @cache_stats[:total_operations] %> | 
              Last Reset: <%= Time.parse(@cache_stats[:last_reset]).strftime("%Y-%m-%d %H:%M:%S") %>
            </small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Cache Information</h5>
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-6">Service Version:</dt>
            <dd class="col-sm-6"><%= @cache_info[:service_version] %></dd>
            
            <dt class="col-sm-6">Cache Methods:</dt>
            <dd class="col-sm-6"><%= @cache_info[:total_methods] %></dd>
            
            <dt class="col-sm-6">Active Keys:</dt>
            <dd class="col-sm-6">~<%= @cache_info[:active_keys] %></dd>
            
            <dt class="col-sm-6">Memory Usage:</dt>
            <dd class="col-sm-6">~<%= @cache_info[:memory_usage][:estimated_mb] %>MB</dd>
          </dl>
          <small class="text-muted"><%= @cache_info[:memory_usage][:note] %></small>
        </div>
      </div>
    </div>
  </div>

  <!-- Cache Operations -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Cache Warming</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Pre-load critical cache data to improve performance.</p>
          
          <%= form_with url: admin_cache_warm_path, method: :post, local: true, class: "d-flex gap-2" do |f| %>
            <%= f.number_field :restaurant_id, placeholder: "Restaurant ID (optional)", 
                               class: "form-control", style: "max-width: 200px;" %>
            <%= f.submit "Warm Caches", class: "btn btn-success" %>
          <% end %>
          
          <small class="text-muted d-block mt-2">
            Leave Restaurant ID empty to warm caches for all restaurants (limited to 10).
          </small>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Cache Management</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Clear all cached data to force fresh data loading.</p>
          
          <div class="d-grid gap-2">
            <%= link_to "Clear All Caches", admin_cache_clear_path, method: :delete,
                        class: "btn btn-danger",
                        data: { confirm: "Are you sure you want to clear all caches? This will impact performance until caches are rebuilt." } %>
            <%= link_to "View Cache Keys", admin_cache_keys_path, class: "btn btn-outline-info" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Cache Patterns</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-2">
              <strong>restaurant_*</strong><br>
              <small class="text-muted">Restaurant dashboards and analytics</small>
            </div>
            <div class="col-md-2">
              <strong>menu_*</strong><br>
              <small class="text-muted">Menu data and performance</small>
            </div>
            <div class="col-md-2">
              <strong>menuitem_*</strong><br>
              <small class="text-muted">Menu item details and analytics</small>
            </div>
            <div class="col-md-2">
              <strong>order_*</strong><br>
              <small class="text-muted">Order data and summaries</small>
            </div>
            <div class="col-md-2">
              <strong>employee_*</strong><br>
              <small class="text-muted">Staff data and performance</small>
            </div>
            <div class="col-md-2">
              <strong>user_*</strong><br>
              <small class="text-muted">User activity and cross-restaurant data</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
