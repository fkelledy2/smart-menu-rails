<%#
  2025 Menu Edit Page
  Modern sidebar navigation for menu management
  Applies same pattern as Restaurant Edit page
%>

<% content_for :title, @menu.name %>

<% restaurant_context = @restaurant || @menu.restaurant %>
<% read_only = defined?(@read_only_menu_context) && @read_only_menu_context %>

<div data-controller="sidebar ai-progress"
     data-ai-progress-csrf-value="<%= form_authenticity_token %>"
     data-action="submit->ai-progress#intercept">
  <!-- Page Header -->
  <div class="container-fluid px-0 py-4 bg-white border-bottom sticky-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <!-- Breadcrumb -->
        <div class="text-gray-500 mb-2" data-testid="menu-breadcrumb">
          <%= link_to restaurant_context.name,
              edit_restaurant_path(restaurant_context),
              class: 'text-primary' %>
          <i class="bi bi-chevron-right"></i>
          <%= t('.menus', default: 'Menus') %>
        </div>

        <h1 class="text-2xl font-semibold text-gray-900 mb-1" data-testid="menu-title">
          <%= @menu.name %>
        </h1>

        <div class="d-flex align-items-center gap-3 mt-2">
          <!-- Status Badge -->
          <% if @menu.active? %>
            <span class="badge bg-success">
              <i class="bi bi-check-circle"></i> <%= t('.active', default: 'Active') %>
            </span>
          <% else %>
            <span class="badge bg-warning text-dark">
              <i class="bi bi-pencil"></i> <%= t('.inactive', default: 'Inactive') %>
            </span>
          <% end %>

          <% if read_only %>
            <span class="badge bg-secondary">
              <i class="bi bi-lock"></i> <%= t('.read_only', default: 'Read-only') %>
            </span>
          <% end %>

          <!-- Quick Stats -->
          <div class="d-flex align-items-center gap-3">
            <span class="text-sm text-gray-500">
              <%= @menu.menusections.count %> <%= t('.sections', default: 'sections') %>
            </span>
            <span class="text-sm text-gray-500">
              <%= defined?(@menuItemCount) && @menuItemCount.present? ? @menuItemCount : @menu.menuitems.count %> <%= t('.items', default: 'items') %>
            </span>
          </div>
        </div>
      </div>

      <!-- Mobile Sidebar Toggle -->
      <button class="sidebar-toggle-btn"
              data-action="click->sidebar#toggle"
              aria-label="Toggle navigation"
              data-testid="menu-sidebar-toggle">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>

  <!-- Sidebar + Content Layout -->
  <div class="sidebar-content-container">
    <!-- Sidebar Navigation -->
    <%= render 'menus/sidebar_2025',
        menu: @menu,
        restaurant: restaurant_context,
        current_section: @current_section %>

    <!-- Main Content Area -->
    <div class="sidebar-main-content">
      <%= turbo_frame_tag 'menu_content' do %>
        <%
          partial_name = case @current_section
                        when 'sections' then 'sections_2025'
                        when 'items' then 'items_2025'
                        when 'schedule' then 'schedule_2025'
                        when 'settings' then 'settings_2025'
                        when 'qrcode' then 'qrcode_2025'
                        when 'versions' then 'versions_2025'
                        else 'details_2025'
                        end
        %>
        <%= render "menus/sections/#{partial_name}",
            menu: @menu,
            restaurant: restaurant_context,
            restaurant_menu: @restaurant_menu,
            read_only: read_only %>
      <% end %>
    </div>
  </div>
</div>

<% content_for :head do %>
  <style>
    /* Page-specific styles */
    body {
      background: var(--color-gray-50);
    }

    turbo-frame#menu_content {
      display: block;
      width: 100%;
      max-width: none;
    }

    .text-2xl {
      font-size: 1.5rem;
      line-height: 2rem;
    }

    .text-gray-900 {
      color: var(--color-gray-900);
    }

    .text-gray-500 {
      color: var(--color-gray-500);
    }

    /* Ensure modal overlays navbar dropdowns */
    .modal { z-index: 5000 !important; }
    .modal-backdrop { z-index: 4990 !important; }
    /* Lower dropdowns on this page so they don't pierce the modal */
    .navbar .dropdown-menu { z-index: 1500; }

    /* Bottom-sheet modal styles */
    #aiProgressModal.modal .modal-dialog {
      margin: 0; /* remove default margins */
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      /* Start off-screen for fade animation */
      transform: translateY(100%);
      width: 100%;
      max-width: 100%;
    }
    #aiProgressModal.modal .modal-content {
      border-top-left-radius: 0.75rem;
      border-top-right-radius: 0.75rem;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      box-shadow: 0 -8px 24px rgba(0,0,0,0.2);
    }
    /* Override Bootstrap fade/transform to slide from bottom for this modal only */
    #aiProgressModal.modal.fade .modal-dialog { transform: translateY(100%); }
    #aiProgressModal.modal.show .modal-dialog { transform: translateY(0); }
    /* Make body scrollable if content grows */
    #aiProgressModal.modal .modal-body {
      max-height: 60vh;
      overflow: auto;
    }
  </style>
<% end %>

<!-- AI Image Generation Modal -->
<div class="modal fade z-index-7000" id="aiProgressModal" tabindex="-1" aria-hidden="true"
     data-ai-progress-target="modal"
     data-action="hidden.bs.modal->ai-progress#dismiss">
  <div class="modal-dialog ai-bottom-sheet z-index-7001 position-fixed bottom-0 left-0 right-0 m-0 width-full max-width-100">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" data-ai-progress-target="modalTitle">Generate AI Images</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="ai-confirm-pane" data-ai-progress-target="confirmPane">
          <p data-ai-progress-target="confirmText">This will generate new AI images for your menu items and may consume API credits. Proceed?</p>
          <!-- Localization options (visible only for Translate Menu) -->
          <div id="localize-options" class="mt-3" style="display: none;" data-ai-progress-target="localizeOptions">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="localizeMode" id="localize-missing" value="missing" checked>
              <label class="form-check-label" for="localize-missing">
                Localize Missing Only
              </label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="localizeMode" id="localize-force" value="force">
              <label class="form-check-label" for="localize-force">
                Force Re-translate All
              </label>
            </div>
          </div>
        </div>
        <div id="ai-progress-pane" class="d-none" data-ai-progress-target="progressPane">
          <div class="mb-2">
            <div class="small text-muted">Currently generating:</div>
            <div id="ai-progress-text" class="fw-semibold" data-ai-progress-target="progressText">Startingâ€¦</div>
          </div>
          <div class="progress">
            <div id="ai-progress-bar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" data-ai-progress-target="progressBar"></div>
          </div>
          <div id="ai-progress-log" class="mt-3 d-none" style="max-height: 220px; overflow: auto;" data-ai-progress-target="logWrap">
            <div class="small text-muted mb-2">Progress log</div>
            <div id="ai-progress-log-items" class="small" data-ai-progress-target="logItems"></div>
          </div>
          <div class="mt-3 d-none" id="ai-preview" data-ai-progress-target="preview">
            <div class="mb-2">
              <span class="small text-muted me-1">Last Image:</span>
              <span id="ai-preview-name" class="fw-semibold"></span>
            </div>
            <img id="ai-preview-img" src="" alt="Generated item image" class="img-fluid w-100 rounded border" data-ai-progress-target="previewImg" />
            <div class="row mt-3 g-2">
              <div class="col-6 d-flex justify-content-center">
                <button type="button" class="btn btn-light border d-flex justify-content-center align-items-center py-2 w-100" id="ai-like-btn" title="Thumbs up" aria-label="Thumbs up">
                  <i class="bi bi-hand-thumbs-up fs-4 text-success"></i>
                </button>
              </div>
              <div class="col-6 d-flex justify-content-center">
                <button type="button" class="btn btn-light border d-flex justify-content-center align-items-center py-2 w-100" id="ai-dislike-btn" title="Thumbs down" aria-label="Thumbs down">
                  <i class="bi bi-hand-thumbs-down fs-4 text-danger"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer gap-2">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"><%= t('common.cancel', default: 'Cancel') %></button>
        <button type="button" id="ai-confirm-btn" class="btn btn-primary"
                data-ai-progress-target="confirmBtn"
                data-action="click->ai-progress#confirm">Confirm & Start</button>
      </div>
    </div>
  </div>
 </div>

