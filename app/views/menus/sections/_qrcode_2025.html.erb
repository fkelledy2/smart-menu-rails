<%#
  Menu QR Code Section
  QR code generation and management
%>

<% menu = local_assigns[:menu] || @menu %>
<% restaurant = menu.restaurant %>

 



<!-- All QR Codes for this Menu -->
<div class="content-card-2025 py-4">
  <h2 class="content-card-title">
    <i class="bi bi-grid"></i>
    <%= t('.all_qr_codes_for_menu') %>
  </h2>

  <p class="text-muted mb-4">
    <%= t('.all_qr_codes_for_menu_desc') %>
  </p>

  <!-- Provide shared data for QR generation (used by RestaurantModule / legacy initialiser) -->
  <div id="qrHost" class="d-none"><%= request.host_with_port %></div>
  <div id="qrIcon" class="d-none"><%= image_url('qr-icon.svg') %></div>

  <% smartmenus = Smartmenu.where(restaurant_id: restaurant.id, menu_id: menu.id).includes(:tablesetting) %>

  <!-- Menu-only QR (no table) -->
  <% menu_only = smartmenus.find { |sm| sm.tablesetting_id.nil? } %>
  <% menu_only_slug = menu_only&.slug || menu.smartmenu&.slug %>
  <% if menu_only_slug %>
    <h3 class="mt-2 mb-2"><i class="bi bi-list-ul me-2"></i><%= t('.menu_only_qr') %></h3>
    <div class="qr-cards-grid">
      <div class="qr-card qr-container">
        <div class="qr-card-header">
          <div class="qr-meta">
            <div class="qr-meta-line qr-restaurant-name"><%= restaurant.name %></div>
            <div class="qr-meta-line qr-menu-name"><%= menu.name %></div>
            <div class="qr-meta-line qr-table-name"><%= t('.all_tables') %></div>
          </div>
        </div>
        <div class="d-none qrSlug"><%= menu_only_slug %></div>
        <div class="qr-card-body">
          <a class="qr-clickable" href="<%= smartmenu_path(menu_only_slug) %>" target="_blank" rel="noopener">
            <div id="<%= menu_only_slug %>" class="qr-code-container"></div>
          </a>
        </div>
        <div class="qr-card-footer">
          <div class="qr-actions">
            <button type="button" class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2" onclick="printQrCard(this)">
              <i class="bi bi-printer"></i> <%= t('.print') %>
            </button>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Per-table QRs for this menu -->
  <% per_table = smartmenus.select { |sm| sm.tablesetting_id.present? } %>
  <% if per_table.any? %>
    <h3 class="mt-4 mb-2"><i class="bi bi-grid-3x3-gap me-2"></i><%= t('.menu_table_qr') %></h3>
    <div class="qr-cards-grid">
      <% per_table.each do |sm| %>
        <div class="qr-card qr-container">
          <div class="qr-card-header">
            <div class="qr-meta">
              <div class="qr-meta-line qr-restaurant-name"><%= restaurant.name %></div>
              <div class="qr-meta-line qr-menu-name"><%= menu.name %></div>
              <div class="qr-meta-line qr-table-name"><%= sm.tablesetting&.name || '-' %></div>
            </div>
          </div>
          <div class="d-none qrSlug"><%= sm.slug %></div>
          <div class="qr-card-body">
            <a class="qr-clickable" href="<%= smartmenu_path(sm.slug) %>" target="_blank" rel="noopener">
              <div id="<%= sm.slug %>" class="qr-code-container"></div>
            </a>
          </div>
          <div class="qr-card-footer">
            <div class="qr-actions">
              <button type="button" class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2" onclick="printQrCard(this)">
                <i class="bi bi-printer"></i> <%= t('.print') %>
              </button>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <% if !menu_only && per_table.blank? %>
    <div class="alert alert-info mt-3">
      <i class="bi bi-info-circle me-2"></i>
      <%= t('.no_qr_found') %>
    </div>
  <% end %>

  <style>
    .qr-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: var(--space-4);
    }
    .qr-card {
      background: var(--color-white);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-3);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .qr-card-header { width: 100%; text-align: center; margin-bottom: var(--space-2); }
    .qr-meta { width: 100%; text-align: center; }
    .qr-meta-line { line-height: 1.2; }
    .qr-restaurant-name { font-weight: 700; text-transform: uppercase; letter-spacing: .03em; }
    .qr-menu-name { font-weight: 600; margin-top: 2px; }
    .qr-table-name { font-weight: 600; font-size: var(--text-sm); color: var(--color-gray-700); margin-top: 2px; }
    .qr-card-body { min-height: 320px; display: flex; align-items: center; justify-content: center; width: 100%; }
    .qr-card-footer { width: 100%; display: flex; align-items: center; justify-content: space-between; gap: var(--space-2); margin-top: var(--space-2); }
    .qr-actions { display: flex; gap: var(--space-2); width: 100%; }
    .qr-clickable { text-decoration: none; display: inline-block; }

    @media print {
      .sidebar-2025, .header-2025, .quick-actions-card, .customization-option, .btn-2025 { display: none !important; }
      .qr-card { page-break-inside: avoid; border: none; }
      .qr-card-footer { justify-content: flex-start; gap: var(--space-4); }
      /* Print-optimized, high-contrast labels */
      .qr-meta { border-bottom: 1px solid #000; padding-bottom: 6px; margin-bottom: 8px; }
      .qr-restaurant-name, .qr-menu-name, .qr-table-name { color: #000 !important; }
    }
  </style>
</div>

<!-- Download Options -->
<div class="content-card-2025 py-4">
  <h2 class="content-card-title">
    <i class="bi bi-download"></i>
    <%= t('.download_options') %>
  </h2>

  <p class="text-muted mb-4">
    <%= t('.download_description') %>
  </p>

  <div class="download-grid">
    <div class="download-option">
      <div class="download-icon">
        <i class="bi bi-file-earmark-image"></i>
      </div>
      <h5><%= t('.png_format') %></h5>
      <p class="text-sm text-muted"><%= t('.png_desc') %></p>
      <button class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2">
        <i class="bi bi-download"></i> <%= t('.download') %>
      </button>
    </div>

    <div class="download-option">
      <div class="download-icon">
        <i class="bi bi-file-earmark-code"></i>
      </div>
      <h5><%= t('.svg_format') %></h5>
      <p class="text-sm text-muted"><%= t('.svg_desc') %></p>
      <button class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2">
        <i class="bi bi-download"></i> <%= t('.download') %>
      </button>
    </div>

    <div class="download-option">
      <div class="download-icon">
        <i class="bi bi-file-earmark-pdf"></i>
      </div>
      <h5><%= t('.pdf_format') %></h5>
      <p class="text-sm text-muted"><%= t('.pdf_desc') %></p>
      <button class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2">
        <i class="bi bi-download"></i> <%= t('.download') %>
      </button>
    </div>
  </div>
</div>

<!-- QR Code Usage Tips -->
<div class="content-card-2025 py-4">
  <h2 class="content-card-title">
    <i class="bi bi-lightbulb"></i>
    <%= t('.usage_tips') %>
  </h2>

  <div class="tips-list">
    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_1') %></p>
    </div>

    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_2') %></p>
    </div>

    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_3') %></p>
    </div>

    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_4') %></p>
    </div>
  </div>
</div>

<style>
  .qr-preview {
    padding: var(--space-6);
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .qr-preview svg {
    max-width: 100%;
    height: auto;
  }

  .qr-code-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
  }

  .qr-code-container canvas {
    max-width: 100%;
    height: auto;
  }

  .qr-placeholder {
    text-align: center;
    padding: var(--space-6);
    color: var(--color-gray-400);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .qr-placeholder i {
    font-size: 4rem;
  }

  .download-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
  }

  .download-option {
    padding: var(--space-4);
    background: var(--color-gray-50);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    text-align: center;
  }

  .download-icon {
    font-size: 3rem;
    color: var(--color-primary);
    margin-bottom: var(--space-2);
  }

  .download-option h5 {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-1);
  }

  .tips-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .tip-item {
    display: flex;
    align-items-start;
    gap: var(--space-2);
  }

  .tip-item i {
    font-size: 1.25rem;
    margin-top: 2px;
  }

  .tip-item p {
    margin: 0;
    color: var(--color-gray-700);
  }
</style>

<script>
  function copyToClipboard() {
    // Get the menu slug and construct the URL with server-side protocol
    const slug = document.querySelector('.qrSlug');
    const host = document.querySelector('#qrHost');
    const protocol = document.querySelector('#qrProtocol');
    if (slug && host && protocol) {
      // Remove trailing colon from protocol if present
      const cleanProtocol = protocol.textContent.trim().replace(/:$/, '');
      const url = `${cleanProtocol}://${host.textContent.trim()}/m/${slug.textContent.trim()}`;
      navigator.clipboard.writeText(url).then(() => {
        alert('<%= j t('.url_copied') %>');
      });
    }
  }

  // Initialize styled QR code when section loads
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof initialiseSlugs === 'function') {
      initialiseSlugs();
    }
  });

  // Also initialize on Turbo Frame load
  document.addEventListener('turbo:frame-load', function() {
    if (typeof initialiseSlugs === 'function') {
      initialiseSlugs();
    }
  });

  // Print only the selected QR card (global)
  window.printQrCard = function(btn) {
    try {
      const card = btn.closest('.qr-card');
      if (!card) { window.print(); return; }

      // Clone the card and strip non-print elements
      const clone = card.cloneNode(true);
      clone.querySelectorAll('.qr-actions, .btn-2025').forEach(el => el.remove());
      // Explicitly remove hidden slug element (bootstrap d-none won't exist in iframe)
      clone.querySelectorAll('.qrSlug').forEach(el => el.remove());
      // Unwrap anchors to avoid browsers printing link URLs (which can show the UUID)
      clone.querySelectorAll('a.qr-clickable').forEach(a => {
        const firstChild = a.firstElementChild || a.firstChild;
        if (firstChild) {
          a.parentNode.insertBefore(firstChild, a);
          a.remove();
        } else {
          a.remove();
        }
      });

      // Remove any visible occurrences of the slug/UUID text from the clone
      const slugEl = card.querySelector('.qrSlug');
      const slug = slugEl ? slugEl.textContent.trim() : '';
      // Remove text-only elements that contain the slug
      const uuidRe = /\b[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\b/i;
      clone.querySelectorAll('*').forEach(el => {
        try {
          if (!el) return;
          const hasVisual = el.querySelector('canvas, img, svg');
          const text = (el.textContent || '').trim();
          if (!hasVisual && text && ((slug && text.includes(slug)) || uuidRe.test(text))) {
            el.remove();
            return;
          }
          // Also strip title attributes that might include slug/uuid
          if (el.hasAttribute && el.hasAttribute('title')) {
            const t = el.getAttribute('title') || '';
            if ((slug && t.includes(slug)) || uuidRe.test(t)) el.removeAttribute('title');
          }
        } catch (_) {}
      });

      // Scrub any remaining text nodes containing the slug/uuid
      try {
        const walker = document.createTreeWalker(clone, NodeFilter.SHOW_TEXT, null);
        const toClean = [];
        while (walker.nextNode()) {
          const n = walker.currentNode;
          if (!n || typeof n.nodeValue !== 'string') continue;
          if ((slug && n.nodeValue.includes(slug)) || uuidRe.test(n.nodeValue)) {
            toClean.push(n);
          }
        }
        toClean.forEach(n => {
          if (slug) n.nodeValue = n.nodeValue.replaceAll(slug, '');
          n.nodeValue = n.nodeValue.replace(uuidRe, '');
        });
      } catch (_) {}

      // Convert canvases (QR code) to images for reliable print output
      const canvases = card.querySelectorAll('canvas');
      const cloneCanvases = clone.querySelectorAll('canvas');
      canvases.forEach((canvas, idx) => {
        try {
          const dataURL = canvas.toDataURL('image/png');
          const img = document.createElement('img');
          img.src = dataURL;
          img.style.maxWidth = '100%';
          img.style.height = 'auto';
          const targetCanvas = cloneCanvases[idx];
          if (targetCanvas && targetCanvas.parentNode) {
            targetCanvas.parentNode.replaceChild(img, targetCanvas);
          }
        } catch (e) {}
      });

      // Create a hidden iframe to isolate print content (no visible new tab)
      const iframe = document.createElement('iframe');
      iframe.style.position = 'fixed';
      iframe.style.right = '0';
      iframe.style.bottom = '0';
      iframe.style.width = '0';
      iframe.style.height = '0';
      iframe.style.border = '0';
      iframe.style.visibility = 'hidden';
      document.body.appendChild(iframe);

      const doc = iframe.contentDocument || iframe.contentWindow.document;
      doc.open();
      doc.write(`<!doctype html>
        <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title><%= j t('.print_qr_title') %></title>
            <style>
              :root { --space-2: 8px; --space-3: 12px; --space-4: 16px; }
              html, body { height: 100%; }
              body {
                margin: 0;
                padding: 16px;
                font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
              }
              /* Prevent browsers from appending URLs after links when printing */
              a[href]:after { content: none !important; }
              .qr-card { border: none; box-shadow: none; padding: var(--space-3); page-break-inside: avoid; max-width: 90vw; }
              .qr-card-header { text-align: center; margin-bottom: var(--space-2); }
              .qr-meta { border-bottom: 1px solid #000; padding-bottom: 6px; margin-bottom: 8px; text-align: center; }
              .qr-meta-line { line-height: 1.2; }
              .qr-restaurant-name, .qr-menu-name, .qr-table-name { color: #000 !important; }
              .qr-actions, .btn-2025 { display: none !important; }
              .qrSlug { display: none !important; }
              @page { margin: 12mm; }
            </style>
          </head>
          <body></body>
        </html>`);
      doc.close();

      doc.body.appendChild(clone);

      // Wait a tick to allow layout, then print and clean up
      setTimeout(() => {
        try {
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        } finally {
          setTimeout(() => iframe.remove(), 250);
        }
      }, 150);
    } catch (e) {
      window.print();
    }
  };
</script>
