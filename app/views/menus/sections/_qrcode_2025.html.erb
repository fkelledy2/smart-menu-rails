<%# 
  Menu QR Code Section
  QR code generation and management
%>

<% menu = local_assigns[:menu] || @menu %>
<% restaurant = menu.restaurant %>

<!-- QR Code Preview -->
<div class="content-card-2025">
  <h2 class="content-card-title">
    <i class="bi bi-qr-code"></i>
    <%= t('.qr_code', default: 'QR Code') %>
  </h2>
  
  <p class="text-muted mb-4">
    <%= t('.qr_code_description', default: 'Let customers scan this QR code to view your menu') %>
  </p>
  
  <!-- Hidden data for QR code generation -->
  <% if menu.smartmenu&.slug %>
    <div id="qrHost" style="display: none;"><%= request.host_with_port %></div>
    <div class="qrSlug" style="display: none;"><%= menu.smartmenu.slug %></div>
    <div id="qrIcon" style="display: none;"><%= image_url('qr-icon.svg') %></div>
  <% end %>
  
  <div class="row g-4">
    <div class="col-md-6">
      <div class="qr-preview">
        <% if menu.smartmenu&.slug %>
          <!-- Styled QR code will be inserted here by JavaScript -->
          <div id="<%= menu.smartmenu.slug %>" class="qr-code-container"></div>
        <% else %>
          <div class="qr-placeholder">
            <i class="bi bi-qr-code"></i>
            <p class="mt-2">
              <%= t('.qr_not_available', default: 'QR code will appear here once menu is published') %>
            </p>
          </div>
        <% end %>
      </div>
    </div>
    
    <div class="col-md-6">
      <h4><%= t('.menu_url', default: 'Menu URL') %></h4>
      <% if defined?(@qrURL) && @qrURL %>
        <div class="url-display">
          <%= @qrURL %>
        </div>
        
        <div class="d-flex gap-2 mt-3">
          <button class="btn-2025 btn-2025-secondary btn-2025-md" onclick="copyToClipboard()">
            <i class="bi bi-clipboard"></i>
            <%= t('.copy_url', default: 'Copy URL') %>
          </button>
          
          <% if menu.smartmenu&.slug %>
            <%= link_to smartmenu_path(menu.smartmenu.slug), 
                class: 'btn-2025 btn-2025-secondary btn-2025-md',
                target: '_blank' do %>
              <i class="bi bi-box-arrow-up-right"></i>
              <%= t('.preview_menu', default: 'Preview Menu') %>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i>
          <%= t('.no_public_url', default: 'Public menu URL not available yet. Save your menu to generate a QR code.') %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Download Options -->
<div class="content-card-2025">
  <h2 class="content-card-title">
    <i class="bi bi-download"></i>
    <%= t('.download_options', default: 'Download Options') %>
  </h2>
  
  <p class="text-muted mb-4">
    <%= t('.download_description', default: 'Download your QR code in different formats for printing') %>
  </p>
  
  <div class="download-grid">
    <div class="download-option">
      <div class="download-icon">
        <i class="bi bi-file-earmark-image"></i>
      </div>
      <h5><%= t('.png_format', default: 'PNG Image') %></h5>
      <p class="text-sm text-muted"><%= t('.png_desc', default: 'High quality for digital use') %></p>
      <button class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2">
        <i class="bi bi-download"></i> <%= t('.download', default: 'Download') %>
      </button>
    </div>
    
    <div class="download-option">
      <div class="download-icon">
        <i class="bi bi-file-earmark-code"></i>
      </div>
      <h5><%= t('.svg_format', default: 'SVG Vector') %></h5>
      <p class="text-sm text-muted"><%= t('.svg_desc', default: 'Scalable for any size') %></p>
      <button class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2">
        <i class="bi bi-download"></i> <%= t('.download', default: 'Download') %>
      </button>
    </div>
    
    <div class="download-option">
      <div class="download-icon">
        <i class="bi bi-file-earmark-pdf"></i>
      </div>
      <h5><%= t('.pdf_format', default: 'PDF Document') %></h5>
      <p class="text-sm text-muted"><%= t('.pdf_desc', default: 'Print-ready format') %></p>
      <button class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2">
        <i class="bi bi-download"></i> <%= t('.download', default: 'Download') %>
      </button>
    </div>
  </div>
</div>

<!-- QR Code Usage Tips -->
<div class="content-card-2025">
  <h2 class="content-card-title">
    <i class="bi bi-lightbulb"></i>
    <%= t('.usage_tips', default: 'Usage Tips') %>
  </h2>
  
  <div class="tips-list">
    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_1', default: 'Print QR codes on table tents or placemats for easy customer access') %></p>
    </div>
    
    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_2', default: 'Include QR code on receipts and business cards') %></p>
    </div>
    
    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_3', default: 'Place QR codes near your entrance for takeout customers') %></p>
    </div>
    
    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_4', default: 'Test the QR code regularly to ensure it works correctly') %></p>
    </div>
  </div>
</div>

<style>
  .qr-preview {
    padding: var(--space-6);
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .qr-preview svg {
    max-width: 100%;
    height: auto;
  }
  
  .qr-code-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
  }
  
  .qr-code-container canvas {
    max-width: 100%;
    height: auto;
  }
  
  .qr-placeholder {
    text-align: center;
    padding: var(--space-6);
    color: var(--color-gray-400);
  }
  
  .qr-placeholder i {
    font-size: 4rem;
  }
  
  .url-display {
    padding: var(--space-3);
    background: var(--color-gray-50);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-md);
    font-family: monospace;
    word-break: break-all;
    font-size: var(--text-sm);
  }
  
  .download-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
  }
  
  .download-option {
    padding: var(--space-4);
    background: var(--color-gray-50);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    text-align: center;
  }
  
  .download-icon {
    font-size: 3rem;
    color: var(--color-primary);
    margin-bottom: var(--space-2);
  }
  
  .download-option h5 {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-1);
  }
  
  .tips-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }
  
  .tip-item {
    display: flex;
    align-items-start;
    gap: var(--space-2);
  }
  
  .tip-item i {
    font-size: 1.25rem;
    margin-top: 2px;
  }
  
  .tip-item p {
    margin: 0;
    color: var(--color-gray-700);
  }
</style>

<script>
  function copyToClipboard() {
    const urlText = document.querySelector('.url-display').textContent.trim();
    navigator.clipboard.writeText(urlText).then(() => {
      alert('<%= t('.url_copied', default: 'URL copied to clipboard!') %>');
    });
  }
  
  // Initialize styled QR code when section loads
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof initialiseSlugs === 'function') {
      initialiseSlugs();
    }
  });
  
  // Also initialize on Turbo Frame load
  document.addEventListener('turbo:frame-load', function() {
    if (typeof initialiseSlugs === 'function') {
      initialiseSlugs();
    }
  });
</script>
