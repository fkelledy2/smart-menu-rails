<%# 
  Menu QR Code Section
  QR code generation and management
%>

<% menu = local_assigns[:menu] || @menu %>
<% restaurant = menu.restaurant %>

<!-- Quick Actions Card -->
<% if menu.smartmenu&.slug %>
  <div class="quick-actions-card">
    <h2 class="quick-actions-title">
      <i class="bi bi-lightning-charge"></i>
      <%= t('.quick_actions', default: 'Quick Actions') %>
    </h2>
    
    <div class="quick-actions-grid">
      <button class="quick-action-btn" onclick="copyToClipboard()">
        <i class="bi bi-clipboard"></i>
        <span><%= t('.copy_url', default: 'Copy URL') %></span>
      </button>
      
      <%= link_to smartmenu_path(menu.smartmenu.slug), 
          class: 'quick-action-btn',
          target: '_blank',
          title: 'Preview menu as staff (authenticated view)' do %>
        <i class="bi bi-eye"></i>
        <span><%= t('.preview_staff', default: 'Preview (Staff)') %></span>
      <% end %>
      
      <%= link_to smartmenu_path(menu.smartmenu.slug, view: 'customer'), 
          class: 'quick-action-btn quick-action-btn-secondary',
          target: '_blank',
          rel: 'noopener noreferrer',
          title: 'Preview menu as customers see it (authenticated as staff but viewing customer interface)' do %>
        <i class="bi bi-eye-slash"></i>
        <span><%= t('.preview_customer', default: 'Preview (Customer)') %></span>
      <% end %>
    </div>
  </div>
<% end %>

<!-- QR Code Preview -->
<div class="content-card-2025 py-4">
  <h2 class="content-card-title">
    <i class="bi bi-qr-code"></i>
    <%= t('.qr_code', default: 'QR Code') %>
  </h2>
  
  <p class="text-muted mb-4">
    <%= t('.qr_code_description', default: 'Let customers scan this QR code to view your menu') %>
  </p>
  
  <!-- Hidden data for QR code generation -->
  <% if menu.smartmenu&.slug %>
    <div id="qrHost" style="display: none;"><%= request.host_with_port %></div>
    <div class="qrSlug" style="display: none;"><%= menu.smartmenu.slug %></div>
    <div id="qrIcon" style="display: none;"><%= image_url('qr-icon.svg') %></div>
    <div id="qrProtocol" style="display: none;"><%= request.protocol %></div>
    
    <!-- Centered QR Code -->
    <div class="d-flex justify-content-center">
      <div class="qr-preview">
        <!-- Styled QR code will be inserted here by JavaScript -->
        <div id="<%= menu.smartmenu.slug %>" class="qr-code-container"></div>
      </div>
    </div>
  <% else %>
    <div class="qr-placeholder">
      <i class="bi bi-qr-code"></i>
      <p class="mt-2">
        <%= t('.qr_not_available', default: 'QR code will appear here once menu is published') %>
      </p>
    </div>
  <% end %>
</div>

<!-- Download Options -->
<div class="content-card-2025 py-4">
  <h2 class="content-card-title">
    <i class="bi bi-download"></i>
    <%= t('.download_options', default: 'Download Options') %>
  </h2>
  
  <p class="text-muted mb-4">
    <%= t('.download_description', default: 'Download your QR code in different formats for printing') %>
  </p>
  
  <div class="download-grid">
    <div class="download-option">
      <div class="download-icon">
        <i class="bi bi-file-earmark-image"></i>
      </div>
      <h5><%= t('.png_format', default: 'PNG Image') %></h5>
      <p class="text-sm text-muted"><%= t('.png_desc', default: 'High quality for digital use') %></p>
      <button class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2">
        <i class="bi bi-download"></i> <%= t('.download', default: 'Download') %>
      </button>
    </div>
    
    <div class="download-option">
      <div class="download-icon">
        <i class="bi bi-file-earmark-code"></i>
      </div>
      <h5><%= t('.svg_format', default: 'SVG Vector') %></h5>
      <p class="text-sm text-muted"><%= t('.svg_desc', default: 'Scalable for any size') %></p>
      <button class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2">
        <i class="bi bi-download"></i> <%= t('.download', default: 'Download') %>
      </button>
    </div>
    
    <div class="download-option">
      <div class="download-icon">
        <i class="bi bi-file-earmark-pdf"></i>
      </div>
      <h5><%= t('.pdf_format', default: 'PDF Document') %></h5>
      <p class="text-sm text-muted"><%= t('.pdf_desc', default: 'Print-ready format') %></p>
      <button class="btn-2025 btn-2025-outline btn-2025-sm w-100 mt-2">
        <i class="bi bi-download"></i> <%= t('.download', default: 'Download') %>
      </button>
    </div>
  </div>
</div>

<!-- QR Code Usage Tips -->
<div class="content-card-2025 py-4">
  <h2 class="content-card-title">
    <i class="bi bi-lightbulb"></i>
    <%= t('.usage_tips', default: 'Usage Tips') %>
  </h2>
  
  <div class="tips-list">
    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_1', default: 'Print QR codes on table tents or placemats for easy customer access') %></p>
    </div>
    
    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_2', default: 'Include QR code on receipts and business cards') %></p>
    </div>
    
    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_3', default: 'Place QR codes near your entrance for takeout customers') %></p>
    </div>
    
    <div class="tip-item">
      <i class="bi bi-check-circle text-success"></i>
      <p><%= t('.tip_4', default: 'Test the QR code regularly to ensure it works correctly') %></p>
    </div>
  </div>
</div>

<style>
  .qr-preview {
    padding: var(--space-6);
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .qr-preview svg {
    max-width: 100%;
    height: auto;
  }
  
  .qr-code-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
  }
  
  .qr-code-container canvas {
    max-width: 100%;
    height: auto;
  }
  
  .qr-placeholder {
    text-align: center;
    padding: var(--space-6);
    color: var(--color-gray-400);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  
  .qr-placeholder i {
    font-size: 4rem;
  }
  
  .download-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
  }
  
  .download-option {
    padding: var(--space-4);
    background: var(--color-gray-50);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    text-align: center;
  }
  
  .download-icon {
    font-size: 3rem;
    color: var(--color-primary);
    margin-bottom: var(--space-2);
  }
  
  .download-option h5 {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-1);
  }
  
  .tips-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }
  
  .tip-item {
    display: flex;
    align-items-start;
    gap: var(--space-2);
  }
  
  .tip-item i {
    font-size: 1.25rem;
    margin-top: 2px;
  }
  
  .tip-item p {
    margin: 0;
    color: var(--color-gray-700);
  }
</style>

<script>
  function copyToClipboard() {
    // Get the menu slug and construct the URL with server-side protocol
    const slug = document.querySelector('.qrSlug');
    const host = document.querySelector('#qrHost');
    const protocol = document.querySelector('#qrProtocol');
    if (slug && host && protocol) {
      // Remove trailing colon from protocol if present
      const cleanProtocol = protocol.textContent.trim().replace(/:$/, '');
      const url = `${cleanProtocol}://${host.textContent.trim()}/m/${slug.textContent.trim()}`;
      navigator.clipboard.writeText(url).then(() => {
        alert('<%= t('.url_copied', default: 'URL copied to clipboard!') %>');
      });
    }
  }
  
  // Initialize styled QR code when section loads
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof initialiseSlugs === 'function') {
      initialiseSlugs();
    }
  });
  
  // Also initialize on Turbo Frame load
  document.addEventListener('turbo:frame-load', function() {
    if (typeof initialiseSlugs === 'function') {
      initialiseSlugs();
    }
  });
</script>
