<%# 
  Menu Items Section
  View all menu items across all sections
%>

<% menu = local_assigns[:menu] || @menu %>
<% restaurant = menu.restaurant %>

<!-- Quick Actions Card -->
<% if menu.menusections.any? %>
  <div class="quick-actions-card" data-testid="menu-items-quick-actions">
    <h2 class="quick-actions-title">
      <i class="bi bi-lightning-charge"></i>
      <%= t('.quick_actions', default: 'Quick Actions') %>
    </h2>
    
    <div class="quick-actions-grid">
      <%= link_to '#', class: 'quick-action-btn', data: { testid: 'add-item-btn' } do %>
        <i class="bi bi-plus-circle"></i>
        <span><%= t('.add_item', default: 'Add Menu Item') %></span>
      <% end %>
      
      <% if menu.smartmenu&.slug %>
        <%= link_to smartmenu_path(menu.smartmenu.slug), 
            class: 'quick-action-btn',
            target: '_blank',
            title: 'Preview menu as staff (authenticated view)',
            data: { testid: 'preview-staff-btn' } do %>
          <i class="bi bi-eye"></i>
          <span><%= t('.preview_staff', default: 'Preview (Staff)') %></span>
        <% end %>
        
        <%= link_to smartmenu_path(menu.smartmenu.slug, view: 'customer'), 
            class: 'quick-action-btn quick-action-btn-secondary',
            target: '_blank',
            rel: 'noopener noreferrer',
            title: 'Preview menu as customers see it (authenticated as staff but viewing customer interface)',
            data: { testid: 'preview-customer-btn' } do %>
          <i class="bi bi-eye-slash"></i>
          <span><%= t('.preview_customer', default: 'Preview (Customer)') %></span>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Items List -->
<div class="content-card-2025 py-4" data-testid="menu-items-card">
  <h2 class="content-card-title">
    <i class="bi bi-list-ul"></i>
    <%= t('.menu_items', default: 'Menu Items') %>
  </h2>
  
  <p class="text-muted mb-4">
    <%= t('.items_description', default: 'View and manage all menu items across all sections') %>
  </p>
  
  <% if menu.menuitems.any? %>
    <!-- Items Table -->
    <div class="table-responsive" data-testid="menu-items-table">
      <table class="table table-hover">
        <thead>
          <tr>
            <th style="width: 40px;"></th>
            <th><%= t('.name', default: 'Name') %></th>
            <th><%= t('.price', default: 'Price') %></th>
            <th class="text-end">
              <span class="btn-2025 btn-2025-ghost btn-2025-sm">
                <i class="bi bi-gear"></i>
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
          <% menu.menusections.order(:sequence).each do |section| %>
            <% section_items = section.menuitems.order(:sequence) %>
            <% if section_items.any? %>
              <!-- Section Header Row -->
              <tr class="table-section-header" data-testid="section-header-<%= section.id %>">
                <td colspan="4">
                  <strong class="text-primary">
                    <i class="bi bi-layout-text-sidebar"></i>
                    <%= section.name %>
                  </strong>
                  <span class="badge bg-secondary ms-2"><%= section_items.count %> items</span>
                </td>
              </tr>
              
              <!-- Items in this section (sortable group) -->
              <tbody class="sortable-group"
                     data-controller="sortable"
                     data-sortable-url-value="<%= reorder_restaurant_menu_menusection_menuitems_path(restaurant, menu, section) %>"
                     data-sortable-handle-value=".item-handle">
              <% section_items.each do |item| %>
                <tr data-sortable-id="<%= item.id %>" data-testid="menu-item-<%= item.id %>">
                  <td class="item-handle" style="width: 40px; cursor: grab;">
                    <i class="bi bi-grip-vertical text-muted"></i>
                  </td>
                  <td>
                    <div class="item-name-cell">
                      <div class="d-flex align-items-center gap-2">
                        <strong><%= item.name %></strong>
                        <% if item.image.present? %>
                          <i class="bi bi-image text-primary" style="font-size: 14px;" title="Has image - hover to preview"></i>
                        <% end %>
                      </div>
                      <% if item.description.present? %>
                        <div class="text-sm text-muted">
                          <%= truncate(item.description, length: 50) %>
                        </div>
                      <% end %>
                      
                      <% if item.thumb_url.present? %>
                        <div class="item-image-tooltip">
                          <%= image_tag item.thumb_url, alt: item.name, loading: 'lazy' %>
                        </div>
                      <% end %>
                    </div>
                  </td>
                  <td>
                    <% if item.price.present? && item.price > 0 %>
                      <% 
                        currency_symbols = {
                          'USD' => '$', 'EUR' => '€', 'GBP' => '£', 'JPY' => '¥',
                          'CNY' => '¥', 'INR' => '₹', 'AUD' => 'A$', 'CAD' => 'C$',
                          'CHF' => 'CHF', 'SEK' => 'kr', 'NZD' => 'NZ$', 'MXN' => '$',
                          'SGD' => 'S$', 'HKD' => 'HK$', 'NOK' => 'kr', 'KRW' => '₩',
                          'TRY' => '₺', 'RUB' => '₽', 'BRL' => 'R$', 'ZAR' => 'R'
                        }
                        currency_symbol = currency_symbols[restaurant.currency] || restaurant.currency || '$'
                      %>
                      <%= number_to_currency(item.price, unit: currency_symbol) %>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <td class="text-end">
                    <%= link_to edit_restaurant_menu_menusection_menuitem_path(restaurant, menu, section, item), 
                        class: 'btn-2025 btn-2025-ghost btn-2025-sm',
                        data: { testid: "edit-item-#{item.id}-btn", turbo_frame: '_top' } do %>
                      <i class="bi bi-pencil"></i>
                    <% end %>
                  </td>
                </tr>
              <% end %>
              </tbody>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <!-- Empty State -->
    <div class="text-center py-5" data-testid="menu-items-empty-state">
      <i class="bi bi-list-ul text-muted" style="font-size: 4rem;"></i>
      <h4 class="mt-3"><%= t('.no_items', default: 'No items yet') %></h4>
      <p class="text-muted">
        <%= t('.no_items_desc', default: 'Add sections first, then add items to those sections') %>
      </p>
      <%= link_to edit_restaurant_menu_path(restaurant, menu, section: 'sections'), 
          class: 'btn-2025 btn-2025-primary btn-2025-lg mt-3',
          data: { testid: 'go-to-sections-btn', turbo_frame: 'menu_content', turbo_action: 'advance' } do %>
        <i class="bi bi-layout-text-sidebar"></i>
        <%= t('.go_to_sections', default: 'Go to Sections') %>
      <% end %>
    </div>
  <% end %>
</div>

<style>
  .table-section-header {
    background-color: var(--color-gray-100);
    border-top: 2px solid var(--color-gray-300);
  }
  
  .table-section-header td {
    padding: var(--space-3) var(--space-4);
    font-weight: 600;
  }
  
  .table-section-header:hover {
    background-color: var(--color-gray-100) !important;
  }
  
  /* Item drag handle styles */
  .item-handle {
    cursor: grab;
    user-select: none;
  }
  
  .item-handle:active {
    cursor: grabbing;
  }
  
  /* Sortable states */
  .sortable-ghost {
    opacity: 0.4;
    background: var(--color-primary-light);
  }
  
  .sortable-drag {
    opacity: 1;
    cursor: grabbing;
  }
  
  /* Item image tooltip on hover/tap */
  .item-name-cell {
    position: relative;
  }
  
  .item-image-tooltip {
    position: absolute;
    left: 100%;
    top: 50%;
    transform: translateY(-50%);
    margin-left: 16px;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    pointer-events: none;
    
    /* Tooltip styling */
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    padding: 8px;
    border: 1px solid var(--color-gray-200);
  }
  
  /* Show on hover (desktop) */
  .item-name-cell:hover .item-image-tooltip {
    opacity: 1;
    visibility: visible;
  }
  
  /* Show on tap/active (mobile) - when item name is tapped */
  .item-name-cell.show-tooltip .item-image-tooltip {
    opacity: 1;
    visibility: visible;
  }
  
  .item-image-tooltip img {
    display: block;
    width: 200px;
    height: 150px;
    object-fit: cover;
    border-radius: 6px;
  }
  
  /* Arrow indicator for tooltip */
  .item-image-tooltip::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid white;
    filter: drop-shadow(-1px 0 0 var(--color-gray-200));
  }
  
  /* Mobile/Tablet responsive adjustments */
  @media (max-width: 768px) {
    .item-image-tooltip {
      /* Reposition to center on mobile */
      left: 50%;
      top: auto;
      bottom: 100%;
      transform: translateX(-50%);
      margin-left: 0;
      margin-bottom: 12px;
    }
    
    /* Change arrow to point down on mobile */
    .item-image-tooltip::before {
      left: 50%;
      top: auto;
      bottom: -8px;
      transform: translateX(-50%);
      border-top: 8px solid white;
      border-right: 8px solid transparent;
      border-bottom: none;
      border-left: 8px solid transparent;
      filter: drop-shadow(0 1px 0 var(--color-gray-200));
    }
    
    /* Make image larger on mobile for better visibility */
    .item-image-tooltip img {
      width: 240px;
      height: 180px;
    }
  }
</style>

<script>
  // Touch-friendly image preview for mobile
  document.addEventListener('DOMContentLoaded', function() {
    const itemCells = document.querySelectorAll('.item-name-cell');
    
    itemCells.forEach(cell => {
      // Only add touch handling if the cell has an image tooltip
      if (cell.querySelector('.item-image-tooltip')) {
        // Handle touch/click on mobile
        cell.addEventListener('click', function(e) {
          // Don't interfere with edit button clicks
          if (e.target.closest('.btn-2025')) return;
          
          // Toggle tooltip visibility
          const isCurrentlyShown = this.classList.contains('show-tooltip');
          
          // Close all other tooltips first
          document.querySelectorAll('.item-name-cell.show-tooltip').forEach(otherCell => {
            otherCell.classList.remove('show-tooltip');
          });
          
          // Toggle this tooltip
          if (!isCurrentlyShown) {
            this.classList.add('show-tooltip');
          }
          
          // Prevent event from bubbling
          e.stopPropagation();
        });
      }
    });
    
    // Close tooltip when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.item-name-cell')) {
        document.querySelectorAll('.item-name-cell.show-tooltip').forEach(cell => {
          cell.classList.remove('show-tooltip');
        });
      }
    });
    
    // Close tooltip when scrolling
    const tableContainer = document.querySelector('.table-responsive');
    if (tableContainer) {
      tableContainer.addEventListener('scroll', function() {
        document.querySelectorAll('.item-name-cell.show-tooltip').forEach(cell => {
          cell.classList.remove('show-tooltip');
        });
      });
    }
  });
</script>
