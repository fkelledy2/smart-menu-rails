<%#
  Menu Items Section
  View all menu items across all sections
%>

<% menu = local_assigns[:menu] || @menu %>
<% restaurant = local_assigns[:restaurant] || @restaurant || menu.restaurant %>
<% read_only = local_assigns[:read_only] ? true : false %>
<% column_count = read_only ? 3 : 4 %>

<% menu_smartmenu_slug = Smartmenu.where(restaurant_id: restaurant.id, menu_id: menu.id, tablesetting_id: nil).first&.slug %>

<% if menu.menusections.any? && !read_only %>
  <div class="mb-3 p-3" data-testid="menu-items-quick-actions">
    <h2 class="h5 mb-3">
      <i class="bi bi-lightning-charge"></i>
      <%= t('.quick_actions') %>
    </h2>

    <div class="quick-actions-grid">
      <%= link_to '#', class: 'quick-action-btn', data: { testid: 'add-item-btn' } do %>
        <i class="bi bi-plus-circle"></i>
        <span><%= t('.add_item') %></span>
      <% end %>

      <% if menu_smartmenu_slug.present? %>
        <%= link_to smartmenu_path(menu_smartmenu_slug),
            class: 'quick-action-btn',
            target: '_blank',
            title: t('.preview_staff_title'),
            data: { testid: 'preview-staff-btn' } do %>
          <i class="bi bi-eye"></i>
          <span><%= t('.preview_staff') %></span>
        <% end %>

        <%= link_to smartmenu_path(menu_smartmenu_slug, view: 'customer'),
            class: 'quick-action-btn quick-action-btn-secondary',
            target: '_blank',
            rel: 'noopener noreferrer',
            title: t('.preview_customer_title'),
            data: { testid: 'preview-customer-btn' } do %>
          <i class="bi bi-eye-slash"></i>
          <span><%= t('.preview_customer') %></span>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Items List -->
<div class="mb-3 p-3" data-testid="menu-items-card">
  <h2 class="h5 mb-3">
      <i class="bi bi-list-ul"></i>
      <%= t('.menu_items') %>
    </h2>

  <p class="text-muted mb-4">
    <%= t('.items_description') %>
  </p>

  <% if menu.menuitems.where(archived: [false, nil]).where.not(status: :archived).any? %>
    <div data-controller="menuitems-bulk">
      <%= form_with url: bulk_update_restaurant_menu_menuitems_path(restaurant, menu), method: :patch, data: { turbo: true, action: 'submit->menuitems-bulk#beforeSubmit' } do |f| %>
        <%= hidden_field_tag :operation, '', data: { menuitems_bulk_target: 'operation' } %>
        <%= hidden_field_tag :value, '', data: { menuitems_bulk_target: 'value' } %>

        <!-- Items Table -->
        <div class="table-responsive" data-testid="menu-items-table">
          <table class="table table-hover">
            <thead>
              <tr>
                <% if read_only %>
                  <th class="w-40px"></th>
                  <th></th>
                  <th class="text-end"></th>
                <% else %>
                  <th class="w-40px">
                    <input type="checkbox" data-menuitems-bulk-target="selectAll" data-action="change->menuitems-bulk#toggleAll" />
                  </th>
                  <th class="text-end text-nowrap" colspan="3">
                    <div class="d-flex justify-content-end flex-nowrap">
                      <div class="input-group input-group-sm flex-nowrap" style="min-width: 260px; width: auto;">
                        <select class="form-select form-select-sm" style="min-width: 0;" data-menuitems-bulk-target="actionSelect" data-action="change->menuitems-bulk#sync">
                          <option value=""><%= t('.bulk_action', default: 'Bulk action…') %></option>
                          <option value="set_status"><%= t('.bulk_set_status', default: 'Set status') %></option>
                          <option value="set_itemtype"><%= t('.bulk_set_food_type', default: 'Set food type') %></option>
                          <option value="set_alcoholic"><%= t('.bulk_set_alcoholic', default: 'Set alcoholic') %></option>
                          <option value="archive"><%= t('.bulk_archive', default: 'Archive') %></option>
                        </select>
                        <button type="submit"
                                class="btn btn-primary"
                                title="<%= t('.apply', default: 'Apply') %>"
                                aria-label="<%= t('.apply', default: 'Apply') %>"
                                disabled
                                data-menuitems-bulk-target="apply"
                                data-action="click->menuitems-bulk#apply">
                          <i class="bi bi-check2"></i>
                          <span class="visually-hidden"><%= t('.apply', default: 'Apply') %></span>
                        </button>
                      </div>
                    </div>
                  </th>
                <% end %>
              </tr>
            </thead>
            <% menu.menusections.order(:sequence).each do |section| %>
              <% section_items = section.menuitems.where(archived: [false, nil]).where.not(status: :archived).order(:sequence) %>
              <% if section_items.any? %>
                <tbody>
                  <!-- Section Header Row -->
                  <tr class="table-section-header" data-testid="section-header-<%= section.id %>">
                    <td colspan="<%= column_count %>">
                      <strong class="text-primary">
                        <i class="bi bi-layout-text-sidebar"></i>
                        <%= section.name %>
                      </strong>
                      <span class="badge bg-secondary ms-2"><%= t('.items_count', count: section_items.count) %></span>
                      <% if section.tasting_menu? %>
                        <%
                          currency_symbols = {
                            'USD' => '$', 'EUR' => '€', 'GBP' => '£', 'JPY' => '¥',
                            'CNY' => '¥', 'INR' => '₹', 'AUD' => 'A$', 'CAD' => 'C$',
                            'CHF' => 'CHF', 'SEK' => 'kr', 'NZD' => 'NZ$', 'MXN' => '$',
                            'SGD' => 'S$', 'HKD' => 'HK$', 'NOK' => 'kr', 'KRW' => '₩',
                            'TRY' => '₺', 'RUB' => '₽', 'BRL' => 'R$', 'ZAR' => 'R'
                          }
                          sym = currency_symbols[restaurant.currency] || restaurant.currency || '$'
                          tasting_amount = (section.tasting_price_cents.to_i / 100.0)
                        %>
                        <span class="badge bg-warning text-dark ms-2">
                          <i class="bi bi-award"></i>
                          <%= t('.tasting_menu') %>
                          <% if section.tasting_price_cents.present? %>
                            · <%= number_to_currency(tasting_amount, unit: sym) %>
                            <%= section.price_per == 'table' ? t('.per_table') : t('.per_person') %>
                          <% end %>
                        </span>
                      <% end %>
                    </td>
                  </tr>
                </tbody>

                <tbody class="sortable-group"
                       <% unless read_only %>
                         data-controller="sortable"
                         data-sortable-url-value="<%= reorder_restaurant_menu_menusection_menuitems_path(restaurant, menu, section) %>"
                         data-sortable-handle-value=".item-handle"
                       <% end %>
                >
                  <!-- Items in this section (sortable group) -->
                  <% section_items.each do |item| %>
                    <% row_status_class = item.active? ? 'row-status-active' : 'row-status-inactive' %>
                    <% row_status_title = item.active? ? t('menus.sections.details_2025.active', default: 'Active') : t('menus.sections.details_2025.inactive', default: 'Inactive') %>
                    <tr data-sortable-id="<%= item.id %>" data-testid="menu-item-<%= item.id %>" class="<%= row_status_class %>" title="<%= row_status_title %>">
                      <% unless read_only %>
                        <td class="w-40px">
                          <input type="checkbox" name="menuitem_ids[]" value="<%= item.id %>" data-menuitems-bulk-target="checkbox" data-action="change->menuitems-bulk#sync" />
                        </td>
                      <% end %>

                      <% if read_only %>
                        <td class="w-40px" style="cursor: not-allowed; opacity: 0.55;">
                          <i class="bi bi-grip-vertical text-muted"></i>
                        </td>
                      <% else %>
                        <td class="item-handle w-40px cursor-grab">
                          <i class="bi bi-grip-vertical text-muted"></i>
                        </td>
                      <% end %>
                      <td>
                        <div class="item-name-cell">
                          <div class="d-flex align-items-center gap-2">
                            <strong><%= item.name %></strong>
                            <% if item.image.present? %>
                              <i class="bi bi-image text-primary text-14px" title="<%= t('.has_image_title') %>"></i>
                            <% end %>
                          </div>
                          <% if item.description.present? %>
                            <div class="text-sm text-muted">
                              <%= truncate(item.description, length: 50) %>
                            </div>
                          <% end %>

                          <% if item.image.present? %>
                            <div class="item-image-tooltip">
                              <%= responsive_image_tag(
                                    item.image,
                                    alt: item.name,
                                    sizes: '200px',
                                    class_name: '',
                                    loading: 'lazy'
                                  ) %>
                            </div>
                          <% end %>
                        </div>
                      </td>
                      <td class="text-end">
                        <%
                          currency_symbols = {
                            'USD' => '$', 'EUR' => '€', 'GBP' => '£', 'JPY' => '¥',
                            'CNY' => '¥', 'INR' => '₹', 'AUD' => 'A$', 'CAD' => 'C$',
                            'CHF' => 'CHF', 'SEK' => 'kr', 'NZD' => 'NZ$', 'MXN' => '$',
                            'SGD' => 'S$', 'HKD' => 'HK$', 'NOK' => 'kr', 'KRW' => '₩',
                            'TRY' => '₺', 'RUB' => '₽', 'BRL' => 'R$', 'ZAR' => 'R'
                          }
                          currency_symbol = currency_symbols[restaurant.currency] || restaurant.currency || '$'
                        %>
                        <% if section.tasting_menu? %>
                          <% if item.tasting_supplement_cents.present? && item.tasting_supplement_cents.to_i > 0 %>
                            <% supplement_amount = (item.tasting_supplement_cents.to_i / 100.0) %>
                            <span class="text-nowrap text-warning fw-semibold">+ <%= number_to_currency(supplement_amount, unit: currency_symbol) %></span>
                          <% else %>
                            <span class="text-muted"><%= t('.included') %></span>
                          <% end %>
                        <% else %>
                          <% if item.price.present? && item.price > 0 %>
                            <%= number_to_currency(item.price, unit: currency_symbol) %>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        <% end %>

                        <% unless read_only %>
                          <div class="mt-1">
                            <%= link_to edit_restaurant_menu_menusection_menuitem_path(restaurant, menu, section, item),
                                        class: 'd-inline-flex align-items-center justify-content-end text-decoration-none link-secondary',
                                        title: t('.edit'),
                                        aria: { label: t('.edit') },
                                        data: { turbo_frame: '_top', testid: "edit-item-#{item.id}-btn" } do %>
                              <i class="bi bi-chevron-right"></i>
                            <% end %>
                          </div>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              <% end %>
            <% end %>
            </table>
          </div>

          <div class="modal fade" tabindex="-1" aria-hidden="true" data-menuitems-bulk-target="modal">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" data-menuitems-bulk-target="modalTitle">Bulk edit</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="d-none" data-menuitems-bulk-target="modalBodyArchive">
                    <p class="mb-0">
                      <%= t('.archive_confirm', default: 'This will archive the selected menu items. Archived items will no longer appear in this list.') %>
                    </p>
                  </div>

                  <div class="d-none" data-menuitems-bulk-target="modalBodyStatus">
                    <label class="form-label"><%= t('.status', default: 'Status') %></label>
                    <select class="form-select" data-menuitems-bulk-target="modalStatusSelect">
                      <option value=""><%= t('.choose_status', default: 'Choose…') %></option>
                      <% Menuitem.statuses.keys.each do |k| %>
                        <option value="<%= k %>"><%= k.to_s.humanize %></option>
                      <% end %>
                    </select>
                  </div>

                  <div class="d-none" data-menuitems-bulk-target="modalBodyItemtype">
                    <label class="form-label"><%= t('.food_type', default: 'Food type') %></label>
                    <select class="form-select" data-menuitems-bulk-target="modalItemtypeSelect">
                      <option value=""><%= t('.choose_food_type', default: 'Choose…') %></option>
                      <% Menuitem.itemtypes.keys.each do |k| %>
                        <option value="<%= k %>"><%= k.to_s.humanize %></option>
                      <% end %>
                    </select>
                  </div>

                  <div class="d-none" data-menuitems-bulk-target="modalBodyAlcoholic">
                    <label class="form-label"><%= t('.alcoholic', default: 'Alcoholic') %></label>
                    <select class="form-select" data-menuitems-bulk-target="modalAlcoholicSelect">
                      <option value=""><%= t('.choose', default: 'Choose…') %></option>
                      <option value="true"><%= t('.alcoholic_true', default: 'Alcoholic') %></option>
                      <option value="false"><%= t('.alcoholic_false', default: 'Not alcoholic') %></option>
                    </select>
                  </div>
                </div>
                <div class="modal-footer gap-2">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"><%= t('common.cancel', default: 'Cancel') %></button>
                  <button type="button" class="btn btn-primary" data-menuitems-bulk-target="modalApply" data-action="click->menuitems-bulk#confirmModalApply"><%= t('.apply', default: 'Apply') %></button>
                </div>
              </div>
            </div>
          </div>

        <% end %>
      </div>
    </div>
  <% else %>
    <!-- Empty State -->
    <div class="text-center py-5" data-testid="menu-items-empty-state">
      <i class="bi bi-list-ul text-muted text-3rem"></i>
      <h4 class="mt-3"><%= t('.no_items') %></h4>
      <p class="text-muted">
        <%= t('.no_items_desc') %>
      </p>
      <%= link_to edit_restaurant_menu_path(restaurant, menu, section: 'sections'),
          class: 'btn btn-primary btn-lg mt-3',
          data: { testid: 'go-to-sections-btn', turbo_frame: 'menu_content', turbo_action: 'advance' } do %>
        <i class="bi bi-layout-text-sidebar"></i>
        <%= t('.go_to_sections') %>
      <% end %>
    </div>
  <% end %>
</div>

<style>
  [data-testid="menu-items-table"].table-responsive {
    width: 100%;
  }

  [data-testid="menu-items-table"] .table {
    width: 100%;
  }

  .table-section-header {
    background-color: var(--color-gray-100);
    border-top: 2px solid var(--color-gray-300);
  }

  .table-section-header td {
    padding: var(--space-3) var(--space-4);
    font-weight: 600;
  }

  .table-section-header:hover {
    background-color: var(--color-gray-100) !important;
  }

  /* Item drag handle styles */
  .item-handle {
    cursor: grab;
    user-select: none;
  }

  .item-handle:active {
    cursor: grabbing;
  }

  /* Sortable states */
  .sortable-ghost {
    opacity: 0.4;
    background: var(--color-primary-light);
  }

  .sortable-drag {
    opacity: 1;
    cursor: grabbing;
  }

  /* Item image tooltip on hover/tap */
  .item-name-cell {
    position: relative;
  }

  .item-image-tooltip {
    position: absolute;
    left: 100%;
    top: 50%;
    transform: translateY(-50%);
    margin-left: 16px;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    pointer-events: none;

    /* Tooltip styling */
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    padding: 8px;
    border: 1px solid var(--color-gray-200);
  }

  .item-image-tooltip.fixed-tooltip {
    position: fixed;
    left: 0;
    top: 0;
    margin-left: 0;
  }

  /* Show on hover (desktop) */
  .item-name-cell:hover .item-image-tooltip {
    opacity: 1;
    visibility: visible;
  }

  /* Show on tap/active (mobile) - when item name is tapped */
  .item-name-cell.show-tooltip .item-image-tooltip {
    opacity: 1;
    visibility: visible;
  }

  .item-image-tooltip img {
    display: block;
    width: 200px;
    height: 150px;
    object-fit: cover;
    border-radius: 6px;
  }

  /* Arrow indicator for tooltip */
  .item-image-tooltip::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid white;
    filter: drop-shadow(-1px 0 0 var(--color-gray-200));
  }

  /* Mobile/Tablet responsive adjustments */
  @media (max-width: 768px) {
    .item-image-tooltip {
      /* Reposition to center on mobile */
      left: 50%;
      top: auto;
      bottom: 100%;
      transform: translateX(-50%);
      margin-left: 0;
      margin-bottom: 12px;
    }

    /* Change arrow to point down on mobile */
    .item-image-tooltip::before {
      left: 50%;
      top: auto;
      bottom: -8px;
      transform: translateX(-50%);
      border-top: 8px solid white;
      border-right: 8px solid transparent;
      border-bottom: none;
      border-left: 8px solid transparent;
      filter: drop-shadow(0 1px 0 var(--color-gray-200));
    }

    /* Make image larger on mobile for better visibility */
    .item-image-tooltip img {
      width: 240px;
      height: 180px;
    }
  }
</style>

<script>
  // Touch-friendly image preview for mobile
  document.addEventListener('DOMContentLoaded', function() {
    const itemCells = document.querySelectorAll('.item-name-cell');

    const isDesktop = () => {
      try { return window.matchMedia && window.matchMedia('(min-width: 769px)').matches; } catch (_) { return true; }
    };

    const positionTooltipDesktop = (cell) => {
      const tooltip = cell.querySelector('.item-image-tooltip');
      if (!tooltip) return;
      if (!isDesktop()) return;
      tooltip.classList.add('fixed-tooltip');
      tooltip.style.left = '0px';
      tooltip.style.top = '0px';

      const cellRect = cell.getBoundingClientRect();
      const tipRect = tooltip.getBoundingClientRect();
      const margin = 16;
      let left = cellRect.right + margin;
      const maxLeft = window.innerWidth - tipRect.width - margin;
      if (left > maxLeft) left = Math.max(margin, maxLeft);
      const top = cellRect.top + (cellRect.height / 2);
      tooltip.style.left = `${left}px`;
      tooltip.style.top = `${top}px`;
    };

    const resetTooltipDesktop = (cell) => {
      const tooltip = cell.querySelector('.item-image-tooltip');
      if (!tooltip) return;
      tooltip.classList.remove('fixed-tooltip');
      tooltip.style.left = '';
      tooltip.style.top = '';
    };

    itemCells.forEach(cell => {
      // Only add touch handling if the cell has an image tooltip
      if (cell.querySelector('.item-image-tooltip')) {
        cell.addEventListener('mouseenter', function() {
          positionTooltipDesktop(this);
        });

        cell.addEventListener('mousemove', function() {
          positionTooltipDesktop(this);
        });

        cell.addEventListener('mouseleave', function() {
          resetTooltipDesktop(this);
        });

        // Handle touch/click on mobile
        cell.addEventListener('click', function(e) {
          // Don't interfere with edit button clicks
          if (e.target.closest('.btn')) return;

          // Toggle tooltip visibility
          const isCurrentlyShown = this.classList.contains('show-tooltip');
          
          // Close all other tooltips first
          document.querySelectorAll('.item-name-cell.show-tooltip').forEach(otherCell => {
            otherCell.classList.remove('show-tooltip');
          });

          // Toggle this tooltip
          if (!isCurrentlyShown) {
            this.classList.add('show-tooltip');
          }

          // Prevent event from bubbling
          e.stopPropagation();
        });
      }
    });

    // Close tooltip when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.item-name-cell')) {
        document.querySelectorAll('.item-name-cell.show-tooltip').forEach(cell => {
          cell.classList.remove('show-tooltip');
        });
      }
    });

    // Close tooltip when scrolling
    const tableContainer = document.querySelector('.table-responsive');
    if (tableContainer) {
      tableContainer.addEventListener('scroll', function() {
        document.querySelectorAll('.item-name-cell.show-tooltip').forEach(cell => {
          cell.classList.remove('show-tooltip');
        });
      });
    }
  });
</script>
