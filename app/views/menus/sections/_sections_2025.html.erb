<%#
  Menu Sections Section
  Manage menu sections (categories)
%>

<% menu = local_assigns[:menu] || @menu %>
<% restaurant = local_assigns[:restaurant] || @restaurant || menu.restaurant %>
<% read_only = local_assigns[:read_only] ? true : false %>

<% menu_smartmenu_slug = menu.smartmenu&.slug %>

<% unless read_only %>
  <div class="mb-3 p-3">
    <h2 class="h5 mb-3">
      <i class="bi bi-lightning-charge"></i>
      <%= t('.quick_actions') %>
    </h2>

    <div class="quick-actions-grid">
      <%= link_to new_restaurant_menu_menusection_path(restaurant, menu), class: 'quick-action-btn' do %>
        <i class="bi bi-plus-circle"></i>
        <span><%= t('.add_section') %></span>
      <% end %>

      <% if menu_smartmenu_slug.present? %>
        <%= link_to smartmenu_path(menu_smartmenu_slug),
            class: 'quick-action-btn',
            target: '_blank',
            title: t('.preview_staff_title') do %>
          <i class="bi bi-eye"></i>
          <span><%= t('.preview_staff') %></span>
        <% end %>

        <%= link_to smartmenu_path(menu_smartmenu_slug, view: 'customer'),
            class: 'quick-action-btn quick-action-btn-secondary',
            target: '_blank',
            rel: 'noopener noreferrer',
            title: t('.preview_customer_title') do %>
          <i class="bi bi-eye-slash"></i>
          <span><%= t('.preview_customer') %></span>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Sections List -->
<div class="mb-3 p-3">
  <h2 class="h5 mb-3">
      <i class="bi bi-layout-text-sidebar"></i>
      <%= t('.menu_sections') %>
    </h2>

  	<p class="text-muted mb-4">
		<%= t('.sections_description') %>
	</p>

	<% if menu.menusections.any? %>
		<div data-controller="menusections-bulk">
			<%= form_with url: bulk_update_restaurant_menu_menusections_path(restaurant, menu), method: :patch, data: { turbo: true, action: 'submit->menusections-bulk#beforeSubmit' } do |f| %>
				<%= hidden_field_tag :operation, '', data: { menusections_bulk_target: 'operation' } %>
				<%= hidden_field_tag :value, '', data: { menusections_bulk_target: 'value' } %>
				<!-- Sections Table -->
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr>
								<% if read_only %>
									<th class="w-40px"></th>
									<th></th>
									<th class="text-end"></th>
								<% else %>
									<th class="w-40px">
										<input type="checkbox" data-menusections-bulk-target="selectAll" data-action="change->menusections-bulk#toggleAll" />
									</th>
									<th class="text-end text-nowrap" colspan="4">
										<div class="d-flex justify-content-end flex-nowrap">
											<div class="input-group input-group-sm flex-nowrap" style="min-width: 260px; width: auto;">
												<select class="form-select form-select-sm" style="min-width: 0;" data-menusections-bulk-target="actionSelect" data-action="change->menusections-bulk#sync">
													<option value=""><%= t('.bulk_action', default: 'Bulk action…') %></option>
													<option value="set_status"><%= t('.bulk_set_status', default: 'Set status') %></option>
													<option value="archive"><%= t('.bulk_archive', default: 'Archive') %></option>
												</select>
												<button type="submit"
																class="btn btn-primary"
													title="<%= t('.apply', default: 'Apply') %>"
													aria-label="<%= t('.apply', default: 'Apply') %>"
													disabled
													data-menusections-bulk-target="apply"
													data-action="click->menusections-bulk#apply">
													<i class="bi bi-check2"></i>
													<span class="visually-hidden"><%= t('.apply', default: 'Apply') %></span>
												</button>
											</div>
										</div>
									</th>
								<% end %>
							</tr>
						</thead>
						<tbody
							<% unless read_only %>
								data-controller="sortable"
								data-sortable-url-value="<%= reorder_restaurant_menu_menusections_path(restaurant, menu) %>"
								data-sortable-handle-value=".section-handle"
							<% end %>
						>
							<% menu.menusections.order(:sequence).each do |section| %>
								<% row_status_class = section.active? ? 'row-status-active' : (section.archived? ? 'row-status-archived' : 'row-status-inactive') %>
								<% row_status_title = section.active? ? t('menus.sections.details_2025.active', default: 'Active') : (section.archived? ? t('menus.sections.details_2025.archived', default: 'Archived') : t('menus.sections.details_2025.inactive', default: 'Inactive')) %>
								<tr data-sortable-id="<%= section.id %>" class="<%= row_status_class %>" title="<%= row_status_title %>">
									<% unless read_only %>
										<td class="w-40px">
											<input type="checkbox" name="menusection_ids[]" value="<%= section.id %>" data-menusections-bulk-target="checkbox" data-action="change->menusections-bulk#sync" />
										</td>
									<% end %>
									<% if read_only %>
										<td class="w-40px" style="cursor: not-allowed; opacity: 0.55;">
											<i class="bi bi-grip-vertical text-muted"></i>
										</td>
									<% else %>
										<td class="section-handle w-40px cursor-grab">
											<i class="bi bi-grip-vertical text-muted"></i>
										</td>
									<% end %>
									<td>
										<strong><%= section.name %></strong>
									</td>
									<td class="text-end">
										<%= section.menuitems.count %>
									</td>
									<% unless read_only %>
										<td class="text-end">
											<%= link_to edit_restaurant_menu_menusection_path(restaurant, menu, section),
														class: 'd-inline-flex align-items-center justify-content-end text-decoration-none link-secondary',
													title: t('.edit'),
													aria: { label: t('.edit') },
													data: { turbo_frame: '_top', testid: "edit-menusection-#{section.id}-btn" } do %>
												<i class="bi bi-chevron-right"></i>
											<% end %>
										</td>
									<% end %>
								</tr>
							<% end %>
						</tbody>
					</table>
				</div>

				<div class="modal fade" tabindex="-1" aria-hidden="true" data-menusections-bulk-target="modal">
					<div class="modal-dialog modal-dialog-centered">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" data-menusections-bulk-target="modalTitle">Bulk edit</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<div class="d-none" data-menusections-bulk-target="modalBodyArchive">
									<p class="mb-0">
										<%= t('.archive_confirm', default: 'This will archive the selected menu sections. Archived sections will no longer appear in this list.') %>
									</p>
								</div>

								<div class="d-none" data-menusections-bulk-target="modalBodyStatus">
									<label class="form-label"><%= t('.status', default: 'Status') %></label>
									<select class="form-select" data-menusections-bulk-target="modalStatusSelect">
										<option value=""><%= t('.choose_status', default: 'Choose…') %></option>
										<% Menusection.statuses.keys.each do |k| %>
											<option value="<%= k %>"><%= k.to_s.humanize %></option>
										<% end %>
									</select>
								</div>
							</div>
							<div class="modal-footer gap-2">
								<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"><%= t('common.cancel', default: 'Cancel') %></button>
								<button type="button" class="btn btn-primary" data-menusections-bulk-target="modalApply" data-action="click->menusections-bulk#confirmModalApply"><%= t('.apply', default: 'Apply') %></button>
							</div>
						</div>
					</div>
				</div>
			<% end %>
		</div>
	<% else %>
		<!-- Empty State -->
		<div class="text-center py-5">
			<i class="bi bi-layout-text-sidebar text-muted text-3rem"></i>
      <h4 class="mt-3"><%= t('.no_sections') %></h4>
      <p class="text-muted">
        <%= t('.no_sections_desc') %>
      </p>
      <%= link_to new_restaurant_menu_menusection_path(restaurant, menu),
          class: 'btn btn-primary btn-lg mt-3' do %>
        <i class="bi bi-plus-circle"></i>
        <%= t('.add_first_section') %>
      <% end %>
    </div>
  <% end %>
</div>

<style>
  /* Section drag handle styles */
  .section-handle {
    cursor: grab;
    user-select: none;
  }

  .section-handle:active {
    cursor: grabbing;
  }

  /* Sortable states */
  .sortable-ghost {
    opacity: 0.4;
    background: var(--color-primary-light);
  }

  .sortable-drag {
    opacity: 1;
    cursor: grabbing;
  }
</style>
