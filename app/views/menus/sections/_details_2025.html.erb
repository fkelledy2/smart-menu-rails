<%#
  Menu Details Section
  Core menu information and settings
%>

<% menu = local_assigns[:menu] || @menu %>
<% restaurant = local_assigns[:restaurant] || @restaurant || menu.restaurant %>
<% restaurant_menu = local_assigns[:restaurant_menu] || @restaurant_menu %>
<% read_only = local_assigns[:read_only] ? true : false %>

<% menu_smartmenu_slug = menu.smartmenu&.slug %>

<%
  recent_completed_import = begin
    restaurant.ocr_menu_imports.completed.where(menu_id: menu.id).first
  rescue StandardError
    nil
  end

  newly_imported_menu = begin
    recent_completed_import&.completed_at.present?
  rescue StandardError
    false
  end

  missing_image_prompt_count = begin
    menu.menuitems.where.not(itemtype: Menuitem.itemtypes[:wine]).where("COALESCE(image_prompt,'') = ''").count
  rescue StandardError
    0
  end

  has_translation = begin
    active_locales = Restaurantlocale.where(restaurant_id: restaurant.id, status: 'active')
    default_locale = active_locales.find { |x| x.dfault == true }
    non_default = active_locales.reject { |x| default_locale && x.id == default_locale.id }
    non_default.any? && menu.menulocales.where(locale: non_default.map(&:locale)).exists?
  rescue StandardError
    false
  end

  has_any_ai_image = begin
    menu.menuitems.where.not(image_data: [nil, '']).exists?
  rescue StandardError
    false
  end
%>

<% if newly_imported_menu && !read_only %>
  <div class="card mb-3" data-testid="menu-go-live-flow" data-controller="go-live-progress">
    <div class="card-body py-3">
      <% ai_polish_complete = (missing_image_prompt_count.to_i == 0) %>
      <% menu_go_live_steps = [
        { label: 'AI Polish', complete: ai_polish_complete, path: edit_restaurant_menu_path(restaurant, menu, section: 'details') },
        { label: 'Add a translation', complete: has_translation, path: (ai_polish_complete ? edit_restaurant_menu_path(restaurant, menu, section: 'details') : nil) },
        { label: 'Generate AI Images', complete: has_any_ai_image, path: (ai_polish_complete ? edit_restaurant_menu_path(restaurant, menu, section: 'details') : nil) },
        { label: 'Preview as Staff', complete: menu_smartmenu_slug.present?, path: (ai_polish_complete && menu_smartmenu_slug.present? ? smartmenu_path(menu_smartmenu_slug) : nil) },
        { label: 'Preview as Customer', complete: menu_smartmenu_slug.present?, path: (ai_polish_complete && menu_smartmenu_slug.present? ? smartmenu_path(menu_smartmenu_slug, view: 'customer') : nil) },
      ] %>
      <% completed_steps = menu_go_live_steps.count { |s| s[:complete] } %>
      <% total_steps = menu_go_live_steps.size %>
      <% percent_complete = total_steps.positive? ? ((completed_steps.to_f / total_steps) * 100).round : 0 %>
      <% go_live_complete = (completed_steps == total_steps) %>

      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <div class="fw-semibold">Menu go live flow</div>
        </div>
        <div class="d-flex align-items-center gap-3">
          <div class="text-muted small"><%= completed_steps %>/<%= total_steps %></div>
          <button class="btn btn-sm btn-outline-secondary"
                  type="button"
                  aria-expanded="false"
                  aria-controls="go-live-progress-details"
                  data-go-live-progress-target="toggle"
                  data-action="click->go-live-progress#toggle mouseenter->go-live-progress#open">
            <i class="bi bi-chevron-right" data-go-live-progress-target="chevron"></i>
          </button>
        </div>
      </div>

      <div class="progress mt-2" style="height: 8px;" role="progressbar" aria-valuenow="<%= percent_complete %>" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-bar <%= go_live_complete ? 'bg-success' : 'progress-bar-striped progress-bar-animated' %>" style="width: <%= percent_complete %>%;"></div>
      </div>

      <div class="collapse mt-3" id="go-live-progress-details" data-go-live-progress-target="details" data-action="mouseenter->go-live-progress#open mouseleave->go-live-progress#close">
        <div class="row g-2">
          <% menu_go_live_steps.each do |step| %>
            <div class="col-12 col-md-6 col-lg-4">
              <div class="d-flex align-items-start gap-2 small">
                <% if step[:complete] %>
                  <i class="bi bi-check-circle-fill text-success mt-1"></i>
                  <div class="text-muted"><%= step[:label] %></div>
                <% else %>
                  <i class="bi bi-circle text-muted mt-1"></i>
                  <% if step[:path].present? %>
                    <%= link_to step[:label], step[:path], class: 'text-decoration-none', data: { turbo_frame: '_top' } %>
                  <% else %>
                    <div class="text-muted"><%= step[:label] %></div>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if read_only %>
  <% if menu_smartmenu_slug.present? %>
    <div class="mb-3 p-3">
      <h2 class="quick-actions-title">
        <i class="bi bi-lightning-charge"></i>
        <%= t('.quick_actions') %>
      </h2>

      <div class="quick-actions-grid">
        <%= link_to smartmenu_path(menu_smartmenu_slug),
            class: 'quick-action-btn',
            target: '_blank',
            title: t('.preview_staff_title') do %>
          <i class="bi bi-eye"></i>
          <span><%= t('.preview_staff') %></span>
        <% end %>

        <%= link_to smartmenu_path(menu_smartmenu_slug, view: 'customer'),
            class: 'quick-action-btn quick-action-btn-secondary',
            target: '_blank',
            rel: 'noopener noreferrer',
            title: t('.preview_customer_title') do %>
          <i class="bi bi-eye-slash"></i>
          <span><%= t('.preview_customer') %></span>
        <% end %>
      </div>

      <% if restaurant_menu.present? %>
        <div class="mt-3">
          <h3 class="quick-actions-title" style="font-size: 1rem; margin-bottom: 0.75rem;">
            <i class="bi bi-calendar-check"></i>
            <%= t('.availability') %>
          </h3>

          <% availability_value = if restaurant_menu.availability_override_enabled?
            restaurant_menu.availability_state.to_s
          else
            'default'
          end %>

          <%= form_with url: availability_restaurant_restaurant_menu_path(restaurant, restaurant_menu),
                method: :patch,
                data: { turbo_frame: '_top' },
                class: 'd-inline' do |f| %>
            <input type="hidden" name="availability_override_enabled" value="<%= availability_value == 'default' ? 'false' : 'true' %>" />
            <input type="hidden" name="availability_state" value="<%= availability_value == 'default' ? 'available' : availability_value %>" />
            <select class="form-select form-select-sm"
                    name="availability_select"
                    onchange="this.form.querySelector('input[name=availability_override_enabled]').value=(this.value==='default'?'false':'true'); this.form.querySelector('input[name=availability_state]').value=(this.value==='default'?'available':this.value); this.form.requestSubmit();">
              <option value="default" <%= 'selected' if availability_value == 'default' %>><%= t('.default') %></option>
              <option value="available" <%= 'selected' if availability_value == 'available' %>><%= t('.available') %></option>
              <option value="unavailable" <%= 'selected' if availability_value == 'unavailable' %>><%= t('.unavailable') %></option>
            </select>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
<% else %>
  <div class="mb-3 p-3">
    <h2 class="quick-actions-title">
      <i class="bi bi-lightning-charge"></i>
      <%= t('.quick_actions') %>
    </h2>

    <% missing_image_prompt_count = begin
      menu.menuitems.where.not(itemtype: Menuitem.itemtypes[:wine]).where("COALESCE(image_prompt,'') = ''").count
    rescue StandardError
      0
    end %>

    <div class="quick-actions-grid">
      <%= button_to regenerate_images_restaurant_menu_path(restaurant, menu, generate_ai: true),
          method: :post,
          class: 'quick-action-btn',
          data: { turbo: false },
          form: { data: { turbo: false, ai_generate: true, menu_id: menu.id } } do %>
        <i class="bi bi-stars"></i>
        <span><%= t('.generate_images') %></span>
      <% end %>

      <% active_locales = Restaurantlocale.where(restaurant_id: restaurant.id, status: 'active') %>
      <% if active_locales.any? %>
        <%= button_to localize_restaurant_menu_path(restaurant, menu, force: false),
            method: :post,
            class: 'quick-action-btn',
            data: { turbo: false, testid: 'localize-menu-btn' },
            form: { data: { turbo: false, localize: true, menu_id: menu.id } } do %>
          <i class="bi bi-translate"></i>
          <span><%= t('.localize_menu') %></span>
        <% end %>
      <% end %>

      <% if menu_smartmenu_slug.present? %>
        <%= link_to smartmenu_path(menu_smartmenu_slug),
            class: 'quick-action-btn',
            target: '_blank',
            title: t('.preview_staff_title') do %>
          <i class="bi bi-eye"></i>
          <span><%= t('.preview_staff') %></span>
        <% end %>

        <%= link_to smartmenu_path(menu_smartmenu_slug, view: 'customer'),
            class: 'quick-action-btn quick-action-btn-secondary',
            target: '_blank',
            rel: 'noopener noreferrer',
            title: t('.preview_customer_title') do %>
          <i class="bi bi-eye-slash"></i>
          <span><%= t('.preview_customer') %></span>
        <% end %>
      <% end %>

      <%= button_to polish_restaurant_menu_path(restaurant, menu),
          method: :post,
          class: 'quick-action-btn quick-action-btn-secondary',
          data: { turbo: false, testid: 'polish-menu-btn' },
          form: { data: { turbo: false, polish: true, menu_id: menu.id } } do %>
        <i class="bi bi-magic"></i>
        <span><%= t('.ai_polish') %></span>
      <% end %>

      <%# Generate Pairings — only for manager/admin/super_admin when food + drink items exist %>
      <% can_generate_pairings = current_user&.super_admin? || current_user&.manager_employee_for_restaurant?(restaurant.id) %>
      <% if can_generate_pairings
           food_count = menu.menuitems.joins(:menusection).where('menusections.archived IS NOT TRUE').where(itemtype: :food, status: 'active').count
           drink_count = menu.menuitems.joins(:menusection).where('menusections.archived IS NOT TRUE').where(status: 'active').where(itemtype: [:wine, :spirit, :whiskey]).count
           pairings_possible = food_count > 0 && drink_count > 0
         end %>
      <% if can_generate_pairings %>
        <% pairings_tooltip = pairings_possible ?
             "Generate AI pairings — #{food_count} food item#{'s' unless food_count == 1}, #{drink_count} drink item#{'s' unless drink_count == 1} (wine/spirit/whiskey)" :
             "Requires food items (#{food_count}) and wine/spirit/whiskey items (#{drink_count})" %>
        <div data-controller="generate-pairings" data-generate-pairings-url-value="<%= generate_pairings_restaurant_menu_path(restaurant, menu) %>">
          <button type="button"
              class="quick-action-btn quick-action-btn-secondary<%= ' disabled' unless pairings_possible %>"
              <%= 'disabled' unless pairings_possible %>
              data-action="click->generate-pairings#generate"
              data-testid="generate-pairings-btn"
              title="<%= pairings_tooltip %>">
            <i class="bi bi-cup-straw"></i>
            <span><%= t('.generate_pairings', default: 'Generate Pairings') %></span>
          </button>

          <%# Pairings result modal %>
          <div class="modal fade" tabindex="-1" data-generate-pairings-target="modal" aria-labelledby="pairingsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="pairingsModalLabel">
                    <i class="bi bi-cup-straw me-2"></i>AI Food &amp; Drink Pairings
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                  <%# Spinner while generating %>
                  <div data-generate-pairings-target="spinner" class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                      <span class="visually-hidden">Generating…</span>
                    </div>
                    <p class="text-muted">Generating pairings — this may take a moment…</p>
                  </div>
                  <%# Error state %>
                  <div data-generate-pairings-target="error" class="alert alert-danger d-none"></div>
                  <%# Results %>
                  <div data-generate-pairings-target="results" class="d-none">
                    <p class="text-muted mb-3" data-generate-pairings-target="count"></p>
                    <div data-generate-pairings-target="pairingsBody"></div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <%= form_with model: menu,
            url: restaurant_menu_path(restaurant, menu),
            method: :patch,
            local: true,
            data: { turbo: false },
            html: { class: 'd-inline' } do |f| %>
        <%= hidden_field_tag :return_to, 'menu_edit' %>
        <% if menu.active? %>
          <%= hidden_field_tag 'menu[status]', 'inactive', id: 'menu_status_toggle' %>
          <%= hidden_field_tag :status, 'inactive' %>
          <button type="submit" class="quick-action-btn quick-action-btn-secondary menu-status-pill menu-status-pill--active" data-testid="menu-status-toggle-btn">
            <i class="bi bi-toggle2-on"></i>
            <span><%= t('.active', default: 'Active') %></span>
          </button>
        <% else %>
          <%= hidden_field_tag 'menu[status]', 'active', id: 'menu_status_toggle' %>
          <%= hidden_field_tag :status, 'active' %>
          <button type="submit" class="quick-action-btn menu-status-pill menu-status-pill--inactive" data-testid="menu-status-toggle-btn">
            <i class="bi bi-toggle2-off"></i>
            <span><%= t('.inactive', default: 'Inactive') %></span>
          </button>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Menu Overview -->
<div class="mb-3 p-3">
  <h2 class="content-card-title">
    <i class="bi bi-info-circle"></i>
    <%= t('.menu_details') %>
  </h2>

  <% if read_only %>
    <div class="row g-4">
      <div class="col-md-12">
        <div class="form-group-2025">
          <div class="form-label-2025"><%= t('.menu_name') %></div>
          <div class="fw-semibold"><%= menu.name %></div>
        </div>
      </div>

      <div class="col-md-12">
        <div class="form-group-2025">
          <div class="form-label-2025"><%= t('.description') %></div>
          <div class="text-muted"><%= menu.description.presence || '-' %></div>
        </div>
      </div>
    </div>
  <% else %>
    <%= menu_form_with(menu, auto_save: true) do |form| %>
      <div class="row g-4">
        <div class="col-md-12">
          <div class="form-group-2025">
            <%= form.label :name, class: 'form-label-2025' do %>
              <%= t('.menu_name') %>
            <% end %>
            <%= form.text_field :name,
                class: 'form-control-2025',
                placeholder: t('.menu_name_placeholder') %>
            <div class="form-help-2025">
              <%= t('.menu_name_help') %>
            </div>
          </div>
        </div>

        <div class="col-md-12">
          <div class="form-group-2025">
            <%= form.label :description, class: 'form-label-2025' do %>
              <%= t('.description') %>
            <% end %>
            <%= form.text_area :description,
                class: 'form-control-2025',
                rows: 4,
                placeholder: t('.description_placeholder') %>
            <div class="form-help-2025">
              <%= t('.description_help') %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<!-- Menu Statistics -->
<div class="mb-3 p-3">
  <h2 class="content-card-title">
    <i class="bi bi-bar-chart"></i>
    <%= t('.statistics') %>
  </h2>

  <div class="stats-grid">
    <%= link_to edit_restaurant_menu_path(restaurant, menu, section: 'sections'),
                class: 'stat-card text-decoration-none',
                data: { turbo_frame: 'menu_content', turbo_action: 'advance', testid: 'menu-stats-sections-link' } do %>
      <div class="stat-icon bg-primary">
        <i class="bi bi-layout-text-sidebar"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value"><%= menu.menusections.count %></div>
        <div class="stat-label"><%= t('.sections') %></div>
      </div>
    <% end %>

    <%= link_to edit_restaurant_menu_path(restaurant, menu, section: 'items'),
                class: 'stat-card text-decoration-none',
                data: { turbo_frame: 'menu_content', turbo_action: 'advance', testid: 'menu-stats-items-link' } do %>
      <div class="stat-icon bg-success">
        <i class="bi bi-list-ul"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value"><%= (defined?(@menuItemCount) && menu == @menu && @menuItemCount.present?) ? @menuItemCount : menu.menuitems.count %></div>
        <div class="stat-label"><%= t('.items') %></div>
      </div>
    <% end %>

    <%= link_to edit_restaurant_menu_path(restaurant, menu, section: 'schedule'),
                class: 'stat-card text-decoration-none',
                data: { turbo_frame: 'menu_content', turbo_action: 'advance', testid: 'menu-stats-schedules-link' } do %>
      <div class="stat-icon bg-warning">
        <i class="bi bi-calendar-check"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value"><%= menu.menuavailabilities.count %></div>
        <div class="stat-label"><%= t('.schedules') %></div>
      </div>
    <% end %>
  </div>
</div>

<style>
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--color-gray-50);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    flex-shrink: 0;
  }

  .stat-value {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-gray-900);
    line-height: 1;
  }

  .stat-label {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
    margin-top: var(--space-1);
  }

  /* Force Quick Actions into two columns on all viewports (including mobile portrait) */
  .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--space-3);
  }
  .quick-actions-grid .quick-action-btn {
    width: 100%;
    justify-content: center;
  }

  .menu-status-pill.menu-status-pill--active {
    background: #d9f7e1;
    border-color: rgba(25, 135, 84, 0.25);
  }

  .menu-status-pill.menu-status-pill--inactive {
    background: #ffd9e1;
    border-color: rgba(220, 53, 69, 0.25);
  }
</style>
