<%#
  Menu Details Section
  Core menu information and settings
%>

<% menu = local_assigns[:menu] || @menu %>
<% restaurant = local_assigns[:restaurant] || @restaurant || menu.restaurant %>
<% restaurant_menu = local_assigns[:restaurant_menu] || @restaurant_menu %>
<% read_only = local_assigns[:read_only] ? true : false %>

<% menu_smartmenu_slug = Smartmenu.where(restaurant_id: restaurant.id, menu_id: menu.id, tablesetting_id: nil).first&.slug %>

<% if read_only %>
  <% if menu_smartmenu_slug.present? %>
    <div class="quick-actions-card">
      <h2 class="quick-actions-title">
        <i class="bi bi-lightning-charge"></i>
        <%= t('.quick_actions') %>
      </h2>

      <div class="quick-actions-grid">
        <%= link_to smartmenu_path(menu_smartmenu_slug),
            class: 'quick-action-btn',
            target: '_blank',
            title: t('.preview_staff_title') do %>
          <i class="bi bi-eye"></i>
          <span><%= t('.preview_staff') %></span>
        <% end %>

        <%= link_to smartmenu_path(menu_smartmenu_slug, view: 'customer'),
            class: 'quick-action-btn quick-action-btn-secondary',
            target: '_blank',
            rel: 'noopener noreferrer',
            title: t('.preview_customer_title') do %>
          <i class="bi bi-eye-slash"></i>
          <span><%= t('.preview_customer') %></span>
        <% end %>
      </div>

      <% if restaurant_menu.present? %>
        <div class="mt-3">
          <h3 class="quick-actions-title" style="font-size: 1rem; margin-bottom: 0.75rem;">
            <i class="bi bi-calendar-check"></i>
            <%= t('.availability') %>
          </h3>

          <% availability_value = if restaurant_menu.availability_override_enabled?
            restaurant_menu.availability_state.to_s
          else
            'default'
          end %>

          <%= form_with url: availability_restaurant_restaurant_menu_path(restaurant, restaurant_menu),
                method: :patch,
                data: { turbo_frame: '_top' },
                class: 'd-inline' do |f| %>
            <input type="hidden" name="availability_override_enabled" value="<%= availability_value == 'default' ? 'false' : 'true' %>" />
            <input type="hidden" name="availability_state" value="<%= availability_value == 'default' ? 'available' : availability_value %>" />
            <select class="form-select form-select-sm"
                    name="availability_select"
                    onchange="this.form.querySelector('input[name=availability_override_enabled]').value=(this.value==='default'?'false':'true'); this.form.querySelector('input[name=availability_state]').value=(this.value==='default'?'available':this.value); this.form.requestSubmit();">
              <option value="default" <%= 'selected' if availability_value == 'default' %>><%= t('.default') %></option>
              <option value="available" <%= 'selected' if availability_value == 'available' %>><%= t('.available') %></option>
              <option value="unavailable" <%= 'selected' if availability_value == 'unavailable' %>><%= t('.unavailable') %></option>
            </select>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
<% else %>
  <div class="quick-actions-card">
    <h2 class="quick-actions-title">
      <i class="bi bi-lightning-charge"></i>
      <%= t('.quick_actions') %>
    </h2>

    <div class="quick-actions-grid">
      <%= button_to regenerate_images_restaurant_menu_path(restaurant, menu, generate_ai: true),
          method: :post,
          class: 'quick-action-btn',
          data: { turbo: false },
          form: { data: { turbo: false, ai_generate: true, menu_id: menu.id } } do %>
        <i class="bi bi-stars"></i>
        <span><%= t('.generate_images') %></span>
      <% end %>

      <% active_locales = Restaurantlocale.where(restaurant_id: restaurant.id, status: 'active') %>
      <% if active_locales.any? %>
        <%= button_to localize_restaurant_menu_path(restaurant, menu, force: false),
            method: :post,
            class: 'quick-action-btn',
            data: { turbo: false, testid: 'localize-menu-btn' },
            form: { data: { turbo: false, localize: true, menu_id: menu.id } } do %>
          <i class="bi bi-translate"></i>
          <span><%= t('.localize_menu') %></span>
        <% end %>
      <% end %>

      <% if menu_smartmenu_slug.present? %>
        <%= link_to smartmenu_path(menu_smartmenu_slug),
            class: 'quick-action-btn',
            target: '_blank',
            title: t('.preview_staff_title') do %>
          <i class="bi bi-eye"></i>
          <span><%= t('.preview_staff') %></span>
        <% end %>

        <%= link_to smartmenu_path(menu_smartmenu_slug, view: 'customer'),
            class: 'quick-action-btn quick-action-btn-secondary',
            target: '_blank',
            rel: 'noopener noreferrer',
            title: t('.preview_customer_title') do %>
          <i class="bi bi-eye-slash"></i>
          <span><%= t('.preview_customer') %></span>
        <% end %>
      <% end %>

      <%= button_to polish_restaurant_menu_path(restaurant, menu),
          method: :post,
          class: 'quick-action-btn quick-action-btn-secondary',
          data: { turbo: false, testid: 'polish-menu-btn' },
          form: { data: { turbo: false, polish: true, menu_id: menu.id } } do %>
        <i class="bi bi-magic"></i>
        <span><%= t('.ai_polish') %></span>
      <% end %>

      <%= form_with model: menu,
            url: restaurant_menu_path(restaurant, menu),
            method: :patch,
            local: true,
            data: { turbo: false },
            html: { class: 'd-inline' } do |f| %>
        <%= hidden_field_tag :return_to, 'menu_edit' %>
        <% if menu.active? %>
          <%= hidden_field_tag 'menu[status]', 'inactive' %>
          <%= hidden_field_tag :status, 'inactive' %>
          <button type="submit" class="quick-action-btn quick-action-btn-secondary" data-testid="menu-status-toggle-btn">
            <i class="bi bi-toggle2-off"></i>
            <span><%= t('.active') %></span>
          </button>
        <% else %>
          <%= hidden_field_tag 'menu[status]', 'active' %>
          <%= hidden_field_tag :status, 'active' %>
          <button type="submit" class="quick-action-btn" data-testid="menu-status-toggle-btn">
            <i class="bi bi-toggle2-on"></i>
            <span><%= t('.inactive') %></span>
          </button>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Menu Overview -->
<div class="content-card-2025">
  <h2 class="content-card-title">
    <i class="bi bi-info-circle"></i>
    <%= t('.menu_details') %>
  </h2>

  <% if read_only %>
    <div class="row g-4">
      <div class="col-md-12">
        <div class="form-group-2025">
          <div class="form-label-2025"><%= t('.menu_name') %></div>
          <div class="fw-semibold"><%= menu.name %></div>
        </div>
      </div>

      <div class="col-md-12">
        <div class="form-group-2025">
          <div class="form-label-2025"><%= t('.description') %></div>
          <div class="text-muted"><%= menu.description.presence || '-' %></div>
        </div>
      </div>
    </div>
  <% else %>
    <%= menu_form_with(menu, auto_save: true) do |form| %>
      <div class="row g-4">
        <div class="col-md-12">
          <div class="form-group-2025">
            <%= form.label :name, class: 'form-label-2025' do %>
              <%= t('.menu_name') %>
            <% end %>
            <%= form.text_field :name,
                class: 'form-control-2025',
                placeholder: t('.menu_name_placeholder') %>
            <div class="form-help-2025">
              <%= t('.menu_name_help') %>
            </div>
          </div>
        </div>

        <div class="col-md-12">
          <div class="form-group-2025">
            <%= form.label :description, class: 'form-label-2025' do %>
              <%= t('.description') %>
            <% end %>
            <%= form.text_area :description,
                class: 'form-control-2025',
                rows: 4,
                placeholder: t('.description_placeholder') %>
            <div class="form-help-2025">
              <%= t('.description_help') %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<!-- Menu Statistics -->
<div class="content-card-2025">
  <h2 class="content-card-title">
    <i class="bi bi-bar-chart"></i>
    <%= t('.statistics') %>
  </h2>

  <div class="stats-grid">
    <%= link_to edit_restaurant_menu_path(restaurant, menu, section: 'sections'),
                class: 'stat-card text-decoration-none',
                data: { turbo_frame: 'menu_content', turbo_action: 'advance', testid: 'menu-stats-sections-link' } do %>
      <div class="stat-icon bg-primary">
        <i class="bi bi-layout-text-sidebar"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value"><%= menu.menusections.count %></div>
        <div class="stat-label"><%= t('.sections') %></div>
      </div>
    <% end %>

    <%= link_to edit_restaurant_menu_path(restaurant, menu, section: 'items'),
                class: 'stat-card text-decoration-none',
                data: { turbo_frame: 'menu_content', turbo_action: 'advance', testid: 'menu-stats-items-link' } do %>
      <div class="stat-icon bg-success">
        <i class="bi bi-list-ul"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value"><%= (defined?(@menuItemCount) && menu == @menu && @menuItemCount.present?) ? @menuItemCount : menu.menuitems.count %></div>
        <div class="stat-label"><%= t('.items') %></div>
      </div>
    <% end %>

    <%= link_to edit_restaurant_menu_path(restaurant, menu, section: 'schedule'),
                class: 'stat-card text-decoration-none',
                data: { turbo_frame: 'menu_content', turbo_action: 'advance', testid: 'menu-stats-schedules-link' } do %>
      <div class="stat-icon bg-warning">
        <i class="bi bi-calendar-check"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value"><%= menu.menuavailabilities.count %></div>
        <div class="stat-label"><%= t('.schedules') %></div>
      </div>
    <% end %>
  </div>
</div>

<style>
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--color-gray-50);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    flex-shrink: 0;
  }

  .stat-value {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-gray-900);
    line-height: 1;
  }

  .stat-label {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
    margin-top: var(--space-1);
  }

  /* Force Quick Actions into two columns on all viewports (including mobile portrait) */
  .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--space-3);
  }
  .quick-actions-grid .quick-action-btn {
    width: 100%;
    justify-content: center;
  }
</style>
