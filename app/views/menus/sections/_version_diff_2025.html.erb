<% menu = local_assigns[:menu] || @menu %>
<% restaurant = local_assigns[:restaurant] || @restaurant || menu.restaurant %>
<% from_version = local_assigns[:from_version] %>
<% to_version = local_assigns[:to_version] %>
<% diff = local_assigns[:diff] || {} %>

<% can_view_snapshot_json = begin
  if current_user && restaurant
    owner = restaurant.user_id.to_i == current_user.id.to_i
    emp = current_user.employees.where(restaurant_id: restaurant.id, status: :active).first
    owner || (emp && (emp.manager? || emp.admin?))
  else
    false
  end
rescue StandardError
  false
end %>

<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <div class="fw-semibold">
          <%= t('.diff_title', default: 'Diff') %>
          v<%= from_version.version_number %> → v<%= to_version.version_number %>
        </div>
        <div class="text-muted small">
          <%= t('.diff_subtitle', default: 'Changes between snapshots') %>
        </div>
      </div>

      <% if can_view_snapshot_json %>
        <%= link_to version_diff_restaurant_menu_path(restaurant, menu, from_version.id, to_version.id),
            class: 'btn btn-outline-secondary btn-sm',
            data: { turbo: false } do %>
          <i class="bi bi-code-slash"></i>
          <%= t('.view_json', default: 'View JSON') %>
        <% end %>
      <% end %>
    </div>

    <% sections = diff[:sections] || {} %>
    <% items = diff[:items] || {} %>

    <div class="mt-3">
      <h4 class="h6 mb-2"><i class="bi bi-layout-text-sidebar"></i> <%= t('.sections', default: 'Sections') %></h4>

      <% if Array(sections[:added]).any? %>
        <div class="mb-2">
          <div class="text-muted small mb-1"><%= t('.added', default: 'Added') %></div>
          <ul class="mb-0">
            <% sections[:added].each do |s| %>
              <li>#<%= s[:id] %> · <%= s[:name] %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% if Array(sections[:removed]).any? %>
        <div class="mb-2">
          <div class="text-muted small mb-1"><%= t('.removed', default: 'Removed') %></div>
          <ul class="mb-0">
            <% sections[:removed].each do |s| %>
              <li>#<%= s[:id] %> · <%= s[:name] %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% if Array(sections[:changed]).any? %>
        <div class="mb-2">
          <div class="text-muted small mb-1"><%= t('.changed', default: 'Changed') %></div>
          <div class="d-flex flex-column gap-2">
            <% sections[:changed].each do |c| %>
              <div class="border rounded p-2">
                <div class="fw-semibold mb-1">Section #<%= c[:id] %></div>
                <ul class="mb-0">
                  <% Array(c[:changes]).each do |ch| %>
                    <li><code><%= ch[:field] %></code>: <%= ch[:from].inspect %> → <%= ch[:to].inspect %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% unless Array(sections[:added]).any? || Array(sections[:removed]).any? || Array(sections[:changed]).any? %>
        <div class="text-muted small"><%= t('.no_section_changes', default: 'No section changes.') %></div>
      <% end %>
    </div>

    <div class="mt-4">
      <h4 class="h6 mb-2"><i class="bi bi-list-ul"></i> <%= t('.items', default: 'Items') %></h4>

      <% if Array(items[:added]).any? %>
        <div class="mb-2">
          <div class="text-muted small mb-1"><%= t('.added', default: 'Added') %></div>
          <ul class="mb-0">
            <% items[:added].each do |it| %>
              <li>#<%= it[:id] %> · <%= it[:name] %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% if Array(items[:removed]).any? %>
        <div class="mb-2">
          <div class="text-muted small mb-1"><%= t('.removed', default: 'Removed') %></div>
          <ul class="mb-0">
            <% items[:removed].each do |it| %>
              <li>#<%= it[:id] %> · <%= it[:name] %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% if Array(items[:changed]).any? %>
        <div class="mb-2">
          <div class="text-muted small mb-1"><%= t('.changed', default: 'Changed') %></div>
          <div class="d-flex flex-column gap-2">
            <% items[:changed].each do |c| %>
              <div class="border rounded p-2">
                <div class="fw-semibold mb-1">Item #<%= c[:id] %></div>
                <ul class="mb-0">
                  <% Array(c[:changes]).each do |ch| %>
                    <li><code><%= ch[:field] %></code>: <%= ch[:from].inspect %> → <%= ch[:to].inspect %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% unless Array(items[:added]).any? || Array(items[:removed]).any? || Array(items[:changed]).any? %>
        <div class="text-muted small"><%= t('.no_item_changes', default: 'No item changes.') %></div>
      <% end %>
    </div>
  </div>
</div>
