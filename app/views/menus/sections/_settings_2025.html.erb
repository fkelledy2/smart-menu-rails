<%#
  Menu Settings Section
  Core configuration toggles for individual menu
%>

<% menu = local_assigns[:menu] || @menu %>
<% restaurant = menu.restaurant %>

<!-- General Settings card removed: status moved to Quick Actions -->

<!-- Feature Toggles -->
<div class="content-card-2025">
  <h2 class="content-card-title">
    <i class="bi bi-sliders"></i>
    <%= t('.feature_toggles', default: 'Feature Toggles') %>
  </h2>

  <%= menu_form_with(menu, auto_save: true) do |form| %>
  <div class="features-grid">
    <!-- Display Images -->
    <div class="feature-card <%= 'feature-card-disabled' unless restaurant.displayImages %>">
      <div class="feature-card-icon bg-primary">
        <i class="bi bi-image"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title">
          <%= t('.display_images', default: 'Display Images') %>
        </h5>
        <p class="feature-card-description">
          <%= t('.display_images_help', default: 'Show menu item images in this menu') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <% unless restaurant.displayImages %>
          <span class="badge bg-warning text-dark">
            <i class="bi bi-lock"></i> <%= t('.disabled_at_restaurant', default: 'Disabled at restaurant level') %>
          </span>
        <% end %>
        <div class="form-check form-switch">
          <input type="hidden" name="menu[displayImages]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="menu[displayImages]"
                 id="menu_displayImages_settings"
                 value="true"
                 <%= 'checked' if menu.displayImages %>
                 <%= 'disabled' unless restaurant.displayImages %>
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <!-- Display Images in Popup -->
    <div id="feature-card-popup" class="feature-card <%= 'feature-card-disabled' unless (restaurant.displayImagesInPopup && menu.displayImages) %>">
      <div class="feature-card-icon bg-success">
        <i class="bi bi-window-stack"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title">
          <%= t('.display_images_popup', default: 'Display Images in Popup') %>
        </h5>
        <p class="feature-card-description">
          <%= t('.display_images_popup_help', default: 'Open menu item images in a popup modal when clicked') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <% unless restaurant.displayImagesInPopup %>
          <span class="badge bg-warning text-dark">
            <i class="bi bi-lock"></i> <%= t('.disabled_at_restaurant', default: 'Disabled at restaurant level') %>
          </span>
        <% end %>
        <div class="form-check form-switch">
          <input type="hidden" name="menu[displayImagesInPopup]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="menu[displayImagesInPopup]"
                 id="menu_displayImagesInPopup_settings"
                 value="true"
                 <%= 'checked' if menu.displayImagesInPopup %>
                 <%= 'disabled' unless (restaurant.displayImagesInPopup && menu.displayImages) %>
                 data-rest-enabled="<%= restaurant.displayImagesInPopup %>"
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <!-- Allow Ordering -->
    <div class="feature-card <%= 'feature-card-disabled' unless restaurant.allowOrdering %>">
      <div class="feature-card-icon bg-warning">
        <i class="bi bi-cart-check"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title">
          <%= t('.allow_ordering', default: 'Allow Ordering') %>
        </h5>
        <p class="feature-card-description">
          <%= t('.allow_ordering_help', default: 'Enable online ordering for this menu') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <% unless restaurant.allowOrdering %>
          <span class="badge bg-warning text-dark">
            <i class="bi bi-lock"></i> <%= t('.disabled_at_restaurant', default: 'Disabled at restaurant level') %>
          </span>
        <% end %>
        <div class="form-check form-switch">
          <input type="hidden" name="menu[allowOrdering]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="menu[allowOrdering]"
                 id="menu_allowOrdering_settings"
                 value="true"
                 <%= 'checked' if menu.allowOrdering %>
                 <%= 'disabled' unless restaurant.allowOrdering %>
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <!-- Inventory Tracking -->
    <div class="feature-card">
      <div class="feature-card-icon bg-danger">
        <i class="bi bi-boxes"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.inventory_tracking', default: 'Inventory Tracking') %></h5>
        <p class="feature-card-description">
          <%= t('.inventory_tracking_help', default: 'Track stock levels for menu items (Coming Soon)') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input class="form-check-input"
                 type="checkbox"
                 name="menu[inventoryTracking]"
                 id="menu_inventoryTracking_settings"
                 value="true"
                 <%= 'checked' if menu.inventoryTracking %>
                 data-skip-tomselect="true"
                 disabled>
        </div>
      </div>
    </div>
  </div>
  <% end %>
</div>

<!-- Settings Info -->
<div class="content-card-2025 bg-light">
  <div class="d-flex align-items-start gap-3">
    <div class="text-primary" style="font-size: 1.5rem;">
      <i class="bi bi-info-circle"></i>
    </div>
    <div>
      <h4 class="mb-2"><%= t('.settings_info_title', default: 'About Menu Settings') %></h4>
      <p class="text-sm text-muted mb-2">
        <%= t('.settings_info_desc', default: 'These settings control functionality for this specific menu. Changes are saved automatically.') %>
      </p>
      <p class="text-sm text-muted mb-2">
        <i class="bi bi-lock"></i> <strong><%= t('.parent_restriction', default: 'Note:') %></strong>
        <%= t('.parent_restriction_desc', default: 'Settings disabled at the restaurant level cannot be enabled for individual menus. Enable them at the restaurant level first.') %>
      </p>
      <ul class="text-sm text-muted mb-0 ps-3">
        <li><strong><%= t('.status', default: 'Status') %>:</strong> <%= t('.status_info', default: 'Controls menu visibility') %></li>
        <li><strong><%= t('.display_images', default: 'Display Images') %>:</strong> <%= t('.images_info', default: 'Toggle menu item photos') %></li>
        <li><strong><%= t('.display_images_popup', default: 'Images in Popup') %>:</strong> <%= t('.popup_info', default: 'Full-screen image viewing') %></li>
        <li><strong><%= t('.allow_ordering', default: 'Allow Ordering') %>:</strong> <%= t('.ordering_info', default: 'Enable customer orders') %></li>
      </ul>
    </div>
  </div>
</div>

<style>
  /* Feature Grid Layout */
  .features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-4);
  }

  .feature-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    padding: var(--space-4);
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
  }

  .feature-card:hover {
    border-color: var(--color-gray-300);
    box-shadow: var(--shadow-sm);
  }

  .feature-card-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .feature-card-content {
    flex: 1;
  }

  .feature-card-title {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    margin: 0 0 var(--space-2) 0;
    color: var(--color-gray-900);
  }

  .feature-card-description {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
    margin: 0;
    line-height: 1.5;
  }

  .feature-card-toggle {
    padding-top: var(--space-2);
    border-top: 1px solid var(--color-gray-100);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: var(--space-2);
  }

  .feature-card-toggle .form-switch {
    display: flex;
    justify-content: flex-end;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .features-grid {
      grid-template-columns: 1fr;
    }
  }

  .bg-light {
    background: var(--color-gray-50) !important;
  }

  /* Disabled feature card styling */
  .feature-card-disabled {
    opacity: 0.7;
    background: var(--color-gray-50);
  }

  .feature-card-disabled .feature-card-icon {
    opacity: 0.5;
  }

  .feature-card-disabled .feature-card-title {
    color: var(--color-gray-600);
  }

  .feature-card-disabled:hover {
    border-color: var(--color-gray-200);
    box-shadow: none;
    cursor: not-allowed;
  }

  .feature-card-disabled .form-check-input:disabled {
    cursor: not-allowed;
  }

  .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    font-weight: normal;
  }
</style>

<script>
  (function(){
    function applyPopupDependency(){
      const displayImages = document.getElementById('menu_displayImages_settings');
      const popup = document.getElementById('menu_displayImagesInPopup_settings');
      const card = document.getElementById('feature-card-popup');
      if(!displayImages || !popup || !card) return;

      const restEnabled = (popup.getAttribute('data-rest-enabled') === 'true');
      if (!displayImages.checked) {
        // Rule 1: if Display Images is false -> disable popup and set false
        popup.checked = false;
        popup.disabled = true;
        card.classList.add('feature-card-disabled');
      } else {
        // Rule 2: if Display Images true -> enable popup if allowed by restaurant
        popup.disabled = !restEnabled;
        if (restEnabled) {
          card.classList.remove('feature-card-disabled');
        } else {
          card.classList.add('feature-card-disabled');
        }
      }
    }

    function ready(fn){
      if (document.readyState !== 'loading') return fn();
      document.addEventListener('DOMContentLoaded', fn);
    }

    ready(applyPopupDependency);
    document.addEventListener('turbo:load', applyPopupDependency);
    document.addEventListener('turbo:frame-load', applyPopupDependency);
    document.addEventListener('change', function(e){
      if (e.target && e.target.id === 'menu_displayImages_settings') {
        applyPopupDependency();
      }
    });
  })();
</script>
