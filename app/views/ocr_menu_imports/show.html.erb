<div data-controller="sidebar">
  <div class="container-fluid px-0 py-3 bg-white border-bottom sticky-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900 mb-1">
          <%= @restaurant.name %>
        </h1>
        <p class="text-sm text-gray-500">
          <%= t('restaurants.edit_2025.subtitle', default: 'Manage your restaurant configuration') %>
        </p>
      </div>

      <button type="button"
              class="sidebar-toggle-btn"
              data-action="click->sidebar#toggle"
              aria-label="<%= t('restaurants.edit_2025.toggle_navigation', default: 'Toggle navigation') %>">
        <i class="bi bi-list" style="pointer-events: none;"></i>
      </button>
    </div>
  </div>

  <div class="sidebar-content-container">
    <%= render 'restaurants/sidebar_2025', restaurant: @restaurant, current_section: 'import' %>

    <div class="sidebar-main-content">
      <div class="py-4 px-3 px-md-4" data-controller="menu-import" data-menu-import-progress-url-value="<%= progress_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>" data-menu-import-polish-url-value="<%= polish_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>" data-menu-import-polish-progress-url-value="<%= polish_progress_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>">
        <div class="mb-3 d-flex justify-content-end">
          <%= link_to edit_restaurant_path(@restaurant, section: 'import'),
              class: 'btn btn-outline-secondary',
              data: { turbo_frame: '_top' } do %>
            <i class="bi bi-arrow-left me-1" aria-hidden="true"></i> <%= t('.back_to_imports', default: 'Back to Imports') %>
          <% end %>
        </div>

  <div class="d-flex justify-content-between align-items-start mb-4 flex-wrap">
    <div class="mb-3 mb-md-0">
      <h3 class="h3 mb-2 import-title-editable"
          data-import-id="<%= @ocr_menu_import.id %>"
          data-update-url="<%= restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>">
        <%= @ocr_menu_import.name.presence || t('.default_title', id: @ocr_menu_import.id) %>
        <span class="edit-indicator text-secondary ms-2">
          <i class="bi bi-pencil" aria-hidden="true"></i>
        </span>
      </h3>
      <div class="d-flex flex-wrap gap-3 text-muted small">
        <div class="d-flex align-items-center">
          <i class="bi bi-calendar3 me-1" aria-hidden="true"></i>
          <span><%= t('.imported_ago', time: time_ago_in_words(@ocr_menu_import.created_at)) %></span>
        </div>
        <div class="d-flex align-items-center">
          <i class="bi bi-clock-history me-1" aria-hidden="true"></i>
          <span><%= t('.updated_at', timestamp: @ocr_menu_import.updated_at.strftime('%B %d, %Y at %I:%M %p')) %></span>
        </div>
      </div>
    </div>
    <div class="d-flex gap-2">
      <% if @ocr_menu_import.completed? %>
        <button type="button" class="btn btn-outline-primary" data-action="click->menu-import#startPolish" data-menu-import-target="polishButton">
          <i class="bi bi-magic me-1" aria-hidden="true"></i> AI Polish
        </button>
      <% end %>
      <% if @ocr_menu_import.may_process? %>
        <%= button_to process_pdf_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import),
            method: :post,
            class: 'btn btn-primary',
            form: { data: { turbo_confirm: t('.process_confirm') } } do %>
          <i class="bi bi-gear me-1" aria-hidden="true"></i> <%= t('.process_pdf') %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Progress Slider -->
  <%
    # Calculate progress percentage based on status
    progress_percent = if @ocr_menu_import.completed?
                        100
                      elsif @ocr_menu_import.processing?
                        @ocr_menu_import.progress || 50
                      elsif @ocr_menu_import.pending?
                        25
                      else
                        0
                      end
  %>
  <div class="card mb-2">
    <div class="card-body py-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted small">0%</span>
        <span class="fw-bold" data-menu-import-target="overallPercent"><%= progress_percent %>%</span>
        <span class="text-muted small">100%</span>
      </div>
      <div class="progress-slider-container">
        <input type="range"
               class="progress-slider"
               min="0"
               max="100"
               value="<%= progress_percent %>"
               autocomplete="off"
               disabled
               data-menu-import-target="overallSlider"
               style="width: 100%;">
        <div class="progress-slider-track">
          <div class="progress-slider-fill" data-menu-import-target="overallFill" style="width: <%= progress_percent %>%;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h3 class="h5 mb-0"><%= t('.import_details') %></h3>
      <p class="mb-0">
        <%= t('.status') %> <%= status_badge(@ocr_menu_import.status) %>
        <% if @ocr_menu_import.processing? && @ocr_menu_import.progress.present? %>
          <span class="ms-2">(<%= @ocr_menu_import.progress %>%)</span>
        <% end %>
      </p>
    </div>

    <div class="card-body">
      <% if @ocr_menu_import.processing? %>
        <div class="text-center py-4">
          <div class="spinner-border text-primary mb-2" role="status">
            <span class="visually-hidden"><%= t('.progress_loading') %></span>
          </div>
          <p class="text-muted mb-2" data-menu-import-target="phaseText"><%= t('.processing_title') %></p>
          <p class="text-muted small mb-4" data-menu-import-target="pageText"><%= t('.processing_page', current: (@ocr_menu_import.current_page || 1), total: (@ocr_menu_import.total_pages || '?')) %></p>

          <div class="progress mb-2 progress-bar-10">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 style="width: <%= @ocr_menu_import.progress || 0 %>%"
                 aria-valuenow="<%= @ocr_menu_import.progress || 0 %>"
                 aria-valuemin="0"
                 aria-valuemax="100">
            </div>
          </div>
          <p class="text-muted small" data-menu-import-target="phasePercent"><%= t('.progress_complete', percent: (@ocr_menu_import.progress || 0)) %></p>
        </div>

        <%= turbo_stream_from @ocr_menu_import %>
          <div id="<%= dom_id(@ocr_menu_import) %>_status">
            <!-- Turbo will update this when the status changes -->
          </div>
        <% elsif @ocr_menu_import.failed? %>
          <div class="alert alert-danger">
            <div class="d-flex">
              <div class="flex-shrink-0 me-3">
                <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
              </div>
              <div>
                <h5 class="alert-heading"><%= t('.failed_heading') %></h5>
                <p class="mb-0"><%= @ocr_menu_import.error_message %></p>
                <div class="mt-3">
                  <%= button_to t('.try_again'),
                      process_pdf_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import),
                      method: :post,
                      class: 'btn btn-outline-danger btn-sm' %>
                </div>
              </div>
            </div>
          </div>
        <% elsif @ocr_menu_import.completed? && @ocr_menu_import.ocr_menu_sections.none? %>
          <div class="alert alert-warning">
            <div class="d-flex">
              <div class="flex-shrink-0 me-3">
                <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
              </div>
              <div>
                <h5 class="alert-heading"><%= t('.no_items_heading') %></h5>
                <p class="mb-2"><%= t('.no_items_explainer') %></p>
                <ul class="mb-3">
                  <li><%= t('.no_items_tip1') %></li>
                  <li><%= t('.no_items_tip2') %></li>
                  <li><%= t('.no_items_tip3') %></li>
                </ul>
                <div class="d-flex gap-2">
                  <% if @ocr_menu_import.may_process? %>
                    <%= button_to t('.try_again'),
                        process_pdf_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import),
                        method: :post,
                        class: 'btn btn-outline-primary btn-sm' %>
                  <% end %>
                  <%= link_to t('.upload_clearer_pdf'), new_restaurant_ocr_menu_import_path(@restaurant), class: 'btn btn-outline-secondary btn-sm' %>
                </div>
              </div>
            </div>
          </div>
        <% elsif @ocr_menu_import.completed? && @ocr_menu_import.ocr_menu_sections.any? %>
          <div class="mb-4">
            <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center mb-4">
              <div class="mb-3 mb-md-0">
                <h2 class="h4 mb-1"><%= t('.imported_menu_title') %></h2>
              </div>
              <div class="w-100 w-md-auto">
                <button type="button"
                        class="btn btn-danger btn-lg w-100 w-md-auto publish-btn"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmModal">
                  <i class="bi bi-check-circle me-1" aria-hidden="true"></i> <%= t('.publish') %>
                </button>
              </div>
            </div>

            <div class="border-top pt-4">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="col-1">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="confirm_all_sections"
                             data-role="confirm-all-sections"
                             data-toggle-all-url="<%= toggle_all_confirmation_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>">
                    </div>
                </div>
                <div class="col-11">
                      <label class="form-check-label" for="confirm_all_sections">
                          <%= t('.approve_sections_items') %>
                      </label>
                </div>
              </div>
              <div id="sections-sortable"
                   class="vstack gap-1"
                   data-reorder-url="<%= reorder_sections_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>"
                   data-reorder-items-url="<%= reorder_items_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>">
                <% @ocr_menu_import.ocr_menu_sections.ordered.each do |section| %>
                    <div class="row">
                        <div class="col-1">
                          <div class="form-check me-2" data-role="section-confirmation">
                              <input class="form-check-input" type="checkbox"
                                     id="confirm_section_<%= section.id %>"
                                     data-section-id="<%= section.id %>"
                                     data-toggle-url="<%= toggle_section_confirmation_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>"
                                     <%= 'checked' if section.is_confirmed %>>
                              <label class="form-check-label" for="confirm_section_<%= section.id %>"></label>
                          </div>
                        </div>
                        <div class="col-11">
                          <% section_alcohol_class = AlcoholDetectionService.section_class_from_text(section.name) %>
                          <% show_alcohol_ui = section_alcohol_class.present? %>
                          <div class="card shadow-sm mb-3"
                               data-controller="menu-section"
                                data-menu-section-section-id="<%= section.id %>"
                                data-section-id="<%= section.id %>"
                                draggable="true">
                            <div class="card-header d-flex justify-content-between align-items-start"
                                 role="button"
                                 data-bs-toggle="collapse"
                                 data-bs-target="#section-<%= section.id %>-items"
                                 aria-expanded="false"
                                 aria-controls="section-<%= section.id %>-items">
                              <div class="flex-grow-1 d-flex align-items-center gap-2">
                                <h3 class="h5 mb-0"><%= section.name %></h3>
                              </div>
                              <span class="btn btn-sm btn-outline-secondary px-2 py-1">
                                <i class="bi bi-chevron-down" aria-hidden="true"></i>
                                <i class="section-drag-handle bi bi-grip-vertical" aria-hidden="true"></i>
                              </span>
                            </div>

                            <% if section.respond_to?(:description) && section.description.present? %>
                              <div class="py-2 px-3 text-muted"><%= section.description %></div>
                            <% else %>
                              <div class="py-2 px-3 text-muted"><%= t('.click_to_add_description') %></div>
                            <% end %>

                            <div class="collapse" id="section-<%= section.id %>-items" data-menu-section-target="content">
                              <div class="card-body">
                                <div class="vstack gap-3">
                                  <% section.ocr_menu_items.ordered.each do |item| %>
                                    <% det = show_alcohol_ui ? AlcoholDetectionService.detect(section_name: section.name, item_name: item.name, item_description: item.description) : nil %>
                                    <% ov = (item.metadata || {}) %>
                                    <% effective = det || {}; if show_alcohol_ui && ov['alcohol_override'].present? %>
                                      <% case ov['alcohol_override'].to_s %>
                                      <% when 'alcoholic' %>
                                        <% effective = { decided: true, alcoholic: true, classification: ov['alcohol_classification'].presence || det&.dig(:classification), abv: ov['alcohol_abv'].presence || det&.dig(:abv), confidence: 1.0, note: 'override' } %>
                                      <% when 'non_alcoholic' %>
                                        <% effective = { decided: true, alcoholic: false, classification: 'non_alcoholic', abv: ov['alcohol_abv'].presence || det&.dig(:abv), confidence: 1.0, note: 'override' } %>
                                      <% end %>
                                    <% end %>
                                    <div class="p-0 item-row" data-item-id="<%= item.id %>">
                                      <div class="d-flex justify-content-between align-items-start mb-1">
                                        <div class="me-4 fw-semibold d-flex align-items-center gap-2 flex-wrap">
                                          <span><%= item.name %></span>
                                          <% if show_alcohol_ui %>
                                            <% if effective && effective[:decided] %>
                                              <% if effective[:alcoholic] %>
                                                <span class="badge bg-danger" title="<%= t('smartmenus.alcohol.flag', default: 'Alcohol') %>"><%= t('smartmenus.alcohol.flag', default: 'Alcohol') %></span>
                                              <% else %>
                                                <span class="badge bg-secondary" title="<%= t('smartmenus.alcohol.non_alcoholic', default: 'Non-alcoholic') %>"><%= t('smartmenus.alcohol.non_alcoholic', default: 'Non-alcoholic') %></span>
                                              <% end %>
                                              <% if effective[:abv] %>
                                                <span class="badge bg-light text-dark border"><%= sprintf('%.1f%%', effective[:abv].to_f) %></span>
                                              <% end %>
                                            <% else %>
                                              <span class="badge bg-warning text-dark" title="<%= t('smartmenus.ocr.alcohol.review_needed', default: 'Needs review') %>"><%= t('smartmenus.ocr.alcohol.review_needed', default: 'Needs review') %></span>
                                            <% end %>
                                          <% end %>
                                        </div>
                                        <span class="text-nowrap px-0 py-1">
                                            <%= number_to_currency(item.price, unit: @restaurantCurrency&.symbol || "$") %>
                                            &nbsp;
                                            <span class="btn btn-sm btn-outline-secondary">
                                                <i class="bi bi-pencil"
                                                 data-bs-toggle="modal"
                                                 data-bs-target="#editItemModal"
                                                 data-item-id="<%= item.id %>"
                                                 data-item-name="<%= item.name %>"
                                                 data-item-description="<%= item.description.to_s %>"
                                                 data-item-image-prompt="<%= item.respond_to?(:image_prompt) ? item.image_prompt.to_s : '' %>"
                                                 data-item-price="<%= item.price %>"
                                                 data-item-allergens='<%= (item.allergens || []).to_json %>'
                                                 data-item-section="<%= section.id %>"
                                                 data-item-position="<%= item.sequence %>"
                                                 data-item-dietary-restrictions='[
                                                   <%= (item.respond_to?(:is_vegetarian) && item.is_vegetarian) ? '"vegetarian"' : nil %>
                                                   <%= (item.respond_to?(:is_vegan) && item.is_vegan) ? ', "vegan"' : nil %>
                                                   <%= (item.respond_to?(:is_gluten_free) && item.is_gluten_free) ? ', "gluten_free"' : nil %>
                                                   <%= (item.respond_to?(:is_dairy_free) && item.is_dairy_free) ? ', "dairy_free"' : nil %>
                                                   <%= (item.respond_to?(:is_nut_free) && item.is_nut_free) ? ', "nut_free"' : nil %>
                                                 ]'
                                                 data-action="click->menu-import#showEditItemModal">
                                                </i>
                                                <i class="item-drag-handle bi bi-grip-vertical"></i>
                                            </span>
                                        </span>
                                      </div>
                                      <% if item.description.present? %>
                                        <div class="text-muted small mb-2"><%= item.description %></div>
                                      <% end %>
                                      <!-- Alcohol override controls -->
                                      <% if show_alcohol_ui %>
                                        <div class="d-flex flex-wrap align-items-center gap-2 mb-2" data-role="alcohol-override" data-update-url="<%= ocr_menu_item_path(item) %>">
                                          <label class="form-label mb-0"><%= t('smartmenus.ocr.alcohol.override_label', default: 'Alcohol') %>:</label>
                                          <select class="form-select form-select-sm w-auto" data-field="alcohol_override">
                                            <% current_override = ov['alcohol_override'].presence || 'undecided' %>
                                            <option value="undecided" <%= 'selected' if current_override == 'undecided' %>>Undecided</option>
                                            <option value="alcoholic" <%= 'selected' if current_override == 'alcoholic' %>>Alcoholic</option>
                                            <option value="non_alcoholic" <%= 'selected' if current_override == 'non_alcoholic' %>>Non-alcoholic</option>
                                          </select>
                                          <label class="form-label mb-0"><%= t('smartmenus.ocr.alcohol.abv', default: 'ABV') %></label>
                                          <input type="number" step="0.1" min="0" max="100" class="form-control form-control-sm w-auto" data-field="alcohol_abv" value="<%= ov['alcohol_abv'].presence || effective[:abv] %>">
                                          <label class="form-label mb-0"><%= t('smartmenus.ocr.alcohol.classification', default: 'Class') %></label>
                                          <select class="form-select form-select-sm w-auto" data-field="alcohol_classification">
                                            <% klass = ov['alcohol_classification'].presence || effective[:classification] %>
                                            <% ['wine','beer','spirit','cocktail','liqueur','other','non_alcoholic',nil].each do |c| %>
                                              <% next if c.nil? %>
                                              <option value="<%= c %>" <%= 'selected' if klass.to_s == c %>><%= c %></option>
                                            <% end %>
                                          </select>
                                          <small class="text-muted"><%= t('smartmenus.ocr.alcohol.overrides_hint', default: 'Overrides apply at publish.') %></small>
                                        </div>
                                      <% end %>
                                      <% if item.allergens.any? %>
                                        <div class="d-flex flex-wrap gap-1 mb-2">
                                          <% allergen_labels(item.allergens).each do |allergen| %>
                                            <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25">
                                              <%= allergen %>
                                            </span>
                                          <% end %>
                                        </div>
                                      <% end %>
                                      <% if [
                                            (item.respond_to?(:is_vegetarian) && item.is_vegetarian),
                                            (item.respond_to?(:is_vegan) && item.is_vegan),
                                            (item.respond_to?(:is_gluten_free) && item.is_gluten_free),
                                            (item.respond_to?(:is_dairy_free) && item.is_dairy_free)
                                          ].any? %>
                                        <div class="d-flex flex-wrap gap-1 mb-2">
                                          <% if item.respond_to?(:is_vegetarian) && item.is_vegetarian %>
                                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                                              <i class="bi bi-egg-fried me-1" aria-hidden="true"></i> Vegetarian
                                            </span>
                                          <% end %>
                                          <% if item.respond_to?(:is_vegan) && item.is_vegan %>
                                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                                              <i class="bi bi-flower1 me-1" aria-hidden="true"></i> Vegan
                                            </span>
                                          <% end %>
                                          <% if item.respond_to?(:is_gluten_free) && item.is_gluten_free %>
                                            <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                                              <i class="bi bi-x-circle me-1" aria-hidden="true"></i> Gluten Free
                                            </span>
                                          <% end %>
                                          <% if item.respond_to?(:is_dairy_free) && item.is_dairy_free %>
                                            <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                                              <i class="bi bi-droplet me-1" aria-hidden="true"></i> Dairy Free
                                            </span>
                                          <% end %>
                                        </div>
                                      <% end %>
                                    </div>
                                  <% end %>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                    </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  </div>
</div>

<script>
  (function(){
    const container = document.currentScript.closest('.container-fluid');
    if (!container) return;
    const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
    container.querySelectorAll('[data-role="alcohol-override"]').forEach((wrap)=>{
      const url = wrap.getAttribute('data-update-url');
      const save = ()=>{
        const payload = {
          ocr_menu_item: { },
          alcohol_override: wrap.querySelector('[data-field="alcohol_override"]').value,
          alcohol_abv: wrap.querySelector('[data-field="alcohol_abv"]').value,
          alcohol_classification: wrap.querySelector('[data-field="alcohol_classification"]').value
        };
        fetch(url, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf, 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        }).then(r=>r.json()).then(j=>{
          // no-op; could add a toast
        }).catch(()=>{});
      };
      wrap.addEventListener('change', save);
      wrap.addEventListener('blur', (e)=>{ const t=e.target; if(t.matches('input,select')) save(); }, true);
    });
  })();
</script>
<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true" data-bs-backdrop="static" data-controller="menu-import" data-menu-import-target="confirmModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center p-4">
          <div class="d-flex justify-content-center mb-3">
          <div class="bg-success bg-opacity-10 rounded-circle p-3">
            <i class="bi bi-check-circle-fill text-success text-2rem" aria-hidden="true"></i>
          </div>
          </div>
        <h5 class="modal-title mb-3" id="confirmModalLabel">Publish Menu</h5>
        <p class="text-muted mb-4">
          Confirm to publish your menu. You can optionally use Sync publish to archive any existing sections/items not present in this import.
        </p>
        <%= form_with url: confirm_import_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import), method: :post, data: { turbo: false }, html: { class: 'mb-0' } do %>
          <div class="form-check d-flex align-items-center justify-content-center mb-3">
            <%= check_box_tag :sync, '1', false, id: 'sync_publish', class: 'form-check-input me-2' %>
            <%= label_tag :sync_publish, 'Sync publish (archive sections/items not in this import)', class: 'form-check-label' %>
          </div>
          <div class="d-flex justify-content-center gap-3">
            <%= submit_tag 'Publish Menu', class: 'btn btn-danger btn-lg' %>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true" data-bs-backdrop="static" data-controller="menu-import" data-menu-import-target="editItemModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editItemModalLabel"><%= t('.edit_item_modal_title') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"></button>
      </div>
      <form id="editItemForm" data-menu-import-target="editItemForm">
        <input type="hidden" name="item_id" data-menu-import-target="editItemId">

        <div class="modal-body">
          <div class="mb-3">
            <label for="item_name" class="form-label"><%= t('.item_name') %></label>
            <input type="text" class="form-control" id="item_name" name="item_name" data-menu-import-target="editItemName" autocomplete="off">
          </div>

          <div class="mb-3">
            <label for="item_description" class="form-label"><%= t('.description') %></label>
            <textarea class="form-control" id="item_description" name="item_description" rows="3" data-menu-import-target="editItemDescription"></textarea>
          </div>

          <div class="mb-3">
            <label for="item_image_prompt" class="form-label"><%= t('.image_prompt', default: 'Image prompt') %></label>
            <textarea class="form-control" id="item_image_prompt" name="item_image_prompt" rows="2" data-menu-import-target="editItemImagePrompt"></textarea>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label for="item_price" class="form-label"><%= t('.price') %></label>
              <div class="input-group">
                <span class="input-group-text"><%= @restaurantCurrency&.symbol || "$" %></span>
                <input type="text" class="form-control" id="item_price" name="item_price" placeholder="0.00" data-menu-import-target="editItemPrice" autocomplete="off">
              </div>
            </div>

            <div class="col-md-4">
              <label for="item_section" class="form-label"><%= t('.section') %></label>
              <select class="form-select" id="item_section" name="item_section" data-menu-import-target="editItemSection" disabled title="<%= t('.section_disabled_title') %>">
                <% @ocr_menu_import.ocr_menu_sections.ordered.each do |section| %>
                  <option value="<%= section.id %>"><%= section.name %></option>
                <% end %>
              </select>
              <div class="form-text text-muted"><%= t('.reorder_hint') %></div>
            </div>
            <div class="col-md-4"></div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label"><%= t('.dietary_information') %></label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_vegetarian" name="item_vegetarian" data-menu-import-target="editItemVegetarian">
                <label class="form-check-label" for="item_vegetarian">
                  <%= t('.vegetarian') %>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_vegan" name="item_vegan" data-menu-import-target="editItemVegan">
                <label class="form-check-label" for="item_vegan">
                  <%= t('.vegan') %>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_gluten_free" name="item_gluten_free" data-menu-import-target="editItemGlutenFree">
                <label class="form-check-label" for="item_gluten_free">
                  <%= t('.gluten_free') %>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_dairy_free" name="item_dairy_free" data-menu-import-target="editItemDairyFree">
                <label class="form-check-label" for="item_dairy_free">
                  <%= t('.dairy_free') %>
                </label>
              </div>
            </div>

            <div class="col-md-6">
              <label for="item_allergens" class="form-label"><%= t('.allergens') %></label>
              <% default_allergens = %w[gluten dairy egg peanut tree_nut soy shellfish fish sesame mustard celery sulphites lupin mollusc garlic onion] %>
              <% existing_allergens = @ocr_menu_import.ocr_menu_items.flat_map { |i| i.allergens || [] } %>
              <% allergen_options = (default_allergens + existing_allergens).compact.map { |a| a.to_s.strip.downcase }.reject(&:blank?).uniq %>
              <select class="form-select" id="item_allergens" name="item_allergens[]" multiple data-menu-import-target="editItemAllergens">
                <% allergen_options.each do |allergen| %>
                  <option value="<%= allergen %>"><%= allergen_label(allergen) %></option>
                <% end %>
              </select>
              <div class="form-text"><%= t('.hold_multi_select') %></div>
            </div>
          </div>
        </div>

        <div class="modal-footer gap-2">
          <button type="button" class="btn btn-outline-danger me-auto" data-action="click->menu-import#deleteItem">
            <i class="bi bi-trash me-1" aria-hidden="true"></i> <%= t('.delete') %>
          </button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <%= t('.cancel') %>
          </button>
          <button type="button" class="btn btn-primary" data-action="click->menu-import#saveItem">
            <i class="bi bi-save me-1" aria-hidden="true"></i> <%= t('.save_changes') %>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  /* Mobile-friendly Publish button styling */
  .publish-btn {
    min-height: 48px;
    font-size: 1rem;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
  }

  @media (max-width: 768px) {
    .publish-btn {
      min-height: 56px;
      font-size: 1.125rem;
    }
  }

  /* Progress Slider Styling */
  .progress-slider-container {
    position: relative;
    width: 100%;
  }

  .progress-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: #e5e7eb;
    outline: none;
    position: relative;
    z-index: 2;
  }

  .progress-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #dc2626;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .progress-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #dc2626;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .progress-slider-track {
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    pointer-events: none;
    z-index: 1;
  }

  .progress-slider-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
  }

  .progress-slider:disabled {
    cursor: default;
  }

  .progress-slider:disabled::-webkit-slider-thumb {
    cursor: default;
  }

  .progress-slider:disabled::-moz-range-thumb {
    cursor: default;
  }
</style>

      </div>
    </div>
  </div>
</div>
