<div data-controller="sidebar">
  <div class="container-fluid px-0 py-3 bg-white border-bottom sticky-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900 mb-1">
          <%= @restaurant.name %>
        </h1>
        <p class="text-sm text-gray-500">
          <%= t('restaurants.edit_2025.subtitle', default: 'Manage your restaurant configuration') %>
        </p>
      </div>

      <button type="button"
              class="sidebar-toggle-btn"
              data-action="click->sidebar#toggle"
              aria-label="<%= t('restaurants.edit_2025.toggle_navigation', default: 'Toggle navigation') %>">
        <i class="bi bi-list" style="pointer-events: none;"></i>
      </button>
    </div>
  </div>

  <div class="sidebar-content-container">
    <%= render 'restaurants/sidebar_2025', restaurant: @restaurant, current_section: 'import' %>

    <div class="sidebar-main-content">
      <div class="py-4 px-3 px-md-4" data-controller="menu-import" data-menu-import-progress-url-value="<%= progress_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>" data-menu-import-polish-url-value="<%= polish_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>" data-menu-import-polish-progress-url-value="<%= polish_progress_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>" data-menu-import-status-value="<%= @ocr_menu_import.status %>">
        <div class="mb-3 d-flex justify-content-end">
          <%= link_to edit_restaurant_path(@restaurant, section: 'import'),
              class: 'btn btn-outline-secondary',
              data: { turbo_frame: '_top' } do %>
            <i class="bi bi-arrow-left me-1" aria-hidden="true"></i> <%= t('.back_to_imports', default: 'Back to Imports') %>
          <% end %>
        </div>

  <%# ── HEADER ── %>
  <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
    <div>
      <div class="d-flex align-items-center gap-2 mb-1">
        <h3 class="h4 fw-semibold mb-0 import-title-editable"
            data-import-id="<%= @ocr_menu_import.id %>"
            data-update-url="<%= restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>">
          <%= @ocr_menu_import.name.presence || t('.default_title', id: @ocr_menu_import.id) %>
          <span class="edit-indicator text-secondary ms-1"><i class="bi bi-pencil small" aria-hidden="true"></i></span>
        </h3>
        <%= status_badge(@ocr_menu_import.status) %>
      </div>
      <div class="d-flex flex-wrap gap-3 text-muted small">
        <span><i class="bi bi-calendar3 me-1" aria-hidden="true"></i><%= t('.imported_ago', time: time_ago_in_words(@ocr_menu_import.created_at)) %></span>
        <span><i class="bi bi-clock-history me-1" aria-hidden="true"></i><%= t('.updated_at', timestamp: @ocr_menu_import.updated_at.strftime('%B %d, %Y at %I:%M %p')) %></span>
        <% if @ocr_menu_import.completed? && @ocr_menu_sections.any? %>
          <span><i class="bi bi-list-ul me-1" aria-hidden="true"></i><%= @ocr_menu_sections.size %> sections &middot; <%= @ocr_menu_sections.sum { |s| s.ocr_menu_items.size } %> items</span>
        <% end %>
      </div>
    </div>
    <div class="d-flex gap-2 flex-shrink-0">
      <% if @ocr_menu_import.completed? && @ocr_menu_sections.any? %>
        <button type="button" class="btn btn-outline-primary btn-sm" data-action="click->menu-import#startPolish" data-menu-import-target="polishButton">
          <i class="bi bi-magic me-1" aria-hidden="true"></i> AI Polish
        </button>
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#confirmModal">
          <i class="bi bi-check-circle me-1" aria-hidden="true"></i> <%= t('.publish') %>
        </button>
      <% end %>
      <% if @ocr_menu_import.may_process? %>
        <%= button_to process_pdf_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import),
            method: :post,
            class: 'btn btn-primary btn-sm',
            form: { data: { turbo_confirm: t('.process_confirm') } } do %>
          <i class="bi bi-gear me-1" aria-hidden="true"></i> <%= t('.process_pdf') %>
        <% end %>
      <% end %>
    </div>
  </div>

  <%# ── PROCESSING STATE ── %>
  <% if @ocr_menu_import.processing? || @ocr_menu_import.pending? %>
    <%
      progress_percent = if @ocr_menu_import.processing?
                          @ocr_menu_import.progress || 0
                        else
                          0
                        end
    %>
    <div class="mb-4">
      <div class="d-flex align-items-center gap-3 mb-2">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
          <span class="visually-hidden"><%= t('.progress_loading') %></span>
        </div>
        <span class="fw-medium" data-menu-import-target="phaseText"><%= @ocr_menu_import.processing? ? t('.processing_title') : 'Waiting to start…' %></span>
        <span class="text-muted small ms-auto" data-menu-import-target="overallPercent"><%= progress_percent %>%</span>
      </div>
      <div class="progress" style="height: 6px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated"
             role="progressbar"
             data-menu-import-target="overallFill"
             style="width: <%= progress_percent %>%"
             aria-valuenow="<%= progress_percent %>"
             aria-valuemin="0"
             aria-valuemax="100">
        </div>
      </div>
      <div class="d-flex justify-content-between mt-1">
        <span class="text-muted small" data-menu-import-target="pageText"><%= @ocr_menu_import.processing? ? t('.processing_page', current: (@ocr_menu_import.current_page || 1), total: (@ocr_menu_import.total_pages || '?')) : '' %></span>
        <span class="text-muted small" data-menu-import-target="phasePercent"></span>
      </div>
    </div>
    <input type="hidden" data-menu-import-target="overallSlider" value="<%= progress_percent %>">
  <% end %>

  <%# ── FAILED STATE ── %>
  <% if @ocr_menu_import.failed? %>
    <div class="alert alert-danger d-flex align-items-start gap-3 mb-4">
      <i class="bi bi-exclamation-triangle-fill fs-5 flex-shrink-0" aria-hidden="true"></i>
      <div>
        <strong><%= t('.failed_heading') %></strong>
        <p class="mb-2"><%= @ocr_menu_import.error_message %></p>
        <%= button_to t('.try_again'),
            process_pdf_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import),
            method: :post,
            class: 'btn btn-outline-danger btn-sm' %>
      </div>
    </div>
  <% end %>

  <%# ── COMPLETED BUT EMPTY ── %>
  <% if @ocr_menu_import.completed? && @ocr_menu_sections.none? %>
    <div class="alert alert-warning d-flex align-items-start gap-3 mb-4">
      <i class="bi bi-info-circle-fill fs-5 flex-shrink-0" aria-hidden="true"></i>
      <div>
        <strong><%= t('.no_items_heading') %></strong>
        <p class="mb-2"><%= t('.no_items_explainer') %></p>
        <ul class="mb-3 ps-3">
          <li><%= t('.no_items_tip1') %></li>
          <li><%= t('.no_items_tip2') %></li>
          <li><%= t('.no_items_tip3') %></li>
        </ul>
        <div class="d-flex gap-2">
          <% if @ocr_menu_import.may_process? %>
            <%= button_to t('.try_again'),
                process_pdf_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import),
                method: :post,
                class: 'btn btn-outline-primary btn-sm' %>
          <% end %>
          <%= link_to t('.upload_clearer_pdf'), new_restaurant_ocr_menu_import_path(@restaurant), class: 'btn btn-outline-secondary btn-sm' %>
        </div>
      </div>
    </div>
  <% end %>

  <%# ── SECTIONS & ITEMS ── %>
  <% if @ocr_menu_import.completed? && @ocr_menu_sections.any? %>
    <div class="d-flex align-items-center gap-2 mb-3 pb-2 border-bottom">
      <div class="form-check mb-0">
        <input class="form-check-input" type="checkbox" id="confirm_all_sections"
               data-role="confirm-all-sections"
               data-toggle-all-url="<%= toggle_all_confirmation_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>">
        <label class="form-check-label text-muted small" for="confirm_all_sections"><%= t('.approve_sections_items') %></label>
      </div>
    </div>

    <div id="sections-sortable"
         class="vstack gap-4"
         data-reorder-url="<%= reorder_sections_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>"
         data-reorder-items-url="<%= reorder_items_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>">
      <% @ocr_menu_sections.each do |section| %>
        <% section_alcohol_class = AlcoholDetectionService.section_class_from_text(section.name) %>
        <% show_alcohol_ui = section_alcohol_class.present? %>
        <div class="section-container"
             data-controller="menu-section"
             data-menu-section-section-id="<%= section.id %>"
             data-section-id="<%= section.id %>">

          <%# Section header %>
          <div class="d-flex align-items-center gap-2 mb-2">
            <div class="form-check mb-0" data-role="section-confirmation">
              <input class="form-check-input" type="checkbox"
                     id="confirm_section_<%= section.id %>"
                     data-section-id="<%= section.id %>"
                     data-toggle-url="<%= toggle_section_confirmation_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>"
                     <%= 'checked' if section.is_confirmed %>>
            </div>
            <h5 class="fw-semibold mb-0 flex-grow-1"
                role="button"
                data-bs-toggle="collapse"
                data-bs-target="#section-<%= section.id %>-items"
                aria-expanded="true"
                aria-controls="section-<%= section.id %>-items">
              <%= section.name %>
              <span class="text-muted fw-normal small ms-1">(<%= section.ocr_menu_items.size %>)</span>
            </h5>
            <span class="text-muted small" role="button" data-bs-toggle="collapse" data-bs-target="#section-<%= section.id %>-items">
              <i class="bi bi-chevron-down" aria-hidden="true"></i>
            </span>
            <i class="section-drag-handle bi bi-grip-vertical text-muted" aria-hidden="true"></i>
          </div>

          <% if section.respond_to?(:description) && section.description.present? %>
            <p class="text-muted small mb-2 ms-4"><%= section.description %></p>
          <% end %>

          <%# Section-level pricing tool %>
          <% section_items = section.ocr_menu_items.ordered %>
          <% estimated_count = section_items.count { |i| (i.metadata || {})['price_estimated'] == true } %>
          <% unpriced_count = section_items.count { |i| (i.price.blank? || i.price.to_f.zero?) && !((i.metadata || {})['size_prices'].is_a?(Hash) && (i.metadata || {})['size_prices'].values.any? { |v| v.present? && v.to_f > 0 }) } %>
          <% if estimated_count > 0 || unpriced_count > 0 %>
            <div class="ms-4 mb-2 p-2 rounded-2 d-flex align-items-center gap-2 flex-wrap" style="background: #fff8e1; border: 1px solid #ffe082;">
              <i class="bi bi-lightbulb text-warning" aria-hidden="true"></i>
              <span class="small text-dark">
                <% if estimated_count > 0 && unpriced_count > 0 %>
                  <%= estimated_count %> estimated price<%= estimated_count == 1 ? '' : 's' %>, <%= unpriced_count %> unpriced
                <% elsif estimated_count > 0 %>
                  <%= estimated_count %> estimated price<%= estimated_count == 1 ? '' : 's' %>
                <% else %>
                  <%= unpriced_count %> unpriced item<%= unpriced_count == 1 ? '' : 's' %>
                <% end %>
              </span>
              <span class="text-muted small">|</span>
              <span class="small text-muted">Set section price:</span>
              <input type="number" step="0.5" min="0" class="form-control form-control-sm" style="width: 80px;"
                     data-role="section-price-input" data-section-id="<%= section.id %>">
              <button type="button" class="btn btn-sm btn-warning px-2 py-0"
                      data-role="section-price-btn"
                      data-section-id="<%= section.id %>"
                      data-url="<%= set_section_price_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>"
                      title="Apply to unpriced/estimated items only">
                <i class="bi bi-check-lg" aria-hidden="true"></i> Apply
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary px-2 py-0"
                      data-role="section-price-all-btn"
                      data-section-id="<%= section.id %>"
                      data-url="<%= set_section_price_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>"
                      title="Override ALL items in this section">
                All
              </button>
            </div>
          <% end %>

          <%# Items %>
          <div class="collapse show ms-4" id="section-<%= section.id %>-items" data-menu-section-target="content">
            <div class="vstack">
            <% section.ocr_menu_items.ordered.each do |item| %>
              <% det = show_alcohol_ui ? AlcoholDetectionService.detect(section_name: section.name, item_name: item.name, item_description: item.description) : nil %>
              <% ov = (item.metadata || {}) %>
              <% effective = det || {}; if show_alcohol_ui && ov['alcohol_override'].present? %>
                <% case ov['alcohol_override'].to_s %>
                <% when 'alcoholic' %>
                  <% effective = { decided: true, alcoholic: true, classification: ov['alcohol_classification'].presence || det&.dig(:classification), abv: ov['alcohol_abv'].presence || det&.dig(:abv), confidence: 1.0, note: 'override' } %>
                <% when 'non_alcoholic' %>
                  <% effective = { decided: true, alcoholic: false, classification: 'non_alcoholic', abv: ov['alcohol_abv'].presence || det&.dig(:abv), confidence: 1.0, note: 'override' } %>
                <% end %>
              <% end %>

              <div class="py-2 item-row" data-item-id="<%= item.id %>" style="border-bottom: 1px solid #f0f0f0;">
                <div class="d-flex justify-content-between align-items-start">
                  <i class="item-drag-handle bi bi-grip-vertical text-muted flex-shrink-0 me-2 mt-1" aria-hidden="true"></i>
                  <div class="me-3 flex-grow-1">
                    <div class="fw-medium">
                      <span><%= item.name %></span>
                    </div>
                    <% if item.description.present? %>
                      <div class="text-muted small mt-1"><%= item.description %></div>
                    <% end %>
                  </div>
                  <div class="d-flex align-items-center gap-2 flex-shrink-0">
                    <% wine_sp = (item.metadata || {})['size_prices'] %>
                    <% has_size_prices = wine_sp.is_a?(Hash) && wine_sp.values.any? { |v| v.present? && v.to_f > 0 } %>
                    <% if has_size_prices %>
                      <span class="text-muted small" data-item-size-prices-display="<%= item.id %>">
                        <%= wine_sp.select { |_, v| v.present? && v.to_f > 0 }.map { |k, v| "#{k.to_s.humanize}: #{number_to_currency(v, unit: @restaurantCurrency&.symbol || '$')}" }.join(' · ') %>
                      </span>
                    <% else %>
                      <span class="fw-medium" data-item-price-display="<%= item.id %>"><%= number_to_currency(item.price, unit: @restaurantCurrency&.symbol || "$") %></span>
                      <% if (item.metadata || {})['price_estimated'] == true %>
                        <span class="badge bg-warning bg-opacity-25 text-dark border border-warning border-opacity-50" style="font-size: 0.65rem;" title="Price estimated by AI — click edit to adjust">
                          <i class="bi bi-lightbulb me-1" aria-hidden="true"></i>est.
                        </span>
                      <% end %>
                    <% end %>
                    <button type="button" class="btn btn-sm btn-outline-secondary px-1 py-0"
                            data-item-id="<%= item.id %>"
                            data-item-name="<%= item.name %>"
                            data-item-description="<%= item.description.to_s %>"
                            data-item-image-prompt="<%= item.respond_to?(:image_prompt) ? item.image_prompt.to_s : '' %>"
                            data-item-price="<%= item.price %>"
                            data-item-size-prices='<%= ((item.metadata || {})['size_prices'] || {}).to_json %>'
                            data-item-allergens='<%= (item.allergens || []).to_json %>'
                            data-item-section="<%= section.id %>"
                            data-item-position="<%= item.sequence %>"
                            data-item-dietary-restrictions='[<%= (item.respond_to?(:is_vegetarian) && item.is_vegetarian) ? '"vegetarian"' : nil %><%= (item.respond_to?(:is_vegan) && item.is_vegan) ? ', "vegan"' : nil %><%= (item.respond_to?(:is_gluten_free) && item.is_gluten_free) ? ', "gluten_free"' : nil %><%= (item.respond_to?(:is_dairy_free) && item.is_dairy_free) ? ', "dairy_free"' : nil %><%= (item.respond_to?(:is_nut_free) && item.is_nut_free) ? ', "nut_free"' : nil %>]'
                            data-action="click->menu-import#showEditItemModal">
                      <i class="bi bi-pencil" aria-hidden="true"></i>
                    </button>
                  </div>
                </div>

                <%# Alcohol override controls %>
                <% if show_alcohol_ui %>
                  <div class="d-flex flex-wrap align-items-center gap-2 mt-2" data-role="alcohol-override" data-update-url="<%= ocr_menu_item_path(item) %>">
                    <label class="form-label mb-0 small"><%= t('smartmenus.ocr.alcohol.override_label', default: 'Alcohol') %>:</label>
                    <select class="form-select form-select-sm w-auto" data-field="alcohol_override">
                      <%
                        current_override = if ov['alcohol_override'].present? && ov['alcohol_override'] != 'undecided'
                                             ov['alcohol_override']
                                           elsif effective[:decided]
                                             effective[:alcoholic] ? 'alcoholic' : 'non_alcoholic'
                                           else
                                             'undecided'
                                           end
                      %>
                      <option value="undecided" <%= 'selected' if current_override == 'undecided' %>>Undecided</option>
                      <option value="alcoholic" <%= 'selected' if current_override == 'alcoholic' %>>Alcoholic</option>
                      <option value="non_alcoholic" <%= 'selected' if current_override == 'non_alcoholic' %>>Non-alcoholic</option>
                    </select>
                    <label class="form-label mb-0 small"><%= t('smartmenus.ocr.alcohol.abv', default: 'ABV') %></label>
                    <input type="number" step="0.1" min="0" max="100" class="form-control form-control-sm w-auto" data-field="alcohol_abv" value="<%= ov['alcohol_abv'].presence || effective[:abv] %>">
                    <label class="form-label mb-0 small"><%= t('smartmenus.ocr.alcohol.classification', default: 'Class') %></label>
                    <select class="form-select form-select-sm w-auto" data-field="alcohol_classification">
                      <% klass = ov['alcohol_classification'].presence || effective[:classification] %>
                      <% ['wine','beer','spirit','cocktail','liqueur','other','non_alcoholic',nil].each do |c| %>
                        <% next if c.nil? %>
                        <option value="<%= c %>" <%= 'selected' if klass.to_s == c %>><%= c %></option>
                      <% end %>
                    </select>
                  </div>
                <% end %>

                <%# Badges %>
                <% badges = [] %>
                <% if item.allergens.any? %>
                  <% badges += allergen_labels(item.allergens).map { |a| { text: a, bg: 'bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25' } } %>
                <% end %>
                <% if item.respond_to?(:is_vegetarian) && item.is_vegetarian %>
                  <% badges << { text: 'Vegetarian', bg: 'bg-success bg-opacity-10 text-success border border-success border-opacity-25', icon: 'bi-egg-fried' } %>
                <% end %>
                <% if item.respond_to?(:is_vegan) && item.is_vegan %>
                  <% badges << { text: 'Vegan', bg: 'bg-success bg-opacity-10 text-success border border-success border-opacity-25', icon: 'bi-flower1' } %>
                <% end %>
                <% if item.respond_to?(:is_gluten_free) && item.is_gluten_free %>
                  <% badges << { text: 'Gluten Free', bg: 'bg-info bg-opacity-10 text-info border border-info border-opacity-25', icon: 'bi-x-circle' } %>
                <% end %>
                <% if item.respond_to?(:is_dairy_free) && item.is_dairy_free %>
                  <% badges << { text: 'Dairy Free', bg: 'bg-info bg-opacity-10 text-info border border-info border-opacity-25', icon: 'bi-droplet' } %>
                <% end %>
                <% if badges.any? %>
                  <div class="d-flex flex-wrap gap-1 mt-2">
                    <% badges.each do |b| %>
                      <span class="badge <%= b[:bg] %>">
                        <% if b[:icon] %><i class="bi <%= b[:icon] %> me-1" aria-hidden="true"></i><% end %>
                        <%= b[:text] %>
                      </span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

<script>
  (function(){
    const container = document.currentScript.closest('.container-fluid');
    if (!container) return;
    const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
    container.querySelectorAll('[data-role="alcohol-override"]').forEach((wrap)=>{
      const url = wrap.getAttribute('data-update-url');
      const save = ()=>{
        const payload = {
          ocr_menu_item: { },
          alcohol_override: wrap.querySelector('[data-field="alcohol_override"]').value,
          alcohol_abv: wrap.querySelector('[data-field="alcohol_abv"]').value,
          alcohol_classification: wrap.querySelector('[data-field="alcohol_classification"]').value
        };
        fetch(url, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf, 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        }).then(r=>r.json()).then(j=>{
          // no-op; could add a toast
        }).catch(()=>{});
      };
      wrap.addEventListener('change', save);
      wrap.addEventListener('blur', (e)=>{ const t=e.target; if(t.matches('input,select')) save(); }, true);
    });
  })();
</script>
<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true" data-bs-backdrop="static" data-menu-import-target="confirmModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center p-4">
          <div class="d-flex justify-content-center mb-3">
          <div class="bg-success bg-opacity-10 rounded-circle p-3">
            <i class="bi bi-check-circle-fill text-success text-2rem" aria-hidden="true"></i>
          </div>
          </div>
        <h5 class="modal-title mb-3" id="confirmModalLabel">Publish Menu</h5>
        <p class="text-muted mb-4">
          Confirm to publish your menu. You can optionally use Sync publish to archive any existing sections/items not present in this import.
        </p>
        <%= form_with url: confirm_import_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import), method: :post, data: { turbo: false }, html: { class: 'mb-0' } do %>
          <div class="form-check d-flex align-items-center justify-content-center mb-3">
            <%= check_box_tag :sync, '1', false, id: 'sync_publish', class: 'form-check-input me-2' %>
            <%= label_tag :sync_publish, 'Sync publish (archive sections/items not in this import)', class: 'form-check-label' %>
          </div>
          <div class="d-flex justify-content-center gap-3">
            <%= submit_tag 'Publish Menu', class: 'btn btn-danger btn-lg' %>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true" data-bs-backdrop="static" data-menu-import-target="editItemModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editItemModalLabel"><%= t('.edit_item_modal_title') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"></button>
      </div>
      <form id="editItemForm" data-menu-import-target="editItemForm">
        <input type="hidden" name="item_id" data-menu-import-target="editItemId">

        <div class="modal-body">
          <div class="mb-3">
            <label for="item_name" class="form-label"><%= t('.item_name') %></label>
            <input type="text" class="form-control" id="item_name" name="item_name" data-menu-import-target="editItemName" autocomplete="off">
          </div>

          <div class="mb-3">
            <label for="item_description" class="form-label"><%= t('.description') %></label>
            <textarea class="form-control" id="item_description" name="item_description" rows="3" data-menu-import-target="editItemDescription"></textarea>
          </div>

          <div class="mb-3">
            <label for="item_image_prompt" class="form-label"><%= t('.image_prompt', default: 'Image prompt') %></label>
            <textarea class="form-control" id="item_image_prompt" name="item_image_prompt" rows="2" data-menu-import-target="editItemImagePrompt"></textarea>
          </div>

          <%# -- Pricing ------------------------------------------------- %>
          <div class="mb-3" data-menu-import-target="pricingWrapper">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <label class="form-label mb-0 fw-semibold">Pricing</label>
              <div class="btn-group btn-group-sm" role="group" aria-label="Pricing mode">
                <button type="button"
                        class="btn btn-outline-secondary active"
                        data-menu-import-target="pricingModeBtn"
                        data-pricing-mode="single"
                        data-action="click->menu-import#switchPricingMode">
                  <i class="bi bi-tag me-1"></i>Single price
                </button>
                <button type="button"
                        class="btn btn-outline-secondary"
                        data-menu-import-target="pricingModeBtn"
                        data-pricing-mode="sizes"
                        data-action="click->menu-import#switchPricingMode">
                  <i class="bi bi-cup-straw me-1"></i>By size
                </button>
              </div>
            </div>

            <%# Single price + section row %>
            <div data-menu-import-target="singlePriceSection">
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="input-group">
                    <span class="input-group-text"><%= @restaurantCurrency&.symbol || "$" %></span>
                    <input type="text" class="form-control" id="item_price" name="item_price" placeholder="0.00" data-menu-import-target="editItemPrice" autocomplete="off">
                  </div>
                </div>
                <div class="col-md-4">
                  <select class="form-select" id="item_section" name="item_section" data-menu-import-target="editItemSection" disabled title="<%= t('.section_disabled_title') %>">
                    <% @ocr_menu_import.ocr_menu_sections.ordered.each do |section| %>
                      <option value="<%= section.id %>"><%= section.name %></option>
                    <% end %>
                  </select>
                  <div class="form-text text-muted"><%= t('.reorder_hint') %></div>
                </div>
                <div class="col-md-4"></div>
              </div>
            </div>

            <%# Size-based prices %>
            <div data-menu-import-target="sizePricesSection" style="display:none;">
              <div class="row g-2">
                <% %w[glass large_glass half_bottle bottle carafe].each do |size_key| %>
                  <div class="col">
                    <label for="item_size_<%= size_key %>" class="form-label small text-muted mb-1"><%= size_key.humanize %></label>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text"><%= @restaurantCurrency&.symbol || "$" %></span>
                      <input type="number" step="0.01" min="0" class="form-control form-control-sm"
                             id="item_size_<%= size_key %>"
                             name="item_size_prices[<%= size_key %>]"
                             placeholder="0.00"
                             data-size-key="<%= size_key %>"
                             data-menu-import-target="editSizePrice">
                    </div>
                  </div>
                <% end %>
              </div>
              <div class="form-text text-muted mt-1">Leave a size blank to omit it.</div>

              <%# Section selector (duplicated so it stays visible in size mode) %>
              <div class="row g-3 mt-2">
                <div class="col-md-4">
                  <label class="form-label small text-muted mb-1"><%= t('.section') %></label>
                  <select class="form-select form-select-sm" name="item_section_size" data-menu-import-target="editItemSectionSize" disabled title="<%= t('.section_disabled_title') %>">
                    <% @ocr_menu_import.ocr_menu_sections.ordered.each do |section| %>
                      <option value="<%= section.id %>"><%= section.name %></option>
                    <% end %>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label"><%= t('.dietary_information') %></label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_vegetarian" name="item_vegetarian" data-menu-import-target="editItemVegetarian">
                <label class="form-check-label" for="item_vegetarian">
                  <%= t('.vegetarian') %>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_vegan" name="item_vegan" data-menu-import-target="editItemVegan">
                <label class="form-check-label" for="item_vegan">
                  <%= t('.vegan') %>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_gluten_free" name="item_gluten_free" data-menu-import-target="editItemGlutenFree">
                <label class="form-check-label" for="item_gluten_free">
                  <%= t('.gluten_free') %>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_dairy_free" name="item_dairy_free" data-menu-import-target="editItemDairyFree">
                <label class="form-check-label" for="item_dairy_free">
                  <%= t('.dairy_free') %>
                </label>
              </div>
            </div>

            <div class="col-md-6">
              <label for="item_allergens" class="form-label"><%= t('.allergens') %></label>
              <% default_allergens = %w[gluten dairy egg peanut tree_nut soy shellfish fish sesame mustard celery sulphites lupin mollusc garlic onion] %>
              <% existing_allergens = @ocr_menu_import.ocr_menu_items.flat_map { |i| i.allergens || [] } %>
              <% allergen_options = (default_allergens + existing_allergens).compact.map { |a| a.to_s.strip.downcase }.reject(&:blank?).uniq %>
              <select class="form-select" id="item_allergens" name="item_allergens[]" multiple data-menu-import-target="editItemAllergens">
                <% allergen_options.each do |allergen| %>
                  <option value="<%= allergen %>"><%= allergen_label(allergen) %></option>
                <% end %>
              </select>
              <div class="form-text"><%= t('.hold_multi_select') %></div>
            </div>
          </div>
        </div>

        <div class="modal-footer gap-2">
          <button type="button" class="btn btn-outline-danger me-auto" data-action="click->menu-import#deleteItem">
            <i class="bi bi-trash me-1" aria-hidden="true"></i> <%= t('.delete') %>
          </button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <%= t('.cancel') %>
          </button>
          <button type="button" class="btn btn-primary" data-action="click->menu-import#saveItem">
            <i class="bi bi-save me-1" aria-hidden="true"></i> <%= t('.save_changes') %>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


      </div>
    </div>
  </div>
</div>
