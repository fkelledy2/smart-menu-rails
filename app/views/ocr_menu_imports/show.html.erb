<div class="container-fluid py-4" data-controller="menu-import">
  <!-- Back Navigation -->
  <div class="mb-3">
    <%= link_to edit_restaurant_path(@restaurant, section: 'import'), 
        class: 'btn btn-outline-secondary',
        data: { turbo_frame: '_top' } do %>
      <i class="bi bi-arrow-left me-1"></i> <%= t('.back_to_imports', default: 'Back to Imports') %>
    <% end %>
  </div>
  
  <div class="d-flex justify-content-between align-items-start mb-4 flex-wrap">
    <div class="mb-3 mb-md-0">
      <h3 class="h3 mb-2 import-title-editable"
          data-import-id="<%= @ocr_menu_import.id %>"
          data-update-url="<%= restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>">
        <%= @ocr_menu_import.name.presence || t('.default_title', id: @ocr_menu_import.id) %>
        <span class="edit-indicator text-secondary ms-2">
          <i class="bi bi-pencil"></i>
        </span>
      </h3>
      <div class="d-flex flex-wrap gap-3 text-muted small">
        <div class="d-flex align-items-center">
          <i class="bi bi-calendar3 me-1"></i>
          <span><%= t('.imported_ago', time: time_ago_in_words(@ocr_menu_import.created_at)) %></span>
        </div>
        <div class="d-flex align-items-center">
          <i class="bi bi-clock-history me-1"></i>
          <span><%= t('.updated_at', timestamp: @ocr_menu_import.updated_at.strftime('%B %d, %Y at %I:%M %p')) %></span>
        </div>
      </div>
    </div>
    <div class="d-flex gap-2">
      <% if @ocr_menu_import.may_process? %>
        <%= button_to process_pdf_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import), 
            method: :post, 
            class: 'btn btn-primary',
            form: { data: { turbo_confirm: t('.process_confirm') } } do %>
          <i class="bi bi-gear me-1"></i> <%= t('.process_pdf') %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Progress Slider -->
  <% 
    # Calculate progress percentage based on status
    progress_percent = if @ocr_menu_import.completed?
                        100
                      elsif @ocr_menu_import.processing?
                        @ocr_menu_import.progress || 50
                      elsif @ocr_menu_import.pending?
                        25
                      else
                        0
                      end
  %>
  <div class="card mb-2">
    <div class="card-body py-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted small">0%</span>
        <span class="fw-bold"><%= progress_percent %>%</span>
        <span class="text-muted small">100%</span>
      </div>
      <div class="progress-slider-container">
        <input type="range" 
               class="progress-slider" 
               min="0" 
               max="100" 
               value="<%= progress_percent %>" 
               disabled
               style="width: 100%;">
        <div class="progress-slider-track">
          <div class="progress-slider-fill" style="width: <%= progress_percent %>%;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h3 class="h5 mb-0"><%= t('.import_details') %></h3>
      <p class="mb-0">
        <%= t('.status') %> <%= status_badge(@ocr_menu_import.status) %>
        <% if @ocr_menu_import.processing? && @ocr_menu_import.progress.present? %>
          <span class="ms-2">(<%= @ocr_menu_import.progress %>%)</span>
        <% end %>
      </p>
    </div>
    
    <div class="card-body">
      <% if @ocr_menu_import.processing? %>
        <div class="text-center py-4">
          <div class="spinner-border text-primary mb-2" role="status">
            <span class="visually-hidden"><%= t('.progress_loading') %></span>
          </div>
          <p class="text-muted mb-2"><%= t('.processing_title') %></p>
          <p class="text-muted small mb-4"><%= t('.processing_page', current: (@ocr_menu_import.current_page || 1), total: (@ocr_menu_import.total_pages || '?')) %></p>
          
          <div class="progress mb-2 progress-bar-10">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" 
                 style="width: <%= @ocr_menu_import.progress || 0 %>%" 
                 aria-valuenow="<%= @ocr_menu_import.progress || 0 %>" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
            </div>
          </div>
          <p class="text-muted small"><%= t('.progress_complete', percent: (@ocr_menu_import.progress || 0)) %></p>
        </div>
        
        <%= turbo_stream_from @ocr_menu_import %>
          <div id="<%= dom_id(@ocr_menu_import) %>_status">
            <!-- Turbo will update this when the status changes -->
          </div>
        <% elsif @ocr_menu_import.failed? %>
          <div class="alert alert-danger">
            <div class="d-flex">
              <div class="flex-shrink-0 me-3">
                <i class="bi bi-exclamation-triangle-fill"></i>
              </div>
              <div>
                <h5 class="alert-heading"><%= t('.failed_heading') %></h5>
                <p class="mb-0"><%= @ocr_menu_import.error_message %></p>
                <div class="mt-3">
                  <%= button_to t('.try_again'), 
                      process_pdf_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import), 
                      method: :post, 
                      class: 'btn btn-outline-danger btn-sm' %>
                </div>
              </div>
            </div>
          </div>
        <% elsif @ocr_menu_import.completed? && @ocr_menu_import.ocr_menu_sections.none? %>
          <div class="alert alert-warning">
            <div class="d-flex">
              <div class="flex-shrink-0 me-3">
                <i class="bi bi-info-circle-fill"></i>
              </div>
              <div>
                <h5 class="alert-heading"><%= t('.no_items_heading') %></h5>
                <p class="mb-2"><%= t('.no_items_explainer') %></p>
                <ul class="mb-3">
                  <li><%= t('.no_items_tip1') %></li>
                  <li><%= t('.no_items_tip2') %></li>
                  <li><%= t('.no_items_tip3') %></li>
                </ul>
                <div class="d-flex gap-2">
                  <% if @ocr_menu_import.may_process? %>
                    <%= button_to t('.try_again'), 
                        process_pdf_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import), 
                        method: :post, 
                        class: 'btn btn-outline-primary btn-sm' %>
                  <% end %>
                  <%= link_to t('.upload_clearer_pdf'), new_restaurant_ocr_menu_import_path(@restaurant), class: 'btn btn-outline-secondary btn-sm' %>
                </div>
              </div>
            </div>
          </div>
        <% elsif @ocr_menu_import.completed? && @ocr_menu_import.ocr_menu_sections.any? %>
          <div class="mb-4">
            <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center mb-4">
              <div class="mb-3 mb-md-0">
                <h2 class="h4 mb-1"><%= t('.imported_menu_title') %></h2>
              </div>
              <div class="w-100 w-md-auto">
                <button type="button" 
                        class="btn btn-danger btn-lg w-100 w-md-auto publish-btn" 
                        data-bs-toggle="modal" 
                        data-bs-target="#confirmModal">
                  <i class="bi bi-check-circle me-1"></i> <%= t('.publish') %>
                </button>
              </div>
            </div>

            <div class="border-top pt-4">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="col-1">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="confirm_all_sections"
                             data-role="confirm-all-sections"
                             data-toggle-all-url="<%= toggle_all_confirmation_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>">
                    </div>
                </div>
                <div class="col-11">
                      <label class="form-check-label" for="confirm_all_sections">
                          <%= t('.approve_sections_items') %>
                      </label>
                </div>
              </div>
              <div id="sections-sortable"
                   class="vstack gap-1"
                   data-reorder-url="<%= reorder_sections_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>"
                   data-reorder-items-url="<%= reorder_items_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>">
                <% @ocr_menu_import.ocr_menu_sections.ordered.each do |section| %>
                    <div class="row">
                        <div class="col-1">
                          <div class="form-check me-2" data-role="section-confirmation">
                              <input class="form-check-input" type="checkbox"
                                     id="confirm_section_<%= section.id %>"
                                     data-section-id="<%= section.id %>"
                                     data-toggle-url="<%= toggle_section_confirmation_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import) %>"
                                     <%= 'checked' if section.is_confirmed %>>
                              <label class="form-check-label" for="confirm_section_<%= section.id %>"></label>
                          </div>
                        </div>
                        <div class="col-11">
                          <div class="section-container sortable-section card mb-3"
                               data-controller="menu-section"
                               data-menu-section-section-id="<%= section.id %>"
                               data-section-id="<%= section.id %>"
                               draggable="true">
                            <div class="card-header d-flex justify-content-between align-items-start"
                                 role="button"
                                 data-bs-toggle="collapse"
                                 data-bs-target="#section-<%= section.id %>-items"
                                 aria-expanded="false"
                                 aria-controls="section-<%= section.id %>-items">
                              <div class="flex-grow-1 d-flex align-items-center gap-2">
                                <h3 class="h5 mb-0"><%= section.name %></h3>
                              </div>
                              <span class="btn btn-sm btn-outline-secondary px-2 py-1">
                                <i class="bi bi-chevron-down"></i>
                                <i class="section-drag-handle bi bi-grip-vertical"></i>
                              </span>
                            </div>

                            <% if section.respond_to?(:description) && section.description.present? %>
                              <div class="py-2 px-3 text-muted"><%= section.description %></div>
                            <% else %>
                              <div class="py-2 px-3 text-muted"><%= t('.click_to_add_description') %></div>
                            <% end %>

                            <div class="collapse" id="section-<%= section.id %>-items" data-menu-section-target="content">
                              <div class="card-body">
                                <div class="vstack gap-3">
                                  <% section.ocr_menu_items.ordered.each do |item| %>
                                    <div class="p-0 item-row" data-item-id="<%= item.id %>">
                                      <div class="d-flex justify-content-between align-items-start mb-1">
                                        <div class="me-4 fw-semibold d-flex align-items-center gap-2">
                                          <span><%= item.name %></span>
                                        </div>
                                        <span class="text-nowrap px-0 py-1">
                                            <%= number_to_currency(item.price, unit: @restaurantCurrency&.symbol || "$") %>
                                            &nbsp;
                                            <span class="btn btn-sm btn-outline-secondary">
                                                <i class="bi bi-pencil"
                                                 data-bs-toggle="modal"
                                                 data-bs-target="#editItemModal"
                                                 data-item-id="<%= item.id %>"
                                                 data-item-name="<%= item.name %>"
                                                 data-item-description="<%= item.description.to_s %>"
                                                 data-item-price="<%= item.price %>"
                                                 data-item-allergens='<%= (item.allergens || []).to_json %>'
                                                 data-item-section="<%= section.id %>"
                                                 data-item-position="<%= item.sequence %>"
                                                 data-item-dietary-restrictions='[
                                                   <%= (item.respond_to?(:is_vegetarian) && item.is_vegetarian) ? '"vegetarian"' : nil %>
                                                   <%= (item.respond_to?(:is_vegan) && item.is_vegan) ? ', "vegan"' : nil %>
                                                   <%= (item.respond_to?(:is_gluten_free) && item.is_gluten_free) ? ', "gluten_free"' : nil %>
                                                   <%= (item.respond_to?(:is_dairy_free) && item.is_dairy_free) ? ', "dairy_free"' : nil %>
                                                   <%= (item.respond_to?(:is_nut_free) && item.is_nut_free) ? ', "nut_free"' : nil %>
                                                 ]'
                                                 data-action="click->menu-import#showEditItemModal">
                                                </i>
                                                <i class="item-drag-handle bi bi-grip-vertical"></i>
                                            </span>
                                        </span>
                                      </div>
                                      <% if item.description.present? %>
                                        <div class="text-muted small mb-2"><%= item.description %></div>
                                      <% end %>
                                      <% if item.allergens.any? %>
                                        <div class="d-flex flex-wrap gap-1 mb-2">
                                          <% item.allergens.each do |allergen| %>
                                            <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25">
                                              <%= allergen.to_s.titleize %>
                                            </span>
                                          <% end %>
                                        </div>
                                      <% end %>
                                      <% if [
                                            (item.respond_to?(:is_vegetarian) && item.is_vegetarian),
                                            (item.respond_to?(:is_vegan) && item.is_vegan),
                                            (item.respond_to?(:is_gluten_free) && item.is_gluten_free),
                                            (item.respond_to?(:is_dairy_free) && item.is_dairy_free)
                                          ].any? %>
                                        <div class="d-flex flex-wrap gap-1 mb-2">
                                          <% if item.respond_to?(:is_vegetarian) && item.is_vegetarian %>
                                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                                              <i class="bi bi-egg-fried me-1"></i> Vegetarian
                                            </span>
                                          <% end %>
                                          <% if item.respond_to?(:is_vegan) && item.is_vegan %>
                                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                                              <i class="bi bi-flower1 me-1"></i> Vegan
                                            </span>
                                          <% end %>
                                          <% if item.respond_to?(:is_gluten_free) && item.is_gluten_free %>
                                            <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                                              <i class="bi bi-x-circle me-1"></i> Gluten Free
                                            </span>
                                          <% end %>
                                          <% if item.respond_to?(:is_dairy_free) && item.is_dairy_free %>
                                            <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                                              <i class="bi bi-droplet me-1"></i> Dairy Free
                                            </span>
                                          <% end %>
                                        </div>
                                      <% end %>
                                    </div>
                                  <% end %>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                    </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true" data-bs-backdrop="static" data-controller="menu-import" data-menu-import-target="confirmModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center p-4">
        <div class="d-flex justify-content-center mb-3">
          <div class="bg-success bg-opacity-10 rounded-circle p-3">
            <i class="bi bi-check-circle-fill text-success text-2rem"></i>
          </div>
        </div>
        <h5 class="modal-title mb-3" id="confirmModalLabel">Publish Menu</h5>
        <p class="text-muted mb-4">
          Confirm to publish your menu. You can optionally use Sync publish to archive any existing sections/items not present in this import.
        </p>
        <%= form_with url: confirm_import_restaurant_ocr_menu_import_path(@restaurant, @ocr_menu_import), method: :post, html: { class: 'mb-0' } do %>
          <div class="form-check d-flex align-items-center justify-content-center mb-3">
            <%= check_box_tag :sync, '1', false, id: 'sync_publish', class: 'form-check-input me-2' %>
            <%= label_tag :sync_publish, 'Sync publish (archive sections/items not in this import)', class: 'form-check-label' %>
          </div>
          <div class="d-flex justify-content-center gap-3">
            <%= submit_tag 'Publish Menu', class: 'btn btn-danger btn-lg' %>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true" data-bs-backdrop="static" data-controller="menu-import" data-menu-import-target="editItemModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editItemModalLabel"><%= t('.edit_item_modal_title') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"></button>
      </div>
      <form id="editItemForm" data-menu-import-target="editItemForm">
        <input type="hidden" name="item_id" data-menu-import-target="editItemId">
        
        <div class="modal-body">
          <div class="mb-3">
            <label for="item_name" class="form-label"><%= t('.item_name') %></label>
            <input type="text" class="form-control" id="item_name" name="item_name" data-menu-import-target="editItemName">
          </div>
          
          <div class="mb-3">
            <label for="item_description" class="form-label"><%= t('.description') %></label>
            <textarea class="form-control" id="item_description" name="item_description" rows="3" data-menu-import-target="editItemDescription"></textarea>
          </div>
          
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label for="item_price" class="form-label"><%= t('.price') %></label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" id="item_price" name="item_price" placeholder="0.00" data-menu-import-target="editItemPrice">
              </div>
            </div>
            
            <div class="col-md-4">
              <label for="item_section" class="form-label"><%= t('.section') %></label>
              <select class="form-select" id="item_section" name="item_section" data-menu-import-target="editItemSection" disabled title="<%= t('.section_disabled_title') %>">
                <% @ocr_menu_import.ocr_menu_sections.ordered.each do |section| %>
                  <option value="<%= section.id %>"><%= section.name %></option>
                <% end %>
              </select>
              <div class="form-text text-muted"><%= t('.reorder_hint') %></div>
            </div>
            <div class="col-md-4">
              <label for="item_position" class="form-label"><%= t('.position') %></label>
              <input type="number" class="form-control" id="item_position" name="item_position" data-menu-import-target="editItemPosition">
            </div>
          </div>
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label"><%= t('.dietary_information') %></label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_vegetarian" name="item_vegetarian" data-menu-import-target="editItemVegetarian">
                <label class="form-check-label" for="item_vegetarian">
                  <%= t('.vegetarian') %>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_vegan" name="item_vegan" data-menu-import-target="editItemVegan">
                <label class="form-check-label" for="item_vegan">
                  <%= t('.vegan') %>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_gluten_free" name="item_gluten_free" data-menu-import-target="editItemGlutenFree">
                <label class="form-check-label" for="item_gluten_free">
                  <%= t('.gluten_free') %>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="item_dairy_free" name="item_dairy_free" data-menu-import-target="editItemDairyFree">
                <label class="form-check-label" for="item_dairy_free">
                  <%= t('.dairy_free') %>
                </label>
              </div>
            </div>

            <div class="col-md-6">
              <label for="item_allergens" class="form-label"><%= t('.allergens') %></label>
              <% default_allergens = %w[gluten dairy egg peanut tree_nut soy shellfish fish sesame mustard celery sulphites lupin mollusc garlic onion] %>
              <% existing_allergens = @ocr_menu_import.ocr_menu_items.flat_map { |i| i.allergens || [] } %>
              <% allergen_options = (default_allergens + existing_allergens).compact.map { |a| a.to_s.strip.downcase }.reject(&:blank?).uniq %>
              <select class="form-select" id="item_allergens" name="item_allergens[]" multiple data-menu-import-target="editItemAllergens">
                <% allergen_options.each do |allergen| %>
                  <option value="<%= allergen %>"><%= allergen.titleize %></option>
                <% end %>
              </select>
              <div class="form-text"><%= t('.hold_multi_select') %></div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger me-auto" data-action="click->menu-import#deleteItem">
            <i class="bi bi-trash me-1"></i> <%= t('.delete') %>
          </button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <%= t('.cancel') %>
          </button>
          <button type="button" class="btn btn-primary" data-action="click->menu-import#saveItem">
            <i class="bi bi-save me-1"></i> <%= t('.save_changes') %>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  /* Mobile-friendly Publish button styling */
  .publish-btn {
    min-height: 48px;
    font-size: 1rem;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
  }
  
  @media (max-width: 768px) {
    .publish-btn {
      min-height: 56px;
      font-size: 1.125rem;
    }
  }
  
  /* Progress Slider Styling */
  .progress-slider-container {
    position: relative;
    width: 100%;
  }
  
  .progress-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: #e5e7eb;
    outline: none;
    position: relative;
    z-index: 2;
  }
  
  .progress-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #dc2626;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .progress-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #dc2626;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .progress-slider-track {
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    pointer-events: none;
    z-index: 1;
  }
  
  .progress-slider-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
  }
  
  .progress-slider:disabled {
    cursor: default;
  }
  
  .progress-slider:disabled::-webkit-slider-thumb {
    cursor: default;
  }
  
  .progress-slider:disabled::-moz-range-thumb {
    cursor: default;
  }
</style>