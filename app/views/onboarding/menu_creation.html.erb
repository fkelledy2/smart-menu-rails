<div class="row">
  <div class="col-lg-6">
    <div class="wizard-form">
      <div class="mb-4">
        <h1 class="h2 mb-3"><%= t('onboarding.menu_creation.title') %></h1>
        <p class="text-muted"><%= t('onboarding.menu_creation.subtitle') %></p>
      </div>

      <%= form_with model: @onboarding, url: onboarding_path, method: :patch, local: true, 
                    data: { step: 4, turbo_method: "patch" }, class: "needs-validation", novalidate: true do |f| %>
        
        <div class="mb-4">
          <%= f.label :menu_name, t('onboarding.menu_creation.menu_name_label'), class: "form-label" %>
          <%= f.text_field :menu_name, 
              class: "form-control form-control-lg", 
              placeholder: t('onboarding.menu_creation.menu_name_placeholder'),
              value: @onboarding&.menu_name || t('onboarding.menu_creation.menu_name_default'),
              required: true %>
          <div class="invalid-feedback">
            <%= t('onboarding.menu_creation.menu_name_required') %>
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label"><%= t('onboarding.menu_creation.menu_items_label') %></label>
          <div id="menu-items-container">
            <!-- Menu items will be added here -->
          </div>
          
          <button type="button" class="btn btn-outline-primary" id="add-item-btn">
            <i class="fas fa-plus me-2"></i>
            <%= t('onboarding.menu_creation.add_menu_item') %>
          </button>
          
          <div class="form-text mt-2">
            <%= t('onboarding.menu_creation.menu_items_help') %>
          </div>
        </div>

        <!-- Template suggestions -->
        <div class="mb-4">
          <label class="form-label"><%= t('onboarding.menu_creation.quick_start_label') %></label>
          <div class="row g-2">
            <div class="col-6">
              <button type="button" class="btn btn-outline-secondary btn-sm w-100 template-btn" 
                      data-template="italian">
                <i class="fas fa-pizza-slice me-1"></i>
                <%= t('onboarding.menu_creation.templates.italian') %>
              </button>
            </div>
            <div class="col-6">
              <button type="button" class="btn btn-outline-secondary btn-sm w-100 template-btn" 
                      data-template="american">
                <i class="fas fa-hamburger me-1"></i>
                <%= t('onboarding.menu_creation.templates.american') %>
              </button>
            </div>
            <div class="col-6">
              <button type="button" class="btn btn-outline-secondary btn-sm w-100 template-btn" 
                      data-template="mexican">
                <i class="fas fa-pepper-hot me-1"></i>
                <%= t('onboarding.menu_creation.templates.mexican') %>
              </button>
            </div>
            <div class="col-6">
              <button type="button" class="btn btn-outline-secondary btn-sm w-100 template-btn" 
                      data-template="asian">
                <i class="fas fa-fish me-1"></i>
                <%= t('onboarding.menu_creation.templates.asian') %>
              </button>
            </div>
          </div>
          <div class="form-text"><%= t('onboarding.menu_creation.templates_help') %></div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-5">
          <%= link_to onboarding_step_path(3), class: "btn btn-outline-secondary btn-lg btn-wizard" do %>
            <i class="fas fa-arrow-left me-2"></i>
            <%= t('onboarding.menu_creation.back') %>
          <% end %>
          
          <button type="submit" class="btn btn-primary btn-lg btn-wizard" id="continue-btn" disabled>
            <%= t('onboarding.menu_creation.create_menu') %>
            <i class="fas fa-arrow-right ms-2"></i>
          </button>
        </div>
      <% end %>
    </div>
  </div>
  
  <div class="col-lg-6">
    <div class="sticky-top" style="top: 2rem;">
      <h5 class="mb-3">
        <i class="fas fa-eye me-2"></i>
        <%= t('onboarding.menu_creation.live_preview') %>
      </h5>
      <div class="menu-preview" id="menu-preview">
        <div class="text-center text-muted py-5">
          <i class="fas fa-utensils fs-1 mb-3"></i>
          <p><%= t('onboarding.menu_creation.preview_empty') %></p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Menu item template -->
<template id="menu-item-template">
  <div class="menu-item-input" data-item-index="">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <h6 class="mb-0"><%= t('onboarding.menu_creation.menu_item_title') %></h6>
      <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="row g-2">
      <div class="col-md-6">
        <input type="text" 
               class="form-control item-name" 
               placeholder="<%= t('onboarding.menu_creation.item_name_placeholder') %>" 
               name="onboarding_session[menu_items][][name]"
               required>
      </div>
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text">$</span>
          <input type="number" 
                 class="form-control item-price" 
                 placeholder="<%= t('onboarding.menu_creation.item_price_placeholder') %>" 
                 name="onboarding_session[menu_items][][price]"
                 step="0.01"
                 min="0"
                 required>
        </div>
      </div>
    </div>
    
    <div class="mt-2">
      <textarea class="form-control item-description" 
                placeholder="<%= t('onboarding.menu_creation.item_description_placeholder') %>"
                name="onboarding_session[menu_items][][description]"
                rows="2"></textarea>
    </div>
  </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let itemIndex = 0;
  const container = document.getElementById('menu-items-container');
  const addBtn = document.getElementById('add-item-btn');
  const continueBtn = document.getElementById('continue-btn');
  const menuPreview = document.getElementById('menu-preview');
  
  // Menu templates
  const templates = {
    italian: [
      { name: '<%= j(t('onboarding.menu_creation.template_items.italian.margherita_pizza.name')) %>', price: '16.99', description: '<%= j(t('onboarding.menu_creation.template_items.italian.margherita_pizza.description')) %>' },
      { name: '<%= j(t('onboarding.menu_creation.template_items.italian.spaghetti_carbonara.name')) %>', price: '18.99', description: '<%= j(t('onboarding.menu_creation.template_items.italian.spaghetti_carbonara.description')) %>' },
      { name: '<%= j(t('onboarding.menu_creation.template_items.italian.caesar_salad.name')) %>', price: '12.99', description: '<%= j(t('onboarding.menu_creation.template_items.italian.caesar_salad.description')) %>' }
    ],
    american: [
      { name: '<%= j(t('onboarding.menu_creation.template_items.american.classic_burger.name')) %>', price: '14.99', description: '<%= j(t('onboarding.menu_creation.template_items.american.classic_burger.description')) %>' },
      { name: '<%= j(t('onboarding.menu_creation.template_items.american.bbq_ribs.name')) %>', price: '22.99', description: '<%= j(t('onboarding.menu_creation.template_items.american.bbq_ribs.description')) %>' },
      { name: '<%= j(t('onboarding.menu_creation.template_items.american.buffalo_wings.name')) %>', price: '11.99', description: '<%= j(t('onboarding.menu_creation.template_items.american.buffalo_wings.description')) %>' }
    ],
    mexican: [
      { name: '<%= j(t('onboarding.menu_creation.template_items.mexican.chicken_tacos.name')) %>', price: '13.99', description: '<%= j(t('onboarding.menu_creation.template_items.mexican.chicken_tacos.description')) %>' },
      { name: '<%= j(t('onboarding.menu_creation.template_items.mexican.beef_burrito.name')) %>', price: '15.99', description: '<%= j(t('onboarding.menu_creation.template_items.mexican.beef_burrito.description')) %>' },
      { name: '<%= j(t('onboarding.menu_creation.template_items.mexican.guacamole_chips.name')) %>', price: '8.99', description: '<%= j(t('onboarding.menu_creation.template_items.mexican.guacamole_chips.description')) %>' }
    ],
    asian: [
      { name: '<%= j(t('onboarding.menu_creation.template_items.asian.pad_thai.name')) %>', price: '16.99', description: '<%= j(t('onboarding.menu_creation.template_items.asian.pad_thai.description')) %>' },
      { name: '<%= j(t('onboarding.menu_creation.template_items.asian.chicken_teriyaki.name')) %>', price: '18.99', description: '<%= j(t('onboarding.menu_creation.template_items.asian.chicken_teriyaki.description')) %>' },
      { name: '<%= j(t('onboarding.menu_creation.template_items.asian.spring_rolls.name')) %>', price: '7.99', description: '<%= j(t('onboarding.menu_creation.template_items.asian.spring_rolls.description')) %>' }
    ]
  };
  
  // Add menu item
  function addMenuItem(itemData = {}) {
    const template = document.getElementById('menu-item-template');
    const clone = template.content.cloneNode(true);
    
    // Set index
    const itemDiv = clone.querySelector('.menu-item-input');
    itemDiv.dataset.itemIndex = itemIndex;
    
    // Fill data if provided
    if (itemData.name) clone.querySelector('.item-name').value = itemData.name;
    if (itemData.price) clone.querySelector('.item-price').value = itemData.price;
    if (itemData.description) clone.querySelector('.item-description').value = itemData.description;
    
    // Update name attributes with index
    clone.querySelectorAll('input, textarea').forEach(input => {
      input.name = input.name.replace('[]', `[${itemIndex}]`);
    });
    
    // Add remove functionality
    clone.querySelector('.remove-item-btn').addEventListener('click', function() {
      itemDiv.remove();
      updatePreview();
      updateContinueButton();
    });
    
    // Add input listeners for live preview
    clone.querySelectorAll('input, textarea').forEach(input => {
      input.addEventListener('input', updatePreview);
    });
    
    container.appendChild(clone);
    itemIndex++;
    
    updatePreview();
    updateContinueButton();
  }
  
  // Update menu preview
  function updatePreview() {
    const menuName = document.querySelector('#onboarding_session_menu_name').value || '<%= j(t('onboarding.menu_creation.menu_name_default')) %>';
    const items = Array.from(container.querySelectorAll('.menu-item-input')).map(item => {
      return {
        name: item.querySelector('.item-name').value,
        price: item.querySelector('.item-price').value,
        description: item.querySelector('.item-description').value
      };
    }).filter(item => item.name);
    
    let html = `<div class="text-center mb-4">
                  <h4 class="text-primary">${menuName}</h4>
                </div>`;
    
    if (items.length === 0) {
      html += `<div class="text-center text-muted py-3">
                 <i class="fas fa-utensils fs-1 mb-3"></i>
                 <p><%= j(t('onboarding.menu_creation.preview_empty_alt')) %></p>
               </div>`;
    } else {
      items.forEach(item => {
        html += `<div class="border-bottom pb-3 mb-3">
                   <div class="d-flex justify-content-between align-items-start">
                     <div class="flex-grow-1">
                       <h6 class="mb-1">${item.name}</h6>
                       ${item.description ? `<small class="text-muted">${item.description}</small>` : ''}
                     </div>
                     <div class="text-primary fw-bold ms-3">
                       ${item.price ? `$${parseFloat(item.price).toFixed(2)}` : ''}
                     </div>
                   </div>
                 </div>`;
      });
    }
    
    menuPreview.innerHTML = html;
  }
  
  // Update continue button state
  function updateContinueButton() {
    const itemCount = container.querySelectorAll('.menu-item-input').length;
    continueBtn.disabled = itemCount < 3;
    
    if (itemCount < 3) {
      continueBtn.innerHTML = `<%= j(t('onboarding.menu_creation.need_more_items', count: '${3 - itemCount}')) %>`.replace('${3 - itemCount}', 3 - itemCount) + ' <i class="fas fa-arrow-right ms-2"></i>';
    } else {
      continueBtn.innerHTML = `<%= j(t('onboarding.menu_creation.create_menu')) %> <i class="fas fa-arrow-right ms-2"></i>`;
    }
  }
  
  // Event listeners
  addBtn.addEventListener('click', () => addMenuItem());
  
  document.querySelector('#onboarding_session_menu_name').addEventListener('input', updatePreview);
  
  // Template buttons
  document.querySelectorAll('.template-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const templateName = this.dataset.template;
      const templateItems = templates[templateName];
      
      // Clear existing items
      container.innerHTML = '';
      itemIndex = 0;
      
      // Add template items
      templateItems.forEach(item => addMenuItem(item));
      
      // Update button state
      this.classList.add('btn-success');
      this.innerHTML = `<i class="fas fa-check me-1"></i> <%= j(t('onboarding.menu_creation.template_added')) %>`;
      
      setTimeout(() => {
        this.classList.remove('btn-success');
        this.innerHTML = this.innerHTML.replace('<%= j(t('onboarding.menu_creation.template_added')) %>', templateName.charAt(0).toUpperCase() + templateName.slice(1));
      }, 2000);
    });
  });
  
  // Load existing items if any
  <% if @onboarding&.menu_items&.any? %>
    <% @onboarding.menu_items.each do |item| %>
      addMenuItem({
        name: '<%= j(item["name"]) %>',
        price: '<%= item["price"] %>',
        description: '<%= j(item["description"]) %>'
      });
    <% end %>
  <% else %>
    // Add one empty item to start
    addMenuItem();
  <% end %>
  
  // Form validation
  const form = document.querySelector('.needs-validation');
  form.addEventListener('submit', function(event) {
    const itemCount = container.querySelectorAll('.menu-item-input').length;
    if (itemCount < 3) {
      event.preventDefault();
      event.stopPropagation();
      alert('<%= j(t('onboarding.menu_creation.min_items_alert')) %>');
    }
  });
});
</script>
