<div class="wizard-form mx-auto max-width-1200">
  <div class="text-center mb-5">
    <h1 class="h2 mb-3"><%= t('onboarding.plan_selection.title') %></h1>
    <p class="text-muted"><%= t('onboarding.plan_selection.subtitle') %></p>
  </div>

  <%= form_with url: onboarding_path, method: :patch, local: true,
                data: { step: 3 }, class: "needs-validation", novalidate: true do |f| %>

    <div class="row g-3 mb-5">
      <% @plans.each do |plan| %>
        <div class="col-sm-6 col-lg-3">
          <div class="card plan-card h-100 <%= 'border-primary' if plan.name == 'Professional' %>"
               data-plan-id="<%= plan.id %>">

            <% if plan.name == 'Professional' %>
              <div class="card-header bg-primary text-white text-center">
                <small class="fw-bold"><%= t('onboarding.plan_selection.most_popular') %></small>
              </div>
            <% end %>

            <div class="card-body d-flex flex-column p-3">
              <div class="text-center mb-3">
                <h5 class="card-title mb-2"><%= plan.name %></h5>
                <div class="h4 fw-bold text-primary mb-1">
                  $<%= plan.price || 0 %>
                  <small class="fs-6 text-muted"><%= t('onboarding.plan_selection.per_month') %></small>
                </div>
                <% if plan.price && plan.price > 0 %>
                  <small class="text-success"><%= t('onboarding.plan_selection.free_trial') %></small>
                <% else %>
                  <small class="text-muted"><%= t('onboarding.plan_selection.always_free') %></small>
                <% end %>
              </div>

              <ul class="list-unstyled mb-3 flex-grow-1 small">
                <li class="mb-1">
                  <i class="fas fa-check text-success me-1"></i>
                  <%= plan.getLocations %> <%= t('onboarding.plan_selection.features.locations') %>
                </li>
                <li class="mb-1">
                  <i class="fas fa-check text-success me-1"></i>
                  <%= plan.getMenusPerLocation %> <%= t('onboarding.plan_selection.features.menus_per_location') %>
                </li>
                <li class="mb-1">
                  <i class="fas fa-check text-success me-1"></i>
                  <%= plan.getItemsPerMenu %> <%= t('onboarding.plan_selection.features.items_per_menu') %>
                </li>
                <li class="mb-1">
                  <i class="fas fa-check text-success me-1"></i>
                  <%= plan.getLanguages %> <%= t('onboarding.plan_selection.features.languages') %>
                </li>
                <li class="mb-1">
                  <i class="fas fa-check text-success me-1"></i>
                  <%= t('onboarding.plan_selection.features.qr_code_menus') %>
                </li>
                <li class="mb-1">
                  <i class="fas fa-check text-success me-1"></i>
                  <%= t('onboarding.plan_selection.features.online_ordering') %>
                </li>
                <% if plan.name != 'Starter' %>
                  <li class="mb-1">
                    <i class="fas fa-check text-success me-1"></i>
                    <%= t('onboarding.plan_selection.features.priority_support') %>
                  </li>
                  <li class="mb-1">
                    <i class="fas fa-check text-success me-1"></i>
                    <%= t('onboarding.plan_selection.features.advanced_analytics') %>
                  </li>
                <% end %>
                <% if plan.name == 'Enterprise' %>
                  <li class="mb-1">
                    <i class="fas fa-check text-success me-1"></i>
                    <%= t('onboarding.plan_selection.features.custom_branding') %>
                  </li>
                  <li class="mb-1">
                    <i class="fas fa-check text-success me-1"></i>
                    <%= t('onboarding.plan_selection.features.api_access') %>
                  </li>
                <% end %>
              </ul>

              <div class="mt-auto">
                <button type="button"
                        class="btn btn-outline-primary w-100 select-plan-btn"
                        data-plan-id="<%= plan.id %>">
                  <% if plan.price && plan.price > 0 %>
                    <%= t('onboarding.plan_selection.start_free_trial') %>
                  <% else %>
                    <%= t('onboarding.plan_selection.choose_free_plan') %>
                  <% end %>
                </button>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <%= hidden_field_tag :plan_id, @onboarding&.selected_plan_id %>

    <div class="d-flex justify-content-between align-items-center mt-5">
      <%= link_to onboarding_step_path(2), class: "btn btn-outline-secondary btn-lg btn-wizard" do %>
        <i class="fas fa-arrow-left me-2"></i>
        <%= t('onboarding.plan_selection.back') %>
      <% end %>

      <button type="submit" class="btn btn-primary btn-lg btn-wizard" id="continue-btn" disabled>
        <%= t('onboarding.plan_selection.continue') %>
        <i class="fas fa-arrow-right ms-2"></i>
      </button>
    </div>
  <% end %>
</div>

<!-- Trust indicators -->
<div class="text-center mt-5">
  <div class="row">
    <div class="col-md-4">
      <i class="fas fa-shield-alt text-success fs-1 mb-2"></i>
      <h6><%= t('onboarding.plan_selection.trust_indicators.secure_title') %></h6>
      <small class="text-muted"><%= t('onboarding.plan_selection.trust_indicators.secure_subtitle') %></small>
    </div>
    <div class="col-md-4">
      <i class="fas fa-mobile-alt text-primary fs-1 mb-2"></i>
      <h6><%= t('onboarding.plan_selection.trust_indicators.mobile_title') %></h6>
      <small class="text-muted"><%= t('onboarding.plan_selection.trust_indicators.mobile_subtitle') %></small>
    </div>
    <div class="col-md-4">
      <i class="fas fa-headset text-info fs-1 mb-2"></i>
      <h6><%= t('onboarding.plan_selection.trust_indicators.support_title') %></h6>
      <small class="text-muted"><%= t('onboarding.plan_selection.trust_indicators.support_subtitle') %></small>
    </div>
  </div>
</div>

<style>
.plan-card {
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid #dee2e6;
}

.plan-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

.plan-card.selected {
  border-color: #007bff !important;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
}

.plan-card.selected .select-plan-btn {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const planCards = document.querySelectorAll('.plan-card');
  const selectButtons = document.querySelectorAll('.select-plan-btn');
  const planIdInput = document.querySelector('#plan_id');
  const continueBtn = document.querySelector('#continue-btn');

  // Handle plan selection
  selectButtons.forEach(button => {
    button.addEventListener('click', function() {
      const planId = this.dataset.planId;

      // Remove selected state from all cards
      planCards.forEach(card => card.classList.remove('selected'));
      selectButtons.forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
        btn.textContent = btn.textContent.replace('<%= j(t('onboarding.plan_selection.selected')) %>', btn.textContent.includes('<%= j(t('onboarding.plan_selection.choose_free_plan')) %>') ? '<%= j(t('onboarding.plan_selection.choose_free_plan')) %>' : '<%= j(t('onboarding.plan_selection.start_free_trial')) %>');
      });

      // Add selected state to clicked card
      const selectedCard = document.querySelector(`[data-plan-id="${planId}"]`);
      selectedCard.classList.add('selected');

      this.classList.remove('btn-outline-primary');
      this.classList.add('btn-primary');
      this.textContent = '<%= j(t('onboarding.plan_selection.selected')) %>';

      // Update hidden field and enable continue button
      planIdInput.value = planId;
      continueBtn.disabled = false;
    });
  });

  // Pre-select if plan already chosen
  if (planIdInput.value) {
    const preselectedBtn = document.querySelector(`[data-plan-id="${planIdInput.value}"]`);
    if (preselectedBtn) {
      preselectedBtn.click();
    }
  }

  // Form validation
  const form = document.querySelector('.needs-validation');
  form.addEventListener('submit', function(event) {
    if (!planIdInput.value) {
      event.preventDefault();
      event.stopPropagation();
      alert('<%= j(t('onboarding.plan_selection.select_plan_alert')) %>');
    }
  });
});
</script>
