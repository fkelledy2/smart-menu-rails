<div class="text-center">
  <div class="mb-5">
    <div class="display-1 text-success mb-4">
      <i class="fas fa-check-circle"></i>
    </div>
    <h1 class="h2 mb-3"><%= t('onboarding.completion.title') %></h1>
    <p class="lead text-muted"><%= t('onboarding.completion.subtitle') %></p>
  </div>

  <div class="row justify-content-center mb-5">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <h5 class="card-title mb-4">
            <i class="fas fa-qrcode text-primary me-2"></i>
            <%= t('onboarding.completion.qr_ready_title') %>
          </h5>

          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="qr-code-placeholder bg-light d-flex align-items-center justify-content-center"
                   class="qr-placeholder">
                <div class="text-center">
                  <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden"><%= t('onboarding.completion.generating_qr') %></span>
                  </div>
                  <p class="mb-0 text-muted"><%= t('onboarding.completion.generating_status') %></p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <h6 class="mb-3"><%= t('onboarding.completion.whats_happening') %></h6>
              <ul class="list-unstyled">
                <li class="mb-2">
                  <i class="fas fa-cog fa-spin text-primary me-2"></i>
                  <%= t('onboarding.completion.creating_profile') %>
                </li>
                <li class="mb-2">
                  <i class="fas fa-cog fa-spin text-primary me-2"></i>
                  <%= t('onboarding.completion.setting_up_menu') %>
                </li>
                <li class="mb-2">
                  <i class="fas fa-cog fa-spin text-primary me-2"></i>
                  <%= t('onboarding.completion.generating_qr_codes') %>
                </li>
                <li class="mb-2">
                  <i class="fas fa-cog fa-spin text-primary me-2"></i>
                  <%= t('onboarding.completion.configuring_payments') %>
                </li>
              </ul>

              <div class="alert alert-info mt-3">
                <small>
                  <i class="fas fa-info-circle me-1"></i>
                  <%= t('onboarding.completion.completion_time') %>
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Next steps preview -->
  <div class="row justify-content-center mb-5">
    <div class="col-lg-10">
      <h5 class="mb-4"><%= t('onboarding.completion.whats_next') %></h5>
      <div class="row g-4">
        <div class="col-md-4">
          <div class="card h-100 border-0 bg-light">
            <div class="card-body text-center">
              <i class="fas fa-edit text-primary fs-1 mb-3"></i>
              <h6><%= t('onboarding.completion.customize_menu_title') %></h6>
              <p class="small text-muted mb-0"><%= t('onboarding.completion.customize_menu_description') %></p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100 border-0 bg-light">
            <div class="card-body text-center">
              <i class="fas fa-print text-success fs-1 mb-3"></i>
              <h6><%= t('onboarding.completion.print_qr_title') %></h6>
              <p class="small text-muted mb-0"><%= t('onboarding.completion.print_qr_description') %></p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100 border-0 bg-light">
            <div class="card-body text-center">
              <i class="fas fa-chart-line text-info fs-1 mb-3"></i>
              <h6><%= t('onboarding.completion.track_orders_title') %></h6>
              <p class="small text-muted mb-0"><%= t('onboarding.completion.track_orders_description') %></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success stats -->
  <div class="row text-center mb-5">
    <div class="col-md-4">
      <div class="display-6 text-success fw-bold">âœ“</div>
      <h6><%= t('onboarding.completion.restaurant_created') %></h6>
      <small class="text-muted"><%= @onboarding&.restaurant_name || 'Your Restaurant' %></small>
    </div>
    <div class="col-md-4">
      <div class="display-6 text-success fw-bold">âœ“</div>
      <h6><%= t('onboarding.completion.menu_published') %></h6>
      <small class="text-muted"><%= @onboarding&.menu_name || t('onboarding.menu_creation.menu_name_default') %></small>
    </div>
    <div class="col-md-4">
      <div class="display-6 text-success fw-bold">âœ“</div>
      <h6><%= t('onboarding.completion.plan_activated') %></h6>
      <small class="text-muted"><%= t('onboarding.completion.free_trial_status') %></small>
    </div>
  </div>

  <!-- CTA buttons -->
  <div class="d-flex flex-column flex-md-row gap-3 justify-content-center">
    <button class="btn btn-primary btn-lg" id="go-to-dashboard" disabled>
      <i class="fas fa-tachometer-alt me-2"></i>
      <%= t('onboarding.completion.go_to_dashboard') %>
    </button>
    <button class="btn btn-outline-primary btn-lg" id="view-menu" disabled>
      <i class="fas fa-eye me-2"></i>
      <%= t('onboarding.completion.view_live_menu') %>
    </button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let checkCount = 0;
  const maxChecks = 30; // 30 seconds maximum wait

  // Check completion status
  function checkCompletion() {
    checkCount++;

    fetch('/onboarding', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.completed) {
        showSuccess(data);
      } else if (checkCount < maxChecks) {
        setTimeout(checkCompletion, 2000); // Check every 2 seconds
      } else {
        showTimeout();
      }
    })
    .catch(error => {
      console.error('Error checking completion:', error);
      if (checkCount < maxChecks) {
        setTimeout(checkCompletion, 2000);
      } else {
        showTimeout();
      }
    });
  }

  function showSuccess(data) {
    // Update QR code
    const qrPlaceholder = document.querySelector('.qr-code-placeholder');
    if (data.qr_code_url) {
      qrPlaceholder.innerHTML = `
        <img src="${data.qr_code_url}" alt="QR Code" class="img-fluid max-width-180">
      `;
    } else {
      qrPlaceholder.innerHTML = `
        <div class="text-center">
          <i class="fas fa-qrcode text-success text-extra-large"></i>
          <p class="mb-0 text-success mt-2"><%= j(t('onboarding.completion.qr_code_ready')) %></p>
        </div>
      `;
    }

    // Update status indicators
    document.querySelectorAll('.fa-cog').forEach(icon => {
      icon.classList.remove('fa-cog', 'fa-spin');
      icon.classList.add('fa-check');
      icon.style.color = '#28a745';
    });

    // Enable buttons
    const dashboardBtn = document.getElementById('go-to-dashboard');
    const menuBtn = document.getElementById('view-menu');

    dashboardBtn.disabled = false;
    menuBtn.disabled = false;

    if (data.dashboard_url) {
      dashboardBtn.onclick = () => window.location.href = data.dashboard_url;
    } else {
      dashboardBtn.onclick = () => window.location.href = '/';
    }

    if (data.menu_url) {
      menuBtn.onclick = () => window.open(data.menu_url, '_blank');
    }

    // Show success animation
    confetti({
      particleCount: 100,
      spread: 70,
      origin: { y: 0.6 }
    });
  }

  function showTimeout() {
    const qrPlaceholder = document.querySelector('.qr-code-placeholder');
    qrPlaceholder.innerHTML = `
      <div class="text-center">
        <i class="fas fa-exclamation-triangle text-warning text-large"></i>
        <p class="mb-0 text-warning mt-2"><%= j(t('onboarding.completion.setup_timeout')) %></p>
        <small class="text-muted"><%= j(t('onboarding.completion.setup_timeout_help')) %></small>
      </div>
    `;

    // Enable dashboard button anyway
    const dashboardBtn = document.getElementById('go-to-dashboard');
    dashboardBtn.disabled = false;
    dashboardBtn.onclick = () => window.location.href = '/';
  }

  // Start checking after 2 seconds
  setTimeout(checkCompletion, 2000);

  // Animate the progress indicators
  let currentStep = 0;
  const steps = document.querySelectorAll('.fa-cog');

  function animateSteps() {
    if (currentStep < steps.length) {
      steps[currentStep].style.color = '#007bff';
      currentStep++;
      setTimeout(animateSteps, 1000);
    }
  }

  animateSteps();
});

// Confetti function (simple fallback if library not available)
function confetti(options) {
  if (typeof window.confetti === 'function') {
    window.confetti(options);
  } else {
    // Simple celebration without library
    console.log('ðŸŽ‰ Celebration! Setup complete!');
  }
}
</script>
