
<!DOCTYPE html>
<html class="h-100">
<style>
    ::-webkit-scrollbar {
        height: 0px;
        width: 4px;
        border: 1px solid #d5d5d5;
    }
    .form-control:disabled {
        background-color: #fafafa;
        opacity: 1;
    }
    .tabulator-row-odd {
        background-color: #ffffff !important;
    }
    .tabulator-row-even {
        background-color: #ffffff !important;
    }
    .disabled .ts-control {
        opacity: 1.0;
        background-color: #fafafa;
    }
    .ts-dropdown, .ts-control, .ts-control input {
        color: #000000;
        padding-left:12px;
        font-size: 16px;
        line-height: 18px;
    }
</style>
  <head>
    <%= render 'shared/head' %>
    <%= Sentry.get_trace_propagation_meta.html_safe %>
    
    <!-- 1. Load jQuery first -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" 
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" 
            crossorigin="anonymous"></script>
    
    <!-- 2. Load Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
          rel="stylesheet" 
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" 
          crossorigin="anonymous">
    
    <!-- 3. Application CSS -->
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    
    <!-- 4. Bootstrap Loader - Must run before any other scripts -->
    <script>
      // Create a promise that resolves when Bootstrap is loaded
      window.bootstrapLoaded = new Promise(resolve => {
        // Check if Bootstrap is already loaded
        if (window.bootstrap && window.bootstrap.Modal) {
          console.log('Bootstrap already loaded in smartmenu');
          resolve(window.bootstrap);
          return;
        }
        
        // Store the original bootstrap reference if it exists
        const originalBootstrap = window.bootstrap;
        
        // Create a script element to load Bootstrap
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js';
        script.integrity = 'sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz';
        script.crossOrigin = 'anonymous';
        
        script.onload = function() {
          // Store Bootstrap in our global variable
          window.bootstrap = bootstrap || originalBootstrap || window.bootstrap;
          console.log('Bootstrap loaded successfully in smartmenu');
          
          // Dispatch an event that Bootstrap is ready
          const event = new Event('bootstrap:ready');
          document.dispatchEvent(event);
          
          // Resolve the promise
          resolve(window.bootstrap);
        };
        
        script.onerror = function() {
          console.error('Failed to load Bootstrap in smartmenu');
          // Resolve with null if loading fails
          resolve(null);
        };
        
        // Add the script to the head
        document.head.appendChild(script);
      });
      
      // Safe Bootstrap component initializer
      window.safeBootstrap = function(componentName, method, selector, options = {}) {
        window.bootstrapLoaded.then(bootstrap => {
          if (!bootstrap || !bootstrap[componentName]) {
            console.warn(`Bootstrap ${componentName} not available in smartmenu`);
            return;
          }
          
          const elements = document.querySelectorAll(selector);
          elements.forEach(element => {
            try {
              if (!element) return;
              
              const instance = bootstrap[componentName].getInstance(element) || 
                             new bootstrap[componentName](element, options);
              
              if (instance && method && typeof instance[method] === 'function') {
                instance[method]();
              }
            } catch (e) {
              console.error(`Error initializing Bootstrap ${componentName} in smartmenu:`, e);
            }
          });
        });
      };
      
      // Start loading Bootstrap immediately
      window.bootstrapLoaded.catch(console.error);
    </script>
    
    <!-- 5. Importmap and other scripts -->
    <%= javascript_importmap_tags %>
  </head>
  <body class="d-flex flex-column min-vh-100"
      data-smartmenu-id="<%= @smartmenu.slug %>"
      data-page="<%= controller.controller_name %><%= "-#{controller.action_name}" if controller.action_name.present? %>">
    <div id="backgroundContent" style="display: flex;min-height: 100vh;flex-direction: column;justify-content: space-between;">
        <main class="flex-wrapper">
          <% if current_user %>
              <%= render "shared/navbar" %>
          <% else %>
              <%= render "shared/smartmenunavbar" %>
          <% end %>
          <div class="container-fluid mx-auto">
                <div style="height:5px"></div>
                <%= yield %>
          </div>
        </main>
      <%= render 'shared/footer' %>
    </div>
    <%= render partial: "smartmenus/showModals", locals: { order: @openOrder, menu: @menu, ordrparticipant: @ordrparticipant, menuparticipant: @menuparticipant, restaurantCurrency: @restaurantCurrency, tablesetting: @tablesetting, current_employee: @current_employee } %>
    <%= render partial: "smartmenus/showContext", locals: { order: @openOrder, menu: @menu, current_employee: @current_employee, ordrparticipant: @ordrparticipant, menuparticipant: @menuparticipant, restaurantCurrency: @restaurantCurrency, tablesetting: @tablesetting } %>
  </body>
</html>
