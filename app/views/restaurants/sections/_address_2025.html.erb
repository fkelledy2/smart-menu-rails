<%#
  Restaurant Address Section
  Location and address management
%>

<% restaurant = local_assigns[:restaurant] || @restaurant %>

<!-- Address & Location -->
<div class="card">
  <div class="card-body">
  <h2 class="h5 mb-3">
      <i class="bi bi-geo-alt"></i>
      <%= t('.location') %>
    </h2>

  <%= restaurant_form_with(restaurant, auto_save: true) do |form| %>
    <div class="mb-4">
      <%= form.label :address1, class: 'form-label' do %>
        <%= t('activerecord.attributes.restaurant.address') %>
        <span class="text-danger">*</span>
      <% end %>
      <%= form.text_field :address1,
          class: 'form-control',
          placeholder: t('.address_placeholder'),
          required: true %>
      <%= form.hidden_field :latitude %>
      <%= form.hidden_field :longitude %>
      <div class="form-text">
        <%= t('.address_help') %>
      </div>
    </div>

    <div class="mb-4">
      <%= form.label :address2, class: 'form-label' do %>
        <%= t('activerecord.attributes.restaurant.address2') %>
      <% end %>
      <%= form.text_field :address2,
          class: 'form-control',
          placeholder: t('.address2_placeholder'),
          readonly: true %>
      <div class="form-text">
        <%= t('.address2_help') %>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div>
          <%= form.label :city, class: 'form-label' do %>
            <%= t('activerecord.attributes.restaurant.city') %>
            <span class="text-danger">*</span>
          <% end %>
          <%= form.text_field :city,
              class: 'form-control',
              required: true,
              readonly: true %>
        </div>
      </div>

      <div class="col-md-3">
        <div>
          <%= form.label :state, class: 'form-label' do %>
            <%= t('activerecord.attributes.restaurant.state') %>
          <% end %>
          <%= form.text_field :state,
              class: 'form-control',
              readonly: true %>
        </div>
      </div>

      <div class="col-md-3">
        <div>
          <%= form.label :postcode, class: 'form-label' do %>
            <%= t('activerecord.attributes.restaurant.postcode') %>
          <% end %>
          <%= form.text_field :postcode,
              class: 'form-control',
              readonly: true %>
        </div>
      </div>

      <div class="col-md-2">
        <div>
          <%= form.label :country, class: 'form-label' do %>
            <%= t('activerecord.attributes.restaurant.country') %>
          <% end %>
          <%= form.text_field :country,
              class: 'form-control',
              readonly: true %>
        </div>
      </div>
    </div>

    <% if restaurant.latitude.present? && restaurant.longitude.present? %>
      <div class="location-map-container mb-3">
        <div class="location-map-header">
          <i class="bi bi-check-circle-fill text-success me-2"></i>
          <span class="text-success fw-semibold">
            <%= t('restaurants.sections.address_2025.location_verified') %>
          </span>
        </div>
        <div id="restaurant-map" class="restaurant-map"
             data-latitude="<%= restaurant.latitude %>"
             data-longitude="<%= restaurant.longitude %>"
             data-name="<%= restaurant.name %>">
        </div>
      </div>
    <% end %>
  <% end %>
  </div>
</div>

<!-- Delivery Zones (if applicable) -->
<% if restaurant.respond_to?(:delivery_enabled) && restaurant.delivery_enabled? %>
  <div class="card mt-3">
    <div class="card-body">
    <h2 class="h5 mb-3">
        <i class="bi bi-geo"></i>
        <%= t('.delivery_zones') %>
      </h2>

    <p class="text-muted mb-4">
      <%= t('.delivery_zones_help') %>
    </p>

    <button class="btn btn-outline-secondary">
      <i class="bi bi-plus-circle"></i>
      <%= t('.add_zone') %>
    </button>
    </div>
  </div>
<% end %>

<style>
  .form-help-2025 {
    font-size: var(--text-sm);
    color: var(--color-gray-500);
    margin-top: var(--space-1);
  }

  .text-danger {
    color: var(--color-danger);
  }

  .location-map-container {
    margin-top: 1.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .location-map-header {
    padding: 0.75rem 1rem;
    background-color: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
  }

  .restaurant-map {
    width: 100%;
    height: 400px;
    background-color: #f3f4f6;
  }
</style>

<script>
  async function initRestaurantMap() {
    const mapElement = document.getElementById('restaurant-map');
    if (!mapElement) return;
    if (mapElement.dataset.mapInitialized === 'true') return;
    mapElement.dataset.mapInitialized = 'true';

    const mapLoadingText = '<%= j t('.map_loading') %>';
    const mapLocationLabel = '<%= j t('.map_location_label') %>';
    const mapLoadErrorText = '<%= j t('.map_load_error') %>';

    const latitude = parseFloat(mapElement.dataset.latitude);
    const longitude = parseFloat(mapElement.dataset.longitude);
    const restaurantName = mapElement.dataset.name;

    if (isNaN(latitude) || isNaN(longitude)) return;

    // Show loading state (no inline styles)
    mapElement.innerHTML = `
      <div class="d-flex align-items-center justify-content-center h-100 flex-column p-4">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">${mapLoadingText}</span>
        </div>
        <p class="text-muted mb-0">${mapLoadingText}</p>
      </div>
    `;

    // Function to wait for Google Maps to be fully loaded
    async function waitForGoogleMaps(maxAttempts = 20) {
      for (let i = 0; i < maxAttempts; i++) {
        if (typeof google !== 'undefined' && google.maps && google.maps.Map) {
          return true;
        }
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      return false;
    }

    try {
      // Load Google Maps API if not already loaded
      if (typeof google === 'undefined' || !google.maps || !google.maps.Map) {
        console.log('[RestaurantMap] Loading Google Maps API...');

        if (typeof window.initGoogleMaps === 'function') {
          await window.initGoogleMaps();
          // Wait for the API to be fully initialized
          const loaded = await waitForGoogleMaps();
          if (!loaded) {
            throw new Error('Google Maps API did not initialize in time');
          }
        } else {
          throw new Error('Google Maps loader not available');
        }
      }

      console.log('[RestaurantMap] Google Maps API ready, initializing map...');

      // Clear loading state
      mapElement.innerHTML = '';

      const position = { lat: latitude, lng: longitude };

      // Initialize Google Map (without mapId and styles to avoid API errors)
      const map = new google.maps.Map(mapElement, {
        center: position,
        zoom: 15,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true
      });

      // Add marker for restaurant location (use legacy Marker for compatibility)
      const marker = new google.maps.Marker({
        position: position,
        map: map,
        title: restaurantName,
        animation: google.maps.Animation.DROP
      });

      window.__restaurantMapInstance = { map: map, marker: marker, element: mapElement };

      // Add info window
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div class="p-2">
            <h6 class="mb-1 fw-semibold">${restaurantName}</h6>
            <p class="mb-0 small text-muted">
              ${latitude.toFixed(6)}, ${longitude.toFixed(6)}
            </p>
          </div>
        `
      });

      // Show info window on marker click
      marker.addListener('click', function() {
        infoWindow.open(map, marker);
      });

      // Auto-open info window briefly
      setTimeout(() => {
        infoWindow.open(map, marker);
        setTimeout(() => infoWindow.close(), 3000);
      }, 500);

      console.log('[RestaurantMap] Map initialized successfully');

    } catch (error) {
      // Fallback: Display coordinates if Google Maps fails to load
      console.error('[RestaurantMap] Failed to load Google Maps:', error);
      mapElement.innerHTML = `
        <div class="d-flex align-items-center justify-content-center h-100 flex-column p-4">
          <i class="bi bi-map text-3rem text-muted mb-3"></i>
          <p class="mb-0 fw-semibold text-muted">${restaurantName}</p>
          <p class="mb-0 mt-2 text-muted">${mapLocationLabel} ${latitude.toFixed(6)}, ${longitude.toFixed(6)}</p>
          <p class="mt-2 small text-muted">${mapLoadErrorText}</p>
        </div>
      `;
    }
  }

  document.addEventListener('turbo:load', initRestaurantMap);
  document.addEventListener('DOMContentLoaded', initRestaurantMap);
</script>
