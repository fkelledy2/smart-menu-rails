<%#
  Restaurant Details Section
  Core information form with auto-save
%>

<% restaurant = local_assigns[:restaurant] || @restaurant %>

<!-- Quick Actions Card -->
<div class="mb-3 p-3<%= ' is-disabled' if restaurant.onboarding_quick_actions_blocked? %>">
  <h2 class="quick-actions-title">
    <i class="bi bi-lightning-charge"></i>
    <%= t('.quick_actions') %>
  </h2>

  <div class="quick-actions-grid">
    <%= link_to new_restaurant_menu_path(restaurant),
        class: 'quick-action-btn',
        data: { turbo_frame: '_top' },
        aria: { disabled: restaurant.onboarding_quick_actions_blocked? },
        tabindex: (restaurant.onboarding_quick_actions_blocked? ? -1 : nil) do %>
      <i class="bi bi-plus-circle"></i>
      <span><%= t('.new_menu') %></span>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'import'),
        class: 'quick-action-btn',
        data: { turbo_frame: 'restaurant_content', turbo_action: 'advance' },
        aria: { disabled: restaurant.onboarding_quick_actions_blocked? },
        tabindex: (restaurant.onboarding_quick_actions_blocked? ? -1 : nil) do %>
      <i class="bi bi-file-earmark-arrow-up"></i>
      <span><%= t('.import_menu') %></span>
    <% end %>

    <!-- Status Toggle Quick Action -->
    <%= form_with model: restaurant,
          url: restaurant_path(restaurant),
          method: :patch,
          local: true,
          data: { turbo: false },
          html: { class: 'd-inline' } do |f| %>
      <%= hidden_field_tag :return_to, 'restaurant_edit' %>
      <% if restaurant.respond_to?(:active?) ? restaurant.active? : (restaurant.status.to_s == 'active' || restaurant.status_before_type_cast.to_i == 1) %>
        <%= hidden_field_tag 'restaurant[status]', 'inactive' %>
        <%= hidden_field_tag :status, 'inactive' %>
        <button type="submit" class="quick-action-btn quick-action-btn-secondary" data-testid="restaurant-status-toggle-btn" <%= 'disabled' if restaurant.onboarding_quick_actions_blocked? || restaurant.menus.none? %>>
          <i class="bi bi-toggle2-off"></i>
          <span><%= t('.active') %></span>
        </button>
      <% else %>
        <%= hidden_field_tag 'restaurant[status]', 'active' %>
        <%= hidden_field_tag :status, 'active' %>
        <button type="submit" class="quick-action-btn" data-testid="restaurant-status-toggle-btn" <%= 'disabled' if restaurant.onboarding_quick_actions_blocked? || restaurant.menus.none? %>>
          <i class="bi bi-toggle2-on"></i>
          <span><%= t('.inactive') %></span>
        </button>
      <% end %>
    <% end %>
  </div>
</div>

<script>
  (function(){
    function __cleanupRestaurantStatusTomSelect(){
      try {
        const tsCtrl = document.getElementById('restaurant_status-ts-control');
        if (tsCtrl) {
          const wrap = tsCtrl.closest('.ts-wrapper');
          if (wrap) wrap.remove();
        }
        const sel = document.getElementById('restaurant_status');
        if (sel) {
          if (sel.tomselect && typeof sel.tomselect.destroy === 'function') {
            try { sel.tomselect.destroy(); } catch(_) {}
          }
          sel.remove();
        }
      } catch(_) {}
    }
    __cleanupRestaurantStatusTomSelect();
    document.addEventListener('turbo:load', __cleanupRestaurantStatusTomSelect);
    document.addEventListener('turbo:frame-load', __cleanupRestaurantStatusTomSelect);
  })();
</script>

<!-- Overview Stats Card -->
<div class="mb-3 p-3" data-testid="overview-stats-card">
  <h2 class="quick-actions-title">
    <i class="bi bi-graph-up"></i>
    <%= t('.overview') %>
  </h2>

  <div class="count-panel-2025 count-panel-2025--three">
    <%= link_to edit_restaurant_path(restaurant, section: 'menus'),
                class: 'count-panel-item-2025 text-decoration-none text-reset d-block',
                data: { turbo_frame: 'restaurant_content', turbo_action: 'advance', testid: 'overview-menus-link' } do %>
      <div class="count-panel-value-2025"><%= restaurant.restaurant_menus.joins(:menu).where(menus: { archived: false }).count %></div>
      <div class="count-panel-label-2025"><%= t('.menus') %></div>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'tables'),
                class: 'count-panel-item-2025 text-decoration-none text-reset d-block',
                data: { turbo_frame: 'restaurant_content', turbo_action: 'advance', testid: 'overview-tables-link' } do %>
      <div class="count-panel-value-2025"><%= restaurant.tablesettings.count %></div>
      <div class="count-panel-label-2025"><%= t('.tables') %></div>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'staff'),
                class: 'count-panel-item-2025 text-decoration-none text-reset d-block',
                data: { turbo_frame: 'restaurant_content', turbo_action: 'advance', testid: 'overview-staff-link' } do %>
      <div class="count-panel-value-2025"><%= restaurant.employees.count %></div>
      <div class="count-panel-label-2025"><%= t('.staff') %></div>
    <% end %>
  </div>
</div>

<!-- Restaurant Details Form -->
<div class="mb-3 p-3" data-testid="restaurant-details-card">
    <h2 class="h5 mb-3">
      <i class="bi bi-building"></i>
      <%= t('.restaurant_details') %>
    </h2>

  <%= restaurant_form_with(
        restaurant,
        auto_save: true,
        validate: true,
        html: {
          data: {
            testid: 'restaurant-details-form',
            controller: 'auto-save',
            auto_save_url_value: restaurant_path(restaurant),
            auto_save_method_value: 'patch'
          }
        }
      ) do |form| %>
    <div class="mb-4">
      <%= form.label :name, class: 'form-label' do %>
        <%= t('activerecord.attributes.restaurant.name') %>
        <span class="text-danger">*</span>
      <% end %>
      <%= form.text_field :name,
          class: 'form-control',
          placeholder: t('.name_placeholder'),
          required: true,
          data: { testid: 'restaurant-name-input' } %>
      <div class="form-text">
        <%= t('.name_help') %>
      </div>
    </div>

    <div class="mb-4">
      <%= form.label :description, class: 'form-label d-inline-flex align-items-center gap-2' do %>
        <%= t('activerecord.attributes.restaurant.description') %>
        <span class="form-autosave-inline small text-muted"></span>
      <% end %>
      <%= form.text_area :description,
          class: 'form-control',
          rows: 4,
          placeholder: t('.description_placeholder'),
          data: { testid: 'restaurant-description-input' } %>
      <div class="form-text">
        <%= t('.description_help') %>
      </div>
    </div>

    <div class="mb-4">
      <%= form.label :currency, class: 'form-label d-inline-flex align-items-center gap-2' do %>
        <%= t('activerecord.attributes.restaurant.currency') %>
        <span class="form-autosave-inline small text-muted"></span>
      <% end %>
      <%= currency_select(form, :currency) %>
      <div class="form-text">
        <%= t('.currency_help') %>
      </div>
    </div>
  <% end %>
</div>

<!-- Address & Location -->
<div class="mb-3 p-3" data-testid="restaurant-address-card">
    <h2 class="h5 mb-3">
      <i class="bi bi-geo-alt"></i>
      <%= t('.location') %>
    </h2>

  <%= restaurant_form_with(restaurant, auto_save: true) do |form| %>
    <div class="mb-4">
      <%= form.label :address1, class: 'form-label d-inline-flex align-items-center gap-2' do %>
        <%= t('activerecord.attributes.restaurant.address') %>
        <span class="text-danger">*</span>
        <span class="form-autosave-inline small text-muted"></span>
      <% end %>
      <%= form.text_field :address1,
          class: 'form-control',
          placeholder: t('.address_placeholder'),
          required: true,
          data: { testid: 'restaurant-address1-input' } %>
      <%= form.hidden_field :latitude %>
      <%= form.hidden_field :longitude %>
      <%= form.hidden_field :country %>
      <div class="form-text">
        <%= t('.address_help') %>
      </div>
    </div>

    <div class="mb-4">
      <%= form.label :address2, class: 'form-label' do %>
        <%= t('activerecord.attributes.restaurant.address2') %>
      <% end %>
      <%= form.text_field :address2,
          class: 'form-control',
          placeholder: t('.address2_placeholder'),
          data: { testid: 'restaurant-address2-input' } %>
      <div class="form-text">
        <%= t('.address2_help') %>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div>
          <%= form.label :city, class: 'form-label d-inline-flex align-items-center gap-2' do %>
            <%= t('activerecord.attributes.restaurant.city') %>
            <span class="text-danger">*</span>
            <span class="form-autosave-inline small text-muted"></span>
          <% end %>
          <%= form.text_field :city,
              class: 'form-control',
              required: true,
              data: { testid: 'restaurant-city-input' } %>
        </div>
      </div>

      <div class="col-md-3">
        <div>
          <%= form.label :state, class: 'form-label' do %>
            <%= t('activerecord.attributes.restaurant.state') %>
          <% end %>
          <%= form.text_field :state,
              class: 'form-control',
              data: { testid: 'restaurant-state-input' } %>
        </div>
      </div>

      <div class="col-md-3">
        <div>
          <%= form.label :postcode, class: 'form-label' do %>
            <%= t('activerecord.attributes.restaurant.postcode') %>
          <% end %>
          <%= form.text_field :postcode,
              class: 'form-control',
              data: { testid: 'restaurant-postcode-input' } %>
        </div>
      </div>
    </div>

    <% if restaurant.latitude.present? && restaurant.longitude.present? %>
      <div class="location-map-container mb-3">
        <div class="location-map-header">
          <i class="bi bi-check-circle-fill text-success me-2"></i>
          <span class="text-success fw-semibold">
            <%= t('.location_verified') %>
          </span>
        </div>
        <div id="restaurant-map" class="restaurant-map"
             data-latitude="<%= restaurant.latitude %>"
             data-longitude="<%= restaurant.longitude %>"
             data-name="<%= restaurant.name %>">
        </div>
      </div>
    <% end %>
  <% end %>

</div>

<!-- Image Context Details Section -->
<div class="mb-3 p-3" data-testid="image-context-card">
    <h2 class="h5 mb-3">
      <i class="bi bi-image"></i>
      <%= t('.image_context_details') %>
    </h2>

  <%= restaurant_form_with(restaurant, auto_save: true) do |form| %>
    <div class="mb-4">
      <%= form.label :imagecontext, class: 'form-label' do %>
        <%= t('activerecord.attributes.restaurant.imagecontext') %>
      <% end %>
      <%= form.text_area :imagecontext,
          class: 'form-control',
          rows: 3,
          placeholder: t('.imagecontext_placeholder'),
          data: { testid: 'restaurant-imagecontext-input' } %>
      <div class="form-text">
        <%= t('.imagecontext_help') %>
      </div>
    </div>

    <div class="mb-4">
      <%= form.label :image_style_profile, class: 'form-label' do %>
        <%= t('activerecord.attributes.restaurant.image_style_profile') %>
      <% end %>
      <%= form.text_area :image_style_profile,
          class: 'form-control',
          rows: 4,
          placeholder: t('.image_style_profile_placeholder'),
          data: { testid: 'restaurant-image-style-input' } %>
      <div class="form-text">
        <%= t('.image_style_profile_help') %>
      </div>
    </div>
  <% end %>
</div>

 

<style>
  /* Force Quick Actions into two columns on all viewports (including mobile portrait) */
  .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--space-3);
  }
  .quick-actions-grid .quick-action-btn {
    width: 100%;
    justify-content: center;
  }
  .is-disabled {
    opacity: 0.6;
  }
  .is-disabled .quick-action-btn {
    pointer-events: none;
    cursor: not-allowed;
  }

  .text-danger {
    color: var(--color-danger);
  }

  .location-map-container {
    margin-top: 1.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .location-map-header {
    padding: 0.75rem 1rem;
    background-color: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
  }

  .restaurant-map {
    width: 100%;
    height: 400px;
    background-color: #f3f4f6;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', async function() {
    const mapElement = document.getElementById('restaurant-map');
    if (!mapElement) return;

    const latitude = parseFloat(mapElement.dataset.latitude);
    const longitude = parseFloat(mapElement.dataset.longitude);
    const restaurantName = mapElement.dataset.name;

    if (isNaN(latitude) || isNaN(longitude)) return;

    // Show loading state (no inline styles)
    mapElement.innerHTML = `
      <div class="d-flex align-items-center justify-content-center h-100 flex-column p-4">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden"><%= t('.loading_map') %></span>
        </div>
        <p class="text-muted mb-0"><%= t('.loading_map') %></p>
      </div>
    `;

    // Function to wait for Google Maps to be fully loaded
    async function waitForGoogleMaps(maxAttempts = 20) {
      for (let i = 0; i < maxAttempts; i++) {
        if (typeof google !== 'undefined' && google.maps && google.maps.Map) {
          return true;
        }
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      return false;
    }

    try {
      // Load Google Maps API if not already loaded
      if (typeof google === 'undefined' || !google.maps || !google.maps.Map) {
        console.log('[RestaurantMap] Loading Google Maps API...');

        if (typeof window.initGoogleMaps === 'function') {
          await window.initGoogleMaps();
          // Wait for the API to be fully initialized
          const loaded = await waitForGoogleMaps();
          if (!loaded) {
            throw new Error('Google Maps API did not initialize in time');
          }
        } else {
          throw new Error('Google Maps loader not available');
        }
      }

      console.log('[RestaurantMap] Google Maps API ready, initializing map...');

      // Clear loading state
      mapElement.innerHTML = '';

      const position = { lat: latitude, lng: longitude };

      // Initialize Google Map (without mapId and styles to avoid API errors)
      const map = new google.maps.Map(mapElement, {
        center: position,
        zoom: 15,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true
      });

      // Add marker for restaurant location (use legacy Marker for compatibility)
      const marker = new google.maps.Marker({
        position: position,
        map: map,
        title: restaurantName,
        animation: google.maps.Animation.DROP
      });

      // Add info window
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div class="p-2">
            <h6 class="mb-1 fw-semibold">${restaurantName}</h6>
            <p class="mb-0 small text-muted">
              ${latitude.toFixed(6)}, ${longitude.toFixed(6)}
            </p>
          </div>
        `
      });

      // Show info window on marker click
      marker.addListener('click', function() {
        infoWindow.open(map, marker);
      });

      // Auto-open info window briefly
      setTimeout(() => {
        infoWindow.open(map, marker);
        setTimeout(() => infoWindow.close(), 3000);
      }, 500);

      console.log('[RestaurantMap] Map initialized successfully');

    } catch (error) {
      // Fallback: Display coordinates if Google Maps fails to load
      console.error('[RestaurantMap] Failed to load Google Maps:', error);
      mapElement.innerHTML = `
        <div class="d-flex align-items-center justify-content-center h-100 flex-column p-4">
          <i class="bi bi-map text-3rem text-muted mb-3"></i>
          <p class="mb-0 fw-semibold text-muted">${restaurantName}</p>
          <p class="mb-0 mt-2 text-muted"><%= t('.location_label') %> ${latitude.toFixed(6)}, ${longitude.toFixed(6)}</p>
          <p class="mt-2 small text-muted"><%= t('.map_error') %></p>
        </div>
      `;
    }
  });
</script>
