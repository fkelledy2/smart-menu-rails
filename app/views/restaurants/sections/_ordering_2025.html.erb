<%#
  Restaurant Ordering Section
  Order management settings and preferences
%>

<% restaurant = local_assigns[:restaurant] || @restaurant %>

<!-- Ordering Dashboard -->
<div id="ordering-dashboard" class="card" data-restaurant-id="<%= restaurant.id %>" data-currency-code="<%= restaurant.respond_to?(:currency) ? (restaurant.currency.presence || 'USD') : 'USD' %>" data-controller="ordering">
  <div class="card-body">
  <h2 class="h5 d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <span>
      <i class="bi bi-graph-up"></i>
      <%= t('.ordering_dashboard') %>
    </span>
    <div class="d-flex align-items-center gap-2">
      <select class="form-select form-select-sm" id="od-time-range">
        <option value="today"><%= t('.today') %></option>
        <option value="yesterday"><%= t('.yesterday') %></option>
        <option value="last7"><%= t('.last_7_days') %></option>
        <option value="last28" selected><%= t('.last_28_days') %></option>
        <option value="mtd"><%= t('.mtd') %></option>
        <option value="last_month"><%= t('.last_month') %></option>
        <option value="custom"><%= t('.custom') %></option>
      </select>
      <div id="od-custom-range" class="d-none">
        <input type="date" class="form-control form-control-sm" id="od-start">
        <input type="date" class="form-control form-control-sm" id="od-end">
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="od-compare">
        <label class="form-check-label" for="od-compare"><%= t('.compare') %></label>
      </div>
    </div>
  </h2>

  <!-- Filters row -->
  <div class="row g-2 mb-3">
    <div class="col-12 col-md-3">
      <label class="form-label mb-1"><%= t('.menu') %></label>
      <select class="form-select form-select-sm" id="od-filter-menu">
        <option value="all"><%= t('.all') %></option>
        <% restaurant.menus.each do |m| %>
          <option value="<%= m.id %>"><%= m.name %></option>
        <% end %>
      </select>
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label mb-1"><%= t('.employee') %></label>
      <select class="form-select form-select-sm" id="od-filter-employee">
        <option value="all"><%= t('.all') %></option>
        <% restaurant.employees.each do |e| %>
          <option value="<%= e.id %>"><%= e.user&.name || e.user&.email || "##{e.id}" %></option>
        <% end %>
      </select>
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label mb-1"><%= t('.table') %></label>
      <select class="form-select form-select-sm" id="od-filter-table">
        <option value="all"><%= t('.all') %></option>
        <% restaurant.tablesettings.each do |tset| %>
          <option value="<%= tset.id %>"><%= tset.name %></option>
        <% end %>
      </select>
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label mb-1"><%= t('.status') %></label>
      <select class="form-select form-select-sm" id="od-filter-status">
        <option value="completed"><%= t('.completed') %></option>
        <option value="open"><%= t('.open') %></option>
        <option value="cancelled"><%= t('.cancelled') %></option>
        <option value="all" selected><%= t('.all') %></option>
      </select>
    </div>
  </div>

  <!-- KPI cards -->
  <div class="od-kpi-grid mb-3">
    <% [
      'gross',
      'net',
      'taxes',
      'tips',
      'service',
      'orders',
      'items',
      'aov'
    ].each do |key| %>
      <div class="od-kpi-card" data-kpi="<%= key %>">
        <div class="od-kpi-title"><%= t(".kpi_#{key}") %></div>
        <div class="od-kpi-value" data-kpi-value>—</div>
        <div class="od-kpi-delta text-muted" data-kpi-delta>—</div>
      </div>
    <% end %>
  </div>

  <!-- Charts -->
  <div class="row g-3">
    <div class="col-12 col-xl-6">
      <div class="od-chart-card">
        <div class="od-chart-title"><%= t('.revenue_over_time') %></div>
        <canvas class="od-chart-canvas" id="od-chart-revenue"></canvas>
      </div>
    </div>
    <div class="col-12 col-xl-6">
      <div class="od-chart-card">
        <div class="od-chart-title"><%= t('.orders_over_time') %></div>
        <canvas class="od-chart-canvas" id="od-chart-orders"></canvas>
      </div>
    </div>
    <div class="col-12 col-xl-6">
      <div class="od-chart-card">
        <div class="od-chart-title"><%= t('.menu_mix') %></div>
        <canvas class="od-chart-canvas" id="od-chart-menu-mix"></canvas>
      </div>
    </div>
    <div class="col-12 col-xl-6">
      <div class="od-chart-card">
        <div class="od-chart-title"><%= t('.top_items') %></div>
        <canvas class="od-chart-canvas" id="od-chart-top-items"></canvas>
      </div>
    </div>
    <div class="col-12 col-xl-6">
      <div class="od-chart-card">
        <div class="od-chart-title"><%= t('.staff_performance') %></div>
        <canvas class="od-chart-canvas" id="od-chart-staff"></canvas>
      </div>
    </div>
    <div class="col-12 col-xl-6">
      <div class="od-chart-card">
        <div class="od-chart-title"><%= t('.table_utilization') %></div>
        <canvas class="od-chart-canvas" id="od-chart-tables"></canvas>
      </div>
    </div>
  </div>

  <!-- Breakdown tables -->
  <div class="row g-3 mt-2">
    <div class="col-12">
      <div class="od-table-card">
        <div class="od-table-title d-flex justify-content-between align-items-center">
          <span><%= t('.orders_table') %></span>
          <button id="od-export-orders" class="btn btn-outline-secondary btn-sm"><%= t('.export_csv') %></button>
        </div>
        <div id="od-table-orders"></div>
      </div>
    </div>
    <div class="col-12">
      <div class="od-table-card">
        <div class="od-table-title d-flex justify-content-between align-items-center">
          <span><%= t('.items_table') %></span>
          <button id="od-export-items" class="btn btn-outline-secondary btn-sm"><%= t('.export_csv') %></button>
        </div>
        <div id="od-table-items"></div>
      </div>
    </div>
  </div>

  <style>
    .od-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-3); }
    .od-kpi-card { border: 1px solid var(--color-gray-200); border-radius: var(--radius-lg); padding: var(--space-3); background: var(--color-white); }
    .od-kpi-title { font-size: var(--text-sm); color: var(--color-gray-600); }
    .od-kpi-value { font-size: 1.5rem; font-weight: var(--font-semibold); }
    .od-chart-card { border: 1px solid var(--color-gray-200); border-radius: var(--radius-lg); padding: var(--space-3); background: var(--color-white); min-height: 260px; }
    .od-chart-title { font-weight: var(--font-semibold); margin-bottom: var(--space-2); }
    /* Use block-level canvas to avoid flex resize loops causing re-renders */
    .od-chart-canvas { width: 100% !important; height: 220px !important; background: var(--color-gray-50); border-radius: var(--radius-md); display: block; }
    .od-table-card { border: 1px solid var(--color-gray-200); border-radius: var(--radius-lg); padding: var(--space-3); background: var(--color-white); }
    .od-table-title { font-weight: var(--font-semibold); margin-bottom: var(--space-2); }
    .od-table-placeholder { min-height: 160px; display: flex; align-items: center; justify-content: center; background: var(--color-gray-50); border-radius: var(--radius-md); }
  </style>

  <script data-turbo-eval="true">
    // Load Chart.js via CDN (temporary; move to asset pipeline later)
    (function ensureChartJs(){
      if (!window.Chart) {
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        s.defer = true;
        document.head.appendChild(s);
      }
    })();
    // Initial stub: show chosen range and reveal custom inputs
    (function() {
      const range = document.getElementById('od-time-range');
      const custom = document.getElementById('od-custom-range');
      if (!range || !custom) return;
      function updateCustom() { custom.classList.toggle('d-none', range.value !== 'custom'); }
      range.addEventListener('change', updateCustom);
      updateCustom();
      // Placeholders in chart canvases
      // Leave canvases empty; Chart.js will render
    })();

    // Initialization handled by Stimulus (data-controller="ordering") and application.js observer.
  </script>
  </div>
</div>

