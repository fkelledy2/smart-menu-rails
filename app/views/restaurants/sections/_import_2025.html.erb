<%#
  OCR Menu Import Section
  Upload and process PDF menus
%>

<% restaurant = local_assigns[:restaurant] || @restaurant %>

<!-- Quick Info Banner -->

<!-- Upload Form Card -->
<div class="content-card-2025" data-testid="import-form-card">
  <h2 class="content-card-title">
    <i class="bi bi-cloud-upload"></i>
    <%= t('.upload_title') %>
  </h2>

  <%= form_with(model: [restaurant, restaurant.ocr_menu_imports.new], local: true, html: { class: 'needs-validation', novalidate: true }, data: { turbo_frame: '_top', testid: 'import-form' }) do |f| %>
    <div class="form-group-2025 mb-4">
      <%= f.label :name, t('.name_label'), class: 'form-label-2025' %>
      <%= f.text_field :name,
          class: 'form-control-2025',
          placeholder: t('.name_placeholder'),
          required: true,
          data: { testid: 'import-name-input' } %>
      <div class="form-help-2025">
        <%= t('.name_help') %>
      </div>
      <div class="invalid-feedback">
        <%= t('.name_invalid') %>
      </div>
    </div>

    <div class="form-group-2025 mb-4">
      <%= f.label :source_locale, t('.source_language_label'), class: 'form-label-2025' %>
      <%= f.select :source_locale,
          options_for_select(
            [[t('.auto_detect'), '']] +
              restaurant.restaurantlocales
                        .select { |rl| rl.status.to_s == 'active' }
                        .sort_by { |rl| rl.locale.to_s }
                        .map { |rl| [rl.language.to_s, rl.locale.to_s.split(/[-_]/).first.to_s.downcase] },
            f.object.source_locale.to_s
          ),
          {},
          class: 'form-control-2025' %>
      <div class="form-help-2025">
        <%= t('.source_language_help') %>
      </div>
    </div>

    <div class="form-group-2025 mb-4">
      <%= f.label :pdf_file, t('.pdf_label'), class: 'form-label-2025' %>
      <div class="file-upload-area">
        <div class="file-upload-icon">
          <i class="bi bi-file-earmark-pdf"></i>
        </div>
        <div class="file-upload-content">
          <label for="file-upload" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-upload me-1"></i> <%= t('.choose_file') %>
            <%= f.file_field :pdf_file,
                id: 'file-upload',
                class: 'd-none',
                accept: 'application/pdf',
                required: true,
                onchange: "document.getElementById('file-name').textContent = this.files[0]?.name || '#{j t('.no_file_chosen')}'",
                data: { testid: 'import-pdf-input' } %>
          </label>
          <div id="file-name" class="file-upload-filename" data-testid="import-filename-display">
            <%= t('.no_file_chosen') %>
          </div>
          <p class="file-upload-hint">
            <%= t('.pdf_hint') %>
          </p>
        </div>
      </div>
      <div class="invalid-feedback">
        <%= t('.pdf_invalid') %>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 pt-3 border-top">
      <button type="submit" id="upload-submit-btn" class="btn btn-danger btn-lg w-100 w-md-auto" disabled data-testid="import-submit-btn">
        <i class="bi bi-upload me-1"></i> <%= t('.upload_process') %>
      </button>
    </div>
  <% end %>
</div>

<script>
  (function() {
    function initImportForm(scope) {
      const root = scope || document;
      const form = root.querySelector('[data-testid="import-form"]') || root.querySelector('form[action*="ocr_menu_imports"]');
      if (!form || form.dataset.importInit === 'true') return;
      form.dataset.importInit = 'true';

      const nameInput = form.querySelector('input[name="ocr_menu_import[name]"]');
      const fileInput = form.querySelector('input[name="ocr_menu_import[pdf_file]"]');
      const submitBtn = root.getElementById ? root.getElementById('upload-submit-btn') : document.getElementById('upload-submit-btn');
      if (!submitBtn) return;

      function checkFormValidity() {
        const hasName = nameInput && nameInput.value.trim() !== '';
        const hasFile = fileInput && fileInput.files.length > 0;

        if (hasName && hasFile) {
          submitBtn.disabled = false;
          submitBtn.classList.remove('btn-secondary');
          submitBtn.classList.add('btn-danger');
        } else {
          submitBtn.disabled = true;
          submitBtn.classList.remove('btn-danger');
          submitBtn.classList.add('btn-secondary');
        }
      }

      if (nameInput) {
        nameInput.addEventListener('input', checkFormValidity);
        nameInput.addEventListener('blur', checkFormValidity);
      }
      if (fileInput) {
        fileInput.addEventListener('change', checkFormValidity);
      }
      // Initial check
      checkFormValidity();
    }

    // Initialize on classic load and Turbo navigations
    document.addEventListener('DOMContentLoaded', function() { initImportForm(document); });
    document.addEventListener('turbo:load', function() { initImportForm(document); });
    document.addEventListener('turbo:frame-load', function(e) {
      // Re-init when the restaurant content frame is replaced
      if (e.target && (e.target.id === 'restaurant_content' || e.target.closest && e.target.closest('#restaurant_content'))) {
        initImportForm(e.target);
      }
    });
  })();
</script>

<!-- Tips Card -->

<!-- Recent Imports -->
<% recent_imports = restaurant.ocr_menu_imports.order(created_at: :desc).limit(5) %>
<% if recent_imports.any? %>
  <div class="content-card-2025 mt-4" data-testid="recent-imports-card">
    <h2 class="content-card-title">
      <i class="bi bi-clock-history"></i>
      <%= t('.recent_imports') %>
    </h2>

    <%= form_with url: bulk_destroy_restaurant_ocr_menu_imports_path(restaurant),
        method: :delete,
        data: { controller: 'localization-bulk', turbo: true, action: 'submit->localization-bulk#beforeSubmit' } do |f| %>
        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
          <div class="d-flex align-items-center gap-2">
            <input type="checkbox" data-localization-bulk-target="selectAll" data-action="change->localization-bulk#toggleAll" />
            <span class="text-muted small"><%= t('.select_all') %></span>
          </div>

          <div class="d-flex align-items-center gap-2 ms-auto">
            <%= f.hidden_field :confirm, value: '1' %>
            <div class="dropdown">
              <button class="btn-2025 btn-2025-ghost btn-2025-sm dropdown-toggle"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      disabled
                      data-localization-bulk-target="submit">
                <%= t('.actions', default: 'Actions') %>
              </button>

              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <%= f.button t('.delete', default: 'Delete'),
                      type: 'submit',
                      class: 'dropdown-item text-danger',
                      data: { turbo_confirm: t('.confirm_delete') } %>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="list-group list-group-flush">
          <% recent_imports.each do |import| %>
            <div class="list-group-item list-group-item-action p-0 clickable-row import-row"
                 data-testid="import-row-<%= import.id %>"
                 data-href="<%= restaurant_ocr_menu_import_path(restaurant, import) %>">
              <div class="d-flex align-items-center gap-2 p-3">
                <div class="w-40px flex-shrink-0">
                  <input type="checkbox"
                         name="ocr_menu_import_ids[]"
                         value="<%= import.id %>"
                         data-localization-bulk-target="checkbox"
                         data-action="change->localization-bulk#sync" />
                </div>

                <div class="flex-grow-1" style="min-width: 0;">
                  <div class="fw-semibold d-flex align-items-center justify-content-between gap-2">
                    <span class="text-truncate" style="min-width: 0;"><%= import.name.presence || t('.default_title', id: import.id) %></span>
                    <div class="flex-shrink-0 text-end">
                      <% if import.completed? %>
                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> <%= t('.status_completed') %></span>
                      <% elsif import.failed? %>
                        <span class="badge bg-danger"><i class="bi bi-x-circle"></i> <%= t('.status_failed') %></span>
                      <% elsif import.processing? %>
                        <span class="badge bg-primary"><i class="bi bi-arrow-repeat"></i> <%= t('.status_processing') %></span>
                      <% else %>
                        <span class="badge bg-secondary"><i class="bi bi-pause-circle"></i> <%= t('.status_pending') %></span>
                      <% end %>
                    </div>
                  </div>
                  <div class="text-muted small"><%= time_ago_in_words(import.created_at) %> <%= t('.ago') %></div>
                </div>

                <%= link_to restaurant_ocr_menu_import_path(restaurant, import),
                    class: 'btn-2025 btn-2025-ghost btn-2025-sm',
                    title: t('.view', default: 'View'),
                    aria: { label: t('.view', default: 'View') },
                    data: { turbo_frame: '_top', row_primary_link: true } do %>
                  <i class="bi bi-chevron-right"></i>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
    <% end %>
  </div>
<% end %>

<style>
  .file-upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    background-color: #f9fafb;
    transition: all 0.2s;
  }

  .file-upload-area:hover {
    border-color: #9ca3af;
    background-color: #f3f4f6;
  }

  .file-upload-icon {
    font-size: 3rem;
    color: #9ca3af;
    margin-bottom: 1rem;
  }

  .file-upload-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }

  .file-upload-filename {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.5rem;
  }

  .file-upload-hint {
    font-size: 0.75rem;
    color: #9ca3af;
    margin: 0;
  }

  .form-help-2025 {
    font-size: var(--text-sm);
    color: var(--color-gray-500);
    margin-top: var(--space-1);
  }

  .tips-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .tip-item {
    display: flex;
    gap: 1rem;
  }

  .tip-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .tip-content h6 {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  /* Mobile-friendly button styling */
  #upload-submit-btn {
    min-height: 48px;
    font-size: 1rem;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
  }

  @media (max-width: 768px) {
    #upload-submit-btn {
      min-height: 56px;
      font-size: 1.125rem;
    }
  }

  /* Disabled state styling */
  #upload-submit-btn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  /* Import row and delete button styling */
  .import-row {
    transition: background-color 0.2s;
  }

  .import-row:hover {
    background-color: #f9fafb;
  }

  .delete-import-btn {
    padding: 0.75rem 1rem;
    font-size: 1.125rem;
    border-left: 1px solid #e5e7eb;
    border-radius: 0;
    opacity: 0.6;
    transition: opacity 0.2s, background-color 0.2s;
  }

  .delete-import-btn:hover {
    opacity: 1;
    background-color: #fee2e2;
  }

  .delete-import-btn form {
    margin: 0;
  }

  .import-row .delete-import-btn i {
    font-size: 1rem;
  }
</style>
