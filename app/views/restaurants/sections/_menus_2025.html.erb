<%#
  Restaurant Menus Section
  Menu list and management
%>

<% restaurant = local_assigns[:restaurant] || @restaurant %>

<% 
  restaurant_menus = restaurant.restaurant_menus.joins(:menu)
    .where(menus: { archived: false })

  restaurant_menus = restaurant_menus.order(Arel.sql('CASE WHEN restaurant_menus.sequence IS NULL THEN 1 ELSE 0 END, restaurant_menus.sequence ASC'))

  show_availability_column = restaurant_menus.includes(:menu).any? do |rm|
    m = rm.menu
    owner_id = m.owner_restaurant_id.presence || m.restaurant_id
    owner_id != restaurant.id
  end
%>

<!-- Quick Actions Card -->
<div class="mb-3 p-3" data-testid="menus-quick-actions">
  <h2 class="quick-actions-title">
    <i class="bi bi-lightning-charge"></i>
    <%= t('.quick_actions') %>
  </h2>

  <div class="quick-actions-grid">
    <%= link_to new_restaurant_menu_path(restaurant),
        class: 'quick-action-btn',
        data: { testid: 'new-menu-btn', turbo_frame: '_top' } do %>
      <i class="bi bi-plus-circle"></i>
      <span><%= t('.new_menu') %></span>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'import'),
        class: 'quick-action-btn',
        data: { testid: 'import-menu-btn', turbo_frame: 'restaurant_content', turbo_action: 'advance' } do %>
      <i class="bi bi-file-earmark-arrow-up"></i>
      <span><%= t('.import_menu') %></span>
    <% end %>
  </div>
</div>

<style>
  /* Force Quick Actions into two columns on all viewports (including mobile portrait) */
  .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--space-3);
  }
  .quick-actions-grid .quick-action-btn {
    width: 100%;
    justify-content: center;
  }

  tr.menu-row-shared {
    background: rgba(13, 110, 253, 0.03);
    border-left: 3px solid rgba(13, 110, 253, 0.25);
  }

  tr.menu-row-owned {
    border-left: 3px solid transparent;
  }

  .menu-origin-badge {
    font-weight: 600;
    letter-spacing: 0.01em;
  }
</style>

<!-- Menus List -->
<div class="mb-3 p-3" data-testid="menus-list-card">
  <h2 class="h5 mb-3">
      <i class="bi bi-grid-3x3"></i>
      <%= t('.menus') %>
    </h2>

  <% if restaurant_menus.any? %>
    <!-- Menus List (styled like Table Settings) -->
    <div data-controller="localization-bulk">
    <%= form_with url: bulk_update_restaurant_restaurant_menus_path(restaurant), method: :patch, data: { turbo: true, action: 'submit->localization-bulk#beforeSubmit' } do |f| %>
      <div class="table-responsive menus-table-view"
           data-testid="menus-list">
        <table class="table table-hover align-middle">
        <thead>
          <% if show_availability_column %>
            <tr class="small text-muted">
              <th class="w-20px menu-compact-cell"></th>
              <th class="w-20px menu-compact-cell"></th>
              <th></th>
              <th class="text-end"><%= t('.availability', default: 'Availability') %></th>
              <th></th>
            </tr>
          <% end %>
          <tr>
            <th class="w-20px menu-compact-cell">
              <input type="checkbox" data-localization-bulk-target="selectAll" data-action="change->localization-bulk#toggleAll" />
            </th>
            <th class="text-end text-nowrap" colspan="<%= show_availability_column ? 4 : 3 %>">
              <div class="d-flex justify-content-end flex-nowrap">
                <div class="input-group input-group-sm flex-nowrap" style="min-width: 260px; width: auto;">
                  <%= f.select :status,
                      [
                        [t('.active'), 'active'],
                        [t('.inactive'), 'inactive'],
                      ],
                      { include_blank: t('.set_status') },
                      { class: 'form-select form-select-sm', disabled: true, style: 'min-width: 0;', data: { localization_bulk_target: 'statusSelect', action: 'change->localization-bulk#sync' } } %>
                  <button type="submit"
                          class="btn btn-primary"
                          title="<%= t('.apply') %>"
                          aria-label="<%= t('.apply') %>"
                          disabled
                          data-localization-bulk-target="submit">
                    <i class="bi bi-check2"></i>
                    <span class="visually-hidden"><%= t('.apply') %></span>
                  </button>
                </div>
              </div>
            </th>
          </tr>
        </thead>
        <tbody data-controller="sortable"
               data-sortable-url-value="<%= reorder_restaurant_restaurant_menus_path(restaurant) %>"
               data-sortable-handle-value=".drag-handle">
          <% restaurant_menus.includes(:menu).each do |restaurant_menu| %>
            <% menu = restaurant_menu.menu %>
            <% owner_restaurant_id = menu.owner_restaurant_id.presence || menu.restaurant_id %>
            <% row_status = restaurant_menu.status.to_s %>
            <tr data-sortable-id="<%= restaurant_menu.id %>"
                data-testid="menu-row-<%= menu.id %>"
                data-href="<%= edit_restaurant_menu_path(restaurant, menu) %>"
                class="<%= owner_restaurant_id == restaurant.id ? 'menu-row-owned' : 'menu-row-shared' %> clickable-row row-status-<%= row_status %> <%= row_status == 'inactive' ? 'menu-row-muted' : '' %>"
                title="<%= t(".#{row_status}") %>">
              <td class="w-20px menu-compact-cell">
                <input type="checkbox" name="restaurant_menu_ids[]" value="<%= restaurant_menu.id %>" data-localization-bulk-target="checkbox" data-action="change->localization-bulk#sync" />
              </td>
              <td class="w-20px menu-compact-cell">
                <i class="bi bi-grip-vertical text-muted drag-handle" title="<%= t('.drag_to_reorder') %>"></i>
              </td>
              <td>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  <div class="fw-semibold"><%= menu.name %></div>
                  <% unless owner_restaurant_id == restaurant.id %>
                    <span class="badge bg-light text-primary menu-origin-badge">
                      <i class="bi bi-link-45deg"></i>
                      <%= t('.shared') %>
                    </span>
                  <% end %>
                </div>
                <% if menu.description.present? %>
                  <div class="text-muted small"><%= truncate(menu.description, length: 80) %></div>
                <% end %>
              </td>
              <% if show_availability_column %>
                <td class="text-end">
                  <% if owner_restaurant_id != restaurant.id %>
                    <% availability_value = if restaurant_menu.availability_override_enabled?
                      restaurant_menu.availability_state.to_s
                    else
                      'default'
                    end %>

                    <%= form_with url: availability_restaurant_restaurant_menu_path(restaurant, restaurant_menu),
                          method: :patch,
                          data: { turbo_frame: '_top' },
                          class: 'd-inline' do %>
                      <input type="hidden" name="availability_override_enabled" value="<%= availability_value == 'default' ? 'false' : 'true' %>" />
                      <input type="hidden" name="availability_state" value="<%= availability_value == 'default' ? 'available' : availability_value %>" />
                      <select class="form-select form-select-sm d-inline-block w-auto"
                              name="availability_select"
                              onchange="this.form.querySelector('input[name=availability_override_enabled]').value=(this.value==='default'?'false':'true'); this.form.querySelector('input[name=availability_state]').value=(this.value==='default'?'available':this.value); this.form.requestSubmit();">
                        <option value="default" <%= 'selected' if availability_value == 'default' %>><%= t('.default') %></option>
                        <option value="available" <%= 'selected' if availability_value == 'available' %>><%= t('.available') %></option>
                        <option value="unavailable" <%= 'selected' if availability_value == 'unavailable' %>><%= t('.unavailable') %></option>
                      </select>
                    <% end %>
                  <% end %>
                </td>
              <% end %>
              <td class="text-end">
                <div class="d-flex justify-content-end align-items-center gap-2">
                  <% unless owner_restaurant_id == restaurant.id %>
                    <%= button_to t('.detach'),
                        detach_restaurant_menu_path(restaurant, menu),
                        method: :delete,
                        form: { data: { turbo_frame: '_top' } },
                        class: 'btn btn-sm btn-outline-secondary' %>
                  <% end %>

                  <% if owner_restaurant_id == restaurant.id %>
                    <% other_restaurants = Restaurant.where(user_id: current_user.id).where.not(id: restaurant.id) %>
                    <% if other_restaurants.any? %>
                      <%= form_with url: share_restaurant_menu_path(restaurant, menu), method: :post, data: { turbo_frame: '_top' } do |f| %>
                        <div class="input-group input-group-sm menu-share-controls" style="width: 184px; max-width: 184px;">
                          <select class="form-select"
                                  name="target_restaurant_ids[]"
                                  aria-label="<%= t('.share') %>">
                            <option value="" selected disabled><%= t('.share_menu') %></option>
                            <option value="all"><%= t('.share_to_all') %></option>
                            <% other_restaurants.each do |r| %>
                              <option value="<%= r.id %>"><%= r.name %></option>
                            <% end %>
                          </select>
                          <button type="submit"
                                  class="btn btn-secondary"
                                  title="<%= t('.share') %>"
                                  aria-label="<%= t('.share') %>">
                            <i class="bi bi-send"></i>
                          </button>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>

                  <%= link_to edit_restaurant_menu_path(restaurant, menu),
                      class: 'd-inline-flex align-items-center justify-content-end text-decoration-none link-secondary',
                      title: t('.edit'),
                      aria: { label: t('.edit') },
                      data: { row_primary_link: true, turbo_frame: '_top' } do %>
                    <i class="bi bi-chevron-right"></i>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- Mobile Card View (compact like localization list) -->
    <div class="menus-cards-view"
         data-controller="sortable"
         data-sortable-url-value="<%= reorder_restaurant_restaurant_menus_path(restaurant) %>"
         data-sortable-handle-value=".drag-handle">
      <% restaurant_menus.includes(:menu).each do |restaurant_menu| %>
        <% menu = restaurant_menu.menu %>
        <% owner_restaurant_id = menu.owner_restaurant_id.presence || menu.restaurant_id %>
        <% row_status = restaurant_menu.status.to_s %>
  
        <div class="menu-card-mobile clickable-row row-status-<%= row_status %> <%= row_status == 'inactive' ? 'menu-row-muted' : '' %>"
             data-sortable-id="<%= restaurant_menu.id %>"
             data-href="<%= edit_restaurant_menu_path(restaurant, menu) %>"
             title="<%= t(".#{row_status}") %>">
          <div class="menu-row-mobile">
            <div class="menu-row-mobile-left">
              <input type="checkbox"
                     name="restaurant_menu_ids[]"
                     value="<%= restaurant_menu.id %>"
                     data-localization-bulk-target="checkbox"
                     data-action="change->localization-bulk#sync" />
  
              <span class="drag-handle cursor-grab" aria-hidden="true">
                <i class="bi bi-grip-vertical text-muted" title="<%= t('.drag_to_reorder') %>"></i>
              </span>
  
              <div class="menu-row-mobile-text">
                <div class="fw-semibold d-flex align-items-center gap-2">
                  <span class="menu-name"><%= menu.name %></span>
                  <% unless owner_restaurant_id == restaurant.id %>
                    <span class="badge bg-light text-primary menu-origin-badge">
                      <i class="bi bi-link-45deg"></i>
                      <%= t('.shared') %>
                    </span>
                  <% end %>
                </div>
                <% if menu.description.present? %>
                  <div class="text-muted small"><%= truncate(menu.description, length: 60) %></div>
                <% end %>
              </div>
            </div>
  
            <%= link_to edit_restaurant_menu_path(restaurant, menu),
                class: 'd-inline-flex align-items-center justify-content-end text-decoration-none link-secondary',
                title: t('.edit'),
                aria: { label: t('.edit') },
                data: { row_primary_link: true, turbo_frame: '_top' } do %>
              <i class="bi bi-chevron-right"></i>
            <% end %>
          </div>

          <% if show_availability_column && owner_restaurant_id != restaurant.id %>
            <% availability_value = if restaurant_menu.availability_override_enabled?
              restaurant_menu.availability_state.to_s
            else
              'default'
            end %>
  
            <div class="mt-2">
              <%= form_with url: availability_restaurant_restaurant_menu_path(restaurant, restaurant_menu),
                    method: :patch,
                    data: { turbo_frame: '_top' },
                    class: 'd-inline' do %>
                <input type="hidden" name="availability_override_enabled" value="<%= availability_value == 'default' ? 'false' : 'true' %>" />
                <input type="hidden" name="availability_state" value="<%= availability_value == 'default' ? 'available' : availability_value %>" />
                <select class="form-select form-select-sm d-inline-block w-100"
                        name="availability_select"
                        onchange="this.form.querySelector('input[name=availability_override_enabled]').value=(this.value==='default'?'false':'true'); this.form.querySelector('input[name=availability_state]').value=(this.value==='default'?'available':this.value); this.form.requestSubmit();">
                  <option value="default" <%= 'selected' if availability_value == 'default' %>><%= t('.default') %></option>
                  <option value="available" <%= 'selected' if availability_value == 'available' %>><%= t('.available') %></option>
                  <option value="unavailable" <%= 'selected' if availability_value == 'unavailable' %>><%= t('.unavailable') %></option>
                </select>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <% end %>
  <% else %>
    <!-- Empty State -->
    <div class="text-center py-5">
      <i class="bi bi-menu-button-wide text-muted text-3rem"></i>
      <h3 class="mt-3 text-muted">
        <%= t('.no_menus') %>
      </h3>
      <p class="text-muted">
        <%= t('.no_menus_description') %>
      </p>
    </div>
  <% end %>
</div>

<style>
  /* Align actions in a column at the right so the badge sits above the dropdown */
  .menu-card { display: flex; align-items: stretch; gap: 12px; }
  .menu-card-main { flex: 1 1 auto; }
  .menu-card-actions { display: flex; flex-direction: column; align-items: flex-end; }
  .menu-status-badge { line-height: 1; }

  tr.clickable-row { cursor: pointer; }

  tr.menu-row-muted td {
    color: var(--color-gray-500);
  }

  tr.menu-row-muted td .fw-semibold {
    color: var(--color-gray-600);
  }

  .menu-share-controls {
    flex: 0 0 184px;
  }

  .menus-table-view th.menu-compact-cell,
  .menus-table-view td.menu-compact-cell {
    padding-left: 0.35rem;
    padding-right: 0.35rem;
  }

  /* Menus Views - Responsive (match localization list) */
  .menus-table-view {
    display: block;
  }

  .menus-cards-view {
    display: none;
  }

  @media (max-width: 768px) {
    .menus-table-view {
      display: block;
    }

    .menus-cards-view {
      display: none;
    }
  }

  .menu-card-mobile {
    background: var(--color-gray-50);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-3);
    margin-bottom: var(--space-2);
    transition: all var(--transition-base);
  }

  .menu-card-mobile:hover {
    box-shadow: var(--shadow-sm);
    border-color: var(--color-gray-300);
  }

  .menu-card-mobile:last-child {
    margin-bottom: 0;
  }

  .menu-row-mobile {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
  }

  .menu-row-mobile-left {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    min-width: 0;
    flex: 1;
  }

  .menu-row-mobile-text {
    min-width: 0;
    flex: 1;
  }

  .menu-row-mobile-text .menu-name {
    display: inline-block;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  @media (max-width: 480px) {
    .menus-table-view th.menu-compact-cell,
    .menus-table-view td.menu-compact-cell {
      padding-left: 0.2rem;
      padding-right: 0.2rem;
    }
  }

  @media (max-width: 480px) {
    .menu-share-controls {
      display: none;
    }
  }
</style>

<style>
  /* Menus List - Single Column */
  .menus-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  /* Menu Card - Horizontal Layout */
  .menu-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    background: white;
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    transition: all var(--transition-base);
  }

  .menu-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-gray-300);
  }

  /* Sortable states */
  .sortable-ghost {
    opacity: 0.4;
    background: var(--color-gray-50);
  }

  .sortable-drag {
    opacity: 1;
    box-shadow: var(--shadow-lg);
  }

  /* Drag Handle */
  .drag-handle {
    cursor: grab;
    color: var(--color-gray-400);
    font-size: 1.5rem;
    padding: var(--space-2);
    margin: calc(var(--space-2) * -1);
    transition: color var(--transition-base);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .drag-handle:hover {
    color: var(--color-gray-600);
  }

  .drag-handle:active {
    cursor: grabbing;
  }

  /* Main Content Area */
  .menu-card-main {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .menu-card-title-row {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-wrap: wrap;
  }

  .menu-card-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-gray-900);
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .menu-card-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
    font-size: var(--text-sm);
    color: var(--color-gray-600);
  }

  .menu-card-description {
    color: var(--color-gray-600);
  }

  .meta-separator {
    color: var(--color-gray-300);
    font-weight: bold;
  }

  .stat-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    color: var(--color-gray-600);
    white-space: nowrap;
  }

  /* Actions Section */
  .menu-card-actions {
    display: flex;
    gap: var(--space-2);
    flex-shrink: 0;
    align-items: center;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .menu-card {
      flex-direction: column;
      align-items: stretch;
      gap: var(--space-3);
    }

    .drag-handle {
      align-self: flex-start;
    }

    .menu-card-actions {
      width: 100%;
      justify-content: stretch;
      align-items: stretch;
    }

    .menu-card-actions .flex-fill {
      flex: 1;
    }

    .menu-card-meta {
      gap: var(--space-1);
    }
  }

  @media (max-width: 480px) {
    .menu-card {
      padding: var(--space-3);
    }

    .menu-card-title {
      font-size: var(--text-base);
    }

    .menu-card-meta {
      font-size: var(--text-xs);
    }
  }

  /* Mobile Card Actions - Better spacing */
  @media (max-width: 480px) {
    .menu-card-actions {
      padding: var(--space-2) var(--space-3);
      gap: var(--space-1);
      align-items: stretch;
    }

    .menu-card-actions .btn {
      padding: 0.625rem 0.875rem; /* enlarge tap target */
      font-size: var(--text-sm);
      min-height: 44px; /* iOS recommended min tap height */
      width: 100%;
    }

    /* Make drag handle a bit larger for easier grab on mobile */
    .drag-handle {
      font-size: 1.75rem;
      padding: var(--space-1) var(--space-2);
      margin: 0;
    }

    /* Hide long descriptions on very small screens */
    .menu-card-description {
      display: none;
    }

    /* Keep meta compact */
    .stat-badge {
      font-size: var(--text-xs);
    }

    /* Keep status badge aligned to top on mobile */
    .menu-status-badge {
      align-self: flex-start;
      margin-bottom: 0.25rem;
    }
  }

  /* Filter Tabs - Mobile Scrollable */
  @media (max-width: 768px) {
    .nav-tabs {
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    .nav-tabs .nav-item {
      flex-shrink: 0;
    }

    .nav-tabs::-webkit-scrollbar {
      height: 3px;
    }

    .nav-tabs::-webkit-scrollbar-thumb {
      background: var(--color-gray-300);
      border-radius: 3px;
    }
  }
</style>
