<%#
  Restaurant Menus Section
  Menu list and management
%>

<% restaurant = local_assigns[:restaurant] || @restaurant %>
<% filter = local_assigns[:filter] || 'all' %>

<%
  menus = case filter
          when 'active'
            restaurant.menus.where(archived: false, status: 'active')
          when 'draft'
            restaurant.menus.where(archived: false, status: 'inactive')
          else
            restaurant.menus.where(archived: false)
          end
  menus = menus.order(:sequence)
%>

<!-- Quick Actions Card -->
<div class="quick-actions-card" data-testid="menus-quick-actions">
  <h2 class="quick-actions-title">
    <i class="bi bi-lightning-charge"></i>
    <%= t('.quick_actions', default: 'Quick Actions') %>
  </h2>

  <div class="quick-actions-grid">
    <%= link_to new_restaurant_menu_path(restaurant),
        class: 'quick-action-btn',
        data: { testid: 'new-menu-btn', turbo_frame: '_top' } do %>
      <i class="bi bi-plus-circle"></i>
      <span><%= t('.new_menu', default: 'New Menu') %></span>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'import'),
        class: 'quick-action-btn',
        data: { testid: 'import-menu-btn', turbo_frame: 'restaurant_content', turbo_action: 'advance' } do %>
      <i class="bi bi-file-earmark-arrow-up"></i>
      <span><%= t('.import_menu', default: 'Import Menu') %></span>
    <% end %>
  </div>
</div>

<style>
  /* Force Quick Actions into two columns on all viewports (including mobile portrait) */
  .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--space-3);
  }
  .quick-actions-grid .quick-action-btn {
    width: 100%;
    justify-content: center;
  }
</style>

<!-- Menus List -->
<div class="content-card-2025" data-testid="menus-list-card">
  <h2 class="content-card-title mb-0">
    <i class="bi bi-menu-button-wide"></i>
    <%= t(".menus_#{filter}", default: filter.titleize + ' Menus') %>
  </h2>

  <!-- Filter Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <%= link_to edit_restaurant_path(restaurant, section: 'menus'),
          class: "nav-link #{'active' if filter == 'all'}",
          data: { testid: 'menus-filter-all', turbo_frame: 'restaurant_content', turbo_action: 'advance' } do %>
        <%= t('.all', default: 'All') %>
        <span class="badge bg-secondary"><%= restaurant.menus.where(archived: false).count %></span>
      <% end %>
    </li>
    <li class="nav-item">
      <%= link_to edit_restaurant_path(restaurant, section: 'menus_active'),
          class: "nav-link #{'active' if filter == 'active'}",
          data: { testid: 'menus-filter-active', turbo_frame: 'restaurant_content', turbo_action: 'advance' } do %>
        <%= t('.active', default: 'Active') %>
        <span class="badge bg-success"><%= restaurant.menus.where(archived: false, status: 'active').count %></span>
      <% end %>
    </li>
    <li class="nav-item">
      <%= link_to edit_restaurant_path(restaurant, section: 'menus_inactive'),
          class: "nav-link #{'active' if filter == 'inactive'}",
          data: { testid: 'menus-filter-inactive', turbo_frame: 'restaurant_content', turbo_action: 'advance' } do %>
        <%= t('.inactive', default: 'Inactive') %>
        <span class="badge bg-warning"><%= restaurant.menus.where(archived: false, status: 'inactive').count %></span>
      <% end %>
    </li>
  </ul>

  <% if menus.any? %>
    <!-- Menus List -->
    <div class="menus-list"
         data-testid="menus-list"
         data-controller="sortable"
         data-sortable-url-value="<%= update_sequence_restaurant_menus_path(restaurant) %>"
         data-sortable-handle-value=".drag-handle">
      <% menus.each do |menu| %>
        <div class="menu-card" data-sortable-id="<%= menu.id %>" data-testid="menu-card-<%= menu.id %>">
          <!-- Drag Handle -->
          <div class="drag-handle" title="<%= t('.drag_to_reorder', default: 'Drag to reorder') %>">
            <i class="bi bi-grip-vertical"></i>
          </div>

          <!-- Menu Info Section -->
          <div class="menu-card-main">
            <div class="menu-card-title-row">
              <h3 class="menu-card-title"><%= menu.name %></h3>
            </div>

            <div class="menu-card-meta">
              <% if menu.description.present? %>
                <span class="menu-card-description">
                  <%= truncate(menu.description, length: 80) %>
                </span>
                <span class="meta-separator">•</span>
              <% end %>

              <span class="stat-badge">
                <i class="bi bi-grid-3x3"></i>
                <%= menu.menusections.count %> <%= t('.sections', default: 'sections') %>
              </span>

              <span class="meta-separator">•</span>

              <span class="stat-badge">
                <i class="bi bi-list"></i>
                <%= menu.menusections.joins(:menuitems).count('menuitems.id') %> <%= t('.items', default: 'items') %>
              </span>
            </div>
          </div>

          <!-- Actions Section -->
          <div class="menu-card-actions ms-auto">
            <!-- Status badge floated to top-right, above dropdown -->
            <div class="menu-status-badge mb-2">
              <% if menu.active? %>
                <span class="badge bg-success">
                  <i class="bi bi-check-circle"></i> <%= t('.active', default: 'Active') %>
                </span>
              <% elsif menu.inactive? %>
                <span class="badge bg-warning text-dark">
                  <i class="bi bi-pencil"></i> <%= t('.inactive', default: 'Inactive') %>
                </span>
              <% end %>
            </div>
            <div class="dropdown">
              <button class="btn-2025 btn-2025-ghost btn-2025-sm"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      data-testid="menu-actions-<%= menu.id %>-btn">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <%= link_to edit_restaurant_menu_path(restaurant, menu), class: 'dropdown-item', data: { turbo_frame: '_top', testid: "edit-menu-#{menu.id}-btn" } do %>
                    <i class="bi bi-pencil"></i> <%= t('.edit', default: 'Edit') %>
                  <% end %>
                </li>
              </ul>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <!-- Empty State -->
    <div class="text-center py-5">
      <i class="bi bi-menu-button-wide text-muted text-3rem"></i>
      <h3 class="mt-3 text-muted">
        <%= t('.no_menus', default: 'No menus found') %>
      </h3>
      <p class="text-muted">
        <%= t('.no_menus_description', default: 'Create your first menu to get started') %>
      </p>
    </div>
  <% end %>
</div>

<style>
  /* Align actions in a column at the right so the badge sits above the dropdown */
  .menu-card { display: flex; align-items: stretch; gap: 12px; }
  .menu-card-main { flex: 1 1 auto; }
  .menu-card-actions { display: flex; flex-direction: column; align-items: flex-end; }
  .menu-status-badge { line-height: 1; }
</style>

<style>
  /* Menus List - Single Column */
  .menus-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  /* Menu Card - Horizontal Layout */
  .menu-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    background: white;
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    transition: all var(--transition-base);
  }

  .menu-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-gray-300);
  }

  /* Sortable states */
  .sortable-ghost {
    opacity: 0.4;
    background: var(--color-gray-50);
  }

  .sortable-drag {
    opacity: 1;
    box-shadow: var(--shadow-lg);
  }

  /* Drag Handle */
  .drag-handle {
    cursor: grab;
    color: var(--color-gray-400);
    font-size: 1.5rem;
    padding: var(--space-2);
    margin: calc(var(--space-2) * -1);
    transition: color var(--transition-base);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .drag-handle:hover {
    color: var(--color-gray-600);
  }

  .drag-handle:active {
    cursor: grabbing;
  }

  /* Main Content Area */
  .menu-card-main {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .menu-card-title-row {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-wrap: wrap;
  }

  .menu-card-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-gray-900);
    margin: 0;
  }

  .menu-card-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
    font-size: var(--text-sm);
    color: var(--color-gray-600);
  }

  .menu-card-description {
    color: var(--color-gray-600);
  }

  .meta-separator {
    color: var(--color-gray-300);
    font-weight: bold;
  }

  .stat-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    color: var(--color-gray-600);
    white-space: nowrap;
  }

  /* Actions Section */
  .menu-card-actions {
    display: flex;
    gap: var(--space-2);
    flex-shrink: 0;
    align-items: center;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .menu-card {
      flex-direction: column;
      align-items: stretch;
      gap: var(--space-3);
    }

    .drag-handle {
      align-self: flex-start;
    }

    .menu-card-actions {
      width: 100%;
      justify-content: stretch;
    }

    .menu-card-actions .flex-fill {
      flex: 1;
    }
  }

  @media (max-width: 480px) {
    .menu-card {
      padding: var(--space-3);
    }

    .menu-card-title {
      font-size: var(--text-base);
    }

    .menu-card-meta {
      font-size: var(--text-xs);
    }
  }

  /* Mobile Card Actions - Better spacing */
  @media (max-width: 480px) {
    .menu-card-actions {
      padding: var(--space-2) var(--space-3);
      gap: var(--space-1);
    }

    .menu-card-actions .btn-2025 {
      padding: var(--space-2);
      font-size: var(--text-xs);
    }
  }

  /* Filter Tabs - Mobile Scrollable */
  @media (max-width: 768px) {
    .nav-tabs {
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    .nav-tabs .nav-item {
      flex-shrink: 0;
    }

    .nav-tabs::-webkit-scrollbar {
      height: 3px;
    }

    .nav-tabs::-webkit-scrollbar-thumb {
      background: var(--color-gray-300);
      border-radius: 3px;
    }
  }
</style>
