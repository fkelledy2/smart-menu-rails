<%#
  Restaurant Hours Section
  Operating hours and availability management
%>

<% restaurant = local_assigns[:restaurant] || @restaurant %>

<!-- Quick Actions Card -->
<div class="quick-actions-card">
  <h2 class="quick-actions-title">
    <i class="bi bi-lightning-charge"></i>
    <%= t('.quick_actions', default: 'Quick Actions') %>
  </h2>

  <div class="quick-actions-grid">
    <button type="button"
            class="quick-action-btn copy-monday-btn"
            data-copied-text="<%= t('.copied_success', default: 'Copied!') %>">
      <i class="bi bi-files"></i>
      <span><%= t('.copy_to_all', default: 'Copy Monday to All Days') %></span>
    </button>
  </div>
</div>

<!-- Operating Hours -->
<div class="content-card-2025 py-4">
  <h2 class="content-card-title">
    <i class="bi bi-clock"></i>
    <%= t('.operating_hours', default: 'Operating Hours') %>
  </h2>

  <p class="text-muted mb-4">
    <%= t('.hours_description', default: 'Set your restaurant\'s regular business hours') %>
  </p>

  <form data-controller="auto-save"
        data-auto-save-url-value="<%= update_hours_restaurant_path(restaurant) %>"
        data-auto-save-method-value="patch"
        data-auto-save-debounce-value="1500">

    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

    <!-- Loading skeleton -->
    <div class="hours-loading-skeleton">
      <div class="skeleton-shimmer"></div>
    </div>

  <div class="hours-editor opacity-0 transition-opacity-300">
    <% %w[monday tuesday wednesday thursday friday saturday sunday].each_with_index do |day, index| %>
      <% day_hours = restaurant.restaurantavailabilities.where(dayofweek: day).order(:sequence).first %>
      <% is_closed = day_hours.nil? || day_hours.closed? %>
      <% open_hour = day_hours&.starthour || 9 %>
      <% open_min = day_hours&.startmin || 0 %>
      <% close_hour = day_hours&.endhour || 22 %>
      <% close_min = day_hours&.endmin || 0 %>
      <% open_minutes = (open_hour * 60) + open_min %>
      <% close_minutes = (close_hour * 60) + close_min %>

      <div class="day-row mb-3" data-day="<%= day %>">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <label class="form-label-2025 mb-0 fw-semibold">
            <%= t("date.day_names")[Date::DAYNAMES.index(day.capitalize)] %>
          </label>

          <div class="form-check form-switch">
            <input class="form-check-input closed-toggle"
                   type="checkbox"
                   id="closed_<%= day %>"
                   name="closed[<%= day %>]"
                   value="1"
                   <%= 'checked' if is_closed %>
                   data-day="<%= day %>" />
            <label class="form-check-label text-muted" for="closed_<%= day %>">
              <%= t('.closed', default: 'Closed') %>
            </label>
          </div>
        </div>

        <div class="time-slider-container <%= 'disabled' if is_closed %>">
          <!-- Time display above slider -->
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div class="time-display opening-time">
              <i class="bi bi-sunrise"></i>
              <span class="time-value"><%= sprintf('%02d:%02d', open_hour, open_min) %></span>
            </div>
            <div class="time-display closing-time">
              <i class="bi bi-sunset"></i>
              <span class="time-value"><%= sprintf('%02d:%02d', close_hour, close_min) %></span>
            </div>
          </div>

          <!-- Range slider -->
          <div class="time-range-slider"
               id="slider_<%= day %>"
               data-open="<%= open_minutes %>"
               data-close="<%= close_minutes %>">
          </div>

          <!-- 24-hour timeline markers -->
          <div class="timeline-markers">
            <% (0..23).step(3).each do |hour| %>
              <div class="marker">
                <span><%= sprintf('%02d:00', hour) %></span>
              </div>
            <% end %>
          </div>

          <!-- Hidden inputs for form submission -->
          <input type="hidden" class="open-time-input" name="hours[<%= day %>][open]" value="<%= sprintf('%02d:%02d', open_hour, open_min) %>" />
          <input type="hidden" class="close-time-input" name="hours[<%= day %>][close]" value="<%= sprintf('%02d:%02d', close_hour, close_min) %>" />
        </div>
      </div>
    <% end %>
  </div>

  <div class="mt-4">
    <!-- Auto-save status indicator -->
    <span class="form-autosave-status" data-auto-save-target="status"></span>
  </div>

  </form>
</div>

<!-- Preload noUiSlider CSS for faster loading -->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css" /></noscript>

<!-- Load noUiSlider if not already loaded -->
<script data-turbo-track="reload" data-turbo-eval="true">
  // Check if noUiSlider is already loaded
  if (typeof noUiSlider === 'undefined') {
    console.log('[HoursEditor] Loading noUiSlider from CDN...');
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js';
    script.onload = function() {
      console.log('[HoursEditor] noUiSlider loaded successfully');
      window.noUiSliderLoaded = true;
    };
    script.onerror = function() {
      console.error('[HoursEditor] Failed to load noUiSlider from CDN');
    };
    document.head.appendChild(script);
  } else {
    console.log('[HoursEditor] noUiSlider already loaded');
    window.noUiSliderLoaded = true;
  }
</script>

<style>
  .hours-editor .day-row {
    padding: var(--space-3);
    border-radius: var(--radius-md);
    background: var(--color-gray-50);
    border: 1px solid var(--color-gray-200);
    transition: all var(--transition-base);
  }

  .hours-editor .day-row:hover {
    background-color: #fff;
    border-color: var(--color-gray-300);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .time-slider-container {
    position: relative;
    padding: 0.5rem 0.25rem;
  }

  .time-slider-container.disabled {
    opacity: 0.4;
    pointer-events: none;
  }

  .time-display {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-gray-900);
  }

  .time-display i {
    font-size: 1.125rem;
  }

  .opening-time {
    color: var(--color-gray-700);
  }

  .closing-time {
    color: var(--color-gray-700);
  }

  .time-range-slider {
    margin: 0.75rem 0;
    height: 12px;
  }

  /* noUiSlider customization */
  .noUi-target {
    background: var(--color-gray-200);
    border: none;
    box-shadow: none;
    border-radius: 6px;
    height: 12px;
  }

  .noUi-connect {
    background: var(--color-gray-600);
    box-shadow: none;
  }

  .noUi-handle {
    background: #fff;
    border: 3px solid var(--color-gray-400);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    width: 24px;
    height: 24px;
    top: -6px;
    cursor: grab;
  }

  .noUi-handle:active {
    cursor: grabbing;
    border-color: var(--color-gray-700);
  }

  .noUi-handle:hover {
    border-color: var(--color-gray-500);
  }

  .noUi-handle:before,
  .noUi-handle:after {
    display: none;
  }

  .noUi-tooltip {
    display: none;
  }

  .timeline-markers {
    display: flex;
    justify-content: space-between;
    margin-top: 0.25rem;
    padding: 0 0.25rem;
  }

  .timeline-markers .marker {
    flex: 1;
    text-align: center;
    position: relative;
  }

  .timeline-markers .marker span {
    font-size: 0.75rem;
    color: var(--color-gray-500);
    font-weight: 500;
  }

  .timeline-markers .marker:before {
    content: '';
    position: absolute;
    top: -0.5rem;
    left: 50%;
    transform: translateX(-50%);
    width: 2px;
    height: 4px;
    background: var(--color-gray-300);
  }

  .form-check-input.closed-toggle:checked {
    background-color: #dc2626;
    border-color: #dc2626;
  }

  /* Auto-save status indicator */
  .form-autosave-status {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    display: inline-block;
    transition: all 0.3s ease;
  }

  .form-autosave-status.saving {
    color: #0ea5e9;
    background-color: #e0f2fe;
  }

  .form-autosave-status.saved {
    color: #10b981;
    background-color: #d1fae5;
  }

  .form-autosave-status.error {
    color: #ef4444;
    background-color: #fee2e2;
  }

  /* Loading skeleton */
  .hours-loading-skeleton {
    height: 400px;
    background: linear-gradient(90deg, var(--color-gray-100) 25%, var(--color-gray-50) 50%, var(--color-gray-100) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: var(--radius-md);
    transition: opacity 0.3s ease;
  }

  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .hours-loading-skeleton.hidden {
    opacity: 0;
    pointer-events: none;
  }

  /* Force Quick Actions into two columns on all viewports (including mobile portrait) */
  .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--space-3);
  }
  .quick-actions-grid .quick-action-btn {
    width: 100%;
    justify-content: center;
  }
</style>

<script data-turbo-eval="true">
  // Track retry attempts
  let noUiSliderRetries = 0;
  const MAX_RETRIES = 50; // 5 seconds maximum wait (50 * 100ms)

  function initializeHoursEditor() {
    console.log('[HoursEditor] Initializing with auto-save');

    // Check if noUiSlider is loaded
    if (typeof noUiSlider === 'undefined') {
      if (noUiSliderRetries < MAX_RETRIES) {
        noUiSliderRetries++;
        console.log(`[HoursEditor] Waiting for noUiSlider to load... (attempt ${noUiSliderRetries}/${MAX_RETRIES})`);
        // Retry after a short delay
        setTimeout(initializeHoursEditor, 100);
        return;
      } else {
        console.error('[HoursEditor] Failed to load noUiSlider after max retries');
        return;
      }
    }

    // Reset retry counter on success
    noUiSliderRetries = 0;
    console.log('[HoursEditor] noUiSlider is available, proceeding with initialization');

    // Verify auto-save controller is attached
    const form = document.querySelector('[data-controller*="auto-save"]');
    if (!form) {
      console.error('[HoursEditor] Auto-save form NOT found!');
    }

    // Initialize all time sliders
    const sliders = document.querySelectorAll('.time-range-slider');

    // Destroy existing sliders first to prevent duplicates
    sliders.forEach((sliderElement) => {
      if (sliderElement.noUiSlider) {
        sliderElement.noUiSlider.destroy();
      }
    });

    sliders.forEach((sliderElement) => {
      const day = sliderElement.id.replace('slider_', '');
      const dayRow = sliderElement.closest('.day-row');
      const openMinutes = parseInt(sliderElement.dataset.open) || 540; // 9:00
      const closeMinutes = parseInt(sliderElement.dataset.close) || 1320; // 22:00

      // Create the slider
      const slider = noUiSlider.create(sliderElement, {
        start: [openMinutes, closeMinutes],
        connect: true,
        range: {
          'min': 0,      // 00:00
          'max': 1440    // 24:00
        },
        step: 15, // 15-minute intervals
        tooltips: false
      });

      // Update time displays in real-time while dragging
      slider.on('update', function(values, handle) {
        const minutes = Math.round(values[handle]);
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        const timeString = sprintf('%02d:%02d', hours, mins);

        if (handle === 0) {
          // Opening time
          const openingTime = dayRow.querySelector('.opening-time .time-value');
          openingTime.textContent = timeString;
        } else {
          // Closing time
          const closingTime = dayRow.querySelector('.closing-time .time-value');
          closingTime.textContent = timeString;
        }
      });

      // Trigger auto-save when user releases the slider handle
      slider.on('set', function(values, handle) {
        const minutes = Math.round(values[handle]);
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        const timeString = sprintf('%02d:%02d', hours, mins);

        let input; // Declare outside if/else for proper scoping

        if (handle === 0) {
          // Opening time
          input = dayRow.querySelector('.open-time-input');
          input.value = timeString;
        } else {
          // Closing time
          input = dayRow.querySelector('.close-time-input');
          input.value = timeString;
        }

        // Trigger change and input events for auto-save
        input.dispatchEvent(new Event('change', { bubbles: true }));
        input.dispatchEvent(new Event('input', { bubbles: true }));
      });
    });

    // Handle closed toggle
    document.querySelectorAll('.closed-toggle').forEach((toggle) => {
      toggle.addEventListener('change', function() {
        const dayRow = this.closest('.day-row');
        const container = dayRow.querySelector('.time-slider-container');

        if (this.checked) {
          container.classList.add('disabled');
        } else {
          container.classList.remove('disabled');
        }
      });
    });

    // Copy Monday to all days
    const copyButton = document.querySelector('.copy-monday-btn');
    if (copyButton) {
      copyButton.addEventListener('click', function(e) {
        e.preventDefault();

        const mondayRow = document.querySelector('[data-day="monday"]');
        if (!mondayRow) return;

        const mondaySlider = mondayRow.querySelector('.time-range-slider');
        const mondaySliderInstance = mondaySlider.noUiSlider;
        const mondayValues = mondaySliderInstance.get();
        const mondayIsClosed = mondayRow.querySelector('.closed-toggle').checked;

        // Apply to all other days
        document.querySelectorAll('.day-row').forEach((row) => {
          if (row.dataset.day === 'monday') return;

          const slider = row.querySelector('.time-range-slider');
          const toggle = row.querySelector('.closed-toggle');

          // Set closed state
          toggle.checked = mondayIsClosed;
          toggle.dispatchEvent(new Event('change'));

          // Set slider values
          if (slider.noUiSlider) {
            slider.noUiSlider.set(mondayValues);
          }
        });

        // Show success message
        const btn = this;
        const originalText = btn.innerHTML;
        const copiedText = btn.dataset.copiedText || 'Copied!';
        btn.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${copiedText}`;
        btn.classList.remove('btn-2025-secondary');
        btn.classList.add('btn-2025-primary');

        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('btn-2025-primary');
          btn.classList.add('btn-2025-secondary');
        }, 2000);
      });
    }

    // Show the editor and hide skeleton now that sliders are initialized
    const editor = document.querySelector('.hours-editor');
    const skeleton = document.querySelector('.hours-loading-skeleton');

    if (skeleton) {
      skeleton.classList.add('hidden');
    }

    if (editor) {
      // Remove any utility class that forces opacity 0
      editor.classList.remove('opacity-0');
      editor.style.opacity = '1';
    }
  }

  // Helper function for formatting
  function sprintf(format, ...args) {
    let i = 0;
    return format.replace(/%0?(\d*)d/g, (match, width) => {
      const num = args[i++].toString();
      return width ? num.padStart(parseInt(width), '0') : num;
    });
  }

  // Initialize on DOMContentLoaded (full page load)
  document.addEventListener('DOMContentLoaded', initializeHoursEditor);

  // Initialize on Turbo navigation (sidebar navigation)
  document.addEventListener('turbo:load', initializeHoursEditor);
  document.addEventListener('turbo:frame-load', initializeHoursEditor);

  console.log('[HoursEditor] Event listeners registered for DOMContentLoaded, turbo:load, and turbo:frame-load');
</script>
