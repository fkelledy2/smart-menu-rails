<%#
  Restaurant Settings Section
  Core configuration toggles and preferences
%>

<% restaurant = local_assigns[:restaurant] || @restaurant %>

<!-- General Settings card removed: status managed via Quick Actions -->

<!-- Feature Toggles -->
<div class="content-card-2025">
  <h2 class="content-card-title">
    <i class="bi bi-sliders"></i>
    <%= t('.feature_toggles', default: 'Feature Toggles') %>
  </h2>

  <%= restaurant_form_with(restaurant, auto_save: true) do |form| %>
  <div class="features-grid">
    <!-- Display Images -->
    <div class="feature-card">
      <div class="feature-card-icon bg-primary">
        <i class="bi bi-image"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.display_images', default: 'Display Images') %></h5>
        <p class="feature-card-description">
          <%= t('.display_images_help', default: 'Show menu item images in your digital menu') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input type="hidden" name="restaurant[displayImages]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="restaurant[displayImages]"
                 id="restaurant_displayImages"
                 value="true"
                 <%= 'checked' if restaurant.displayImages %>
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <!-- Alcohol Policy -->
    <div class="feature-card" id="alcohol-policy-editor" data-endpoint="<%= update_alcohol_policy_restaurant_path(restaurant) %>" data-status-endpoint="<%= alcohol_status_restaurant_path(restaurant) %>">
      <div class="feature-card-icon bg-danger">
        <i class="bi bi-shield-exclamation"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.alcohol_policy', default: 'Alcohol Policy') %></h5>
        <p class="feature-card-description">
          <%= t('.alcohol_policy_help', default: 'Configure allowed days/times and blackout dates for alcohol sales.') %>
        </p>
        <div class="mt-3">
          <!-- Status preview -->
          <div class="mb-3">
            <span id="alcohol-policy-status" class="badge <%= restaurant.alcohol_allowed_now? ? 'bg-success' : 'bg-secondary' %>">
              <%= restaurant.alcohol_allowed_now? ? t('.allowed_now', default: 'Allowed now') : t('.blocked_now', default: 'Blocked now') %>
            </span>
          </div>

          <!-- Days of week -->
          <div class="mb-3">
            <label class="form-label-2025"><%= t('.allowed_days', default: 'Allowed Days') %></label>
            <div class="d-flex flex-wrap gap-3" id="alcohol-days">
              <% days = %w[Sun Mon Tue Wed Thu Fri Sat] %>
              <% selected_days = restaurant.alcohol_policy&.allowed_days_of_week || [] %>
              <% days.each_with_index do |d, i| %>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="<%= i %>" id="alcohol-day-<%= i %>" <%= 'checked' if selected_days.include?(i) %> />
                  <label class="form-check-label" for="alcohol-day-<%= i %>"><%= d %></label>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Time ranges -->
          <div class="mb-3">
            <label class="form-label-2025"><%= t('.time_ranges', default: 'Allowed Time Ranges') %></label>
            <div id="alcohol-time-ranges" class="d-flex flex-column gap-2">
              <% (restaurant.alcohol_policy&.allowed_time_ranges || []).each_with_index do |r, idx| %>
                <div class="input-group" data-range-index="<%= idx %>">
                  <span class="input-group-text"><%= t('.from', default: 'From') %></span>
                  <input type="time" class="form-control" value="<%= format('%02d:%02d', (r['from_min'].to_i/60), (r['from_min'].to_i%60)) %>" />
                  <span class="input-group-text"><%= t('.to', default: 'To') %></span>
                  <input type="time" class="form-control" value="<%= format('%02d:%02d', (r['to_min'].to_i/60), (r['to_min'].to_i%60)) %>" />
                  <button type="button" class="btn btn-outline-danger remove-range"><i class="bi bi-x"></i></button>
                </div>
              <% end %>
            </div>
            <div class="mt-2">
              <button type="button" class="btn btn-sm btn-outline-primary" id="add-time-range"><i class="bi bi-plus"></i> <%= t('.add_range', default: 'Add range') %></button>
            </div>
          </div>

          <!-- Blackout dates -->
          <div class="mb-3">
            <label class="form-label-2025"><%= t('.blackout_dates', default: 'Blackout Dates (YYYY-MM-DD, comma-separated)') %></label>
            <input type="text" class="form-control" id="alcohol-blackouts" value="<%= (restaurant.alcohol_policy&.blackout_dates || []).map(&:to_s).join(', ') %>" placeholder="2025-12-25, 2025-01-01" />
          </div>
        </div>
      </div>
      
      <script>
        (function(){
          const card = document.getElementById('alcohol-policy-editor');
          if (!card) return;
          const statusBadge = card.querySelector('#alcohol-policy-status');
          const daysContainer = card.querySelector('#alcohol-days');
          const rangesContainer = card.querySelector('#alcohol-time-ranges');
          const addRangeBtn = card.querySelector('#add-time-range');
          const blackoutsInput = card.querySelector('#alcohol-blackouts');
          const saveBtn = card.querySelector('#save-alcohol-policy');
          const endpoint = card.getAttribute('data-endpoint');
          const statusEndpoint = card.getAttribute('data-status-endpoint');

          const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
          const toMin = (hhmm) => { if(!hhmm) return 0; const [h,m] = hhmm.split(':').map(x=>parseInt(x,10)||0); return (h*60)+m; };
          const fmt = (n) => String(n).padStart(2,'0');
          const toHHMM = (mins) => `${fmt(Math.floor(mins/60))}:${fmt(mins%60)}`;

          const gather = () => {
            const allowed_days_of_week = Array.from(daysContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>parseInt(cb.value,10));
            const allowed_time_ranges = Array.from(rangesContainer.querySelectorAll('.input-group')).map(g=>{
              const inputs = g.querySelectorAll('input[type="time"]');
              return { from_min: toMin(inputs[0]?.value), to_min: toMin(inputs[1]?.value) };
            });
            const blackout_dates = (blackoutsInput.value||'').split(',').map(s=>s.trim()).filter(Boolean);
            return { allowed_days_of_week, allowed_time_ranges, blackout_dates };
          };

          let saving = false; let t;
          const updateStatus = (allowed_now) => {
            if (!statusBadge) return;
            statusBadge.textContent = allowed_now ? '<%= j t('.allowed_now', default: 'Allowed now') %>' : '<%= j t('.blocked_now', default: 'Blocked now') %>';
            statusBadge.classList.remove('bg-success','bg-secondary');
            statusBadge.classList.add(allowed_now ? 'bg-success' : 'bg-secondary');
          };

          const fetchStatus = () => {
            if (!statusEndpoint) return;
            fetch(statusEndpoint, { headers: { 'Accept': 'application/json' }})
              .then(r=>r.json()).then(j=>{ if ('allowed_now' in j) updateStatus(!!j.allowed_now); }).catch(()=>{});
          };

          const save = () => {
            if (saving) return; saving = true;
            const body = gather();
            fetch(endpoint, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf, 'Accept': 'application/json' },
              body: JSON.stringify(body)
            }).then(r=>r.json()).then(j=>{
              if (j && typeof j.allowed_now !== 'undefined') updateStatus(!!j.allowed_now); else fetchStatus();
            }).catch(()=>{ /* noop */ }).finally(()=>{ saving = false; });
          };

          const debounce = (fn, ms=600) => { let tm; return (...args)=>{ clearTimeout(tm); tm = setTimeout(()=>fn.apply(null,args), ms); }; };
          const autoSave = debounce(save, 700);

          card.addEventListener('change', (e)=>{
            if (e.target.closest('#alcohol-days') || e.target.id === 'alcohol-blackouts' || e.target.type === 'time') {
              autoSave();
            }
          });

          addRangeBtn?.addEventListener('click', ()=>{
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
              <span class="input-group-text"><%= j t('.from', default: 'From') %></span>
              <input type="time" class="form-control" value="08:00" />
              <span class="input-group-text"><%= j t('.to', default: 'To') %></span>
              <input type="time" class="form-control" value="22:00" />
              <button type="button" class="btn btn-outline-danger remove-range"><i class="bi bi-x"></i></button>
            `;
            rangesContainer.appendChild(div);
            autoSave();
          });

          rangesContainer.addEventListener('click', (e)=>{
            if (e.target.closest('.remove-range')) {
              const grp = e.target.closest('.input-group');
              grp?.remove();
              autoSave();
            }
          });

          // No explicit save button; auto-save on changes is enabled.
        })();
      </script>
    </div>

    <!-- Allow Alcohol -->
    <div class="feature-card">
      <div class="feature-card-icon bg-danger">
        <i class="bi bi-cup-straw"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.allow_alcohol', default: 'Allow Alcohol Sales') %></h5>
        <p class="feature-card-description">
          <%= t('.allow_alcohol_help', default: 'Enable selling alcoholic beverages. You are responsible for legal compliance.') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input type="hidden" name="restaurant[allow_alcohol]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="restaurant[allow_alcohol]"
                 id="restaurant_allow_alcohol"
                 value="true"
                 <%= 'checked' if restaurant.allow_alcohol %>
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <!-- Display Images in Popup -->
    <div class="feature-card">
      <div class="feature-card-icon bg-success">
        <i class="bi bi-window-stack"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.display_images_popup', default: 'Display Images in Popup') %></h5>
        <p class="feature-card-description">
          <%= t('.display_images_popup_help', default: 'Open menu item images in a popup modal when clicked') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input type="hidden" name="restaurant[displayImagesInPopup]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="restaurant[displayImagesInPopup]"
                 id="restaurant_displayImagesInPopup"
                 value="true"
                 <%= 'checked' if restaurant.displayImagesInPopup %>
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <!-- Allow Ordering -->
    <div class="feature-card">
      <div class="feature-card-icon bg-warning">
        <i class="bi bi-cart-check"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.allow_ordering', default: 'Allow Ordering') %></h5>
        <p class="feature-card-description">
          <%= t('.allow_ordering_help', default: 'Enable online ordering for customers') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input type="hidden" name="restaurant[allowOrdering]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="restaurant[allowOrdering]"
                 id="restaurant_allowOrdering"
                 value="true"
                 <%= 'checked' if restaurant.allowOrdering %>
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <!-- Inventory Tracking -->
    <div class="feature-card">
      <div class="feature-card-icon bg-danger">
        <i class="bi bi-boxes"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.inventory_tracking', default: 'Inventory Tracking') %></h5>
        <p class="feature-card-description">
          <%= t('.inventory_tracking_help', default: 'Track stock levels for menu items (Coming Soon)') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input class="form-check-input"
                 type="checkbox"
                 name="restaurant[inventoryTracking]"
                 id="restaurant_inventoryTracking"
                 value="true"
                 <%= 'checked' if restaurant.inventoryTracking %>
                 data-skip-tomselect="true"
                 disabled>
        </div>
      </div>
    </div>
  </div>
  <% end %>
</div>

<!-- WiFi Configuration -->
<div class="content-card-2025">
  <h2 class="content-card-title">
    <i class="bi bi-wifi"></i>
    <%= t('.wifi_configuration', default: 'WiFi Configuration') %>
  </h2>

  <p class="text-muted mb-4">
    <%= t('.wifi_description', default: 'Configure WiFi settings to generate QR codes for customer access') %>
  </p>

  <%= restaurant_form_with(restaurant, auto_save: true) do |form| %>
    <div class="row g-4">
      <!-- WiFi SSID -->
      <div class="col-md-6">
        <div class="form-group-2025">
          <%= form.label :wifissid, class: 'form-label-2025' do %>
            <%= t('activerecord.attributes.restaurant.wifissid', default: 'WiFi Network Name (SSID)') %>
          <% end %>
          <%= form.text_field :wifissid,
              class: 'form-control-2025',
              placeholder: t('.ssid_placeholder', default: 'Enter your WiFi network name') %>
          <div class="form-help-2025">
            <%= t('.ssid_help', default: 'The name of your WiFi network that customers will connect to') %>
          </div>
        </div>
      </div>

      <!-- WiFi Password -->
      <div class="col-md-6">
        <div class="form-group-2025">
          <%= form.label :wifiPassword, class: 'form-label-2025' do %>
            <%= t('activerecord.attributes.restaurant.wifiPassword', default: 'WiFi Password') %>
          <% end %>
          <%= form.password_field :wifiPassword,
              class: 'form-control-2025',
              placeholder: t('.password_placeholder', default: 'Enter WiFi password') %>
          <div class="form-help-2025">
            <%= t('.password_help', default: 'The password customers will need to connect') %>
          </div>
        </div>
      </div>

      <!-- WiFi Encryption Type -->
      <div class="col-md-6">
        <div class="form-group-2025">
          <%= form.label :wifiEncryptionType, class: 'form-label-2025' do %>
            <%= t('activerecord.attributes.restaurant.wifiEncryptionType', default: 'Encryption Type') %>
          <% end %>
          <%= form.select :wifiEncryptionType,
              options_for_select(Restaurant.wifiEncryptionTypes.keys.to_a, form.object.wifiEncryptionType),
              { prompt: t('.select_encryption', default: 'Select encryption...') },
              { class: 'form-control-2025', **select_data_attributes(:default) } %>
          <div class="form-help-2025">
            <%= t('.encryption_help', default: 'The security protocol used by your WiFi network') %>
          </div>
        </div>
      </div>

      <!-- WiFi Hidden -->
      <div class="col-md-6">
        <div class="form-group-2025">
          <%= form.label :wifiHidden, class: 'form-label-2025' do %>
            <%= t('activerecord.attributes.restaurant.wifiHidden', default: 'Hidden Network') %>
          <% end %>
          <%= form.select :wifiHidden,
              [
                [t('.no', default: 'No'), false],
                [t('.yes', default: 'Yes'), true]
              ],
              { prompt: t('.select_option', default: 'Select option...') },
              { class: 'form-control-2025', **select_data_attributes(:default) } %>
          <div class="form-help-2025">
            <%= t('.hidden_help', default: 'Whether the network name is broadcast publicly') %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Settings Info -->
<div class="content-card-2025 bg-light">
  <div class="d-flex align-items-start gap-3">
    <div class="text-primary" style="font-size: 1.5rem;">
      <i class="bi bi-info-circle"></i>
    </div>
    <div>
      <h4 class="mb-2"><%= t('.settings_info_title', default: 'About Settings') %></h4>
      <p class="text-sm text-muted mb-2">
        <%= t('.settings_info_desc', default: 'These settings control core functionality of your restaurant. Changes are saved automatically.') %>
      </p>
      <ul class="text-sm text-muted mb-0 ps-3">
        <li><strong><%= t('.status', default: 'Status') %>:</strong> <%= t('.status_info', default: 'Controls restaurant visibility') %></li>
        <li><strong><%= t('.display_images', default: 'Display Images') %>:</strong> <%= t('.images_info', default: 'Toggle menu item photos') %></li>
        <li><strong><%= t('.display_images_popup', default: 'Images in Popup') %>:</strong> <%= t('.popup_info', default: 'Full-screen image viewing') %></li>
      </ul>
    </div>
  </div>
</div>

<style>
  /* Feature Grid Layout */
  .features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-4);
  }

  .feature-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    padding: var(--space-4);
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
  }

  .feature-card:hover {
    border-color: var(--color-gray-300);
    box-shadow: var(--shadow-sm);
  }

  .feature-card-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .feature-card-content {
    flex: 1;
  }

  .feature-card-title {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    margin: 0 0 var(--space-2) 0;
    color: var(--color-gray-900);
  }

  .feature-card-description {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
    margin: 0;
    line-height: 1.5;
  }

  .feature-card-toggle {
    padding-top: var(--space-2);
    border-top: 1px solid var(--color-gray-100);
  }

  .feature-card-toggle .form-switch {
    display: flex;
    justify-content: flex-end;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .features-grid {
      grid-template-columns: 1fr;
    }
  }

  .bg-light {
    background: var(--color-gray-50) !important;
  }
</style>
