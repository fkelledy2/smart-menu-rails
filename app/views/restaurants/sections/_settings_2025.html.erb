<%#
  Restaurant Settings Section
  Core configuration toggles and preferences
%>

<% restaurant = local_assigns[:restaurant] || @restaurant %>

<% payment_profile = restaurant.payment_profile || restaurant.build_payment_profile(primary_provider: :stripe) %>
<% stripe_account = restaurant.provider_accounts.find { |a| a.provider.to_s == 'stripe' } || restaurant.provider_accounts.where(provider: :stripe).first %>
<% stripe_connect_enabled = stripe_account&.status.to_s == 'enabled' %>
<% payment_profile.merchant_model = nil unless payment_profile.persisted? %>
<% restaurant_mor_selected = payment_profile.merchant_model.to_s == 'restaurant_mor' %>
<% restaurant_mor_saved = payment_profile.persisted? && restaurant_mor_selected %>

<div class="content-card-2025">
  <h2 class="content-card-title">
    <i class="bi bi-credit-card"></i>
    <%= t('.payments', default: 'Payments') %>
  </h2>

  <div class="row g-3 align-items-start">
    <div class="col-12 col-lg-6">
      <div class="feature-card">
        <div class="feature-card-icon bg-primary">
          <i class="bi bi-shield-lock"></i>
        </div>
        <div class="feature-card-content">
          <h5 class="feature-card-title"><%= t('.merchant_of_record', default: 'Merchant of record') %></h5>
          <p class="feature-card-description">
            <%= t('.merchant_of_record_help', default: 'Choose whether payments are processed as the restaurant or as the platform.') %>
          </p>

          <%= form_with url: restaurant_payments_payment_profile_path(restaurant), method: :patch, data: { turbo: false } do |f| %>
            <%= f.fields_for :payment_profile, payment_profile do |pf| %>
              <%= pf.select :merchant_model,
                PaymentProfile.merchant_models.keys.map { |k|
                  label = case k.to_s
                  when 'restaurant_mor'
                    'Restaurant acts as Merchant of Record'
                  when 'smartmenu_mor'
                    'Mellow.menu acts as Merchant of Record'
                  else
                    k.to_s.humanize
                  end

                  [label, k]
                },
                { include_blank: '--choose--' },
                class: 'form-select form-select-sm',
                required: true %>
            <% end %>
            <div class="mt-2">
              <%= f.submit t('.save', default: 'Save'), class: 'btn btn-primary btn-sm' %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <% if restaurant_mor_saved %>
      <div class="col-12 col-lg-6">
        <div class="feature-card">
          <div class="feature-card-icon bg-dark">
            <i class="bi bi-stripe"></i>
          </div>
          <div class="feature-card-content">
            <h5 class="feature-card-title"><%= t('.stripe_connect', default: 'Stripe Connect') %></h5>
            <p class="feature-card-description">
              <%= t('.stripe_connect_help', default: 'Connect your Stripe account to enable restaurant MoR payments.') %>
            </p>

            <% if flash[:stripe_connect_error].present? %>
              <div class="alert alert-warning py-2 px-3 mb-2">
                <%= flash[:stripe_connect_error] %>
              </div>
            <% end %>

            <p class="text-muted small mb-0">
              <% if stripe_account&.status.to_s == 'enabled' %>
                <span class="text-success"><i class="bi bi-check-circle"></i> <%= t('.enabled', default: 'Enabled') %></span>
              <% elsif stripe_account.present? %>
                <span class="text-muted"><i class="bi bi-hourglass-split"></i> <%= stripe_account.status.to_s.humanize %></span>
              <% else %>
                <span class="text-muted"><i class="bi bi-x-circle"></i> <%= t('.not_connected', default: 'Not connected') %></span>
              <% end %>
            </p>
          </div>
          <div class="feature-card-toggle">
            <%= button_to t('.start_onboarding', default: 'Start onboarding'),
              restaurant_payments_stripe_connect_start_path(restaurant),
              method: :post,
              class: 'btn btn-outline-secondary btn-sm',
              disabled: stripe_connect_enabled || !restaurant_mor_selected,
              data: { turbo: false } %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- General Settings card removed: status managed via Quick Actions -->

<!-- Feature Toggles -->
<div class="content-card-2025">
  <h2 class="content-card-title">
    <i class="bi bi-sliders"></i>
    <%= t('.feature_toggles') %>
  </h2>

  <%= restaurant_form_with(restaurant, auto_save: true) do |form| %>
  <div class="features-grid">
    <!-- Display Images -->
    <div class="feature-card">
      <div class="feature-card-icon bg-primary">
        <i class="bi bi-image"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.display_images') %></h5>
        <p class="feature-card-description">
          <%= t('.display_images_help') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input type="hidden" name="restaurant[displayImages]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="restaurant[displayImages]"
                 id="restaurant_displayImages"
                 value="true"
                 <%= 'checked' if restaurant.displayImages %>
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <!-- Alcohol Policy -->
    <div class="feature-card" id="alcohol-policy-editor" data-endpoint="<%= update_alcohol_policy_restaurant_path(restaurant) %>" data-status-endpoint="<%= alcohol_status_restaurant_path(restaurant) %>">
      <div class="feature-card-icon bg-danger">
        <i class="bi bi-shield-exclamation"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.alcohol_policy') %></h5>
        <p class="feature-card-description">
          <%= t('.alcohol_policy_help') %>
        </p>
        <div class="mt-3">
          <!-- Status preview -->
          <div class="mb-3">
            <span id="alcohol-policy-status" class="badge <%= restaurant.alcohol_allowed_now? ? 'bg-success' : 'bg-secondary' %>">
              <%= restaurant.alcohol_allowed_now? ? t('.allowed_now') : t('.blocked_now') %>
            </span>
          </div>

          <!-- Days of week -->
          <div class="mb-3">
            <label class="form-label-2025"><%= t('.allowed_days') %></label>
            <div class="d-flex flex-wrap gap-3" id="alcohol-days">
              <% days = Array(I18n.t('date.abbr_day_names')) %>
              <% selected_days = restaurant.alcohol_policy&.allowed_days_of_week || [] %>
              <% days.each_with_index do |d, i| %>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="<%= i %>" id="alcohol-day-<%= i %>" <%= 'checked' if selected_days.include?(i) %> />
                  <label class="form-check-label" for="alcohol-day-<%= i %>"><%= d %></label>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Time ranges -->
          <div class="mb-3">
            <label class="form-label-2025"><%= t('.time_ranges') %></label>
            <div id="alcohol-time-ranges" class="d-flex flex-column gap-2">
              <% (restaurant.alcohol_policy&.allowed_time_ranges || []).each_with_index do |r, idx| %>
                <div class="input-group" data-range-index="<%= idx %>">
                  <span class="input-group-text"><%= t('.from') %></span>
                  <input type="time" class="form-control" value="<%= format('%02d:%02d', (r['from_min'].to_i/60), (r['from_min'].to_i%60)) %>" />
                  <span class="input-group-text"><%= t('.to') %></span>
                  <input type="time" class="form-control" value="<%= format('%02d:%02d', (r['to_min'].to_i/60), (r['to_min'].to_i%60)) %>" />
                  <button type="button" class="btn btn-outline-danger remove-range"><i class="bi bi-x"></i></button>
                </div>
              <% end %>
            </div>
            <div class="mt-2">
              <button type="button" class="btn btn-sm btn-outline-primary" id="add-time-range"><i class="bi bi-plus"></i> <%= t('.add_range') %></button>
            </div>
          </div>

          <!-- Blackout dates -->
          <div class="mb-3">
            <label class="form-label-2025"><%= t('.blackout_dates') %></label>
            <input type="text" class="form-control" id="alcohol-blackouts" value="<%= (restaurant.alcohol_policy&.blackout_dates || []).map(&:to_s).join(', ') %>" placeholder="2025-12-25, 2025-01-01" />
          </div>
        </div>
      </div>
      
      <script>
        (function(){
          const card = document.getElementById('alcohol-policy-editor');
          if (!card) return;
          const statusBadge = card.querySelector('#alcohol-policy-status');
          const daysContainer = card.querySelector('#alcohol-days');
          const rangesContainer = card.querySelector('#alcohol-time-ranges');
          const addRangeBtn = card.querySelector('#add-time-range');
          const blackoutsInput = card.querySelector('#alcohol-blackouts');
          const saveBtn = card.querySelector('#save-alcohol-policy');
          const endpoint = card.getAttribute('data-endpoint');
          const statusEndpoint = card.getAttribute('data-status-endpoint');

          const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
          const toMin = (hhmm) => { if(!hhmm) return 0; const [h,m] = hhmm.split(':').map(x=>parseInt(x,10)||0); return (h*60)+m; };
          const fmt = (n) => String(n).padStart(2,'0');
          const toHHMM = (mins) => `${fmt(Math.floor(mins/60))}:${fmt(mins%60)}`;

          const gather = () => {
            const allowed_days_of_week = Array.from(daysContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>parseInt(cb.value,10));
            const allowed_time_ranges = Array.from(rangesContainer.querySelectorAll('.input-group')).map(g=>{
              const inputs = g.querySelectorAll('input[type="time"]');
              return { from_min: toMin(inputs[0]?.value), to_min: toMin(inputs[1]?.value) };
            });
            const blackout_dates = (blackoutsInput.value||'').split(',').map(s=>s.trim()).filter(Boolean);
            return { allowed_days_of_week, allowed_time_ranges, blackout_dates };
          };

          let saving = false; let t;
          const updateStatus = (allowed_now) => {
            if (!statusBadge) return;
            statusBadge.textContent = allowed_now ? '<%= j t('.allowed_now') %>' : '<%= j t('.blocked_now') %>';
            statusBadge.classList.remove('bg-success','bg-secondary');
            statusBadge.classList.add(allowed_now ? 'bg-success' : 'bg-secondary');
          };

          const fetchStatus = () => {
            if (!statusEndpoint) return;
            fetch(statusEndpoint, { headers: { 'Accept': 'application/json' }})
              .then(r=>r.json()).then(j=>{ if ('allowed_now' in j) updateStatus(!!j.allowed_now); }).catch(()=>{});
          };

          const save = () => {
            if (saving) return; saving = true;
            const body = gather();
            fetch(endpoint, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf, 'Accept': 'application/json' },
              body: JSON.stringify(body)
            }).then(r=>r.json()).then(j=>{
              if (j && typeof j.allowed_now !== 'undefined') updateStatus(!!j.allowed_now); else fetchStatus();
            }).catch(()=>{ /* noop */ }).finally(()=>{ saving = false; });
          };

          const debounce = (fn, ms=600) => { let tm; return (...args)=>{ clearTimeout(tm); tm = setTimeout(()=>fn.apply(null,args), ms); }; };
          const autoSave = debounce(save, 700);

          card.addEventListener('change', (e)=>{
            if (e.target.closest('#alcohol-days') || e.target.id === 'alcohol-blackouts' || e.target.type === 'time') {
              autoSave();
            }
          });

          addRangeBtn?.addEventListener('click', ()=>{
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
              <span class="input-group-text"><%= j t('.from') %></span>
              <input type="time" class="form-control" value="08:00" />
              <span class="input-group-text"><%= j t('.to') %></span>
              <input type="time" class="form-control" value="22:00" />
              <button type="button" class="btn btn-outline-danger remove-range"><i class="bi bi-x"></i></button>
            `;
            rangesContainer.appendChild(div);
            autoSave();
          });

          rangesContainer.addEventListener('click', (e)=>{
            if (e.target.closest('.remove-range')) {
              const grp = e.target.closest('.input-group');
              grp?.remove();
              autoSave();
            }
          });

          // No explicit save button; auto-save on changes is enabled.
        })();
      </script>
    </div>

    <!-- Age Verification (moved from Advanced) -->
    <div class="feature-card">
      <div class="feature-card-icon bg-danger">
        <i class="bi bi-shield-check"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.age_verification') %></h5>
        <p class="feature-card-description">
          <%= t('.age_verification_desc') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="enable_age_verification">
        </div>
      </div>
    </div>

    <!-- Allow Alcohol -->
    <div class="feature-card">
      <div class="feature-card-icon bg-danger">
        <i class="bi bi-cup-straw"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.allow_alcohol') %></h5>
        <p class="feature-card-description">
          <%= t('.allow_alcohol_help') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input type="hidden" name="restaurant[allow_alcohol]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="restaurant[allow_alcohol]"
                 id="restaurant_allow_alcohol"
                 value="true"
                 <%= 'checked' if restaurant.allow_alcohol %>
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <!-- Display Images in Popup -->
    <div class="feature-card">
      <div class="feature-card-icon bg-success">
        <i class="bi bi-window-stack"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.display_images_popup') %></h5>
        <p class="feature-card-description">
          <%= t('.display_images_popup_help') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input type="hidden" name="restaurant[displayImagesInPopup]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="restaurant[displayImagesInPopup]"
                 id="restaurant_displayImagesInPopup"
                 value="true"
                 <%= 'checked' if restaurant.displayImagesInPopup %>
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <!-- Allow Ordering -->
    <div class="feature-card">
      <div class="feature-card-icon bg-warning">
        <i class="bi bi-cart-check"></i>
      </div>
      <div class="feature-card-content">
        <h5 class="feature-card-title"><%= t('.allow_ordering') %></h5>
        <p class="feature-card-description">
          <%= t('.allow_ordering_help') %>
        </p>
      </div>
      <div class="feature-card-toggle">
        <div class="form-check form-switch">
          <input type="hidden" name="restaurant[allowOrdering]" value="false">
          <input class="form-check-input"
                 type="checkbox"
                 name="restaurant[allowOrdering]"
                 id="restaurant_allowOrdering"
                 value="true"
                 <%= 'checked' if restaurant.allowOrdering %>
                 data-skip-tomselect="true">
        </div>
      </div>
    </div>

    <%# Inventory Tracking temporarily hidden %>
    <% if false %>
      <!-- Inventory Tracking -->
      <div class="feature-card">
        <div class="feature-card-icon bg-danger">
          <i class="bi bi-boxes"></i>
        </div>
        <div class="feature-card-content">
          <h5 class="feature-card-title"><%= t('.inventory_tracking') %></h5>
          <p class="feature-card-description">
            <%= t('.inventory_tracking_help') %>
          </p>
        </div>
        <div class="feature-card-toggle">
          <div class="form-check form-switch">
            <input class="form-check-input"
                   type="checkbox"
                   name="restaurant[inventoryTracking]"
                   id="restaurant_inventoryTracking"
                   value="true"
                   <%= 'checked' if restaurant.inventoryTracking %>
                   data-skip-tomselect="true"
                   disabled>
          </div>
        </div>
      </div>
    <% end %>
  </div>
  <% end %>
</div>

<!-- WiFi Configuration moved to its own section (wifi_2025) -->


<style>
  /* Feature Grid Layout */
  .features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-4);
  }

  .feature-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    padding: var(--space-4);
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
  }

  .feature-card:hover {
    border-color: var(--color-gray-300);
    box-shadow: var(--shadow-sm);
  }

  .feature-card-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .feature-card-content {
    flex: 1;
  }

  .feature-card-title {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    margin: 0 0 var(--space-2) 0;
    color: var(--color-gray-900);
  }

  .feature-card-description {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
    margin: 0;
    line-height: 1.5;
  }

  .feature-card-toggle {
    padding-top: var(--space-2);
    border-top: 1px solid var(--color-gray-100);
  }

  .feature-card-toggle .form-switch {
    display: flex;
    justify-content: flex-end;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .features-grid {
      grid-template-columns: 1fr;
    }
  }

  .bg-light {
    background: var(--color-gray-50) !important;
  }
</style>
