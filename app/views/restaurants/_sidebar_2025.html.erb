<%#
  Sidebar Navigation for Restaurant Configuration
  Groups 13+ tabs into 4 logical sections
%>

<%
  # Calculate counts for badges
  restaurant = local_assigns[:restaurant] || @restaurant
  active_menus_count = restaurant.restaurant_menus.where(status: 'active').count rescue 0
  inactive_menus_count = restaurant.restaurant_menus.where(status: 'inactive').count rescue 0
  staff_count = restaurant.employees.count rescue 0
  tables_count = restaurant.tablesettings.count rescue 0
  allergens_count = restaurant.allergyns.where(archived: false).count rescue 0
  locales_count = restaurant.restaurantlocales.count rescue 0
  taxes_count = restaurant.taxes.count rescue 0
  tips_count = restaurant.tips.count rescue 0
  current_section = local_assigns[:current_section] || 'details'

  # Onboarding gating: only allow navigation to the next required section
  onboarding_next = @onboarding_next
  def disabled_class_for(section, onboarding_next)
    return '' if onboarding_next.blank? || onboarding_next == section
    'disabled link-disabled'
  end
  def disabled_data_attrs(section, onboarding_next)
    return {}
      .merge({}) if onboarding_next.blank? || onboarding_next == section
    { disabled: true, controller: 'prevent-click' }
  end
%>

<aside class="sidebar-2025" data-sidebar-target="sidebar" data-testid="restaurant-sidebar">
  <!-- Mobile Header -->
  <div class="sidebar-header">
    <h3><%= restaurant.name %></h3>
    <button type="button" data-action="click->sidebar#close" aria-label="<%= t('.close_menu') %>">
      <i class="bi bi-x-lg pointer-events-none"></i>
    </button>
  </div>

  <!-- RESTAURANT SECTION -->
  <div class="sidebar-section">
    <div class="sidebar-section-title">
      <i class="bi bi-file-text"></i>
      <%= t('.restaurant') %>
    </div>

    <%= link_to edit_restaurant_path(restaurant, section: 'details'),
        class: "sidebar-link #{'active' if current_section == 'details' || current_section == 'address'} #{disabled_class_for('details', onboarding_next)}",
        data: { testid: 'sidebar-details-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('details', onboarding_next) } do %>
      <i class="bi bi-info-circle"></i>
      <span><%= t('.details') %></span>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'hours'),
        class: "sidebar-link #{'active' if current_section == 'hours'} #{disabled_class_for('hours', onboarding_next)}",
        data: { testid: 'sidebar-hours-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('hours', onboarding_next) } do %>
      <i class="bi bi-calendar-check"></i>
      <span><%= t('.schedule') %></span>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'localization'),
        class: "sidebar-link #{'active' if current_section == 'localization'} #{disabled_class_for('localization', onboarding_next)}",
        data: { testid: 'sidebar-localization-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('localization', onboarding_next) } do %>
      <i class="bi bi-globe"></i>
      <span><%= t('.localization') %></span>
      <% if locales_count > 0 %>
        <span class="sidebar-link-badge"><%= locales_count %></span>
      <% end %>
    <% end %>
  </div>

  <!-- MENUS SECTION -->
  <div class="sidebar-section">
    <div class="sidebar-section-title">
      <i class="bi bi-menu-button-wide"></i>
      <%= t('.menus') %>
    </div>

    <%= link_to edit_restaurant_path(restaurant, section: 'menus'),
        class: "sidebar-link #{'active' if current_section == 'menus' || current_section == 'menus_active' || current_section == 'menus_inactive'} #{disabled_class_for('menus', onboarding_next)}",
        data: { testid: 'sidebar-menus-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('menus', onboarding_next) } do %>
      <i class="bi bi-grid-3x3"></i>
      <span><%= t('.all_menus') %></span>
      <span class="sidebar-link-badge"><%= restaurant.restaurant_menus.count %></span>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'allergens'),
        class: "sidebar-link #{'active' if current_section == 'allergens'} #{disabled_class_for('allergens', onboarding_next)}",
        data: { testid: 'sidebar-allergens-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('allergens', onboarding_next) } do %>
      <i class="bi bi-exclamation-triangle"></i>
      <span><%= t('.allergens') %></span>
      <% if allergens_count > 0 %>
        <span class="sidebar-link-badge"><%= allergens_count %></span>
      <% end %>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'sizes'),
        class: "sidebar-link #{'active' if current_section == 'sizes'} #{disabled_class_for('sizes', onboarding_next)}",
        data: { testid: 'sidebar-sizes-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('sizes', onboarding_next) } do %>
      <i class="bi bi-rulers"></i>
      <span><%= t('.sizes') %></span>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'settings'),
        class: "sidebar-link #{'active' if current_section == 'settings'} #{disabled_class_for('settings', onboarding_next)}",
        data: { testid: 'sidebar-settings-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('settings', onboarding_next) } do %>
      <i class="bi bi-toggles"></i>
      <span><%= t('.settings') %></span>
    <% end %>
  </div>

  <!-- OPERATIONS (Tables + Staff) -->
  <div class="sidebar-section">
    <div class="sidebar-section-title">
      <i class="bi bi-gear-wide-connected"></i>
      <%= t('.operations') %>
    </div>

    <% if @current_employee && @current_employee.role == 'manager' %>
      <%= link_to edit_restaurant_path(restaurant, section: 'tables'),
          class: "sidebar-link #{'active' if current_section == 'tables'} #{disabled_class_for('tables', onboarding_next)}",
          data: { testid: 'sidebar-tables-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('tables', onboarding_next) } do %>
        <i class="bi bi-layout-wtf"></i>
        <span><%= t('.tables') %></span>
        <% if tables_count > 0 %>
          <span class="sidebar-link-badge"><%= tables_count %></span>
        <% end %>
      <% end %>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'staff'),
        class: "sidebar-link #{'active' if current_section == 'staff'} #{disabled_class_for('staff', onboarding_next)}",
        data: { testid: 'sidebar-staff-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('staff', onboarding_next) } do %>
      <i class="bi bi-person-badge"></i>
      <span><%= t('.staff') %></span>
      <% if staff_count > 0 %>
        <span class="sidebar-link-badge"><%= staff_count %></span>
      <% end %>
    <% end %>

    <%= link_to kitchen_dashboard_restaurant_path(restaurant),
        class: 'sidebar-link',
        target: '_blank',
        rel: 'noopener',
        data: { testid: 'sidebar-kitchen-dashboard-link', turbo: false } do %>
      <i class="bi bi-fire"></i>
      <span><%= t('.kitchen_dashboard') %></span>
      <i class="bi bi-box-arrow-up-right ms-auto"></i>
    <% end %>

    <%= link_to bar_dashboard_restaurant_path(restaurant),
        class: 'sidebar-link',
        target: '_blank',
        rel: 'noopener',
        data: { testid: 'sidebar-bar-dashboard-link', turbo: false } do %>
      <i class="bi bi-cup-straw"></i>
      <span><%= t('.bar_dashboard') %></span>
      <i class="bi bi-box-arrow-up-right ms-auto"></i>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'taxes_and_tips'),
        class: "sidebar-link #{'active' if current_section == 'taxes_and_tips'} #{disabled_class_for('taxes_and_tips', onboarding_next)}",
        data: { testid: 'sidebar-taxes-tips-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('taxes_and_tips', onboarding_next) } do %>
      <i class="bi bi-cash-coin"></i>
      <span><%= t('.taxes_and_tips') %></span>
      <% if taxes_count > 0 %>
        <span class="sidebar-link-badge" title="<%= t('.taxes') %>"><%= taxes_count %></span>
      <% end %>
      <% if tips_count > 0 %>
        <span class="sidebar-link-badge" title="<%= t('.tips') %>"><%= tips_count %></span>
      <% end %>
    <% end %>

    <% if @current_employee && @current_employee.role == 'manager' %>
      <%= link_to edit_restaurant_path(restaurant, section: 'ordering'),
          class: "sidebar-link #{'active' if current_section == 'ordering'} #{disabled_class_for('ordering', onboarding_next)}",
          data: { testid: 'sidebar-ordering-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('ordering', onboarding_next) } do %>
        <i class="bi bi-cart-check"></i>
        <span><%= t('.ordering') %></span>
      <% end %>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'jukebox'),
        class: "sidebar-link #{'active' if current_section == 'jukebox'} #{disabled_class_for('jukebox', onboarding_next)}",
        data: { testid: 'sidebar-jukebox-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('jukebox', onboarding_next) } do %>
      <i class="bi bi-music-note-beamed"></i>
      <span><%= t('.jukebox') %></span>
    <% end %>

    <%= link_to edit_restaurant_path(restaurant, section: 'wifi'),
        class: "sidebar-link #{'active' if current_section == 'wifi'} #{disabled_class_for('wifi', onboarding_next)}",
        data: { testid: 'sidebar-wifi-link', turbo_frame: 'restaurant_content', turbo_action: 'advance', action: 'click->sidebar#handleLinkClick', **disabled_data_attrs('wifi', onboarding_next) } do %>
      <i class="bi bi-wifi"></i>
      <span><%= t('.wifi') %></span>
    <% end %>
  </div>

  

  
</aside>

<!-- Mobile Overlay -->
<div class="sidebar-overlay" data-sidebar-target="overlay" data-action="click->sidebar#close"></div>
