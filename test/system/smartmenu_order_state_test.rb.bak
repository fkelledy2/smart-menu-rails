require "application_system_test_case"

class SmartmenuOrderStateTest < ApplicationSystemTestCase
  setup do
    @restaurant = restaurants(:one)
    @menu = menus(:ordering_menu)
    @table = tablesettings(:table_one)
    @smartmenu = smartmenus(:one)
    
    @burger = menuitems(:burger)
    @pasta = menuitems(:pasta)
    @spring_rolls = menuitems(:spring_rolls)
  end

  # ===================
  # ORDER LIFECYCLE TESTS
  # ===================

  test 'new order starts in opened status' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add item to create order
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify order state
    order = Ordr.last
    assert_equal 'opened', order.status
    assert order.ordritems.all? { |item| item.status == 'opened' }
  end

  test 'order transitions from opened to ordered on submission' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Create order
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    order = Ordr.last
    assert_equal 'opened', order.status
    
    # Submit order
    click_testid('submit-order-btn')
    sleep 2
    
    # Verify status changed
    order.reload
    assert_equal 'ordered', order.status
    assert order.ordritems.all? { |item| item.status == 'ordered' }
  end

  test 'submitted order can receive additional items' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Create and submit initial order
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    click_testid('submit-order-btn')
    sleep 2
    
    order = Ordr.last
    first_item = order.ordritems.first
    assert_equal 'ordered', first_item.status
    
    # Add another item
    click_testid("add-item-btn-#{@pasta.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify new item added in opened state
    order.reload
    second_item = order.ordritems.where(menuitem: @pasta).first
    assert_equal 'opened', second_item.status
    assert_equal 2, order.ordritems.count
  end

  test 'order maintains items across different statuses' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add and submit first item
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    click_testid('submit-order-btn')
    sleep 2
    
    # Add second item (not submitted)
    click_testid("add-item-btn-#{@pasta.id}")
    assert_testid('view-order-modal', wait: 5)
    
    order = Ordr.last
    
    # Verify mixed statuses
    burger_item = order.ordritems.joins(:menuitem).find_by(menuitems: { id: @burger.id })
    pasta_item = order.ordritems.joins(:menuitem).find_by(menuitems: { id: @pasta.id })
    
    assert_equal 'ordered', burger_item.status
    assert_equal 'opened', pasta_item.status
  end

  # ===================
  # SESSION PERSISTENCE TESTS
  # ===================

  test 'order persists for same session across page reloads' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Create order
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    order_id = Ordr.last.id
    session_id = page.driver.browser.manage.all_cookies.find { |c| c[:name] == '_session_id' }&.fetch(:value)
    
    # Reload page
    visit smartmenu_path(@smartmenu.slug)
    
    # Verify same order loaded
    assert_testid('order-fab-container')
    click_testid('order-fab-btn')
    assert_testid('view-order-modal', wait: 5)
    
    # Should be same order
    assert_equal order_id, Ordr.last.id
  end

  test 'empty order remains in opened state' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Create order
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    order = Ordr.last
    ordritem = order.ordritems.first
    
    # Remove all items
    click_testid("remove-order-item-#{ordritem.id}-btn")
    sleep 1
    
    # Verify order still exists but empty
    order.reload
    assert_equal 'opened', order.status
    assert_equal 0, order.ordritems.count
    assert order.persisted?
  end

  test 'order tracks participants correctly' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Create order
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    order = Ordr.last
    
    # Verify participant created
    participant = Ordrparticipant.find_by(ordr: order)
    assert participant.present?
    assert participant.sessionid.present?
  end

  # ===================
  # ORDER INTEGRITY TESTS
  # ===================

  test 'order total calculated correctly' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add multiple items
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    click_testid("add-item-btn-#{@pasta.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    click_testid("add-item-btn-#{@spring_rolls.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify total in UI
    expected_total = @burger.price + @pasta.price + @spring_rolls.price
    within_testid('order-total-amount') do
      assert_text "$#{sprintf('%.2f', expected_total)}"
    end
    
    # Verify total in database
    order = Ordr.last
    assert_in_delta expected_total, order.nett, 0.01
  end

  test 'removing item updates order total correctly' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add two items
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    click_testid("add-item-btn-#{@pasta.id}")
    assert_testid('view-order-modal', wait: 5)
    
    initial_total = @burger.price + @pasta.price
    
    # Remove one item
    order = Ordr.last
    pasta_item = order.ordritems.joins(:menuitem).find_by(menuitems: { id: @pasta.id })
    click_testid("remove-order-item-#{pasta_item.id}-btn")
    sleep 1
    
    # Verify updated total
    within_testid('order-total-amount') do
      assert_text "$#{sprintf('%.2f', @burger.price)}"
    end
    
    order.reload
    assert_in_delta @burger.price, order.nett, 0.01
  end

  test 'order items maintain correct prices' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add items
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    order = Ordr.last
    ordritem = order.ordritems.first
    
    # Verify order item has correct price
    assert_equal @burger.price, ordritem.ordritemprice
    assert_equal @burger.id, ordritem.menuitem_id
  end

  # ===================
  # EDGE CASE TESTS
  # ===================

  test 'cannot submit order with no items' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add and remove item to create empty order
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    ordritem = Ordr.last.ordritems.first
    click_testid("remove-order-item-#{ordritem.id}-btn")
    sleep 1
    
    # Verify submit button disabled
    submit_btn = find_testid('submit-order-btn')
    assert submit_btn[:disabled] || submit_btn[:class].include?('disabled'),
           "Submit button should be disabled for empty order"
  end

  test 'order item count reflects actual items' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add items one by one
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    within_testid('order-item-count-badge') do
      assert_text '1'
    end
    
    click_testid("add-item-btn-#{@pasta.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    within_testid('order-item-count-badge') do
      assert_text '2'
    end
    
    click_testid("add-item-btn-#{@spring_rolls.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    within_testid('order-item-count-badge') do
      assert_text '3'
    end
  end
end
