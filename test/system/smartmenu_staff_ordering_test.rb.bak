require "application_system_test_case"

class SmartmenuStaffOrderingTest < ApplicationSystemTestCase
  setup do
    @user = users(:one)
    @restaurant = restaurants(:one)
    @menu = menus(:ordering_menu)
    @table = tablesettings(:table_one)
    @smartmenu = smartmenus(:one)
    
    # Menu sections
    @starters = menusections(:starters_section)
    @mains = menusections(:mains_section)
    
    # Menu items
    @spring_rolls = menuitems(:spring_rolls)
    @burger = menuitems(:burger)
    @pasta = menuitems(:pasta)
    @salmon = menuitems(:salmon)
    
    # Login as staff
    Warden.test_mode!
    login_as(@user, scope: :user)
  end

  teardown do
    Warden.test_reset!
  end

  # ===================
  # STAFF VIEW ACCESS TESTS
  # ===================

  test 'staff can access smartmenu and see staff view' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Verify staff view is displayed
    assert_testid('smartmenu-staff-view')
    assert_no_selector('[data-testid="smartmenu-customer-view"]')
    
    # Verify menu content loads
    assert_testid('menu-content-container')
  end

  test 'staff view shows menu content like customer view' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Verify sections visible
    assert_testid("menu-section-#{@starters.id}")
    assert_testid("menu-section-#{@mains.id}")
    
    # Verify items visible
    assert_testid("menu-item-#{@burger.id}")
    assert_testid("menu-item-#{@spring_rolls.id}")
  end

  # ===================
  # STAFF ORDERING TESTS
  # ===================

  test 'staff can add items to order on behalf of customer' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add item as staff
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify order created
    order = Ordr.last
    assert order.present?
    assert_equal 'opened', order.status
    
    # Verify staff participant created
    participant = Ordrparticipant.find_by(ordr: order)
    assert participant.present?
  end

  test 'staff can add multiple items to order' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add first item
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    # Add second item
    click_testid("add-item-btn-#{@pasta.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify both items in order
    order = Ordr.last
    assert_equal 2, order.ordritems.count
    
    within_testid('order-modal-body') do
      assert_text 'Classic Burger'
      assert_text 'Spaghetti Carbonara'
    end
  end

  test 'staff can remove items from order' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add two items
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    click_testid("add-item-btn-#{@pasta.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Remove one item
    order = Ordr.last
    pasta_item = order.ordritems.joins(:menuitem).find_by(menuitems: { id: @pasta.id })
    
    click_testid("remove-order-item-#{pasta_item.id}-btn")
    sleep 1
    
    # Verify item removed
    assert_no_selector("[data-testid='order-item-#{pasta_item.id}']")
    assert_equal 1, order.ordritems.reload.count
  end

  test 'staff can submit order for customer' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add items
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Submit order
    click_testid('submit-order-btn')
    sleep 2
    
    # Verify order submitted
    order = Ordr.last
    order.reload
    assert_equal 'ordered', order.status
  end

  test 'staff can view order total while building order' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add item
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify total
    expected_total = @burger.price
    within_testid('order-total-amount') do
      assert_text "$#{sprintf('%.2f', expected_total)}"
    end
    
    # Add another item
    find('.btn-dark', text: /cancel|close/i).click
    click_testid("add-item-btn-#{@salmon.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify updated total
    expected_total = @burger.price + @salmon.price
    within_testid('order-total-amount') do
      assert_text "$#{sprintf('%.2f', expected_total)}"
    end
  end

  # ===================
  # CUSTOMER NAME TESTS
  # ===================

  test 'staff can add customer name to order' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add item to create order
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    # Verify add name button exists
    assert_testid('add-customer-name-btn')
  end

  test 'staff order management matches customer experience' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Staff ordering flow should work like customer
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Should have FAB after closing
    find('.btn-dark', text: /cancel|close/i).click
    assert_testid('order-fab-container')
    
    # Should show item count
    assert_testid('order-item-count-badge')
    within_testid('order-item-count-badge') do
      assert_text '1'
    end
  end

  # ===================
  # STAFF WORKFLOW TESTS
  # ===================

  test 'staff can manage orders for multiple tables' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Create order for this table
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    click_testid('submit-order-btn')
    sleep 2
    
    table1_order = Ordr.last
    assert_equal @table.id, table1_order.tablesetting_id
    assert_equal 'ordered', table1_order.status
  end

  test 'staff can continue working with persistent order' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add item
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    order_id = Ordr.last.id
    
    # Reload page (simulate navigation)
    visit smartmenu_path(@smartmenu.slug)
    
    # Verify order persists
    assert_testid('order-fab-container')
    
    # Add another item
    click_testid("add-item-btn-#{@pasta.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify same order
    assert_equal order_id, Ordr.last.id
    assert_equal 2, Ordr.last.ordritems.count
  end

  test 'staff can add items after order is submitted' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Create and submit order
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    click_testid('submit-order-btn')
    sleep 2
    
    order = Ordr.last
    assert_equal 'ordered', order.status
    
    # Add another item
    click_testid("add-item-btn-#{@pasta.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify item added to existing order
    order.reload
    assert_equal 2, order.ordritems.count
  end

  # ===================
  # STAFF VIEW PREVIEW TESTS
  # ===================

  test 'staff can switch to customer view preview' do
    visit smartmenu_path(@smartmenu.slug, view: 'customer')
    
    # Should show customer view even when logged in
    assert_testid('smartmenu-customer-view')
    assert_no_selector('[data-testid="smartmenu-staff-view"]')
  end

  test 'staff customer preview functions like actual customer view' do
    visit smartmenu_path(@smartmenu.slug, view: 'customer')
    
    # Should be able to add items
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify order created
    order = Ordr.last
    assert order.present?
    
    # Should see customer UI elements
    within_testid('order-modal-body') do
      assert_text 'Classic Burger'
    end
  end

  test 'staff can verify order contents before submission' do
    visit smartmenu_path(@smartmenu.slug)
    
    # Add multiple items
    click_testid("add-item-btn-#{@burger.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    click_testid("add-item-btn-#{@pasta.id}")
    assert_testid('view-order-modal', wait: 5)
    find('.btn-dark', text: /cancel|close/i).click
    
    click_testid("add-item-btn-#{@spring_rolls.id}")
    assert_testid('view-order-modal', wait: 5)
    
    # Verify all items shown
    within_testid('order-modal-body') do
      assert_text 'Classic Burger'
      assert_text 'Spaghetti Carbonara'
      assert_text 'Spring Rolls'
    end
    
    # Verify total
    expected_total = @burger.price + @pasta.price + @spring_rolls.price
    within_testid('order-total-amount') do
      assert_text "$#{sprintf('%.2f', expected_total)}"
    end
  end
end
