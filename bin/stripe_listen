#!/usr/bin/env sh

set -e

WEB_PORT="${WEB_PORT:-${PORT:-3000}}"
FORWARD_TO="${STRIPE_WEBHOOK_FORWARD_TO:-http://localhost:${WEB_PORT}/payments/webhooks/stripe}"
RAILS_ENV_VALUE="${RAILS_ENV:-development}"

if [ -z "${STRIPE_API_KEY}" ]; then
  if [ -n "${STRIPE_CLI_API_KEY}" ]; then
    STRIPE_API_KEY="${STRIPE_CLI_API_KEY}"
  elif [ -n "${STRIPE_SECRET_KEY}" ]; then
    STRIPE_API_KEY="${STRIPE_SECRET_KEY}"
  else
    STRIPE_API_KEY="$(bundle exec rails runner -e "${RAILS_ENV_VALUE}" 'key = (Rails.application.credentials.stripe_secret_key rescue nil)
if key.nil? || key.to_s.empty?
  key = (Rails.application.credentials.dig(:stripe, :secret_key) || Rails.application.credentials.dig(:stripe, :api_key) rescue nil)
end
print key.to_s')"
  fi
fi

if [ -z "${STRIPE_API_KEY}" ]; then
  echo "STRIPE_API_KEY not found; starting Stripe CLI using local login (run: stripe login)" 1>&2
  exec env -u STRIPE_API_KEY stripe listen --forward-to "${FORWARD_TO}"
fi

case "${STRIPE_API_KEY}" in
  sk_*|rk_*)
    exec stripe listen --api-key "${STRIPE_API_KEY}" --forward-to "${FORWARD_TO}"
    ;;
  pk_*)
    echo "Stripe CLI requires a secret or restricted key (sk_* or rk_*), not a publishable key (pk_*)." 1>&2
    echo "Falling back to Stripe CLI login mode (run: stripe login)" 1>&2
    exec env -u STRIPE_API_KEY stripe listen --forward-to "${FORWARD_TO}"
    ;;
  *)
    echo "Unrecognized STRIPE_API_KEY format; falling back to Stripe CLI login mode (run: stripe login)" 1>&2
    exec env -u STRIPE_API_KEY stripe listen --forward-to "${FORWARD_TO}"
    ;;
esac
